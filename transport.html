<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Calculateur Transport â€” Cofel</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

  <style>
    :root{
      --cofel:#5a2d82; --cofel-2:#7838a7;
      --txt:#f5f7ff; --txt-dim:#e6e6ff;
      --accent:#c9b7ff;
      --glass: rgba(255,255,255,.10);
      --glass-2: rgba(255,255,255,.06);
      --radius:18px; --blur:18px;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--txt);
      font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","Segoe UI",Roboto,Arial,sans-serif;
      background:
        radial-gradient(800px 500px at 20% -10%, rgba(255,255,255,.10), transparent 60%),
        radial-gradient(800px 500px at 110% 10%, rgba(255,255,255,.08), transparent 60%),
        linear-gradient(135deg, var(--cofel), var(--cofel-2));
    }

    /* HERO */
    .hero{ padding:34px 20px 18px; }
    .hero-inner{ max-width:1100px; margin:0 auto; display:flex; align-items:center; justify-content:space-between; gap:14px; }
    .brand{
      display:flex; align-items:center; gap:12px;
      padding:10px 14px; border-radius:14px;
      background: linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.06));
      border:1px solid rgba(255,255,255,.2);
      backdrop-filter: blur(var(--blur));
      box-shadow: var(--shadow);
    }
    .brand img{height:42px; width:auto; border-radius:10px}
    .brand h1{ margin:0; font-size:20px; letter-spacing:.2px; }
    .hero-actions{ display:flex; align-items:center; gap:10px; }
    .tagline{ color:var(--txt-dim); font-size:12px; }

    /* WRAP */
    .wrap{ max-width:1100px; margin:20px auto 40px; padding:0 20px; }

    /* CARDS */
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.16), rgba(255,255,255,.06));
      border:1px solid rgba(255,255,255,.2);
      border-radius:20px; padding:18px; box-shadow:var(--shadow);
      backdrop-filter: blur(var(--blur));
      margin-bottom:16px;
    }
    h2{ margin:0 0 12px; font-size: clamp(18px, 2.4vw, 22px); letter-spacing:.2px; }
    label{font-weight:700; font-size:12px; color:var(--accent)}

    .grid{ display:grid; gap:12px; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); }
    select{
      width:100%; padding:12px;
      background: rgba(255,255,255,.10); color:var(--txt);
      border:1px solid rgba(255,255,255,.22); border-radius:12px; outline:none;
    }

    .price-box{
      display:flex; align-items:center; justify-content:space-between;
      background: linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.06));
      border:1px solid rgba(255,255,255,.22); border-radius:16px;
      padding:14px 16px; margin-top:10px;
    }
    .price{ font-size:22px; font-weight:800; letter-spacing:.2px; }
    .muted{ color:var(--txt-dim); font-size:12px; }

    table{ width:100%; border-collapse:collapse; min-width:560px; }
    th, td{ padding:10px 12px; text-align:left; }
    thead tr{ background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.04)); }
    th{ font-size:12px; color:var(--accent); letter-spacing:.2px; }
    tbody tr + tr td{ border-top:1px solid rgba(255,255,255,.12); }

    .note{ color:var(--txt-dim); font-size:12px; margin-top:8px; }
    .btn{
      appearance:none; border:none; cursor:pointer; font-weight:800;
      color:#0b0b0b; background:#fff; border-radius:12px; padding:10px 14px;
      box-shadow: 0 10px 24px rgba(0,0,0,.25);
    }
    .btn-ghost{
      color:var(--txt); background: transparent;
      border:1px solid rgba(255,255,255,.22);
    }

    @media (max-width:720px){
      .brand h1{ display:none; }
      .price{ font-size:20px; }
    }
  </style>
</head>
<body>

  <!-- HERO -->
  <header class="hero">
    <div class="hero-inner">
      <div class="brand">
        <img src="./assets/logo cofel.jpg" alt="Cofel" />
        <h1>Calculateur Transport â€” Cofel</h1>
      </div>
      <div class="hero-actions">
        <div class="brand"><div class="tagline">Page de test dÃ©diÃ©e (hors page dâ€™accueil)</div></div>
        <a href="./index.html" class="btn btn-ghost" title="Retour Ã  lâ€™accueil">âŸµ Accueil</a>
      </div>
    </div>
  </header>

  <main class="wrap">
    <!-- SÃ©lecteurs -->
    <section class="card">
      <h2>ðŸ§® SÃ©lection</h2>
      <div class="grid">
        <div>
          <label for="typeSelect">Type de transport</label>
          <select id="typeSelect">
            <option value="messagerie">Messagerie</option>
            <option value="affretement">AffrÃ¨tement</option>
          </select>
        </div>
        <div>
          <label for="deptSelect">DÃ©partement</label>
          <select id="deptSelect">
            <option value="">â€” Choisir un dÃ©partement â€”</option>
          </select>
        </div>
        <div id="selectWrap">
          <label id="thirdLabel" for="thirdSelect">Poids (kg)</label>
          <select id="thirdSelect" disabled>
            <option value="">â€” Choisir â€”</option>
          </select>
        </div>
      </div>

      <div class="price-box">
        <div>
          <div class="muted" id="currentContext">SÃ©lection en attenteâ€¦</div>
          <div class="price" id="priceValue">â€”</div>
        </div>
        <div>
          <button id="resetBtn" class="btn btn-ghost">RÃ©initialiser</button>
        </div>
      </div>

      <div class="note">
        Astuce : les tarifs affichÃ©s sont les <strong>prix de vente client HT</strong> issus de vos grilles.  
        Cette page est destinÃ©e aux tests internes avant intÃ©gration.
      </div>
    </section>

    <!-- Tableau du dÃ©partement -->
    <section class="card">
      <h2>ðŸ“‹ DÃ©tails pour le dÃ©partement sÃ©lectionnÃ©</h2>
      <div style="overflow:auto; border-radius:14px; border:1px solid rgba(255,255,255,.16);">
        <table id="detailsTable">
          <thead>
            <tr id="theadRow">
              <!-- Colonnes dynamiques -->
            </tr>
          </thead>
          <tbody id="tbodyRows">
            <tr><td colspan="3" class="muted">Choisissez un dÃ©partement pour voir les lignes disponibles.</td></tr>
          </tbody>
        </table>
      </div>
      <div class="note" id="tableNote"></div>
    </section>
  </main>

  <script>
    // === CONFIG DES SOURCES CSV (adapter si besoin) ==========================
    const CSV_MESSAGERIE_URL = "./data/transport_messagerie.csv";
    const CSV_AFFRETEMENT_URL = "./data/transport_affretement.csv";

    // === UTILITAIRES ========================================================
    const fmtEUR = n => {
      const v = Number(n || 0);
      return v.toFixed(2).replace('.', ',') + " â‚¬";
    };

    // CSV trÃ¨s simple (sÃ©parateur virgule, pas de guillemets imbriquÃ©s)
    async function loadCSV(url){
      const res = await fetch(url, { cache: "no-store" });
      if(!res.ok) throw new Error("Erreur chargement " + url + " : " + res.status);
      const text = await res.text();
      const lines = text.split(/\r?\n/).filter(l => l.trim().length>0);
      const headers = lines[0].split(",").map(h=>h.trim());
      const rows = lines.slice(1).map(line => {
        const cols = line.split(",").map(c => c.trim());
        const rec = {};
        headers.forEach((h, i) => rec[h] = cols[i] ?? "");
        return rec;
      });
      return { headers, rows };
    }

    function uniqueSorted(arr, mapper = v=>v){
      const s = new Set(arr.map(mapper));
      return Array.from(s).filter(Boolean).sort((a,b)=> (a < b ? -1 : a > b ? 1 : 0));
    }

    function byDept(rows, dept){
      return rows.filter(r => String(r.departement || "").trim() === String(dept).trim());
    }

    // === ETAT ===============================================================
    const state = {
      type: "messagerie",        // "messagerie" | "affretement"
      departement: "",
      third: "",                 // poids_kg (messagerie) ou longueur_m (affrÃ¨tement)
      messagerie: { headers:[], rows:[] },
      affretement: { headers:[], rows:[] }
    };

    // === DOM ================================================================
    const typeSelect   = document.getElementById("typeSelect");
    const deptSelect   = document.getElementById("deptSelect");
    const thirdSelect  = document.getElementById("thirdSelect");
    const thirdLabel   = document.getElementById("thirdLabel");
    const currentCtx   = document.getElementById("currentContext");
    const priceValue   = document.getElementById("priceValue");
    const resetBtn     = document.getElementById("resetBtn");

    const theadRow     = document.getElementById("theadRow");
    const tbodyRows    = document.getElementById("tbodyRows");
    const tableNote    = document.getElementById("tableNote");

    // === RENDU ==============================================================
    function renderDepartments(){
      const rows = state.type === "messagerie" ? state.messagerie.rows : state.affretement.rows;
      const depts = uniqueSorted(rows.map(r => String(r.departement || "").trim()));
      deptSelect.innerHTML = `<option value="">â€” Choisir un dÃ©partement â€”</option>` +
        depts.map(d => `<option value="${d}">${d}</option>`).join("");
      // reset dependent select
      thirdSelect.innerHTML = `<option value="">â€” Choisir â€”</option>`;
      thirdSelect.disabled = true;
      state.departement = "";
      state.third = "";
      renderPrice();
      renderTable();
    }

    function renderThirdSelector(){
      const isMess = state.type === "messagerie";
      thirdLabel.textContent = isMess ? "Poids (kg)" : "Longueur palette (m)";
      thirdSelect.disabled = !state.departement;

      if(!state.departement){
        thirdSelect.innerHTML = `<option value="">â€” Choisir â€”</option>`;
        return;
      }

      const rows = state.type === "messagerie" ? state.messagerie.rows : state.affretement.rows;
      const rowsDept = byDept(rows, state.departement);
      const key = isMess ? "poids_kg" : "longueur_m";
      const opts = uniqueSorted(rowsDept.map(r => String(r[key] || "").trim()), v => v);

      thirdSelect.innerHTML = `<option value="">â€” Choisir â€”</option>` +
        opts.map(v => `<option value="${v}">${v}</option>`).join("");
      state.third = "";
      renderPrice();
      renderTable();
    }

    function renderPrice(){
      if(!state.departement || !state.third){
        currentCtx.textContent = "SÃ©lection en attenteâ€¦";
        priceValue.textContent = "â€”";
        return;
      }
      const isMess = state.type === "messagerie";
      const rows = isMess ? state.messagerie.rows : state.affretement.rows;
      const key = isMess ? "poids_kg" : "longueur_m";
      const match = rows.find(r => String(r.departement).trim() === state.departement && String(r[key]).trim() === state.third);
      if(!match){
        currentCtx.textContent = "Aucune ligne correspondante.";
        priceValue.textContent = "â€”";
        return;
      }
      currentCtx.textContent = `${isMess ? "Messagerie" : "AffrÃ¨tement"} â€¢ Dept ${state.departement} â€¢ ${isMess ? "Poids" : "Longueur"}: ${state.third}`;
      const price = Number(String(match.prix_ht || "0").replace(",", "."));
      priceValue.textContent = isFinite(price) ? fmtEUR(price) : "â€”";
    }

    function renderTable(){
      // En-tÃªtes
      const isMess = state.type === "messagerie";
      theadRow.innerHTML = `
        <th>DÃ©partement</th>
        <th>${isMess ? "Poids (kg)" : "Longueur palette (m)"}</th>
        <th>Prix client HT</th>
      `;

      // Lignes du dÃ©partement
      const rows = isMess ? state.messagerie.rows : state.affretement.rows;
      if(!state.departement){
        tbodyRows.innerHTML = `<tr><td colspan="3" class="muted">Choisissez un dÃ©partement pour voir les lignes disponibles.</td></tr>`;
        tableNote.textContent = "";
        return;
      }
      const rowsDept = byDept(rows, state.departement);
      if(!rowsDept.length){
        tbodyRows.innerHTML = `<tr><td colspan="3" class="muted">Aucune ligne pour ce dÃ©partement.</td></tr>`;
        tableNote.textContent = "";
        return;
      }
      const key = isMess ? "poids_kg" : "longueur_m";
      const sorted = rowsDept.slice().sort((a,b)=>{
        const na = parseFloat(String(a[key]).replace(",", "."));
        const nb = parseFloat(String(b[key]).replace(",", "."));
        return (isFinite(na) && isFinite(nb)) ? (na - nb) : String(a[key]).localeCompare(String(b[key]));
      });
      tbodyRows.innerHTML = sorted.map(r=>{
        const price = Number(String(r.prix_ht || "0").replace(",", "."));
        return `
          <tr>
            <td>${r.departement || ""}</td>
            <td>${r[key] || ""}</td>
            <td>${isFinite(price) ? fmtEUR(price) : ""}</td>
          </tr>
        `;
      }).join("");

      tableNote.textContent = `${rowsDept.length} ligne(s) â€” source: ${isMess ? "transport_messagerie.csv" : "transport_affretement.csv"}`;
    }

    function resetAll(){
      typeSelect.value = state.type = "messagerie";
      renderDepartments();
    }

    // === EVENTS =============================================================
    typeSelect.addEventListener("change", ()=>{
      state.type = typeSelect.value;
      renderDepartments();
    });
    deptSelect.addEventListener("change", ()=>{
      state.departement = deptSelect.value;
      renderThirdSelector();
    });
    thirdSelect.addEventListener("change", ()=>{
      state.third = thirdSelect.value;
      renderPrice();
    });
    resetBtn.addEventListener("click", resetAll);

    // === BOOT ===============================================================
    (async function boot(){
      try{
        const [mess, affr] = await Promise.all([
          loadCSV(CSV_MESSAGERIE_URL),
          loadCSV(CSV_AFFRETEMENT_URL)
        ]);
        // Normalisation attendue: departement, poids_kg, prix_ht  /  departement, longueur_m, prix_ht
        state.messagerie = {
          headers: mess.headers,
          rows: mess.rows.map(r=>({
            departement: String(r.departement || "").trim(),
            poids_kg: String(r.poids_kg || "").trim(),
            prix_ht: String(r.prix_ht || "").trim()
          }))
        };
        state.affretement = {
          headers: affr.headers,
          rows: affr.rows.map(r=>({
            departement: String(r.departement || "").trim(),
            longueur_m: String(r.longueur_m || "").trim(),
            prix_ht: String(r.prix_ht || "").trim()
          }))
        };

        renderDepartments(); // initialise liste des dÃ©partements
      }catch(err){
        alert("Erreur de chargement des CSV de transport. VÃ©rifiez les chemins dans le haut du fichier.\n" + err.message);
        console.error(err);
      }
    })();
  </script>
</body>
</html>
