<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Calculateur Transport â€” Cofel</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <style>
    :root{ --cofel:#5a2d82; --cofel-2:#7838a7; --txt:#f5f7ff; --txt-dim:#e6e6ff; --accent:#c9b7ff;
      --glass1: rgba(255,255,255,.16); --glass2: rgba(255,255,255,.06);
      --border: rgba(255,255,255,.2); --inputbg: rgba(255,255,255,.10); --inputbd: rgba(255,255,255,.22);
      --radius:18px; --blur:18px; --shadow:0 10px 30px rgba(0,0,0,.35); }
    *{box-sizing:border-box} html,body{height:100%}
    body{
      margin:0; color:var(--txt);
      font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","Segoe UI",Roboto,Arial,sans-serif;
      background:
        radial-gradient(800px 500px at 20% -10%, rgba(255,255,255,.10), transparent 60%),
        radial-gradient(800px 500px at 110% 10%, rgba(255,255,255,.08), transparent 60%),
        linear-gradient(135deg, var(--cofel), var(--cofel-2));
    }
    .hero{ padding:34px 20px 18px; }
    .hero-inner{ max-width:1100px; margin:0 auto; display:flex; align-items:center; justify-content:space-between; gap:14px; }
    .brand{
      display:flex; align-items:center; gap:12px;
      padding:10px 14px; border-radius:14px;
      background: linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.06));
      border:1px solid var(--border); backdrop-filter: blur(var(--blur)); box-shadow: var(--shadow);
    }
    .brand img{height:42px; width:auto; border-radius:10px}
    .brand h1{ margin:0; font-size:20px; letter-spacing:.2px; }
    .hero-actions{ display:flex; align-items:center; gap:10px; }

    .wrap{ max-width:1100px; margin:20px auto 40px; padding:0 20px; }
    .card{
      background: linear-gradient(180deg, var(--glass1), var(--glass2));
      border:1px solid var(--border); border-radius:20px; padding:18px; box-shadow:var(--shadow);
      backdrop-filter: blur(var(--blur)); margin-bottom:16px;
    }
    h2{ margin:0 0 12px; font-size: clamp(18px, 2.4vw, 22px); letter-spacing:.2px; }
    label{font-weight:700; font-size:12px; color:var(--accent)}
    .grid{ display:grid; gap:12px; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); }

    select{
      width:100%; padding:12px; color:var(--txt);
      background: rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.18);
      border-radius:12px; outline:none; backdrop-filter: blur(var(--blur)); appearance:none;
      transition: border-color .18s ease, background .18s ease;
    }
    select:focus{ border-color: rgba(255,255,255,.34); background: rgba(255,255,255,.12); }
    select option{ background:#5a2d82; color:var(--txt); }

    .price-box{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      background: linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.06));
      border:1px solid var(--inputbd); border-radius:16px; padding:14px 16px; margin-top:10px;
    }
    .price{ font-size:24px; font-weight:800; letter-spacing:.2px; }
    .muted{ color:var(--txt-dim); font-size:12px; }

    /* Message explicatif messagerie */
    .info-note{
      margin-top:14px; font-size:13px; color:var(--txt-dim);
      background: rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.15);
      border-radius:12px; padding:10px 12px;
    }

    .btn{ appearance:none; border:none; cursor:pointer; font-weight:800;
      color:#0b0b0b; background:#fff; border-radius:12px; padding:10px 14px;
      box-shadow: 0 10px 24px rgba(0,0,0,.25); transition: transform .16s ease, box-shadow .16s ease, opacity .16s ease; }
    .btn:active{ transform: translateY(1px); box-shadow: 0 6px 16px rgba(0,0,0,.28); }
    .btn-ghost{ color:var(--txt); background: transparent; border:1px solid var(--inputbd); }
    .btn-primary{ background:#fff; }
    .stack{ display:flex; gap:10px; flex-wrap:wrap; }
    .toast{ position:fixed; right:16px; bottom:16px; background:#fff; color:#222; padding:10px 12px; border-radius:10px; box-shadow:0 10px 24px rgba(0,0,0,.35); display:none; }
    .toast.show{ display:block; }
    @media (max-width:720px){ .brand h1{display:none;} .price{font-size:20px} }
  </style>
</head>
<body>
  <header class="hero">
    <div class="hero-inner">
      <div class="brand">
        <img src="./assets/logo cofel.jpg" alt="Cofel" />
        <h1>Calculateur Transport â€” Cofel</h1>
      </div>
      <div class="hero-actions">
        <a href="./index.html" class="btn btn-ghost">âŸµ Accueil</a>
      </div>
    </div>
  </header>

  <main class="wrap">
    <section class="card">
      <h2>ðŸ§® SÃ©lection</h2>
      <div class="grid">
        <div>
          <label for="typeSelect">Type de transport</label>
          <select id="typeSelect">
            <option value="messagerie">Messagerie</option>
            <option value="affretement">AffrÃ¨tement</option>
          </select>
        </div>
        <div>
          <label for="deptSelect">DÃ©partement</label>
          <select id="deptSelect"><option value="">â€” Choisir un dÃ©partement â€”</option></select>
        </div>
        <div>
          <label id="thirdLabel" for="thirdSelect">Poids (kg)</label>
          <select id="thirdSelect" disabled><option value="">â€” Choisir â€”</option></select>
        </div>
      </div>

      <!-- ðŸŸ£ Message explicatif messagerie -->
      <div class="info-note">
        Le transport par <strong>messagerie</strong> sâ€™applique uniquement pour les colis et pour les palettes
        dâ€™une dimension maximale de <strong>120 Ã— 80 cm</strong>.
      </div>

      <div class="price-box">
        <div>
          <div class="muted" id="currentContext">SÃ©lection en attenteâ€¦</div>
          <div class="price" id="priceValue">â€”</div>
        </div>
        <div class="stack">
          <button id="addBtn" class="btn" disabled>âž• Ajouter au devis</button>
          <button id="resetBtn" class="btn btn-ghost">RÃ©initialiser</button>
        </div>
      </div>
    </section>
  </main>

  <div id="toast" class="toast">AjoutÃ© au devis ! Retournez Ã  lâ€™accueil pour le voir.</div>

  <script>
    const CSV_MESSAGERIE_URL  = "./data/transport_messagerie.csv";
    const CSV_AFFRETEMENT_URL = "./data/transport_affretement.csv";
    const fmtEUR = n => (Number(n||0)).toFixed(2).replace('.', ',') + " â‚¬";
    const stripBOM = s => s.replace(/^\uFEFF/, "");

    async function loadCSV(url){
      const res = await fetch(url, { cache: "no-store" });
      let text = await res.text(); text = stripBOM(text);
      const lines = text.split(/\r?\n/).filter(l => l.trim().length>0);
      const sep = (lines[0].match(/;/g)||[]).length > (lines[0].match(/,/g)||[]).length ? ";" : ",";
      const split = l => l.split(sep).map(c => c.replace(/^"(.*)"$/,'$1').trim());
      const headers = split(lines[0]).map(h => h.toLowerCase().replace(/\s+/g,'').replace('dÃ©partement','departement'));
      return lines.slice(1).map(l => {
        const c = split(l); const r={}; headers.forEach((h,i)=>r[h]=c[i]);
        return {
          departement: r.departement?.trim()||"",
          poids_kg:    r.poids_kg?.trim()||r["poids(kg)"]?.trim()||"",
          longueur_m:  r.longueur_m?.trim()||r["longueurpalette(m)"]?.trim()||"",
          prix_ht:     (r.prix_ht||r.prix||"0").replace(",",".")
        };
      });
    }

    const state={type:"messagerie",dept:"",third:"",mess:[],affr:[]};
    const $=id=>document.getElementById(id);
    const typeSelect=$("typeSelect"), deptSelect=$("deptSelect"), thirdSelect=$("thirdSelect"),
          thirdLabel=$("thirdLabel"), ctx=$("currentContext"), price=$("priceValue"),
          reset=$("resetBtn"), addBtn=$("addBtn"), toast=$("toast");

    function uniqueNums(arr){ return Array.from(new Set(arr.map(v=>parseFloat(v)||0))).filter(v=>v>0).sort((a,b)=>a-b); }
    const byDept = (rows, d) => rows.filter(r => r.departement===d);

    function renderDepartments(){
      const rows = state.type==="messagerie"?state.mess:state.affr;
      const depts = Array.from(new Set(rows.map(r=>r.departement))).sort((a,b)=>a.localeCompare(b));
      deptSelect.innerHTML = `<option value="">â€” Choisir un dÃ©partement â€”</option>` + depts.map(d=>`<option>${d}</option>`).join("");
      thirdSelect.innerHTML = `<option value="">â€” Choisir â€”</option>`; thirdSelect.disabled=true; addBtn.disabled=true;
      state.dept=""; state.third=""; renderPrice();
    }

    function renderThirdSelector(){
      const isMess = state.type==="messagerie";
      thirdLabel.textContent = isMess ? "Poids (kg)" : "Longueur palette (m)";
      thirdSelect.disabled = !state.dept;
      if(!state.dept){ thirdSelect.innerHTML=`<option value="">â€” Choisir â€”</option>`; addBtn.disabled=true; return; }
      const rowsDept = byDept(isMess?state.mess:state.affr, state.dept);
      const key = isMess ? "poids_kg" : "longueur_m";
      const opts = uniqueNums(rowsDept.map(r=>r[key]));
      thirdSelect.innerHTML = `<option value="">â€” Choisir â€”</option>` + opts.map(v=>`<option value="${v}">${v}</option>`).join("");
      state.third=""; addBtn.disabled=true; renderPrice();
    }

    function renderPrice(){
      if(!state.dept || !state.third){ ctx.textContent="SÃ©lection en attenteâ€¦"; price.textContent="â€”"; return; }
      const isMess = state.type==="messagerie";
      const rows = byDept(isMess?state.mess:state.affr, state.dept);
      const key = isMess ? "poids_kg" : "longueur_m";
      const found = rows.find(r => parseFloat(r[key])===parseFloat(state.third));
      if(!found){ ctx.textContent="Aucune ligne trouvÃ©e"; price.textContent="â€”"; addBtn.disabled=true; return; }
      ctx.textContent = `${isMess?"Messagerie":"AffrÃ¨tement"} â€¢ Dept ${state.dept} â€¢ ${isMess?"Poids":"Longueur"}: ${state.third}`;
      price.textContent = fmtEUR(found.prix_ht);
      addBtn.disabled = false;
    }

    function addToDevis(){
      const isMess = state.type==="messagerie";
      const label = isMess ? `Transport â€” Messagerie â€” Dept ${state.dept} â€” ${state.third} kg`
                           : `Transport â€” AffrÃ¨tement â€” Dept ${state.dept} â€” ${state.third} m`;
      const pu = Number(price.textContent.replace(/\s|â‚¬|,/g, m=> m===','?'.': ''));
      const payload = {
        id: 'tr_'+Date.now(),
        designation: label,
        quantite: 1,
        pu_net_ht: pu,
        type: 'transport',
        ts: Date.now()
      };
      try{
        localStorage.setItem('cofel_transport_add', JSON.stringify(payload));
        toast.classList.add('show');
        setTimeout(()=> toast.classList.remove('show'), 2500);
      }catch(e){ alert("Impossible dâ€™ajouter au devis (localStorage)."); console.error(e); }
    }

    typeSelect.onchange = ()=>{ state.type=typeSelect.value; renderDepartments(); };
    deptSelect.onchange = ()=>{ state.dept=deptSelect.value; renderThirdSelector(); };
    thirdSelect.onchange = ()=>{ state.third=thirdSelect.value; renderPrice(); };
    reset.onclick = ()=>{ typeSelect.value="messagerie"; state.type="messagerie"; renderDepartments(); };
    $("addBtn").onclick = addToDevis;

    (async()=>{
      state.mess = await loadCSV(CSV_MESSAGERIE_URL);
      state.affr = await loadCSV(CSV_AFFRETEMENT_URL);
      renderDepartments();
    })();
  </script>
</body>
</html>
