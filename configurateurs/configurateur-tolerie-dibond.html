<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Configurateur ‚Äî Lettres Bo√Ætiers | Cofel</title>

<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

<style>
  /* ===================== THEME (Cofel ‚Äì verre + violets harmonis√©s) ===================== */
  :root{
    --violet:#5a2d82;         /* d√©grad√© fond */
    --violet-2:#7838a7;       /* d√©grad√© fond */
    --glass: rgba(255,255,255,.08);  /* cartes & champs */
    --glass-hr: rgba(255,255,255,.14); /* contours */
    --txt:#f5f7ff;            /* texte principal */
    --txt-dim:#e6e6ff;        /* texte att√©nu√© */
    --accent:#c9b7ff;         /* labels & accents */
    --radius:18px; --blur:18px; --shadow:0 10px 30px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--txt);
    font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","Segoe UI",Roboto,Arial,sans-serif;
    background:
      radial-gradient(800px 500px at 20% -10%, rgba(255,255,255,.10), transparent 60%),
      radial-gradient(800px 500px at 110% 10%, rgba(255,255,255,.08), transparent 60%),
      linear-gradient(135deg, var(--violet), var(--violet-2));
  }

  /* ===================== HERO ===================== */
  .hero{position:relative;z-index:1;padding:40px 20px 24px;}
  .hero-inner{max-width:1200px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;gap:16px;}
  .brand{
    display:flex;align-items:center;gap:14px;
    backdrop-filter:blur(var(--blur));
    background:linear-gradient(180deg,rgba(255,255,255,.14),rgba(255,255,255,.06));
    border:1px solid rgba(255,255,255,.18);
    padding:10px 14px;border-radius:14px;box-shadow:var(--shadow);
  }
  .brand img{height:42px;width:auto;border-radius:10px}
  .brand h1{font-size:clamp(18px,2.6vw,22px);margin:0}
  .tagline{max-width:1200px;margin:18px auto 0;padding:0 20px;color:var(--txt-dim)}

  /* ===================== PANELS / CARDS ===================== */
  .wrap{max-width:1200px;margin:26px auto;padding:0 20px 40px;}
  .panel{
    background:linear-gradient(180deg,rgba(255,255,255,.16),rgba(255,255,255,.06));
    border:1px solid var(--glass-hr);
    border-radius:20px;padding:18px;box-shadow:var(--shadow);backdrop-filter:blur(var(--blur));
    margin-bottom:18px;
  }
  .panel h2{margin:0 0 12px;font-size:clamp(18px,2.4vw,22px);letter-spacing:.2px}
  .card{
    background:var(--glass);
    border:1px solid var(--glass-hr);
    border-radius:16px;padding:14px;box-shadow:var(--shadow);
    backdrop-filter:blur(var(--blur));
  }
  .grid{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
  .muted,.help{color:var(--txt-dim);font-size:12px;margin-top:6px;white-space:pre-wrap}

  footer{color:#f3ecff;font-size:12px;text-align:center;padding:24px 10px;opacity:.9;}

  /* ===================== FIELDS ===================== */
  label{font-weight:700;font-size:13px;color:var(--accent);} 
  input[type="number"]{
    width:100%; padding:10px 12px; margin-top:6px;
    border-radius:12px; outline:none; color:var(--txt);
    border:1px solid var(--glass-hr);
    background:linear-gradient(180deg,rgba(255,255,255,.14),rgba(255,255,255,.06));
    box-shadow:var(--shadow);
    transition:border-color .18s, box-shadow .18s;
    backdrop-filter:blur(var(--blur));
  }
  input[type="number"]:focus{
    border-color:rgba(255,255,255,.34);
    box-shadow:0 0 0 3px rgba(201,183,255,.25), var(--shadow);
  }

  /* ====== SELECT CUSTOM (verre harmonis√©) ====== */
  .native-select{ position:absolute !important; opacity:0 !important; pointer-events:none !important; width:0;height:0;margin:0;padding:0;border:0; }
  .cselect{ position:relative; margin-top:6px; }
  .cselect-toggle{
    width:100%; display:flex; align-items:center; justify-content:space-between; gap:12px;
    padding:10px 12px; color:var(--txt);
    border-radius:12px; cursor:pointer; user-select:none;
    border:1px solid var(--glass-hr);
    box-shadow: var(--shadow);
    background:linear-gradient(180deg,rgba(255,255,255,.14),rgba(255,255,255,.06));
    backdrop-filter:blur(var(--blur));
  }
  .cselect-toggle:hover{ filter:brightness(1.06); }
  .cselect-toggle:focus-visible{ outline:none; box-shadow: 0 0 0 3px rgba(201,183,255,.35); }
  .cselect-label{white-space:nowrap; overflow:hidden; text-overflow:ellipsis; flex:1}
  .cselect-caret{
    width:10px; height:10px; flex:0 0 auto; opacity:.9;
    background-image:
      linear-gradient(45deg, transparent 50%, var(--txt) 50%),
      linear-gradient(135deg, var(--txt) 50%, transparent 50%);
    background-size:6px 6px, 6px 6px;
    background-position:right top, right bottom;
    background-repeat:no-repeat;
    transform: translateY(1px);
  }
  .cselect[aria-expanded="true"] .cselect-caret{ transform: rotate(180deg); }

  /* Menu port√© dans <body> */
  .cselect-menu{
    position:fixed; left:0; top:0; width:260px; z-index:99999; max-height:280px; overflow:auto; padding:6px;
    border-radius:14px; border:1px solid var(--glass-hr);
    box-shadow: 0 16px 40px rgba(0,0,0,.45);
    background:linear-gradient(180deg,rgba(255,255,255,.14),rgba(255,255,255,.06));
    backdrop-filter:blur(var(--blur));
    display:none;
  }
  .cselect[aria-expanded="true"] .cselect-menu{ display:block; }
  .cselect-option{
    border-radius:10px; margin:4px 0; padding:10px 12px; cursor:pointer; color:var(--txt);
    border:1px solid var(--glass-hr);
    background: rgba(255,255,255,.10);
  }
  .cselect-option:hover, .cselect-option[aria-selected="true"]{
    background: rgba(255,255,255,.22);
    border-color: rgba(255,255,255,.28);
  }

  /* ===================== BADGES & NOTE ===================== */
  .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:rgba(255,255,255,.14);color:var(--txt);font-size:12px;border:1px solid var(--glass-hr);margin:6px 6px 0 0}
  .note{ margin-top:10px;background:#fff7e6;border:1px solid #ffd38a;border-radius:10px;padding:10px;font-size:13px;color:#5a430e;display:none }

  /* ===================== RESULT + BUTTONS ===================== */
  .result{
    text-align:center;padding:16px;
    background:linear-gradient(180deg,rgba(255,255,255,.14),rgba(255,255,255,.06));
    border:1px solid var(--glass-hr); border-radius:16px;
    box-shadow:0 8px 22px rgba(0,0,0,.28);
    font-size:18px; backdrop-filter:blur(var(--blur));
  }
  .result b{font-size:20px}
  .btn{
    appearance:none;border:none;cursor:pointer;font-weight:700;
    color:#0b0b0b;background:#fff;border-radius:12px;padding:10px 14px;
    box-shadow:0 10px 24px rgba(0,0,0,.25);
    transition:transform .16s, box-shadow .16s;
  }
  .btn:active{transform:translateY(1px);box-shadow:0 6px 16px rgba(0,0,0,.28);}
  .btn-ghost{background:transparent;color:var(--txt);border:1px solid var(--glass-hr);} 
</style>
</head>
<body>

<!-- ===================== HERO ===================== -->
<div class="hero">
  <div class="hero-inner">
    <div class="brand">
      <img src="../assets/logo cofel.jpg" alt="Cofel" />
      <h1>Configurateur ‚Äî Lettres Bo√Ætiers</h1>
    </div>
    <a class="brand" href="../index.html" style="text-decoration:none;color:inherit">‚¨Ö Retour accueil (devis)</a>
  </div>
  <div class="tagline">Choisissez la famille, la hauteur et l‚Äô√©clairage. Les montants s‚Äôactualisent automatiquement.</div>
</div>

<!-- ===================== CONTENU ===================== -->
<main class="wrap">
  <section class="panel">
    <h2>‚öôÔ∏è Param√®tres</h2>

    <div class="card grid">
      <div>
        <label for="famille">Type de lettre bo√Ætier</label>

        <!-- Select natif (masqu√©) -->
        <select id="famille" class="native-select"><option value="">‚Äî s√©lectionnez ‚Äî</option></select>

        <!-- Select custom -->
        <div class="cselect" data-bind="famille" aria-haspopup="listbox" aria-expanded="false">
          <button type="button" class="cselect-toggle">
            <span class="cselect-label">‚Äî s√©lectionnez ‚Äî</span>
            <span class="cselect-caret" aria-hidden="true"></span>
          </button>
          <div class="cselect-menu" role="listbox"></div>
        </div>
      </div>

      <div>
        <label for="quantite">Quantit√©</label>
        <input type="number" id="quantite" value="1" min="1"/>
      </div>
    </div>

    <div class="card grid">
      <div>
        <label for="hauteur">Hauteur (mm)</label>
        <input type="number" id="hauteur" placeholder="Ex : 325" min="1"/>
        <div id="rangesHelp" class="help"></div>
      </div>
      <div>
        <label for="variant">√âclairage (si pr√©sent)</label>

        <!-- Select natif (masqu√©) -->
        <select id="variant" class="native-select"><option value="">‚Äî (aucun filtre) ‚Äî</option></select>

        <!-- Select custom -->
        <div class="cselect" data-bind="variant" aria-haspopup="listbox" aria-expanded="false">
          <button type="button" class="cselect-toggle">
            <span class="cselect-label">‚Äî (aucun filtre) ‚Äî</span>
            <span class="cselect-caret" aria-hidden="true"></span>
          </button>
          <div class="cselect-menu" role="listbox"></div>
        </div>

        <div class="help" id="variantHelp"></div>
        <div id="dibondRule" class="note">Pour les <b>faces Dibond</b> : si un √©clairage est choisi, alors <b>r√©tro√©clairage</b> </div>
      </div>
    </div>
  </section>

  <section class="panel">
    <h2>üßæ R√©capitulatif</h2>
    <div class="result">
      <p>Prix HT : <b><span id="prixHT">0,00</span> ‚Ç¨</b></p>
      <p>Prix TTC : <b><span id="prixTTC">0,00</span> ‚Ç¨</b></p>
      <div class="muted">TVA 20 % incluse dans le calcul.</div>
    </div>

    <div style="margin-top:16px;display:flex;gap:10px;flex-wrap:wrap;">
      <button id="btnAddDevis" class="btn">‚ûï Ajouter au devis</button>
      <button id="btnReset" class="btn btn-ghost">üîÑ R√©initialiser</button>
    </div>
  </section>
</main>

<footer>
  ¬© Cofel ‚Äî ZA du Perquoi, 72560 Chang√© ‚Äî SIRET 927 659 458 00024 ‚Äî TVA FR80927659458
</footer>

<script>
/* ======================= CONFIG ======================= */
const TVA = 0.20;
const UPLIFT_PUBLIC = 2.0; // multiplicateur interne (non montr√©)

const FAMILLES = [
  { name: "Bo√Ætier B√¢ton ‚Äì face PMMA blanc diffusant",
    url: "https://raw.githubusercontent.com/stevens-cofel/configurateur-cofel/refs/heads/main/lettres/lettre%20boitier%20baton%20chants%20alu%20laqu%C3%A9%20et%20face%20PMMA%20blanc%20diffusant.csv" },
  { name: "Bo√Ætier B√¢ton ‚Äì face Dibond",
    url: "https://raw.githubusercontent.com/stevens-cofel/configurateur-cofel/refs/heads/main/lettres/Lettre%20boitier%20laqu%C3%A9e%20B%C3%A2ton%20chants%20aluminium%20et%20face%20avant%20type%20Dibond.csv" },
  { name: "Bo√Ætier Fantaisie ‚Äì face Dibond",
    url: "https://raw.githubusercontent.com/stevens-cofel/configurateur-cofel/refs/heads/main/lettres/Lettre%20boitier%20laqu%C3%A9e%20Fantaisie%20chants%20aluminium%20et%20face%20avant%20type%20Dibond.csv" },
  { name: "Bo√Ætier Fantaisie ‚Äì face PMMA blanc diffusant",
    url: "https://raw.githubusercontent.com/stevens-cofel/configurateur-cofel/refs/heads/main/lettres/Lettre%20boitier%20Fantaisie%20chants%20laqu%C3%A9s%20et%20faces%20PMMA%20blanc%20diffusant.csv" }
];

/* ======================= STATE & ELEMENTS ======================= */
let CURRENT=null, HEADS=[], ROWS=[], MAP=null; // MAP: {hminKey,hmaxKey,baseKey,variantKey}
const $=id=>document.getElementById(id);
const elFam=$("famille"), elQ=$("quantite"), elH=$("hauteur");
const elVar=$("variant"), elVarHelp=$("variantHelp");
const elRanges=$("rangesHelp"), elHT=$("prixHT"), elTTC=$("prixTTC");
const elDibondRule=$("dibondRule");

/* ======================= UTILS ======================= */
function normKey(k){return String(k||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9]+/g,'').trim();}
function numFR(v){
  if(v==null) return NaN;
  let s = String(v).trim().replace(/‚Ç¨/g,'').replace(/[\u00A0\u202F]/g,'').replace(/\s+/g,'');
  if (s.includes(',') && s.includes('.')) s = s.replace(/\./g,'');
  s = s.replace(',','.');
  const m=s.match(/-?\d+(\.\d+)?/);
  return m ? parseFloat(m[0]) : NaN;
}
function euro(n){return (isFinite(n)?n:0).toFixed(2).replace('.',',');}

/* ======= Custom select (build/sync/portal) ======= */
const customSelects=new Map();
function buildCustomFromNative(native){
  const wrap=document.querySelector('.cselect[data-bind="'+native.id+'"]'); if(!wrap) return;
  const toggle=wrap.querySelector('.cselect-toggle');
  const label=wrap.querySelector('.cselect-label');
  const menu=wrap.querySelector('.cselect-menu');
  menu.innerHTML='';
  Array.from(native.options).forEach(opt=>{
    const d=document.createElement('div');
    d.className='cselect-option'; d.setAttribute('role','option'); d.tabIndex=-1;
    d.dataset.value=opt.value; d.textContent=opt.textContent;
    if(opt.selected) d.setAttribute('aria-selected','true');
    d.addEventListener('click',()=>{ setNativeValue(native,opt.value); closeMenu(native.id); });
    d.addEventListener('keydown',e=>{ if(e.key==='Enter'||e.key===' '){e.preventDefault(); setNativeValue(native,opt.value); closeMenu(native.id);} });
    menu.appendChild(d);
  });
  label.textContent = (native.selectedOptions[0]||native.options[0])?.textContent || '';
  toggle.onclick=()=>{ const exp=wrap.getAttribute('aria-expanded')==='true'; exp?closeMenu(native.id):openMenu(native.id); };
  toggle.onkeydown=(e)=>{
    const exp=wrap.getAttribute('aria-expanded')==='true';
    if((e.key==='ArrowDown'||e.key==='ArrowUp')&&!exp){e.preventDefault();openMenu(native.id);(menu.querySelector('.cselect-option')||{}).focus?.();}
    else if(e.key==='Enter'||e.key===' '){e.preventDefault();toggle.click();}
    else if(e.key==='Escape'&&exp){closeMenu(native.id);} };
  customSelects.set(native.id,{wrap,toggle,labelSpan:label,menu,native});
}
function setNativeValue(native,val){
  if(native.value!==val){ native.value=val; native.dispatchEvent(new Event('change',{bubbles:true})); }
  const api=customSelects.get(native.id);
  if(api){
    api.labelSpan.textContent = native.selectedOptions[0]?.textContent || '';
    Array.from(api.menu.children).forEach(n=>n.classList.contains('cselect-option')&&n.setAttribute('aria-selected',n.dataset.value===val?'true':'false'));
  }
}
function openMenu(id){
  const api=customSelects.get(id); if(!api) return;
  const {wrap,toggle,menu}=api;
  wrap.setAttribute('aria-expanded','true');
  const r=toggle.getBoundingClientRect();
  menu.style.left=Math.round(r.left)+'px';
  menu.style.top =Math.round(r.bottom+6)+'px';
  menu.style.width=Math.round(r.width)+'px';
  if(menu.parentElement!==document.body) document.body.appendChild(menu);
  menu.style.display='block';
  const onViewport=()=>closeMenu(id);
  const onDocClick=(e)=>{ if(!wrap.contains(e.target)&&!menu.contains(e.target)) closeMenu(id); };
  window.addEventListener('scroll',onViewport,{passive:true});
  window.addEventListener('resize',onViewport);
  document.addEventListener('click',onDocClick);
  api.__off=()=>{window.removeEventListener('scroll',onViewport);window.removeEventListener('resize',onViewport);document.removeEventListener('click',onDocClick);};
}
function closeMenu(id){
  const api=customSelects.get(id); if(!api) return;
  const {wrap,menu,__off}=api;
  wrap.setAttribute('aria-expanded','false');
  menu.style.display='none';
  if(menu.parentElement!==wrap) wrap.appendChild(menu);
  if(typeof __off==='function') __off();
  api.toggle.focus();
}

/* ======================= CSV & MAPPING ======================= */
function parseCSVLine(line,sep=','){
  const out=[]; let cur='', inQ=false;
  for(let i=0;i<line.length;i++){
    const ch=line[i], nx=line[i+1];
    if(ch==='"'){
      if(inQ && nx==='"'){ cur+='"'; i++; } else inQ=!inQ;
    }else if(ch===sep && !inQ){ out.push(cur); cur=''; }
    else cur+=ch;
  }
  out.push(cur); return out;
}
function normalizeWeirdCSV(text){
  let t=text.replace(/^\uFEFF/,'').replace(/\r/g,'');
  const manyQuotes=(t.match(/"/g)||[]).length>50, fewNewlines=(t.match(/\n/g)||[]).length<3;
  if(manyQuotes&&fewNewlines){
    t=t.replace(/""/g,'"'); const blocks=[],re=/"([^"]*)"/g; let m; while((m=re.exec(t))!==null) blocks.push(m[1]);
    if(!blocks.length) return text;
    const cols=parseCSVLine(blocks[0],',').length, lines=[];
    for(let i=0;i<blocks.length;i+=cols) lines.push(blocks.slice(i,i+cols).map(s=>'"'+s+'"').join(','));
    return lines.join('\n');
  }
  return t.split('\n').map(l=>{const s=l.trim();return (s.startsWith('"')&&s.endsWith('"'))?s.slice(1,-1):s;}).join('\n');
}
function parseCSVAuto(text){
  const norm=normalizeWeirdCSV(text);
  const lines=norm.split('\n').filter(l=>l.trim()!=='');
  if(!lines.length) return {rawHeads:[],rows:[]};
  const first=lines[0];
  const sep=((first.match(/;/g)||[]).length>(first.match(/,/g)||[]).length)?';':',';
  const rawHeads=parseCSVLine(lines[0],sep).map(s=>s.replace(/^"+|"+$/g,'').trim());
  const rows=lines.slice(1).map(line=>{
    const cells=parseCSVLine(line,sep).map(s=>s.replace(/^"+|"+$/g,'').trim());
    const o={}; rawHeads.forEach((h,i)=>o[h]=cells[i]??''); return o;
  });
  return {rawHeads,rows};
}
function buildMapping(rawHeads){
  const NK=rawHeads.map(normKey);
  const find=(k)=>{const i=NK.indexOf(k);return i>=0?rawHeads[i]:null;};
  const loose=(...res)=>{for(let i=0;i<NK.length;i++){const k=NK[i];if(res.every(r=>r.test(k))) return rawHeads[i];}return null;};
  const hminKey=find('hauteurminmm')||loose(/hauteur/,/min/);
  const hmaxKey=find('hauteurmaxmm')||loose(/hauteur/,/max/);
  const baseKey=find('prixunitaireeur')||loose(/prix|tarif/,/eur|ht|unitaire/);
  const variantKey=find('eclairage')||loose(/eclair|led/);
  return {hminKey,hmaxKey,baseKey,variantKey};
}

/* ======================= UI BUILDERS ======================= */
function fillFamilles(){
  elFam.innerHTML = '<option value="">‚Äî s√©lectionnez ‚Äî</option>' + FAMILLES.map((f,i)=>`<option value="${i}">${f.name}</option>`).join('');
  buildCustomFromNative(elFam);
}
function buildVariantUI(){
  elVar.innerHTML = '<option value="">‚Äî (aucun filtre) ‚Äî</option>';
  elVarHelp.textContent = '';
  if(!MAP?.variantKey){ buildCustomFromNative(elVar); return; }
  const key=MAP.variantKey;
  const values=[...new Set(ROWS.map(r=>String(r[key]||'').trim()).filter(Boolean))].sort();
  elVar.innerHTML = values.length
    ? '<option value="">‚Äî s√©lectionnez ‚Äî</option>' + values.map(v=>`<option value="${v}">${v}</option>`).join('')
    : '<option value="">‚Äî (aucun filtre) ‚Äî</option>';
  elVarHelp.textContent = values.length ? `Filtre sur ¬´ ${key} ¬ª.` : '';
  buildCustomFromNative(elVar);
}
/* Affiche juste "Hauteur maximale X mm" en respectant le filtre d‚Äô√©clairage */
function buildRangesHelp(){
  if(!MAP?.hmaxKey){ elRanges.innerHTML=''; return; }
  const kmax = MAP.hmaxKey;
  const rows = filterRowsByVariant(ROWS);
  const maxVals = rows.map(r => numFR(r[kmax])).filter(Number.isFinite);
  if(!maxVals.length){ elRanges.innerHTML=''; return; }
  const maxH = Math.max(...maxVals);
  elRanges.innerHTML = `Hauteur maximale ${Math.round(maxH)} mm`;
}

/* ======================= RULE ======================= */
function updateDibondRule(){
  const isDibond = (CURRENT?.name||'').toLowerCase().includes('dibond');
  const hasLighting = !!elVar.value;
  elDibondRule.style.display = (isDibond && hasLighting) ? 'block' : 'none';
}

/* ======================= COMPUTE ======================= */
function filterRowsByVariant(rows){
  if(!MAP?.variantKey) return rows;
  const v=elVar.value; if(!v) return rows;
  return rows.filter(r=>String(r[MAP.variantKey]||'').trim()===v);
}

function findRowForHeight(H){
  const kmin=MAP.hminKey, kmax=MAP.hmaxKey;
  let rows=filterRowsByVariant(ROWS);
  if(!rows.length) return null;

  rows = rows.slice().map(r=>{
    const a = numFR(kmin ? r[kmin] : 0);
    const b = numFR(r[kmax]);
    return { ...r, __a:a, __b:b };
  }).filter(r => Number.isFinite(r.__b))
    .sort((a,b)=> a.__a!==b.__a ? a.__a - b.__a : a.__b - b.__b);

  const exact = rows.find(r => Number.isFinite(r.__a) && Number.isFinite(r.__b) && H>=r.__a && H<=r.__b);
  if (exact) return exact;

  let best=null, bestDist=Infinity;
  for(const r of rows){
    const d = (H < r.__a) ? (r.__a - H) : (H - r.__b);
    if (d < bestDist || (d === bestDist && r.__a > (best?.__a ?? -Infinity))){
      best = r; bestDist = d;
    }
  }
  return best || rows[0];
}

function compute(){
  // === Remise automatique client ===
  let remiseClient = 1;
  try {
      const p = JSON.parse(localStorage.getItem('cofel_client_profile'));
      if (p && typeof p.discountRate === 'number') remiseClient = 1 - p.discountRate;
  } catch(e){}

  const H=Number(elH.value||0), Q=Math.max(1,Number(elQ.value||1));

  if (MAP?.variantKey && !elVar.value){
    elHT.textContent='0,00'; elTTC.textContent='0,00'; updateDibondRule(); return;
  }

  if(!(H>0)||!ROWS.length||!MAP?.hmaxKey||!MAP?.baseKey){
    elHT.textContent='0,00'; elTTC.textContent='0,00'; updateDibondRule(); return;
  }
  const row=findRowForHeight(H);
  const base_interne=row? numFR(row[MAP.baseKey]) : 0;
  const unit_public=(base_interne||0)*UPLIFT_PUBLIC*remiseClient;
  const totalHT=unit_public*Q, totalTTC=totalHT*(1+TVA);
  elHT.textContent=euro(totalHT); elTTC.textContent=euro(totalTTC);
  updateDibondRule();
}

/* ======================= LOADERS ======================= */
async function fetchText(u){ const r=await fetch(u,{cache:'no-store'}); if(!r.ok) throw new Error('HTTP '+r.status); return await r.text(); }
async function loadFamily(f){
  const txt=await fetchText(f.url);
  const {rawHeads,rows}=parseCSVAuto(txt);
  HEADS=rawHeads; ROWS=rows; MAP=buildMapping(HEADS);
  buildVariantUI(); buildRangesHelp(); compute();
}

/* ======================= INIT ======================= */
function bind(){
  elFam.addEventListener('change', async ()=>{
    const i=parseInt(elFam.value,10);
    if(isNaN(i)){ CURRENT=null; ROWS=[]; MAP=null; compute(); return; }
    CURRENT=FAMILLES[i];
    try{ await loadFamily(CURRENT); }catch(e){ console.error(e); alert("Erreur de chargement des donn√©es."); }
  });
  elQ.addEventListener('input', compute);
  elH.addEventListener('input', ()=>{ buildRangesHelp(); compute(); });
  elVar.addEventListener('change', ()=>{ buildRangesHelp(); updateDibondRule(); compute(); });
  $("btnReset").addEventListener('click', ()=>{
    elFam.value=""; buildCustomFromNative(elFam);
    CURRENT=null; ROWS=[]; MAP=null;
    elVar.innerHTML='<option value="">‚Äî (aucun filtre) ‚Äî</option>'; buildCustomFromNative(elVar);
    elQ.value=1; elH.value='';
    elRanges.innerHTML = '';
    compute();
  });
}
(function init(){ fillFamilles(); bind(); })();
</script>

<!-- ========= Int√©gration au devis ========= -->
<script src="../js/devis-core.js"></script>
<script>
document.getElementById("btnAddDevis").addEventListener("click", ()=>{
  try{
    if(!window.Devis) throw new Error("Moteur de devis introuvable.");
    const famIdx=parseInt(document.getElementById("famille").value,10);
    if(isNaN(famIdx)){ alert("Choisis d'abord une famille de lettres bo√Ætiers."); return; }
    const familleName=(FAMILLES[famIdx]||{}).name||"Lettres bo√Ætiers";
    const qte=Math.max(1, Number(document.getElementById("quantite").value||1));
    const H=Number(document.getElementById("hauteur").value||0);
    if(!(H>0)){ alert("Saisis une hauteur valide."); return; }
    const variant=document.getElementById("variant").value;

    const total_ht=parseFloat(document.getElementById("prixHT").innerText.replace(',','.'))||0;
    if(total_ht<=0){ alert("Le prix est √† 0, v√©rifie la famille/hauteur/√©clairage."); return; }
    const pu_public_ht = qte>0 ? (total_ht/qte) : 0;

    const designation = `${familleName} ‚Äî H ${H} mm` + (variant?` ‚Äî √âclairage: ${variant}`:'');
    Devis.addLine({ type:'Lettres Bo√Ætiers', designation, quantite:qte, pu_public_ht:Number(pu_public_ht.toFixed(2)) });

    alert(`‚úÖ Ligne ajout√©e au devis !\n${designation}\nQt√© : ${qte}\nPU HT : ${pu_public_ht.toFixed(2)} ‚Ç¨`);
  }catch(err){ console.error(err); alert('Erreur lors de l‚Äôajout au devis : '+err.message); }
});
</script>

</body>
</html>
