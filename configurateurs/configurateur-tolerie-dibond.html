<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Configurateur – Tôlerie sur mesure & panneau Alu/PVC (type Dibond)</title>

<!-- Styles communs si présents -->
<link rel="stylesheet" href="../styles/cofel.css" />
<link rel="stylesheet" href="../styles/cofel-config.css" />

<style>
  /* ====== DA Cofel : verre violet harmonisée ====== */
  :root{
    --violet:#5a2d82;
    --violet-2:#7838a7;
    --glass: rgba(255,255,255,.08);
    --glass-hr: rgba(255,255,255,.14);
    --txt:#f5f7ff;
    --txt-dim:#e6e6ff;
    --accent:#c9b7ff;
    --radius:18px;
    --blur:18px;
    --shadow: 0 10px 30px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--txt);
    font-family:-apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, Arial, sans-serif;
    background:
      radial-gradient(800px 500px at 20% -10%, rgba(255,255,255,.10), transparent 60%),
      radial-gradient(800px 500px at 110% 10%, rgba(255,255,255,.08), transparent 60%),
      linear-gradient(135deg, var(--violet), var(--violet-2));
  }

  /* Header “verre” */
  .cofel-header{
    position:sticky; top:0; z-index:1000; color:#fff;
    background: linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.06));
    border-bottom:1px solid rgba(255,255,255,.18);
    backdrop-filter: blur(var(--blur));
  }
  .cofel-header .row{
    max-width:1200px; margin:0 auto; display:flex; align-items:center; gap:16px; padding:10px 14px;
  }
  .cofel-back{
    color:#fff; text-decoration:none; border:1px solid rgba(255,255,255,.35);
    padding:8px 12px; border-radius:12px; backdrop-filter: blur(10px);
  }
  .cofel-brand{display:flex; align-items:center; gap:10px}
  .cofel-brand img{height:36px; border-radius:8px; object-fit:cover}
  .cofel-title{font-size:18px; margin:0}

  .cofel-container{max-width:1100px; margin:0 auto; padding:18px}

  h1{margin:8px 0 14px; text-align:center; letter-spacing:.2px}

  /* Fieldsets “verre” */
  fieldset{
    border:1px solid rgba(255,255,255,.2);
    border-radius:20px; padding:16px; margin:16px 0;
    background: linear-gradient(180deg, rgba(255,255,255,.16), rgba(255,255,255,.06));
    box-shadow: var(--shadow); backdrop-filter: blur(var(--blur));
    overflow:visible;
    position:relative; z-index:1;
  }
  legend{padding:0 10px; font-weight:800; color:#fff; letter-spacing:.2px}

  label{font-weight:700; font-size:13px; color:var(--accent); display:block; margin-top:10px}

  input[type="number"],
  input[type="text"],
  select{
    width:100%; margin-top:6px; padding:12px 12px; min-height:42px;
    background: rgba(255,255,255,.10); color:var(--txt);
    border:1px solid rgba(255,255,255,.24); border-radius:14px; outline:none;
    transition: border-color .18s ease, background .18s ease, box-shadow .18s ease;
    position:relative; z-index:2;
  }
  input::placeholder{color:#f0edff; opacity:.75}
  input:disabled{opacity:.9}

  input:focus, select:focus{
    border-color: rgba(255,255,255,.38);
    background: rgba(255,255,255,.16);
    box-shadow: 0 0 0 4px rgba(255,255,255,.08) inset;
  }

  /* Select harmonisé (options sur fond violet foncé) */
  select{appearance:auto}
  select option{background:#3c1f61; color:#fff}
  select:focus{z-index:1001}

  .grid{display:grid; gap:16px}
  @media(min-width:820px){ .grid{grid-template-columns:1fr 1fr} }

  .radio-row{display:flex; gap:10px; flex-wrap:wrap; margin-top:8px}
  .radio-row label,
  .pill{
    display:flex; align-items:center; gap:10px; cursor:pointer;
    padding:10px 14px; border-radius:14px;
    background: linear-gradient(180deg, rgba(255,255,255,.18), rgba(255,255,255,.08));
    border:1px solid rgba(255,255,255,.24); color:#fff; font-weight:700;
    box-shadow: var(--shadow);
  }
  .radio-row input[type="radio"],
  .radio-row input[type="checkbox"]{ accent-color:#cbb3ff; width:18px; height:18px }

  .note{
    margin-top:8px; background:rgba(255,255,255,.08);
    border:1px solid rgba(255,255,255,.22); border-radius:12px; padding:10px; color:#fff; font-size:13px;
  }

  .result{
    background: linear-gradient(180deg, rgba(255,255,255,.16), rgba(255,255,255,.06));
    border:1px solid rgba(255,255,255,.24);
    border-radius:20px; padding:16px; margin-top:18px; text-align:center; font-size:18px;
    box-shadow: var(--shadow); backdrop-filter: blur(var(--blur));
  }
  .result span{ font-weight:800; }

  /* Bouton “Ajouter au devis” */
  #btnAddDevis{
    position:fixed; right:20px; bottom:20px; padding:12px 18px;
    background:#fff; color:#0b0b0b; border:none; border-radius:14px;
    box-shadow:0 10px 24px rgba(0,0,0,.25); cursor:pointer; font-weight:800; z-index:2000;
    transition: transform .16s ease, box-shadow .16s ease, opacity .16s ease;
  }
  #btnAddDevis:active{ transform: translateY(1px); box-shadow: 0 6px 16px rgba(0,0,0,.28); }

  .cofel-footer{
    color:#f3ecff; font-size:12px; text-align:center; padding:24px 10px; opacity:.9;
  }
</style>
</head>
<body>

<!-- Bandeau violet / retour -->
<header class="cofel-header">
  <div class="row">
    <a class="cofel-back" href="../index.html">⬅ Retour accueil (devis)</a>
    <div class="cofel-brand">
      <img src="../assets/logo cofel.jpg" alt="Cofel" />
      <h1 class="cofel-title">Configurateur — Tôlerie & Dibond</h1>
    </div>
  </div>
</header>

<div class="cofel-container">
  <h1>Tôlerie sur mesure & panneau Alu/PVC (type Dibond)</h1>

  <fieldset>
    <div class="grid">
      <div>
        <label for="famille">Famille</label>
        <select id="famille">
          <option value="alu" selected>Aluminium</option>
          <option value="dibond">Alu/PVC 3 mm (type Dibond)</option>
        </select>
      </div>
      <div>
        <label for="quantite">Quantité</label>
        <input type="number" id="quantite" min="1" value="1" />
      </div>
    </div>
  </fieldset>

  <!-- Aluminium -->
  <fieldset id="blockAlu">
    <legend>Matière – Aluminium</legend>

    <fieldset>
      <legend>Aluminium 15/10ᵉ</legend>
      <div class="radio-row">
        <label><input type="radio" name="matAlu" value="alu15_brut"> Brut</label>
        <label><input type="radio" name="matAlu" value="alu15_pre" checked> Prélaqué</label>
        <label><input type="radio" name="matAlu" value="alu15_laq"> Laqué</label>
      </div>
    </fieldset>

    <fieldset>
      <legend>Aluminium 20/10ᵉ</legend>
      <div class="radio-row">
        <label><input type="radio" name="matAlu" value="alu20_brut"> Brut</label>
        <label><input type="radio" name="matAlu" value="alu20_pre"> Prélaqué</label>
        <label><input type="radio" name="matAlu" value="alu20_laq"> Laqué</label>
      </div>
    </fieldset>

    <div class="note">⚠️ Prendre en compte le <b>développé de la tôle</b> avec plis lors de la saisie des dimensions.</div>
  </fieldset>

  <!-- Dibond -->
  <fieldset id="blockDibond" style="display:none">
    <legend>Matière – Alu/PVC 3 mm (type Dibond)</legend>
    <div class="radio-row">
      <label><input type="radio" name="matDibond" value="dibond_pre" checked> Prélaqué</label>
      <label><input type="radio" name="matDibond" value="dibond_laq"> Laqué</label>
    </div>
    <div class="note">ℹ️ <b>Pas de pli</b> sur l’alu/PVC type Dibond.</div>
  </fieldset>

  <!-- Dimensions -->
  <fieldset>
    <legend>Dimensions</legend>
    <div class="grid">
      <div>
        <label for="largeur">Largeur (mm)</label>
        <input type="number" id="largeur" min="1" placeholder="Ex : 1200" />
      </div>
      <div>
        <label for="hauteur">Hauteur (mm)</label>
        <input type="number" id="hauteur" min="1" placeholder="Ex : 600" />
      </div>
    </div>
    <div class="grid">
      <div>
        <label>Surface (calculée)</label>
        <input id="surface" value="0,000 m²" disabled />
      </div>
      <div></div>
    </div>
  </fieldset>

  <!-- Résultats -->
  <div class="result">
    <p>Total HT : <span id="prixHT">0,00</span> €</p>
    <p>Total TTC (TVA 20%) : <span id="prixTTC">0,00</span> €</p>
  </div>
</div>

<!-- Pied de page -->
<footer class="cofel-footer">
  © Cofel — ZA du Perquoi, 72560 Changé — SIRET 927 659 458 00024 — TVA FR80927659458
</footer>

<script>
/*** CONFIG ***/
const TVA = 0.20;
const PRICE = {
  // Aluminium 15/10e (tarifs internes au m²)
  alu15_brut: 61.00,
  alu15_pre:  82.00,
  alu15_laq:  94.00,
  // Aluminium 20/10e
  alu20_brut: 72.00,
  alu20_pre:  89.00,
  alu20_laq: 105.00,
  // Dibond (alu/pvc 3 mm)
  dibond_pre: 50.00,
  dibond_laq: 71.00
};
// Affichage PUBLIC = x2 (aucune mention côté client)
const UPLIFT_PUBLIC = 2.0;

/*** DOM ***/
const $ = id => document.getElementById(id);
const elFamille = $('famille');
const elBlockAlu = $('blockAlu');
const elBlockDibond = $('blockDibond');
const elQ = $('quantite');
const elL = $('largeur');
const elH = $('hauteur');
const elSurf = $('surface');
const elHT = $('prixHT');
const elTTC = $('prixTTC');

/*** UTILS ***/
function euro(n){ return (isFinite(n)?n:0).toFixed(2).replace('.', ','); }
function areaM2(Lmm,Hmm){ return (Math.max(0,Number(Lmm||0))*Math.max(0,Number(Hmm||0)))/1e6; }
function selectedMaterialKey(){
  if(elFamille.value==='alu'){
    const r = document.querySelector('input[name="matAlu"]:checked');
    return r ? r.value : 'alu15_pre';
  }else{
    const r = document.querySelector('input[name="matDibond"]:checked');
    return r ? r.value : 'dibond_pre';
  }
}

/*** DISPLAY TOGGLES ***/
function toggleBlocks(){
  const isAlu = elFamille.value==='alu';
  elBlockAlu.style.display   = isAlu ? '' : 'none';
  elBlockDibond.style.display= isAlu ? 'none' : '';
}

/*** CALCUL ***/
function compute(){
  const key = selectedMaterialKey();
  const prixM2_interne = PRICE[key] || 0;
  const A = areaM2(elL.value, elH.value);
  const unitHT_interne = prixM2_interne * A;

  // Conversion → affichage PUBLIC (x2)
  const unitHT_public = unitHT_interne * UPLIFT_PUBLIC;
  const Q = Math.max(1, Number(elQ.value||1));
  const totalHT_public = unitHT_public * Q;
  const totalTTC_public = totalHT_public * (1 + TVA);

  elSurf.value   = `${A.toFixed(3).replace('.', ',')} m²`;
  elHT.textContent  = euro(totalHT_public);
  elTTC.textContent = euro(totalTTC_public);
}

/*** EVENTS ***/
['input','change'].forEach(evt=>{
  [famille, quantite, largeur, hauteur,
   ...document.querySelectorAll('input[name="matAlu"]'),
   ...document.querySelectorAll('input[name="matDibond"]')
  ].forEach(el=> el.addEventListener(evt, ()=>{ toggleBlocks(); compute(); }));
});

/*** INIT ***/
toggleBlocks();
compute();
</script>

<!-- ===== Intégration Devis ===== -->
<script src="../js/devis-core.js"></script>

<button id="btnAddDevis">➕ Ajouter au devis</button>

<script>
(function(){
  const btn = document.getElementById('btnAddDevis');
  if(!btn) return;

  function parseTotalHTPublic(){
    const txt = document.getElementById('prixHT').innerText.trim(); // "1 234,56"
    return Number(txt.replace(/\s/g,'').replace(',', '.')) || 0;
  }

  function currentMaterialLabel(){
    const fam = document.getElementById('famille').value;
    if (fam === 'alu') {
      const r = document.querySelector('input[name="matAlu"]:checked');
      if(!r) return 'Aluminium';
      if (r.value.startsWith('alu15')) return 'Aluminium 15/10';
      if (r.value.startsWith('alu20')) return 'Aluminium 20/10';
      return 'Aluminium';
    } else {
      return 'Alu/PVC 3 mm (type Dibond)';
    }
  }

  function currentFinishLabel(){
    const fam = document.getElementById('famille').value;
    if (fam === 'alu') {
      const r = document.querySelector('input[name="matAlu"]:checked');
      if(!r) return '';
      if (/brut/.test(r.value)) return 'brut';
      if (/pre/.test(r.value))  return 'prélaqué';
      if (/laq/.test(r.value))  return 'laqué';
      return '';
    } else {
      const r = document.querySelector('input[name="matDibond"]:checked');
      if(!r) return '';
      if (/pre/.test(r.value))  return 'prélaqué';
      if (/laq/.test(r.value))  return 'laqué';
      return '';
    }
  }

  btn.addEventListener('click', () => {
    try{
      if(!window.Devis) throw new Error("Moteur de devis introuvable.");

      const qte = Math.max(1, Number(document.getElementById('quantite').value || 1));
      const Lmm = Math.max(0, Number(document.getElementById('largeur').value || 0));
      const Hmm = Math.max(0, Number(document.getElementById('hauteur').value || 0));
      if(!(Lmm>0) || !(Hmm>0)){ alert("Renseigne largeur et hauteur."); return; }

      const surface = (Math.max(0, Number(Lmm))*Math.max(0, Number(Hmm)))/1e6;
      const matLabel = currentMaterialLabel();
      const finLabel = currentFinishLabel();

      // Total & PU PUBLIC (l'affichage est déjà en public x2)
      const total_ht_public = parseTotalHTPublic();
      if (total_ht_public <= 0){ alert("Le prix est à 0, vérifie les paramètres."); return; }
      const pu_public_ht = qte>0 ? (total_ht_public / qte) : 0;

      const designation = [
        'Tôlerie / Panneau',
        matLabel + (finLabel ? ' ' + finLabel : ''),
        `L ${Lmm} × H ${Hmm} mm`,
        `Surface ${surface.toFixed(3)} m²`
      ].join(' — ');

      Devis.addLine({
        type: 'Tôlerie & Dibond',
        designation,
        quantite: qte,
        pu_public_ht: Number(pu_public_ht.toFixed(2))
      });

      alert(`✅ Ligne ajoutée au devis !\n${designation}\nQté : ${qte}\nPU HT : ${pu_public_ht.toFixed(2)} €`);
    }catch(err){
      console.error(err);
      alert('Erreur lors de l’ajout au devis : ' + err.message);
    }
  });
})();
</script>

</body>
</html>

