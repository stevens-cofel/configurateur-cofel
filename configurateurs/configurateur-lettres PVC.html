<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Configurateur ‚Äî Lettres PVC | Cofel</title>

<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin">

<style>
  /* ===================== THEME (Cofel ‚Äì verre + violets) ===================== */
  :root{
    --cofel:#5a2d82; --cofel-2:#7838a7;
    --violet:#6b39a0; --violet-2:#8752c1;
    --violet-ui:#bda3ff;           /* violet clair des cartes/inputs */
    --violet-ui-pressed:#a88fff;
    --txt:#f5f7ff; --txt-dim:#e6e6ff; --accent:#c9b7ff;
    --radius:18px; --blur:18px; --shadow:0 10px 30px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--txt);
    font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","Segoe UI",Roboto,Arial,sans-serif;
    background:
      radial-gradient(800px 500px at 20% -10%, rgba(255,255,255,.10), transparent 60%),
      radial-gradient(800px 500px at 110% 10%, rgba(255,255,255,.08), transparent 60%),
      linear-gradient(135deg, var(--cofel), var(--cofel-2));
  }

  /* ===================== HERO ===================== */
  .hero{position:relative;z-index:1;padding:40px 20px 24px;}
  .hero-inner{max-width:1200px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;gap:16px;}
  .brand{
    display:flex;align-items:center;gap:14px;
    backdrop-filter:blur(var(--blur));
    background:linear-gradient(180deg,rgba(255,255,255,.14),rgba(255,255,255,.06));
    border:1px solid rgba(255,255,255,.18);
    padding:10px 14px;border-radius:14px;box-shadow:var(--shadow);
  }
  .brand img{height:42px;width:auto;border-radius:10px;object-fit:contain}
  .brand h1{font-size:clamp(18px,2.6vw,22px);margin:0;letter-spacing:.2px}
  .tagline{max-width:1200px;margin:18px auto 0;padding:0 20px;color:var(--txt-dim)}

  /* ===================== WRAP / PANELS ===================== */
  .wrap{max-width:1200px;margin:26px auto;padding:0 20px 40px;}
  .panel{
    background:linear-gradient(180deg,rgba(255,255,255,.16),rgba(255,255,255,.06));
    border:1px solid rgba(255,255,255,.2);
    border-radius:20px;padding:18px;box-shadow:var(--shadow);backdrop-filter:blur(var(--blur));
    margin-bottom:18px;
  }
  .panel h2{margin:0 0 12px;font-size:clamp(18px,2.4vw,22px);letter-spacing:.2px}
  .card{
    background:linear-gradient(180deg,rgba(255,255,255,.14),rgba(255,255,255,.06));
    border:1px solid rgba(255,255,255,.18);
    border-radius:16px;padding:14px;box-shadow:var(--shadow);
  }
  .grid{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
  .muted,.help{color:var(--txt-dim);font-size:12px;margin-top:6px;white-space:pre-wrap}

  footer{color:#f3ecff;font-size:12px;text-align:center;padding:24px 10px;opacity:.9;}

  /* ===================== FIELDS ===================== */
  label{font-weight:700;font-size:13px;color:var(--accent);}

  input[type="number"]{
    width:100%; padding:10px 12px; margin-top:6px;
    border-radius:12px; outline:none; color:var(--txt);
    border:1px solid rgba(255,255,255,.22);
    background: var(--violet-ui);
    box-shadow:var(--shadow);
    transition:border-color .18s, box-shadow .18s;
    min-height:44px;
  }
  input[type="number"]:focus{
    border-color:rgba(255,255,255,.34);
    box-shadow:0 0 0 3px rgba(201,183,255,.25), var(--shadow);
  }

  /* ====== SELECT CUSTOM (√©paisseur) ====== */
  .native-select{
    position:absolute !important;
    opacity:0 !important;
    pointer-events:none !important;
    width:0;height:0;margin:0;padding:0;border:0;
  }
  .cselect{ position:relative; margin-top:6px; }
  .cselect-toggle{
    width:100%;
    display:flex; align-items:center; justify-content:space-between; gap:12px;
    padding:10px 12px; color:var(--txt);
    border-radius:12px; cursor:pointer; user-select:none;
    border:1px solid rgba(255,255,255,.22);
    box-shadow: var(--shadow);
    background: var(--violet-ui);
    min-height:44px;
  }
  .cselect-toggle:hover{ background: var(--violet-ui-pressed); }
  .cselect-toggle:focus-visible{ outline:none; box-shadow: 0 0 0 3px rgba(201,183,255,.35); }
  .cselect-label{white-space:nowrap; overflow:hidden; text-overflow:ellipsis; flex:1}
  .cselect-caret{
    width:10px; height:10px; flex:0 0 auto; opacity:.9;
    background-image:
      linear-gradient(45deg, transparent 50%, var(--txt) 50%),
      linear-gradient(135deg, var(--txt) 50%, transparent 50%);
    background-size:6px 6px, 6px 6px;
    background-position:right top, right bottom;
    background-repeat:no-repeat;
    transform: translateY(1px);
  }
  .cselect[aria-expanded="true"] .cselect-caret{ transform: rotate(180deg); }

  /* Menu port√© dans <body> pour ne jamais passer dessous */
  .cselect-menu{
    position:fixed; left:0; top:0; width:260px;
    z-index:99999;
    max-height:280px; overflow:auto; padding:6px;
    border-radius:14px; border:1px solid rgba(255,255,255,.22);
    box-shadow: 0 16px 40px rgba(0,0,0,.45);
    background: var(--violet-ui);
    display:none;
  }
  .cselect[aria-expanded="true"] .cselect-menu{ display:block; }
  .cselect-option{
    border-radius:10px; margin:4px 0; padding:10px 12px; cursor:pointer;
    color:var(--txt);
    border:1px solid rgba(255,255,255,.18);
    background: rgba(255,255,255,.10);
  }
  .cselect-option:hover, .cselect-option[aria-selected="true"]{
    background: rgba(255,255,255,.22);
    border-color: rgba(255,255,255,.28);
  }

  /* ====== CHECKBOXES (lisibles, violet clair homog√®ne) ====== */
  .options{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px;margin-top:10px}
  .option-item{
    display:flex;align-items:center;gap:10px;
    border:1px solid rgba(255,255,255,.22);
    background: var(--violet-ui);
    border-radius:12px; padding:10px 12px; min-height:44px;
    box-shadow:var(--shadow);
  }
  .option-item input[type="checkbox"]{
    width:18px;height:18px; accent-color:#8e6ae5; /* violet lisible natif */
  }

  /* ===================== RESULT + BUTTONS ===================== */
  .result{
    text-align:center;padding:16px;
    background:var(--violet-ui);
    border:1px solid rgba(255,255,255,.22); border-radius:16px;
    box-shadow:0 8px 22px rgba(0,0,0,.28);
    font-size:18px;
    margin-top:16px;
  }
  .result b{font-size:20px}
  .btn{
    appearance:none;border:none;cursor:pointer;font-weight:700;
    color:#0b0b0b;background:#fff;border-radius:12px;padding:10px 14px;
    box-shadow:0 10px 24px rgba(0,0,0,.25);
    transition:transform .16s, box-shadow .16s;
  }
  .btn:active{transform:translateY(1px);box-shadow:0 6px 16px rgba(0,0,0,.28);}
  .btn-ghost{background:transparent;color:var(--txt);border:1px solid rgba(255,255,255,.24);}
</style>
</head>
<body>

<!-- ===================== HERO ===================== -->
<div class="hero">
  <div class="hero-inner">
    <div class="brand">
      <img src="../assets/logo cofel.jpg" alt="Cofel" />
      <h1>Configurateur ‚Äî Lettres PVC</h1>
    </div>
    <a class="brand" href="../index.html" style="text-decoration:none;color:inherit">‚¨Ö Retour aux configurateurs</a>
  </div>
  <div class="tagline">Saisis la hauteur, choisis l‚Äô√©paisseur et les options. Les montants s‚Äôactualisent automatiquement.</div>
</div>

<!-- ===================== CONTENU ===================== -->
<main class="wrap">
  <section class="panel">
    <h2>‚öôÔ∏è Param√®tres</h2>
    <div class="card grid">
      <div>
        <label for="hauteur">Hauteur (mm)</label>
        <input type="number" id="hauteur" placeholder="Ex : 250" min="0"/>
      </div>

      <div>
        <label for="epaisseur">√âpaisseur / Chant (mm)</label>
        <!-- Select natif (masqu√©) -->
        <select id="epaisseur" class="native-select">
          <option value="">‚Äî S√©lectionnez ‚Äî</option>
          <option value="10">10 mm</option>
          <option value="19">19 mm</option>
          <option value="30">30 mm</option>
        </select>
        <!-- Select custom -->
        <div class="cselect" data-bind="epaisseur" aria-haspopup="listbox" aria-expanded="false">
          <button type="button" class="cselect-toggle">
            <span class="cselect-label">‚Äî S√©lectionnez ‚Äî</span>
            <span class="cselect-caret" aria-hidden="true"></span>
          </button>
          <div class="cselect-menu" role="listbox"></div>
        </div>
      </div>

      <div>
        <label for="quantite">Quantit√©</label>
        <input type="number" id="quantite" min="1" value="1"/>
      </div>
    </div>

    <div class="card">
      <div class="options">
        <label class="option-item" for="optLaquage">
          <input type="checkbox" id="optLaquage"/>
          <span>Laquage</span>
        </label>
        <label class="option-item" for="optFixation">
          <input type="checkbox" id="optFixation"/>
          <span>Fixations</span>
        </label>
        <label class="option-item" for="optRetro">
          <input type="checkbox" id="optRetro"/>
          <span>R√©tro√©clairage</span>
        </label>
      </div>
      <div class="help" style="margin-top:8px">Le r√©tro√©clairage est propos√© uniquement pour les chants 19 mm et 30 mm.</div>
    </div>
  </section>

  <section class="panel">
    <h2>üßæ R√©capitulatif</h2>
    <div class="result">
      <p>Prix HT : <b><span id="prixHT">0,00</span> ‚Ç¨</b></p>
      <p>Prix TTC : <b><span id="prixTTC">0,00</span> ‚Ç¨</b></p>
      <div class="muted">TVA 20 % incluse dans le calcul.</div>
    </div>

    <div style="margin-top:16px;display:flex;gap:10px;flex-wrap:wrap;">
      <button id="btnAddDevis" class="btn">‚ûï Ajouter au devis</button>
      <button id="btnReset" class="btn btn-ghost">üîÑ R√©initialiser</button>
    </div>
  </section>
</main>

<footer>
  ¬© Cofel ‚Äî ZA du Perquoi, 72560 Chang√© ‚Äî SIRET 927 659 458 00024 ‚Äî TVA FR80927659458
</footer>

<script>
/* ===== CONFIG ===== */
const TVA = 0.20;
const UPLIFT_PUBLIC = 2.0; // x2 (affichage public), aucune mention c√¥t√© client
const CSV_URL = "https://raw.githubusercontent.com/stevens-cofel/configurateur-cofel/refs/heads/main/lettres/Lettre%20PVC.csv";

let DATA = []; // {Hauteur_mm, Epaisseur_mm, PrixBase_EUR, SupLaquage_EUR, SupFixation_EUR, SupRetro_EUR}

/* ===== DOM ===== */
const $ = id => document.getElementById(id);
const elH   = $('hauteur');
const elE   = $('epaisseur');
const elQ   = $('quantite');
const elLQ  = $('optLaquage');
const elFX  = $('optFixation');
const elRT  = $('optRetro');
const elHT  = $('prixHT');
const elTTC = $('prixTTC');

/* ===== Utils ===== */
function euro(n){ return (isFinite(n)?n:0).toFixed(2).replace('.', ','); }
function numFR(s){
  if(s===undefined||s===null) return NaN;
  let x = String(s).replace(/[\u00A0\u202F]/g,'').replace(/‚Ç¨/g,'').trim();
  x = x.replace(',', '.');
  const m = x.match(/-?\d+(\.\d+)?/);
  return m ? parseFloat(m[0]) : NaN;
}

/* ===== Select custom (√©paisseur) ===== */
const customSelects=new Map();
function buildCustomFromNative(native){
  const wrap=document.querySelector('.cselect[data-bind="'+native.id+'"]'); if(!wrap) return;
  const toggle=wrap.querySelector('.cselect-toggle');
  const label=wrap.querySelector('.cselect-label');
  const menu=wrap.querySelector('.cselect-menu');
  menu.innerHTML='';
  Array.from(native.options).forEach(opt=>{
    const d=document.createElement('div');
    d.className='cselect-option'; d.setAttribute('role','option'); d.tabIndex=-1;
    d.dataset.value=opt.value; d.textContent=opt.textContent;
    if(opt.selected) d.setAttribute('aria-selected','true');
    d.addEventListener('click',()=>{ setNativeValue(native,opt.value); closeMenu(native.id); });
    d.addEventListener('keydown',e=>{ if(e.key==='Enter'||e.key===' '){e.preventDefault(); setNativeValue(native,opt.value); closeMenu(native.id);} });
    menu.appendChild(d);
  });
  label.textContent = (native.selectedOptions[0]||native.options[0])?.textContent || '';
  toggle.onclick=()=>{ const exp=wrap.getAttribute('aria-expanded')==='true'; exp?closeMenu(native.id):openMenu(native.id); };
  toggle.onkeydown=(e)=>{
    const exp=wrap.getAttribute('aria-expanded')==='true';
    if((e.key==='ArrowDown'||e.key==='ArrowUp')&&!exp){e.preventDefault();openMenu(native.id);(menu.querySelector('.cselect-option')||{}).focus?.();}
    else if(e.key==='Enter'||e.key===' '){e.preventDefault();toggle.click();}
    else if(e.key==='Escape'&&exp){closeMenu(native.id);}
  };
  customSelects.set(native.id,{wrap,toggle,labelSpan:label,menu,native});
}
function setNativeValue(native,val){
  if(native.value!==val){ native.value=val; native.dispatchEvent(new Event('change',{bubbles:true})); }
  const api=customSelects.get(native.id);
  if(api){
    api.labelSpan.textContent = native.selectedOptions[0]?.textContent || '';
    Array.from(api.menu.children).forEach(n=>n.classList.contains('cselect-option')&&n.setAttribute('aria-selected',n.dataset.value===val?'true':'false'));
  }
}
function openMenu(id){
  const api=customSelects.get(id); if(!api) return;
  const {wrap,toggle,menu}=api;
  wrap.setAttribute('aria-expanded','true');
  const r=toggle.getBoundingClientRect();
  menu.style.left=Math.round(r.left)+'px';
  menu.style.top =Math.round(r.bottom+6)+'px';
  menu.style.width=Math.round(r.width)+'px';
  if(menu.parentElement!==document.body) document.body.appendChild(menu);
  menu.style.display='block';
  const onViewport=()=>closeMenu(id);
  const onDocClick=(e)=>{ if(!wrap.contains(e.target)&&!menu.contains(e.target)) closeMenu(id); };
  window.addEventListener('scroll',onViewport,{passive:true});
  window.addEventListener('resize',onViewport);
  document.addEventListener('click',onDocClick);
  api.__off=()=>{window.removeEventListener('scroll',onViewport);window.removeEventListener('resize',onViewport);document.removeEventListener('click',onDocClick);};
}
function closeMenu(id){
  const api=customSelects.get(id); if(!api) return;
  const {wrap,menu,__off}=api;
  wrap.setAttribute('aria-expanded','false');
  menu.style.display='none';
  if(menu.parentElement!==wrap) wrap.appendChild(menu);
  if(typeof __off==='function') __off();
  api.toggle.focus();
}

/* ---------- CSV parser robuste ---------- */
function parseCSVLine(line, sep=','){
  const out=[]; let cur=''; let inQ=false;
  for(let i=0;i<line.length;i++){
    const ch=line[i], nx=line[i+1];
    if(ch === '"'){
      if(inQ && nx === '"'){ cur+='"'; i++; }
      else inQ = !inQ;
    }else if(ch === sep && !inQ){
      out.push(cur); cur='';
    }else{
      cur += ch;
    }
  }
  out.push(cur);
  return out;
}
function normalizeWeirdCSV(text){
  let t = text.replace(/^\uFEFF/,'').replace(/\r/g,'').replace(/""/g,'"');
  let lines = t.split('\n').filter(l=>l.trim()!=='');
  if(lines.length === 1){
    const blocks=[]; const re=/"([^"]*)"/g; let m;
    while((m=re.exec(t))!==null){ blocks.push(m[1]); }
    if(blocks.length){
      const perLine = blocks[0].split(',').length;
      const out=[];
      for(let i=0;i<blocks.length;i+=perLine){
        out.push(blocks.slice(i,i+perLine).map(s=>`"${s}"`).join(','));
      }
      lines = out;
    }
  }else{
    lines = lines.map(s=>{
      s=s.trim();
      if(s.startsWith('"') && s.endsWith('"')) return s.slice(1,-1);
      return s;
    });
  }
  return lines.join('\n');
}
function parseCSVSmart(text){
  const norm = normalizeWeirdCSV(text);
  const lines = norm.split('\n').filter(l=>l.trim()!=='');
  if(!lines.length) return {heads:[], rows:[]};
  const heads = parseCSVLine(lines[0]).map(h=>h.replace(/^"+|"+$/g,'').trim());
  const rows = lines.slice(1).map(line=>{
    const cells = parseCSVLine(line).map(c=>c.replace(/^"+|"+$/g,'').trim());
    const obj={}; heads.forEach((h,i)=> obj[h] = cells[i] ?? '');
    return obj;
  });
  return {heads, rows};
}

async function loadCSV(){
  const txt = await fetch(CSV_URL, {cache:'no-store'}).then(r=>r.text());
  const parsed = parseCSVSmart(txt);
  DATA = parsed.rows.map(r=>{
    const o = (key)=> r[key] ?? '';
    return {
      Hauteur_mm:       numFR(o('Hauteur_mm')),
      Epaisseur_mm:     numFR(o('Epaisseur_mm')),
      PrixBase_EUR:     numFR(o('PrixBase_EUR')),
      SupLaquage_EUR:   numFR(o('SupLaquage_EUR'))   || 0,
      SupFixation_EUR:  numFR(o('SupFixation_EUR'))  || 0,
      SupRetro_EUR:     numFR(o('SupRetro_EUR'))     || 0
    };
  }).filter(x=>isFinite(x.Hauteur_mm)&&isFinite(x.Epaisseur_mm)&&isFinite(x.PrixBase_EUR));
}

function updateRetroAvailability(){
  const ep = Number(elE.value);
  if(ep===10){ elRT.checked=false; elRT.disabled=true; }
  else { elRT.disabled=false; }
}

function compute(){
  const h = Number(elH.value||0);
  const e = Number(elE.value||0);
  const q = Math.max(1, Number(elQ.value||1));

  if(!(h>0) || !(e>0) || !DATA.length){
    elHT.textContent = '0,00';
    elTTC.textContent = '0,00';
    return;
  }

  const pool = DATA.filter(r=>r.Epaisseur_mm===e).sort((a,b)=>a.Hauteur_mm-b.Hauteur_mm);
  if(!pool.length){ elHT.textContent='0,00'; elTTC.textContent='0,00'; return; }

  let cible = pool[0].Hauteur_mm;
  for(const r of pool){ if(h<=r.Hauteur_mm){ cible=r.Hauteur_mm; break; } cible=r.Hauteur_mm; }
  const row = pool.find(r=>r.Hauteur_mm===cible) || pool[pool.length-1];

  // Prix interne + options
  let prix = row.PrixBase_EUR;
  if(elLQ.checked) prix += row.SupLaquage_EUR;
  if(elFX.checked) prix += row.SupFixation_EUR;
  if(elRT.checked) prix += row.SupRetro_EUR;

  // Conversion ‚Üí prix public (x2)
  const prix_public = prix * UPLIFT_PUBLIC;

  const totalHT = prix_public * q;
  const totalTTC = totalHT * (1+TVA);
  elHT.textContent = euro(totalHT);
  elTTC.textContent = euro(totalTTC);
}

function bind(){
  [elH, elE, elQ, elLQ, elFX, elRT].forEach(el=>{
    el.addEventListener('input', ()=>{ updateRetroAvailability(); compute(); });
    el.addEventListener('change', ()=>{ updateRetroAvailability(); compute(); });
  });
  document.getElementById('btnReset').addEventListener('click', ()=>{
    elH.value=''; elE.value=''; elQ.value=1; elLQ.checked=false; elFX.checked=false; elRT.checked=false;
    buildCustomFromNative(elE);
    updateRetroAvailability(); compute();
  });
}

/* ===== INIT ===== */
(async function init(){
  buildCustomFromNative(elE);
  bind();
  await loadCSV();
  updateRetroAvailability();
  compute();
})();
</script>

<!-- ====== Int√©gration Devis ====== -->
<script src="../js/devis-core.js"></script>
<script>
document.getElementById('btnAddDevis').addEventListener('click', () => {
  try{
    if(!window.Devis) throw new Error("Moteur de devis introuvable.");
    const h = Number(document.getElementById('hauteur').value || 0);
    const e = Number(document.getElementById('epaisseur').value || 0);
    const q = Math.max(1, Number(document.getElementById('quantite').value || 1));
    if(!(h>0) || !(e>0)){ alert("Renseigne la hauteur et l‚Äô√©paisseur."); return; }

    const opts=[];
    if(document.getElementById('optLaquage').checked) opts.push('Laquage');
    if(document.getElementById('optFixation').checked) opts.push('Fixations');
    if(document.getElementById('optRetro').checked)   opts.push('R√©tro√©clairage');

    const total_ht_public = parseFloat(document.getElementById('prixHT').innerText.replace(',','.'))||0;
    if (total_ht_public <= 0){ alert("Le prix est √† 0, v√©rifie les param√®tres."); return; }

    const pu_public_ht = q>0 ? total_ht_public / q : 0;

    const designation = `Lettres PVC ‚Äî H ${h} mm ‚Äî √âp. ${e} mm` + (opts.length? ` ‚Äî ${opts.join(' + ')}` : '');

    Devis.addLine({
      type: 'Lettres PVC',
      designation,
      quantite: q,
      pu_public_ht: Number(pu_public_ht.toFixed(2))
    });

    alert(`‚úÖ Ligne ajout√©e au devis !
${designation}
Qt√© : ${q}
PU HT : ${pu_public_ht.toFixed(2)} ‚Ç¨`);
  }catch(err){
    console.error(err);
    alert('Erreur lors de l‚Äôajout au devis : ' + err.message);
  }
});
</script>

</body>
</html>
