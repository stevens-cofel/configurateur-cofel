<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Configurateur Lettres PVC – Cofel</title>

<!-- Styles communs (mêmes que la page d’accueil, si présents) -->
<link rel="stylesheet" href="../styles/cofel.css" />
<link rel="stylesheet" href="../styles/cofel-config.css" />

<style>
  /* ===== Habillage Cofel (violet) — logique JS inchangée ===== */
  body{margin:0;background:#f6f3fa;color:#2b2140;font-family:Arial, Helvetica, sans-serif}
  .wrap{max-width:860px;margin:20px auto;background:#fff;border-radius:14px;padding:20px;box-shadow:0 10px 28px rgba(90,45,130,.12)}
  h1{margin:0 0 12px;text-align:center}
  label{font-weight:700;display:block;margin-top:14px}
  input,select{width:100%;padding:10px;margin-top:6px;border:1px solid #d8cbe8;border-radius:10px;background:#fff;min-height:44px}

  .options{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px;margin-top:10px}
  .option-item{
    display:flex;align-items:center;gap:10px;border:1px solid #e6daf4;background:#fff;border-radius:10px;
    padding:10px 12px;min-height:44px
  }
  .option-item input{transform:scale(1.1)}

  .result{
    background:#fcfaff;border:1px solid #dec5f2;border-radius:12px;padding:16px;margin-top:18px;text-align:center;
    font-size:18px;box-shadow:0 8px 18px rgba(90,45,130,.08)
  }
  .note{background:#fff7e6;border:1px solid #ffd38a;border-radius:10px;padding:10px;font-size:13px;margin-top:10px}
  .muted{color:#7d6f8e;font-size:12px;margin-top:8px;white-space:pre-wrap}

  /* Bandeau / footer (fallback si cofel.css absent) */
  .cofel-header{background:#5a2d82;color:#fff}
  .cofel-header .row{max-width:1100px;margin:0 auto;display:flex;align-items:center;gap:16px;padding:10px 14px}
  .cofel-back{color:#fff;text-decoration:none;border:1px solid rgba(255,255,255,.35);padding:8px 12px;border-radius:10px}
  .cofel-brand{display:flex;align-items:center;gap:10px}
  .cofel-brand img{height:36px;border-radius:6px;object-fit:cover}
  .cofel-title{font-size:18px;margin:0}
  .cofel-container{max-width:1100px;margin:0 auto;padding:14px}
  .cofel-footer{
    margin:24px 0 0;padding:14px;text-align:center;color:#6f5b86;font-size:13px;
    border-top:1px solid #e6daf4;background:#fbf9fe
  }

  /* Bouton Ajouter au devis */
  #btnAddDevis{
    position:fixed;right:20px;bottom:20px;padding:10px 16px;
    background:#ffffff;border:1px solid #ccc;border-radius:10px;
    box-shadow:0 2px 6px rgba(0,0,0,0.15);cursor:pointer;z-index:999;font-weight:600
  }
</style>
</head>
<body>

<!-- Bandeau violet / retour -->
<header class="cofel-header">
  <div class="row">
    <a class="cofel-back" href="../index.html">⬅ Retour aux configurateurs</a>
    <div class="cofel-brand">
      <img src="../assets/logo cofel.jpg" alt="Cofel" />
      <h1 class="cofel-title">Configurateur — Lettres PVC</h1>
    </div>
  </div>
</header>

<div class="cofel-container">
  <h1>Lettres PVC</h1>

  <div class="wrap">
    <!-- ===== UI ===== -->
    <label for="hauteur">Hauteur (mm)</label>
    <input type="number" id="hauteur" placeholder="Ex : 250" min="0"/>

    <label for="epaisseur">Épaisseur / Chant (mm)</label>
    <select id="epaisseur">
      <option value="">— Sélectionnez —</option>
      <option value="10">10 mm</option>
      <option value="19">19 mm</option>
      <option value="30">30 mm</option>
    </select>

    <label for="quantite">Quantité</label>
    <input type="number" id="quantite" min="1" value="1"/>

    <div class="options">
      <label class="option-item" for="optLaquage">
        <input type="checkbox" id="optLaquage"/>
        <span>Laquage</span>
      </label>
      <label class="option-item" for="optFixation">
        <input type="checkbox" id="optFixation"/>
        <span>Fixations</span>
      </label>
      <label class="option-item" for="optRetro">
        <input type="checkbox" id="optRetro"/>
        <span>Rétroéclairage</span>
      </label>
    </div>

    <div class="result">
      <p>Prix HT : <span id="prixHT">0,00</span> €</p>
      <p>Prix TTC : <span id="prixTTC">0,00</span> €</p>
    </div>

    <div class="note">
      ⚠️ Le rétroéclairage est disponible uniquement pour les lettres PVC de 19 mm ou 30 mm.
    </div>

    <div id="log" class="muted"></div>
  </div>
</div>

<!-- Pied de page -->
<footer class="cofel-footer">
  © Cofel — ZA du Perquoi, 72560 Changé — SIRET 927 659 458 00024 — TVA FR80927659458
</footer>

<script>
/* ===== CONFIG ===== */
const TVA = 0.20;
const UPLIFT_PUBLIC = 1.5; // +50% (affichage public)
const CSV_URL = "https://raw.githubusercontent.com/stevens-cofel/configurateur-cofel/refs/heads/main/lettres/Lettre%20PVC.csv";

let DATA = []; // {Hauteur_mm, Epaisseur_mm, PrixBase_EUR, SupLaquage_EUR, SupFixation_EUR, SupRetro_EUR}

const elH   = document.getElementById('hauteur');
const elE   = document.getElementById('epaisseur');
const elQ   = document.getElementById('quantite');
const elLQ  = document.getElementById('optLaquage');
const elFX  = document.getElementById('optFixation');
const elRT  = document.getElementById('optRetro');
const elHT  = document.getElementById('prixHT');
const elTTC = document.getElementById('prixTTC');
const elLog = document.getElementById('log');

function euro(n){ return (isFinite(n)?n:0).toFixed(2).replace('.', ','); }
function numFR(s){
  if(s===undefined||s===null) return NaN;
  let x = String(s).replace(/[\u00A0\u202F]/g,'').replace(/€/g,'').trim();
  x = x.replace(',', '.');
  return parseFloat(x);
}

/* ---------- CSV parser robuste ---------- */
function parseCSVLine(line, sep=','){
  const out=[]; let cur=''; let inQ=false;
  for(let i=0;i<line.length;i++){
    const ch=line[i], nx=line[i+1];
    if(ch === '"'){
      if(inQ && nx === '"'){ cur+='"'; i++; }
      else inQ = !inQ;
    }else if(ch === sep && !inQ){
      out.push(cur); cur='';
    }else{
      cur += ch;
    }
  }
  out.push(cur);
  return out;
}

function normalizeWeirdCSV(text){
  let t = text.replace(/^\uFEFF/,'').replace(/\r/g,'').replace(/""/g,'"');
  let lines = t.split('\n').filter(l=>l.trim()!=='');
  if(lines.length === 1){
    const blocks=[]; const re=/"([^"]*)"/g; let m;
    while((m=re.exec(t))!==null){ blocks.push(m[1]); }
    if(blocks.length){
      const perLine = blocks[0].split(',').length;
      const out=[];
      for(let i=0;i<blocks.length;i+=perLine){
        out.push(blocks.slice(i,i+perLine).map(s=>`"${s}"`).join(','));
      }
      lines = out;
    }
  }else{
    lines = lines.map(s=>{
      s=s.trim();
      if(s.startsWith('"') && s.endsWith('"')) return s.slice(1,-1);
      return s;
    });
  }
  return lines.join('\n');
}

function parseCSVSmart(text){
  const norm = normalizeWeirdCSV(text);
  const lines = norm.split('\n').filter(l=>l.trim()!=='');
  if(!lines.length) return {heads:[], rows:[]};
  const heads = parseCSVLine(lines[0]).map(h=>h.replace(/^"+|"+$/g,'').trim());
  const rows = lines.slice(1).map(line=>{
    const cells = parseCSVLine(line).map(c=>c.replace(/^"+|"+$/g,'').trim());
    const obj={}; heads.forEach((h,i)=> obj[h] = cells[i] ?? '');
    return obj;
  });
  return {heads, rows};
}

async function loadCSV(){
  const txt = await fetch(CSV_URL, {cache:'no-store'}).then(r=>r.text());
  const parsed = parseCSVSmart(txt);
  DATA = parsed.rows.map(r=>{
    const o = (key)=> r[key] ?? '';
    return {
      Hauteur_mm:       numFR(o('Hauteur_mm')),
      Epaisseur_mm:     numFR(o('Epaisseur_mm')),
      PrixBase_EUR:     numFR(o('PrixBase_EUR')),
      SupLaquage_EUR:   numFR(o('SupLaquage_EUR'))   || 0,
      SupFixation_EUR:  numFR(o('SupFixation_EUR'))  || 0,
      SupRetro_EUR:     numFR(o('SupRetro_EUR'))     || 0
    };
  }).filter(x=>isFinite(x.Hauteur_mm)&&isFinite(x.Epaisseur_mm)&&isFinite(x.PrixBase_EUR));

  elLog.textContent = `Données chargées: ${DATA.length} lignes.`;
}

function updateRetroAvailability(){
  const ep = Number(elE.value);
  if(ep===10){ elRT.checked=false; elRT.disabled=true; }
  else { elRT.disabled=false; }
}

function compute(){
  const h = Number(elH.value||0);
  const e = Number(elE.value||0);
  const q = Math.max(1, Number(elQ.value||1));

  if(!(h>0) || !(e>0) || !DATA.length){
    elHT.textContent = '0,00';
    elTTC.textContent = '0,00';
    return;
  }

  const pool = DATA.filter(r=>r.Epaisseur_mm===e).sort((a,b)=>a.Hauteur_mm-b.Hauteur_mm);
  if(!pool.length){ elHT.textContent='0,00'; elTTC.textContent='0,00'; return; }

  let cible = pool[0].Hauteur_mm;
  for(const r of pool){ if(h<=r.Hauteur_mm){ cible=r.Hauteur_mm; break; } cible=r.Hauteur_mm; }
  const row = pool.find(r=>r.Hauteur_mm===cible) || pool[pool.length-1];

  // Prix “interne”
  let prix = row.PrixBase_EUR;
  if(elLQ.checked) prix += row.SupLaquage_EUR;
  if(elFX.checked) prix += row.SupFixation_EUR;
  if(elRT.checked) prix += row.SupRetro_EUR;

  // Conversion → prix public (+50 %)
  const prix_public = prix * UPLIFT_PUBLIC;

  const totalHT = prix_public * q;
  const totalTTC = totalHT * (1+TVA);
  elHT.textContent = euro(totalHT);
  elTTC.textContent = euro(totalTTC);
}

function bind(){
  [elH, elE, elQ, elLQ, elFX, elRT].forEach(el=>{
    el.addEventListener('input', ()=>{ updateRetroAvailability(); compute(); });
    el.addEventListener('change', ()=>{ updateRetroAvailability(); compute(); });
  });
}

(async function init(){
  bind();
  await loadCSV();
  updateRetroAvailability();
  compute();
})();
</script>

<!-- ====== Intégration Devis ====== -->
<script src="../js/devis-core.js"></script>

<button id="btnAddDevis">➕ Ajouter au devis</button>

<script>
(function(){
  const btn = document.getElementById('btnAddDevis');
  if(!btn) return;

  function parsePrixHT(){
    const txt = document.getElementById('prixHT').innerText.trim();
    return Number(txt.replace(/\s/g,'').replace(',', '.')) || 0;
  }

  btn.addEventListener('click', () => {
    try{
      if(!window.Devis) throw new Error("Moteur de devis introuvable.");

      const h = Number(document.getElementById('hauteur').value || 0);
      const e = Number(document.getElementById('epaisseur').value || 0);
      const q = Math.max(1, Number(document.getElementById('quantite').value || 1));
      if(!(h>0) || !(e>0)){ alert("Renseigne la hauteur et l’épaisseur."); return; }

      const opts=[];
      if(document.getElementById('optLaquage').checked) opts.push('Laquage');
      if(document.getElementById('optFixation').checked) opts.push('Fixations');
      if(document.getElementById('optRetro').checked)   opts.push('Rétroéclairage');

      const total_ht_public = parsePrixHT();
      if (total_ht_public <= 0){ alert("Le prix est à 0, vérifie les paramètres."); return; }

      const pu_public_ht = q>0 ? total_ht_public / q : 0;

      const designation = `Lettres PVC — H ${h} mm — Ép. ${e} mm` + (opts.length? ` — ${opts.join(' + ')}` : '');

      Devis.addLine({
        type: 'Lettres PVC',
        designation,
        quantite: q,
        pu_public_ht: Number(pu_public_ht.toFixed(2))
      });

      alert(`✅ Ligne ajoutée au devis !
${designation}
Qté : ${q}
PU HT : ${pu_public_ht.toFixed(2)} €`);
    }catch(err){
      console.error(err);
      alert('Erreur lors de l’ajout au devis : ' + err.message);
    }
  });
})();
</script>

</body>
</html>
