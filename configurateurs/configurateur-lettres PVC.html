<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Configurateur — Lettres PVC | Cofel</title>

<link rel="stylesheet" href="../styles/cofel.css" />
<link rel="stylesheet" href="../styles/cofel-config.css" />

<style>
  :root{
    --violet:#5a2d82;
    --violet-2:#7838a7;
    --glass: rgba(255,255,255,.08);
    --txt:#f5f7ff;
    --txt-dim:#e6e6ff;
    --accent:#c9b7ff;
    --radius:18px;
    --blur:18px;
    --shadow: 0 10px 30px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--txt);
    font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","Segoe UI",Roboto,Arial,sans-serif;
    background:
      radial-gradient(800px 500px at 20% -10%, rgba(255,255,255,.10), transparent 60%),
      radial-gradient(800px 500px at 110% 10%, rgba(255,255,255,.08), transparent 60%),
      linear-gradient(135deg, var(--violet), var(--violet-2));
  }

  .cofel-header{
    position:sticky; top:0; z-index:1000; color:#fff;
    background:linear-gradient(180deg,rgba(255,255,255,.14),rgba(255,255,255,.06));
    border-bottom:1px solid rgba(255,255,255,.18);
    backdrop-filter:blur(var(--blur));
  }
  .cofel-header .row{
    max-width:1200px; margin:0 auto; display:flex; align-items:center; gap:16px; padding:10px 14px;
  }
  .cofel-back{
    color:#fff; text-decoration:none; border:1px solid rgba(255,255,255,.35);
    padding:8px 12px; border-radius:12px; backdrop-filter:blur(10px);
  }
  .cofel-brand{display:flex; align-items:center; gap:10px}
  .cofel-brand img{height:36px; border-radius:8px; object-fit:cover}
  .cofel-title{font-size:18px; margin:0}

  .cofel-container{max-width:1100px; margin:0 auto; padding:18px}
  h1{text-align:center; margin:12px 0}

  fieldset{
    border:1px solid rgba(255,255,255,.2);
    border-radius:20px; padding:16px; margin:16px 0;
    background:linear-gradient(180deg,rgba(255,255,255,.16),rgba(255,255,255,.06));
    box-shadow:var(--shadow); backdrop-filter:blur(var(--blur));
    overflow:visible;
  }
  legend{padding:0 10px; font-weight:800; color:#fff;}
  label{font-weight:700;font-size:13px;color:var(--accent);display:block;margin-top:10px}

  input[type="number"],
  select{
    width:100%; margin-top:6px; padding:12px 12px; min-height:42px;
    background:rgba(255,255,255,.10); color:var(--txt);
    border:1px solid rgba(255,255,255,.24); border-radius:14px; outline:none;
    transition:border-color .18s ease, background .18s ease, box-shadow .18s ease;
  }
  input:focus, select:focus{
    border-color:rgba(255,255,255,.38);
    background:rgba(255,255,255,.16);
    box-shadow:0 0 0 4px rgba(255,255,255,.08) inset;
  }
  select option{background:#3c1f61;color:#fff;}

  .radio-row{display:flex; gap:10px; flex-wrap:wrap; margin-top:8px;}
  .radio-row label{
    display:flex; align-items:center; gap:10px; cursor:pointer;
    padding:10px 14px; border-radius:14px;
    background:linear-gradient(180deg,rgba(255,255,255,.18),rgba(255,255,255,.08));
    border:1px solid rgba(255,255,255,.24); color:#fff; font-weight:700;
    box-shadow:var(--shadow);
  }
  .radio-row input[type="checkbox"]{accent-color:#cbb3ff;width:18px;height:18px}

  .result{
    background:linear-gradient(180deg,rgba(255,255,255,.16),rgba(255,255,255,.06));
    border:1px solid rgba(255,255,255,.24);
    border-radius:20px; padding:16px; margin-top:18px; text-align:center; font-size:18px;
    box-shadow:var(--shadow); backdrop-filter:blur(var(--blur));
  }
  .result span{font-weight:800;}

  .notice-glass{
    margin-top:10px;
    padding:10px 12px;
    border-radius:14px;
    border:1px solid rgba(255,255,255,.24);
    background: linear-gradient(180deg, rgba(255,255,255,.16), rgba(255,255,255,.06));
    backdrop-filter: blur(var(--blur));
    color: var(--txt);
    font-size:13px;
    box-shadow: var(--shadow);
  }
  .notice-glass b{ color: var(--accent); }
  .hidden{ display:none; }

  #btnAddDevis{
    padding:12px 20px; border:none; border-radius:14px; background:#fff; color:#0b0b0b;
    font-weight:800; cursor:pointer; box-shadow:0 10px 24px rgba(0,0,0,.25);
  }
  #btnAddDevis:active{ transform: translateY(1px); box-shadow:0 6px 16px rgba(0,0,0,.28); }

  footer{
    color:#f3ecff;font-size:12px;text-align:center;padding:24px 10px;opacity:.9;
  }
</style>
</head>
<body>

<header class="cofel-header">
  <div class="row">
    <a class="cofel-back" href="../index.html">⬅ Retour accueil (devis)</a>
    <div class="cofel-brand">
      <img src="../assets/logo cofel.jpg" alt="Cofel" />
      <h1 class="cofel-title">Configurateur — Lettres PVC</h1>
    </div>
  </div>
</header>

<div class="cofel-container">
  <h1>Lettres PVC</h1>

  <fieldset>
    <legend>Paramètres</legend>
    <div class="grid">
      <div>
        <label for="hauteur">Hauteur (mm)</label>
        <input type="number" id="hauteur" placeholder="Ex : 250" min="0">
      </div>
      <div>
        <label for="epaisseur">Épaisseur (mm)</label>
        <select id="epaisseur">
          <option value="">— Sélectionnez —</option>
          <option value="10">10 mm</option>
          <option value="19">19 mm</option>
          <option value="30">30 mm</option>
        </select>
      </div>
      <div>
        <label for="quantite">Quantité</label>
        <input type="number" id="quantite" min="1" value="1">
      </div>
    </div>
  </fieldset>

  <fieldset>
    <legend>Options</legend>
    <div class="radio-row">
      <label><input type="checkbox" id="optLaquage"> Laquage</label>
      <label><input type="checkbox" id="optFixation"> Fixation</label>
      <label><input type="checkbox" id="optRetro"> Rétroéclairage</label>
    </div>
    <div id="retroNotice" class="notice-glass hidden">
      <b>Indisponible sur 10&nbsp;mm :</b> le rétroéclairage nécessite une épaisseur minimale de <b>19&nbsp;mm</b>.
    </div>
    <div class="hint" style="color:var(--txt-dim);margin-top:6px;font-size:13px;">
      Le rétroéclairage est disponible uniquement pour les chants 19 mm et 30 mm.
    </div>
  </fieldset>

  <div class="result">
    <p>Prix unitaire HT : <span id="prixUHT">0,00</span> €</p>
    <p>Total HT : <span id="prixHT">0,00</span> €</p>
    <p>Total TTC : <span id="prixTTC">0,00</span> €</p>
  </div>

  <div style="text-align:center;margin-top:20px;">
    <button id="btnAddDevis">➕ Ajouter au devis</button>
  </div>
</div>

<footer>
  © Cofel — ZA du Perquoi, 72560 Changé — SIRET 927 659 458 00024 — TVA FR80927659458
</footer>

<script src="../js/devis-core.js"></script>

<script>
const TVA = 0.20;
const UPLIFT_PUBLIC = 2.0;
const CSV_URL = "https://raw.githubusercontent.com/stevens-cofel/configurateur-cofel/refs/heads/main/configurateurs/Lettre%20PVC.csv";

let DATA = [];
let BY_THICK = {};
const $ = (id)=>document.getElementById(id);

function parseEuroFR(s){
  if(s==null) return NaN;
  let t = String(s).replace(/€/g,'').replace(/\s|[\u00A0\u202F]/g,'').trim().replace(',', '.');
  const m = t.match(/-?\d+(\.\d+)?/);
  return m ? parseFloat(m[0]) : NaN;
}
function parseIntFR(s){
  if(s==null) return NaN;
  let t = String(s).replace(/\s|[\u00A0\u202F]/g,'').trim();
  const m = t.match(/\d+/);
  return m ? parseInt(m[0],10) : NaN;
}
function euro(n){ return (isFinite(n)?n:0).toFixed(2).replace('.', ','); }

async function loadCSV(){
  const r = await fetch(CSV_URL, {cache:'no-store'});
  if(!r.ok) throw new Error("CSV introuvable");
  const txt = await r.text();

  const first = (txt.split(/\r?\n/)[0]||'');
  const sep = (first.match(/;/g)||[]).length >= (first.match(/,/g)||[]).length ? ';' : ',';

  const lines = txt.split(/\r?\n/).filter(l=>l.trim()!=='');
  const maybeHeader = isNaN(parseIntFR(lines[0].split(sep)[1]));
  const start = maybeHeader ? 1 : 0;

  DATA = lines.slice(start).map(l=>{
    const p=l.split(sep).map(x=>x.trim());
    return {
      type:p[0]||"Lettre PVC",
      hauteur:parseIntFR(p[1]),
      epaisseur:parseIntFR(p[2]),
      base:parseEuroFR(p[3]),
      laquage:parseEuroFR(p[4]),
      fixation:parseEuroFR(p[5]),
      retro:parseEuroFR(p[6])
    };
  }).filter(r=>isFinite(r.hauteur)&&isFinite(r.epaisseur));

  BY_THICK={};
  DATA.forEach(r=>{
    if(!BY_THICK[r.epaisseur]) BY_THICK[r.epaisseur]=new Set();
    BY_THICK[r.epaisseur].add(r.hauteur);
  });
  for(const k in BY_THICK){
    BY_THICK[k]=Array.from(BY_THICK[k]).sort((a,b)=>a-b);
  }
}

function findRowFor(h,e){
  const pal=BY_THICK[e];
  if(!pal) return null;
  let chosen=pal[pal.length-1];
  for(const v of pal){ if(v>=h){ chosen=v; break; } }
  return DATA.find(r=>r.epaisseur===e && r.hauteur===chosen)||null;
}

function updateRetroUI(){
  const e=parseFloat($("epaisseur").value)||0;
  const retro=$("optRetro");
  const msg=$("retroNotice");
  if(e===10){ retro.checked=false; retro.disabled=true; msg.classList.remove("hidden"); }
  else{ retro.disabled=false; msg.classList.add("hidden"); }
}

function compute(){
  // === Remise automatique client ===
  let remiseClient = 1;
  try {
      const p = JSON.parse(localStorage.getItem('cofel_client_profile'));
      if (p && typeof p.discountRate === 'number') remiseClient = 1 - p.discountRate;
  } catch(e){}

  const h=parseFloat($("hauteur").value)||0;
  const e=parseFloat($("epaisseur").value)||0;
  const q=Math.max(1,parseInt($("quantite").value)||1);
  const laq=$("optLaquage").checked;
  const fix=$("optFixation").checked;
  const retro=$("optRetro").checked;

  const row=findRowFor(h,e);
  if(!row){["prixUHT","prixHT","prixTTC"].forEach(id=>$(id).textContent="0,00");return;}

  let base=row.base||0;
  if(laq) base+=row.laquage||0;
  if(fix) base+=row.fixation||0;
  if(retro && e>=19) base+=row.retro||0;

  const unit=base*UPLIFT_PUBLIC*remiseClient;
  const tot=unit*q;
  const ttc=tot*(1+TVA);

  $("prixUHT").textContent=euro(unit);
  $("prixHT").textContent=euro(tot);
  $("prixTTC").textContent=euro(ttc);
}

["input","change"].forEach(evt=>{
  ["hauteur","epaisseur","quantite","optLaquage","optFixation","optRetro"].forEach(id=>{
    $(id).addEventListener(evt,()=>{updateRetroUI();compute();});
  });
});

loadCSV().then(()=>{updateRetroUI();compute();});

document.getElementById("btnAddDevis").addEventListener("click",()=>{
  try{
    if(!window.Devis) throw new Error("Module devis introuvable.");
    const h=parseFloat(hauteur.value)||0;
    const e=parseFloat(epaisseur.value)||0;
    const q=Math.max(1,parseInt(quantite.value)||1);
    const laq=optLaquage.checked;
    const fix=optFixation.checked;
    const retro=optRetro.checked;

    const row=findRowFor(h,e);
    if(!row){alert("Aucune donnée trouvée pour cette configuration.");return;}

    let base=row.base||0;
    if(laq) base+=row.laquage||0;
    if(fix) base+=row.fixation||0;
    if(retro && e>=19) base+=row.retro||0;
let remiseClient = 1;
try {
    const p = JSON.parse(localStorage.getItem('cofel_client_profile'));
    if (p && typeof p.discountRate === 'number') 
        remiseClient = 1 - p.discountRate;
} catch(e){}

    const pu=base*UPLIFT_PUBLIC*remiseClient;

    const designation=`Lettre PVC ${h} mm (ép. ${e} mm)`
      +(laq?" · Laquage":"")
      +(fix?" · Fixation":"")
      +((retro && e>=19)?" · Rétroéclairage":"");

    Devis.addLine({
      type:"Lettre PVC",
      designation,
      quantite:q,
      pu_public_ht:Number(pu.toFixed(2))
    });

    alert(`✅ Ligne ajoutée au devis !\n${designation}\nQté : ${q}\nPU HT : ${pu.toFixed(2)} €`);
  }catch(err){alert("Erreur : "+err.message);}
});
</script>
</body>
</html>


