<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Configurateur — Tôle Tablette</title>
<link rel="stylesheet" href="../styles/cofel.css">
<style>
  /* Habillage du "wizard" (étapes) complémentaire au cofel.css */
  .steps {
    display:flex; gap:8px; flex-wrap:wrap; margin:14px 0 18px;
  }
  .step-badge{
    display:flex; align-items:center; gap:8px;
    background:#fcfaff; border:1px solid #dec5f2; color:#5a2d82;
    border-radius:999px; padding:8px 12px; font-weight:700; font-size:13px;
  }
  .step-badge.active{ background:#5a2d82; color:#fff; border-color:#5a2d82; }
  .step{ display:none; }
  .step.active{ display:block; animation:fade .18s ease; }
  @keyframes fade{ from{opacity:.4; transform:translateY(4px)} to{opacity:1; transform:none} }
  .nav{ display:flex; gap:10px; justify-content:space-between; margin-top:18px }
  .nav .left, .nav .right{ display:flex; gap:10px }
  .muted{ color:#7d6f8e; font-size:12px }
  .inline{ display:flex; gap:8px; align-items:center }
  .inline input[type="number"]{ width:140px }
  .pill{ display:inline-block; padding:2px 8px; border-radius:999px; background:#efe7f6; color:#5a2d82; font-size:12px; border:1px solid #dec5f2}
  .price-block{ margin-top:14px }
  .hidden{ display:none !important; }
</style>
</head>
<body>

<header class="cofel-header">
  <div class="row">
    <a class="cofel-back" href="../index.html">⬅ Retour aux configurateurs</a>
    <div class="cofel-brand">
      <img src="../assets/logo cofel.jpg" alt="Cofel">
      <h1 class="cofel-title">Configurateur — Tôle Tablette</h1>
    </div>
  </div>
</header>

<main class="wrap">

  <!-- Indicateur d’étapes -->
  <div class="steps" id="stepsBadges">
    <div class="step-badge" data-step="0">1. Matière</div>
    <div class="step-badge" data-step="1">2. Dimensions</div>
    <div class="step-badge" data-step="2">3. Fixation</div>
    <div class="step-badge" data-step="3">4. Ajourage</div>
    <div class="step-badge" data-step="4">5. PMMA</div>
    <div class="step-badge" data-step="5">6. LED</div>
  </div>

  <!-- Étape 1 — Matière -->
  <section class="card step" data-step="0">
    <h2 class="section-title">Étape 1 — Matière</h2>
    <div class="grid">
      <div class="field">
        <label for="matiere">Matière / finition de la tôle</label>
        <select id="matiere">
          <option value="brut">Brut</option>
          <option value="prelaque">Prélaqué</option>
          <option value="laque">Laqué (RAL)</option>
        </select>
      </div>
      <div class="field" id="ralBloc" class="hidden">
        <label for="ral">RAL (si laqué)</label>
        <input id="ral" type="text" placeholder="ex : RAL 7016">
        <small class="muted">Saisissez un RAL si vous avez choisi “Laqué”.</small>
      </div>
    </div>
    <div class="nav">
      <div class="left"></div>
      <div class="right">
        <button class="btn" id="next0">Étape suivante →</button>
      </div>
    </div>
  </section>

  <!-- Étape 2 — Dimensions -->
  <section class="card step" data-step="1">
    <h2 class="section-title">Étape 2 — Dimensions</h2>
    <div class="grid">
      <div class="field">
        <label for="L_mm">Largeur (mm)</label>
        <input id="L_mm" type="number" min="1" value="1000">
      </div>
      <div class="field">
        <label for="H_mm">Hauteur (mm)</label>
        <input id="H_mm" type="number" min="1" value="500">
      </div>
      <div class="field">
        <label>Surface (m²)</label>
        <input id="surface_m2" type="text" readonly>
        <small class="muted">Calculée automatiquement : (L×H)/1 000 000</small>
      </div>
    </div>
    <div class="nav">
      <div class="left">
        <button class="btn secondary" id="prev1">← Étape précédente</button>
      </div>
      <div class="right">
        <button class="btn" id="next1">Étape suivante →</button>
      </div>
    </div>
  </section>

  <!-- Étape 3 — Fixation -->
  <section class="card step" data-step="2">
    <h2 class="section-title">Étape 3 — Fixation</h2>
    <div class="grid">
      <div class="field">
        <label>Type de fixation</label>
        <div class="inline">
          <label class="pill"><input type="radio" name="fix" value="chassis" checked> Châssis 30×30 mm</label>
          <label class="pill"><input type="radio" name="fix" value="boite"> Boîte à chaussures</label>
          <label class="pill"><input type="radio" name="fix" value="corniere"> Cornière</label>
        </div>
      </div>

      <div class="field hidden" id="corniereBloc">
        <label for="corniere_ml">Cornière (mètres linéaires)</label>
        <input id="corniere_ml" type="number" min="0" step="0.1" value="0">
        <small class="muted">Renseignez la longueur totale si vous choisissez “Cornière”.</small>
      </div>
    </div>
    <small class="muted">Châssis : goussets minimum 4, puis +4 par m² (arrondi sup.).</small>
    <div class="nav">
      <div class="left">
        <button class="btn secondary" id="prev2">← Étape précédente</button>
      </div>
      <div class="right">
        <button class="btn" id="next2">Étape suivante →</button>
      </div>
    </div>
  </section>

  <!-- Étape 4 — Ajourage -->
  <section class="card step" data-step="3">
    <h2 class="section-title">Étape 4 — Ajourage</h2>
    <div class="grid">
      <div class="field">
        <label>Ajourage</label>
        <div class="inline">
          <label class="pill"><input type="radio" name="ajour" value="oui"> Oui</label>
          <label class="pill"><input type="radio" name="ajour" value="non" checked> Non</label>
        </div>
      </div>
      <div class="field hidden" id="surfAjourBloc">
        <label for="surf_ajour">Surface ajourée (m²)</label>
        <input id="surf_ajour" type="number" min="0" step="0.01" value="0.00">
        <small class="muted">Saisir la surface réellement découpée/ajourée.</small>
      </div>
    </div>
    <div class="nav">
      <div class="left">
        <button class="btn secondary" id="prev3">← Étape précédente</button>
      </div>
      <div class="right">
        <button class="btn" id="next3">Étape suivante →</button>
      </div>
    </div>
  </section>

  <!-- Étape 5 — PMMA -->
  <section class="card step" data-step="4">
    <h2 class="section-title">Étape 5 — PMMA</h2>
    <div class="grid">
      <div class="field" id="pmmaBloc">
        <label for="pmma">Type de PMMA (si ajourage = oui)</label>
        <select id="pmma" disabled>
          <option value="">— Pas de PMMA —</option>
          <!-- Mets ici tes vrais libellés/ids disponibles -->
          <option value="PMMA_OPALE_3">PMMA opale 3 mm</option>
          <option value="PMMA_DIFFUSANT_3">PMMA diffusant 3 mm</option>
          <option value="PMMA_INCOLORE_5">PMMA incolore 5 mm</option>
        </select>
        <small class="muted">Le choix du PMMA impacte le coût (barème par option).</small>
      </div>
    </div>
    <div class="nav">
      <div class="left">
        <button class="btn secondary" id="prev4">← Étape précédente</button>
      </div>
      <div class="right">
        <button class="btn" id="next4">Étape suivante →</button>
      </div>
    </div>
  </section>

  <!-- Étape 6 — LED -->
  <section class="card step" data-step="5">
    <h2 class="section-title">Étape 6 — Option lumineuse</h2>
    <div class="grid">
      <div class="field">
        <label>LED derrière PMMA</label>
        <div class="inline" id="ledRow">
          <label class="pill"><input type="radio" name="led" value="oui" disabled> Oui</label>
          <label class="pill"><input type="radio" name="led" value="non" checked disabled> Non</label>
        </div>
        <small class="muted">Les LED sont disponibles uniquement si vous avez sélectionné un PMMA.</small>
      </div>
      <div class="field">
        <label for="qte">Quantité</label>
        <input id="qte" type="number" min="1" value="1">
      </div>
    </div>

    <!-- Bloc prix -->
    <div class="price-block">
      <div class="price">
        <div class="label">PU public (inclut +50%)</div>
        <div class="value" id="puPublic">—</div>
      </div>
      <div class="price">
        <div class="label">PU net (remise globale via page principale)</div>
        <div class="value" id="puNet">—</div>
      </div>
      <div class="price">
        <div class="label">Total net</div>
        <div class="value" id="totalNet">—</div>
      </div>
    </div>

    <div class="nav">
      <div class="left">
        <button class="btn secondary" id="prev5">← Étape précédente</button>
      </div>
      <div class="right">
        <button class="btn" id="btnAjouter">Ajouter au devis</button>
      </div>
    </div>
  </section>

</main>

<footer class="cofel-footer">
  © Cofel — ZA du Perquoi, 72560 Changé — SIRET 927 659 458 00024 — TVA FR80927659458
</footer>

<script>
  // ====== UTIL ======
  const $ = s => document.querySelector(s);
  const $$ = s => document.querySelectorAll(s);
  const fmt = n => (Math.round(n*100)/100).toFixed(2).replace('.', ',');

  // ====== ETAPES ======
  let step = 0;
  const steps = $$('.step');
  const badges = $$('#stepsBadges .step-badge');
  function showStep(i){
    step = Math.max(0, Math.min(steps.length-1, i));
    steps.forEach((st,idx)=> st.classList.toggle('active', idx===step));
    badges.forEach((b,idx)=> b.classList.toggle('active', idx===step));
    calcAndRender(); // recalcul à chaque étape (pratique)
  }
  // boutons prev/next
  $('#next0').onclick = ()=> showStep(1);
  $('#next1').onclick = ()=> showStep(2);
  $('#next2').onclick = ()=> showStep(3);
  $('#next3').onclick = ()=> showStep(4);
  $('#next4').onclick = ()=> showStep(5);
  $('#prev1').onclick = ()=> showStep(0);
  $('#prev2').onclick = ()=> showStep(1);
  $('#prev3').onclick = ()=> showStep(2);
  $('#prev4').onclick = ()=> showStep(3);
  $('#prev5').onclick = ()=> showStep(4);

  // ====== CHAMPS ======
  const matiere = $('#matiere');
  const ralBloc = $('#ralBloc');
  const ral = $('#ral');

  const Lmm = $('#L_mm');
  const Hmm = $('#H_mm');
  const surf = $('#surface_m2');

  const fixRadios = $$('input[name="fix"]');
  const corniereBloc = $('#corniereBloc');
  const corniereMl = $('#corniere_ml');

  const ajourRadios = $$('input[name="ajour"]');
  const surfAjourBloc = $('#surfAjourBloc');
  const surfAjour = $('#surf_ajour');

  const pmma = $('#pmma');
  const ledRadios = $$('input[name="led"]');
  const qte = $('#qte');

  // ====== LOGIQUE D’INTERFACE ======
  function majUI(){
    // RAL visible si laqué
    ralBloc.classList.toggle('hidden', matiere.value !== 'laque');

    // Cornière ML si choix "corniere"
    const fix = [...fixRadios].find(r=>r.checked)?.value;
    corniereBloc.classList.toggle('hidden', fix !== 'corniere');

    // Ajourage → surface ajourée
    const ajour = [...ajourRadios].find(r=>r.checked)?.value === 'oui';
    surfAjourBloc.classList.toggle('hidden', !ajour);

    // PMMA activé seulement si ajourage = oui
    pmma.disabled = !ajour;
    if(!ajour){ pmma.value = ''; }

    // LED activée seulement si PMMA choisi
    const hasPmma = !!pmma.value;
    ledRadios.forEach(r => r.disabled = !hasPmma);
    if(!hasPmma){
      // force NON si désactivé
      ledRadios.forEach(r=>{ if(r.value==='non') r.checked=true; });
    }

    // Surface calculée
    const s = calcSurface();
    surf.value = fmt(s).replace(',', '.').replace('.', ','); // afficher virgule
  }

  function calcSurface(){
    const L = Math.max(0, parseFloat(Lmm.value||0));
    const H = Math.max(0, parseFloat(Hmm.value||0));
    return (L/1000)*(H/1000);
  }

  // ====== PRIX (exemples simples — à raccorder à tes barèmes réels) ======
  function prixTole(surface){
    // Exemple : €/m² selon matière
    const base = (matiere.value==='brut')? 50 : (matiere.value==='prelaque')? 65 : 80;
    const mini = 0.3; // mini de facturation
    return base * Math.max(surface, mini);
  }
  function prixFixation(surface){
    const fix = [...fixRadios].find(r=>r.checked)?.value;
    if(fix==='chassis'){
      const goussets = Math.max(4, Math.ceil(surface)*4);
      return 35*surface + goussets*1.8;
    }
    if(fix==='boite'){
      return 45*surface; // exemple
    }
    if(fix==='corniere'){
      const ml = Math.max(0, parseFloat(corniereMl.value||0));
      return ml * 2.2;
    }
    return 0;
  }
  function prixPMMA(surfaceAjour){
    const map = { PMMA_OPALE_3:60, PMMA_DIFFUSANT_3:75, PMMA_INCOLORE_5:90 }; // €/m²
    return (map[pmma.value]||0) * Math.max(0, surfaceAjour);
  }
  function prixLED(){
    const ledOui = [...ledRadios].find(r=>r.checked)?.value==='oui';
    if(!ledOui) return 0;
    // petit forfait d’exemple ; à ajuster
    return 20;
  }

  function calcAndRender(){
    // surface panneau
    const S = calcSurface();
    // ajourage
    const ajour = [...ajourRadios].find(r=>r.checked)?.value === 'oui';
    const S_ajour = ajour ? Math.max(0, parseFloat(surfAjour.value||0)) : 0;

    // bases
    const cTole = prixTole(S);
    const cFix  = prixFixation(S);
    const cPMMA = ajour ? prixPMMA(S_ajour) : 0;
    const cLED  = cPMMA>0 ? prixLED() : 0;

    // PU interne
    let pu = cTole + cFix + cPMMA + cLED;

    // +50 % dans le module
    const puPublic = pu * 1.5;

    // (la remise globale viendra depuis la page principale plus tard)
    const remiseGlobale = 0;
    const puNet = puPublic * (1 - remiseGlobale/100);
    const total = puNet * Math.max(1, parseInt(qte.value||1,10));

    // Affichage
    $('#puPublic').textContent = fmt(puPublic) + ' €';
    $('#puNet').textContent = fmt(puNet) + ' €';
    $('#totalNet').textContent = fmt(total) + ' €';
  }

  // écouteurs
  [matiere, ral, Lmm, Hmm, corniereMl, pmma, qte].forEach(el=>{
    el.addEventListener('input', ()=>{ majUI(); calcAndRender(); });
    el.addEventListener('change', ()=>{ majUI(); calcAndRender(); });
  });
  [...fixRadios, ...ajourRadios, ...ledRadios].forEach(r=>{
    r.addEventListener('change', ()=>{ majUI(); calcAndRender(); });
  });

  // init
  showStep(0);
  majUI();
  calcAndRender();

  // Ajouter au devis (placeholder tant que le store global n’est pas branché)
  $('#btnAjouter').onclick = ()=>{
    alert('Ligne prête à être envoyée au devis global (prix public +50% inclus).');
  };
</script>
</body>
</html>
