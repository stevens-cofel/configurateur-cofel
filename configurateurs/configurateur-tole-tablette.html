<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Configurateur Tôle Tablette – Cofel</title>

<!-- Styles communs Cofel (si présents) -->
<link rel="stylesheet" href="../styles/cofel.css" />
<link rel="stylesheet" href="../styles/cofel-config.css" />

<style>
  /* ====== DA Cofel : verre violet (même esprit que tes autres configurateurs validés) ====== */
  :root{
    --violet:#5a2d82;
    --violet-2:#7838a7;
    --glass: rgba(255,255,255,.08);
    --glass-hr: rgba(255,255,255,.14);
    --txt:#f5f7ff;
    --txt-dim:#e6e6ff;
    --accent:#c9b7ff;
    --radius:18px;
    --blur:18px;
    --shadow: 0 10px 30px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--txt);
    font-family:-apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, Arial, sans-serif;
    background:
      radial-gradient(800px 500px at 20% -10%, rgba(255,255,255,.10), transparent 60%),
      radial-gradient(800px 500px at 110% 10%, rgba(255,255,255,.08), transparent 60%),
      linear-gradient(135deg, var(--violet), var(--violet-2));
  }

  /* ===== Header (cohérent accueil) ===== */
  .cofel-header{
    position:sticky; top:0; z-index:1000; color:#fff;
    background: linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.06));
    border-bottom:1px solid rgba(255,255,255,.18);
    backdrop-filter: blur(var(--blur));
  }
  .cofel-header .row{
    max-width:1200px; margin:0 auto; display:flex; align-items:center; gap:16px; padding:10px 14px;
  }
  .cofel-back{
    color:#fff; text-decoration:none; border:1px solid rgba(255,255,255,.35);
    padding:8px 12px; border-radius:12px; backdrop-filter: blur(10px);
  }
  .cofel-brand{display:flex; align-items:center; gap:10px}
  .cofel-brand img{height:36px; border-radius:8px; object-fit:cover}
  .cofel-title{font-size:18px; margin:0}

  .cofel-container{max-width:1100px; margin:0 auto; padding:18px}

  h1{margin:8px 0 14px; text-align:center; letter-spacing:.2px}

  /* ===== Cartes / fieldsets “verre” ===== */
  fieldset{
    border:1px solid rgba(255,255,255,.2);
    border-radius:20px; padding:16px; margin:16px 0;
    background: linear-gradient(180deg, rgba(255,255,255,.16), rgba(255,255,255,.06));
    box-shadow: var(--shadow); backdrop-filter: blur(var(--blur));
    overflow:visible; /* pour que les menus déroulants passent au-dessus */
  }
  legend{
    padding:0 10px; font-weight:800; color:#fff; letter-spacing:.2px;
  }

  label{font-weight:700; font-size:13px; color:var(--accent); display:block; margin-top:10px}

  input[type="number"],
  input[type="text"],
  select{
    width:100%; margin-top:6px; padding:12px 12px; min-height:42px;
    background: rgba(255,255,255,.10); color:var(--txt);
    border:1px solid rgba(255,255,255,.24); border-radius:14px; outline:none;
    transition: border-color .18s ease, background .18s ease, box-shadow .18s ease;
    position:relative; z-index:1;
  }
  input::placeholder{color:#f0edff; opacity:.75}
  input:focus, select:focus{
    border-color: rgba(255,255,255,.38);
    background: rgba(255,255,255,.16);
    box-shadow: 0 0 0 4px rgba(255,255,255,.08) inset;
  }

  /* Menu déroulant harmonisé (fond violet) */
  select{ appearance:auto; }
  select option{ background:#3c1f61; color:#fff; }
  /* Empêche que ça passe sous les éléments voisins */
  fieldset, .radio-row, .glass-card{ position:relative; z-index:1; }
  select:focus{ z-index:1001; }

  .grid{display:grid; gap:16px}
  @media(min-width:820px){ .grid{grid-template-columns:1fr 1fr} }

  .radio-row{
    display:flex; gap:10px; flex-wrap:wrap; margin-top:8px;
  }
  .radio-row label,
  .pill{
    display:flex; align-items:center; gap:10px; cursor:pointer;
    padding:10px 14px; border-radius:14px;
    background: linear-gradient(180deg, rgba(255,255,255,.18), rgba(255,255,255,.08));
    border:1px solid rgba(255,255,255,.24); color:#fff; font-weight:700;
    box-shadow: var(--shadow);
  }
  .radio-row input[type="radio"],
  .radio-row input[type="checkbox"]{ accent-color:#cbb3ff; width:18px; height:18px }

  .hint{ color:var(--txt-dim); font-size:12px; margin-top:6px }

  .hidden{display:none}

  /* ===== Résultats ===== */
  .result{
    background: linear-gradient(180deg, rgba(255,255,255,.16), rgba(255,255,255,.06));
    border:1px solid rgba(255,255,255,.24);
    border-radius:20px; padding:16px; margin-top:18px; text-align:center; font-size:18px;
    box-shadow: var(--shadow); backdrop-filter: blur(var(--blur));
  }
  .result span{ font-weight:800; }

  /* ===== Bouton flottant ===== */
  #btnAddDevis{
    position:fixed; right:20px; bottom:20px; padding:12px 18px;
    background:#fff; color:#0b0b0b; border:none; border-radius:14px;
    box-shadow:0 10px 24px rgba(0,0,0,.25); cursor:pointer; font-weight:800; z-index:2000;
    transition: transform .16s ease, box-shadow .16s ease, opacity .16s ease;
  }
  #btnAddDevis:active{ transform: translateY(1px); box-shadow: 0 6px 16px rgba(0,0,0,.28); }

  /* ===== Footer ===== */
  .cofel-footer{
    color:#f3ecff; font-size:12px; text-align:center; padding:24px 10px; opacity:.9;
  }
</style>
</head>
<body>

<!-- Bandeau -->
<header class="cofel-header">
  <div class="row">
    <a class="cofel-back" href="../index.html">⬅ Retour accueil (Devis)</a>
    <div class="cofel-brand">
      <img src="../assets/logo cofel.jpg" alt="Cofel" />
      <h1 class="cofel-title">Configurateur — Tôle Tablette</h1>
    </div>
  </div>
</header>

<div class="cofel-container">
  <h1>Tôle Tablette</h1>

  <!-- Quantité -->
  <fieldset>
    <legend>Quantité</legend>
    <div class="grid">
      <div>
        <label for="quantite">Quantité</label>
        <input type="number" id="quantite" min="1" value="1" />
      </div>
    </div>
  </fieldset>

  <!-- Dimensions -->
  <fieldset>
    <legend>Dimensions</legend>
    <div class="grid">
      <div>
        <label for="largeur">Largeur (mm)</label>
        <input type="number" id="largeur" placeholder="Ex : 1500" min="1" />
      </div>
      <div>
        <label for="hauteur">Hauteur (mm)</label>
        <input type="number" id="hauteur" placeholder="Ex : 500" min="1" />
      </div>
      <div>
        <label>Surface tôle (auto)</label>
        <input id="surfaceCalc" disabled value="0.000 m²" />
        <div class="hint">Surface = (L × H) / 1 000 000</div>
      </div>
    </div>
    <!-- ✅ Ajout de l'avertissement demandé -->
    <div class="hint" style="margin-top:8px">⚠️ Prendre en compte le développé de la tôle avec plis lors de la saisie des dimensions.</div>
  </fieldset>

  <!-- Matière tôle tablette -->
  <fieldset>
    <legend>Matière</legend>
    <div class="grid">
      <div>
        <label>Matière de la tôle tablette</label>
        <div class="radio-row" id="matiereRow">
          <!-- ⚠️ Tarifs retirés visuellement -->
          <label><input type="radio" name="matiere" value="brut"> Alu 20/10 <b>brut</b></label>
          <label><input type="radio" name="matiere" value="prelaque" checked> <b>Prélaqué</b></label>
          <label><input type="radio" name="matiere" value="laque"> Alu 20/10 <b>laqué</b></label>
        </div>
      </div>
      <div></div>
    </div>
  </fieldset>

  <!-- Ajourage + PMMA + LED -->
  <fieldset>
    <legend>Ajourage / Remplissage</legend>

    <label class="radio-row" style="padding:0;border:none">
      <span><input type="checkbox" id="optAjour" /> Ajourage de la face avant</span>
    </label>

    <div id="blockAjour" class="hidden" style="margin-top:8px">
      <div class="grid">
        <div>
          <label for="pmmaSurface">Surface ajourée en m²</label>
          <div class="radio-row" style="gap:8px">
            <input type="number" id="pmmaSurface" min="0" step="0.001" placeholder="Ex : 0.75" style="flex:1" />
          </div>
          <!-- ⚠️ Tarif retiré visuellement -->
          <div class="hint">Ajourage : /m² × surface ajourée. Les LED utilisent aussi cette surface.</div>
        </div>
        <div>
          <!-- ⚠️ "(si trouvé dans le CSV)" retiré -->
          <label for="pmmaSel">Type de PMMA</label>
          <select id="pmmaSel"><option value="">(aucun)</option></select>
        </div>
      </div>

      <div class="grid">
        <div>
          <label class="radio-row" style="padding:0;border:none">
            <span><input type="checkbox" id="optLED" /> Éclairage LED (utilise surface ajourée)</span>
          </label>
        </div>
      </div>
    </div>
  </fieldset>

  <!-- Fixation -->
  <fieldset>
    <legend>Fixation de la tôle tablette (choix exclusif)</legend>
    <div class="radio-row">
      <label><input type="radio" name="fixation" value="aucune" checked> Aucune</label>
      <label><input type="radio" name="fixation" value="boite"> Boîte à chaussure</label>
      <label><input type="radio" name="fixation" value="chassis"> Châssis tube 30×30</label>
      <label><input type="radio" name="fixation" value="corniere"> Cornière</label>
    </div>

    <div id="fixBoite" class="hidden">
      <div class="radio-row" style="margin-top:8px">
        <!-- ⚠️ Tarifs retirés visuellement -->
        <label><input type="radio" name="boiteMat" value="brut" checked> Boîte en alu 20/10 <b>brut</b></label>
        <label><input type="radio" name="boiteMat" value="laque"> Boîte en alu 20/10 <b>laqué</b></label>
      </div>
      <div class="hint">La boîte a la <b>même dimension</b> que la tôle.</div>
    </div>

    <div id="fixChassis" class="hidden">
      <!-- ⚠️ Tarifs retirés visuellement -->
      <!-- ⬇️ Masqué visuellement, conservé au DOM pour ne rien casser -->
      <div class="hint hidden" style="margin-top:8px">
        Linéaire châssis = <b>périmètre</b> (2×(L+H)).<br />
        Goussets = minimum 4, puis +4 par m² (arrondi à l’entier sup.).
      </div>
      <div class="hidden" style="margin-top:8px">
        <label for="goussetPrixU">Gousset €/u</label>
        <input type="number" id="goussetPrixU" placeholder="€/u (auto/manuel)" min="0" step="0.01" />
      </div>
    </div>

    <div id="fixCorniere" class="hidden">
      <!-- ⚠️ Tarifs retirés visuellement -->
      <div class="hint">Longueur = périmètre (2×(L+H)).</div>
    </div>
  </fieldset>

  <!-- Résultats -->
  <div class="result">
    <p>Prix unitaire HT : <span id="prixUHT">0,00</span> €</p>
    <p>Total HT : <span id="prixHT">0,00</span> €</p>
    <p>Total TTC : <span id="prixTTC">0,00</span> €</p>
  </div>
</div>

<!-- Pied de page -->
<footer class="cofel-footer">
  © Cofel — ZA du Perquoi, 72560 Changé — SIRET 927 659 458 00024 — TVA FR80927659458
</footer>

<!-- ======= LOGIQUE (inchangée, simplement rendue invisible côté tarifs) ======= -->
<script>
/*** CONFIG ***/
const TVA = 0.20; // fixe 20 %
const CSV_URL = "https://raw.githubusercontent.com/stevens-cofel/configurateur-cofel/refs/heads/main/toles_tabelette";
const CORNIERE_PRICE_ML = 6.5;   // €/ml (interne)
const CHASSIS_PRICE_ML  = 10.5;  // €/ml (interne)
const MATERIAL_PRICE_M2 = {       // €/m² (interne)
  brut: 71.5,
  prelaque: 89.0,
  laque: 105.0
};
const BOX_PRICE_M2 = {            // €/m² (interne)
  brut: 71.5,
  laque: 105.0
};
const AJOURAGE_PRICE_M2 = 99.0;   // €/m² (interne)
const UPLIFT_PUBLIC = 2.0;        // affichage public x2 (non affiché visuellement)

/*** STATE / DOM ***/
const $ = id => document.getElementById(id);
let HEADS=[], ROWS=[], MAP=null;

const elQ=$('quantite');
const elL=$('largeur'), elH=$('hauteur'), elSurf=$('surfaceCalc');

const elOptAjour=$('optAjour'), elBlockAjour=$('blockAjour');
const elPMMA=$('pmmaSel'), elPMMASurface=$('pmmaSurface');

const elLED=$('optLED');

const fixRadios=[...document.querySelectorAll('input[name="fixation"]')];
const elFixBoite=$('fixBoite'), elFixChassis=$('fixChassis'), elFixCorniere=$('fixCorniere');
const elGoussetPrixU=$('goussetPrixU');

const elUHT=$('prixUHT'), elHT=$('prixHT'), elTTC=$('prixTTC');

/*** UTILS ***/
function norm(s){return String(s||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');}
function numFR(v){
  if(v===null||v===undefined) return NaN;
  let s=String(v).trim().replace(/€/g,'').replace(/[\u00A0\u202F]/g,'').replace(/\s+/g,'');
  if(s.includes(',') && s.includes('.')) s=s.replace(/\./g,'');
  s=s.replace(',', '.');
  const m=s.match(/-?\d+(\.\d+)?/);
  return m?parseFloat(m[0]):NaN;
}
function euro(n){return (isFinite(n)?n:0).toFixed(2).replace('.', ',');}
function areaM2(Lmm,Hmm){return (Math.max(0,Number(Lmm||0))*Math.max(0,Number(Hmm||0)))/1e6;}
function perimeterMeters(Lmm,Hmm){return 2*((Lmm/1000)+(Hmm/1000));}

/*** CSV PARSER ROBUSTE ***/
function parseCSVAuto(text){
  const raw = String(text||'').replace(/^\uFEFF/,'');
  const lines = raw.split(/\r\n|\n|\r/).filter(l=>l.trim()!=='');
  if(!lines.length) return {rawHeads:[], rows:[]};
  const first = lines[0];
  const sep = ((first.match(/;/g)||[]).length > (first.match(/,/g)||[]).length) ? ';' : ',';

  function parseLine(line){
    const out=[]; let cur=''; let inQ=false;
    for(let i=0;i<line.length;i++){
      const ch=line[i], nx=line[i+1];
      if(ch==='"'){ if(inQ && nx==='"'){cur+='"'; i++;} else inQ=!inQ; }
      else if(ch===sep && !inQ){ out.push(cur); cur=''; }
      else{ cur+=ch; }
    }
    out.push(cur);
    return out;
  }
  const rawHeads=parseLine(first).map(s=>s.replace(/^"+|"+$/g,'').trim());
  const rows = lines.slice(1).map(line=>{
    const cells=parseLine(line).map(s=>s.replace(/^"+|"+$/g,'').trim());
    const o={}; rawHeads.forEach((h,i)=>o[h]=cells[i]??'' ); return o;
  });
  return {rawHeads, rows};
}

/*** MAPPING ***/
function buildMapping(heads){
  const n = heads.map(h=>norm(h));
  const find=(needle)=>{ const i=n.indexOf(norm(needle)); return i>=0?heads[i]:null; };
  const like=(...res)=>{ for(let i=0;i<n.length;i++){ const k=n[i]; if(res.every(r=>r.test(k))) return heads[i]; } return null; };

  return {
    TITRE:  find('titre') || like(/titre/),
    PROD:   find('produit') || like(/produit/),
    PROD_REL: like(/produit.*lie/),
    ETAPE:  find('nom étape') || like(/nom.*etape|etape/),
    MIN:    find('temps en minute') || like(/minute/),
    TH:     find('tauxhoraire_eur_h') || like(/taux.*horaire|eur.*h/),
    MAT:    find('coutmatiere_eur') || like(/matiere.*eur/),
    FORMULE: find('formule cout') || like(/formule/),
    TARIF_M2: find('tarif_m2_eur') || like(/tarif.*m2/),
    TARIF_ML: find('tarif mètre linéaire en eur') || like(/tarif.*metre.*lineaire/),
    OBLIG:  find('obligatoire') || like(/oblig/),
    COMM:   find('commentaire') || like(/comment/),
    ECLAIR: like(/(led|eclair|éclair)/)
  };
}

/*** CHARGEMENT CSV ***/
async function loadCSV(){
  try{
    const r = await fetch(CSV_URL, {cache:'no-store'});
    if(!r.ok) throw new Error('HTTP '+r.status);
    const txt = await r.text();
    const {rawHeads, rows} = parseCSVAuto(txt);
    HEADS=rawHeads; ROWS=rows; MAP=buildMapping(HEADS);
    refreshPMMACatalog(ROWS);
    compute();
  }catch(e){
    console.error('Erreur CSV:', e?.message||e);
  }
}

/*** CATALOGUES (PMMA : on garde le prix en data-* mais on ne l’affiche pas) ***/
function refreshPMMACatalog(rows){
  const pmmas = new Map();
  rows.forEach(r=>{
    const s = norm([r[MAP.ETAPE], r[MAP.PROD], r[MAP.TITRE], r[MAP.COMM]].join(' '));
    if(/pmma/.test(s)){
      const label = (r[MAP.ETAPE] || r[MAP.PROD] || 'PMMA').trim();
      const priceM2 = numFR(r[MAP.TARIF_M2]);
      if(label) pmmas.set(label, isFinite(priceM2)?priceM2:NaN);
    }
  });
  const cur=elPMMA.value; elPMMA.innerHTML='';
  const o0=document.createElement('option'); o0.value=''; o0.textContent='(aucun)'; elPMMA.appendChild(o0);
  [...pmmas.entries()].forEach(([label, val])=>{
    const o=document.createElement('option');
    o.value=label;
    o.textContent = label;               // <-- texte sans tarif
    o.dataset.price = isFinite(val)?val:''; // <-- tarif conservé en data-* pour le calcul
    elPMMA.appendChild(o);
  });
  if([...pmmas.keys()].includes(cur)) elPMMA.value=cur;
}

/*** AUTO-FIND PRICES DANS LE CSV ***/
function autoFindPrice(keywordRe, type='m2'){
  if(!ROWS.length) return NaN;
  for(const r of ROWS){
    const bag = norm([r[MAP.ETAPE], r[MAP.PROD], r[MAP.TITRE], r[MAP.COMM]].join(' '));
    if(!keywordRe.test(bag)) continue;
    if(type==='m2'){ const v=numFR(r[MAP.TARIF_M2]); if(isFinite(v)) return v; }
    if(type==='ml'){ const v=numFR(r[MAP.TARIF_ML]); if(isFinite(v)) return v; }
    if(type==='u'){  const v=numFR(r[MAP.MAT]);     if(isFinite(v)) return v; }
  }
  return NaN;
}

/*** CALCUL ***/
function currentSurface(){
  const A = areaM2(elL.value, elH.value);
  elSurf.value = `${A.toFixed(3)} m²`;
  return A;
}
function currentPerimeter(){ return perimeterMeters(elL.value, elH.value); }

function compute(){
  // === Remise automatique client ===
  let remiseClient = 1;
  try {
      const p = JSON.parse(localStorage.getItem('cofel_client_profile'));
      if (p && typeof p.discountRate === 'number') remiseClient = 1 - p.discountRate;
  } catch(e){}

  const Q = Math.max(1, Number(elQ.value||1));
  const A = currentSurface();      // m² tôle
  const P = currentPerimeter();    // m périmètre

  // Matière tôle (interne)
  const mat = (document.querySelector('input[name="matiere"]:checked')||{}).value || 'prelaque';
  const matM2 = MATERIAL_PRICE_M2[mat] ?? 0;
  const base_interne = matM2 * A;

  // Ajourage / PMMA / LED (internes)
  let ajourage_interne=0, pmma_interne=0, led_interne=0, pmmaSurf=0;
  if(elOptAjour.checked){
    pmmaSurf = Number(elPMMASurface.value||0); // m²
    ajourage_interne = AJOURAGE_PRICE_M2 * Math.max(0, pmmaSurf); // 99 €/m² × surface PMMA (interne)

    const selectedPMMA = elPMMA.options[elPMMA.selectedIndex];
    let pmmaM2 = selectedPMMA && selectedPMMA.dataset.price ? Number(selectedPMMA.dataset.price) : NaN;
    if(isFinite(pmmaM2)) pmma_interne = pmmaM2 * pmmaSurf;

    if(elLED.checked){
      let ledM2 = autoFindPrice(/(led|eclairage|éclairage)/,'m2');
      if(isFinite(ledM2)) led_interne = ledM2 * pmmaSurf; // même surface que PMMA
    }
  }

  // Fixations (interne)
  const fixVal = (document.querySelector('input[name="fixation"]:checked')||{}).value || 'aucune';
  let fix_interne=0, nbGoussets=0;

  if(fixVal==='boite'){
    const boiteMat = (document.querySelector('input[name="boiteMat"]:checked')||{}).value || 'brut';
    const boiteM2 = BOX_PRICE_M2[boiteMat] || 0;
    fix_interne = boiteM2 * A;

  }else if(fixVal==='chassis'){
    const chLinCost = CHASSIS_PRICE_ML * P; // périmètre × (interne)
    nbGoussets = Math.max(4, Math.ceil(4 + 4 * A)); // min 4 puis +4/m²
    let gusU = autoFindPrice(/gousset/,'u');
    if(!isFinite(gusU)) gusU = Number(elGoussetPrixU?.value||0);
    const gusCost = (isFinite(gusU)?gusU:0) * nbGoussets;
    fix_interne = chLinCost + gusCost;

  }else if(fixVal==='corniere'){
    fix_interne = CORNIERE_PRICE_ML * P; // périmètre × (interne)
  }

  // ** Total interne **
  const unitHT_interne = base_interne + ajourage_interne + pmma_interne + led_interne + fix_interne;

  // ** Conversion → affichage public (x2) **
  const unitHT_public = unitHT_interne * UPLIFT_PUBLIC * remiseClient;
  const totalHT_public = unitHT_public * Q;
  const totalTTC_public = totalHT_public * (1+TVA);

  // Affichage (PUBLIC)
  elUHT.textContent = euro(unitHT_public);
  elHT.textContent  = euro(totalHT_public);
  elTTC.textContent = euro(totalTTC_public);
}

/*** UI TOGGLES ***/
function toggleBlocks(){
  elBlockAjour.classList.toggle('hidden', !elOptAjour.checked);
  const fixVal = (document.querySelector('input[name="fixation"]:checked')||{}).value || 'aucune';
  elFixBoite.classList.toggle('hidden', fixVal!=='boite');
  elFixChassis.classList.toggle('hidden', fixVal!=='chassis');
  elFixCorniere.classList.toggle('hidden', fixVal!=='corniere');
}

/*** EVENTS ***/
['input','change'].forEach(evt=>{
  [
    quantite, largeur, hauteur,
    ...document.querySelectorAll('input[name="matiere"]'),
    optAjour, pmmaSel, pmmaSurface,
    optLED, ...fixRadios, goussetPrixU,
    ...document.querySelectorAll('input[name="boiteMat"]')
  ].forEach(el=>{
    // el peut être undefined (ex: si un id n'existe pas) → on protège l'accès
    if(!el || !el.addEventListener) return;
    el.addEventListener(evt, e=>{
      toggleBlocks();
      compute();
    });
  });
});

/*** INIT ***/
loadCSV();
toggleBlocks();
compute();
</script>

<!-- ===== Intégration Devis ===== -->
<script src="../js/devis-core.js"></script>

<button id="btnAddDevis">➕ Ajouter au devis</button>

<script>
(function(){
  const btn = document.getElementById('btnAddDevis');
  if(!btn) return;

  function parseTotalHTPublic(){
    const txt = document.getElementById('prixHT').innerText.trim(); // "1 234,56"
    return Number(txt.replace(/\s/g,'').replace(',', '.')) || 0;
  }

  btn.addEventListener('click', () => {
    try{
      if(!window.Devis) throw new Error("Moteur de devis introuvable.");

      const qte = Math.max(1, Number(document.getElementById('quantite').value || 1));
      const Lmm = Math.max(0, Number(document.getElementById('largeur').value || 0));
      const Hmm = Math.max(0, Number(document.getElementById('hauteur').value || 0));
      if(!(Lmm>0) || !(Hmm>0)){ alert("Renseigne largeur et hauteur."); return; }

      // Matière
      const mat = (document.querySelector('input[name="matiere"]:checked')||{}).value || 'prelaque';

      // Ajourage / PMMA / LED
      const ajour = document.getElementById('optAjour').checked;
      const pmmaSel = document.getElementById('pmmaSel');
      const pmmaLabel = pmmaSel && pmmaSel.value ? pmmaSel.value : '';
      const pmmaSurf = Number(document.getElementById('pmmaSurface').value || 0);
      const led = document.getElementById('optLED').checked;

      // Fixation
      const fixVal = (document.querySelector('input[name="fixation"]:checked')||{}).value || 'aucune';
      const boiteMat = (document.querySelector('input[name="boiteMat"]:checked')||{}).value || '';
      const gusU = document.getElementById('goussetPrixU')?.value || '';

      // Total et PU public
      const total_ht_public = parseTotalHTPublic();
      if (total_ht_public <= 0){ alert("Le prix est à 0, vérifie les paramètres."); return; }
      const pu_public_ht = qte>0 ? (total_ht_public / qte) : 0;

      // Désignation lisible
      const parts = [
        `Tôle Tablette`,
        `L ${Lmm} × H ${Hmm} mm`,
        `Matière: ${mat}`
      ];

      if (ajour){
        const pmmaBits = [];
        if (pmmaLabel) pmmaBits.push(pmmaLabel);
        if (pmmaSurf>0) pmmaBits.push(`${pmmaSurf.toFixed(3)} m²`);
        parts.push(`Ajouré${pmmaBits.length? ' + PMMA ('+pmmaBits.join(' · ')+')':''}`);
        if (led) parts.push(`LED`);
      }

      if (fixVal==='boite'){
        parts.push(`Fixation: boîte${boiteMat? ' ('+boiteMat+')':''}`);
      }else if (fixVal==='chassis'){
        parts.push(`Fixation: châssis tube 30×30${gusU? ' · gousset '+gusU+' €/u':''}`);
      }else if (fixVal==='corniere'){
        parts.push(`Fixation: cornière`);
      }else{
        parts.push(`Fixation: aucune`);
      }

      const designation = parts.join(' — ');

      Devis.addLine({
        type: 'Tôle Tablette',
        designation,
        quantite: qte,
        pu_public_ht: Number(pu_public_ht.toFixed(2))
      });

      alert(`✅ Ligne ajoutée au devis !\n${designation}\nQté : ${qte}\nPU HT : ${pu_public_ht.toFixed(2)} €`);
    }catch(err){
      console.error(err);
      alert('Erreur lors de l’ajout au devis : ' + err.message);
    }
  });
})();
</script>

</body>
</html>
