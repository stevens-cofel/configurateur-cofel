<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Configurateur ‚Äî Lettres Alu 20/10 & Dibond 3 mm | Cofel</title>

<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

<style>
  /* ===================== THEME (Cofel ‚Äì verre + violets) ===================== */
  :root{
    --cofel:#5a2d82; --cofel-2:#7838a7;
    --violet:#6b39a0; --violet-2:#8752c1;
    --violet-soft:#c9b7ff;
    --violet-ui:#bda3ff;           /* violet clair des cartes */
    --violet-ui-pressed:#a88fff;
    --txt:#f5f7ff; --txt-dim:#e6e6ff; --accent:#c9b7ff;
    --radius:18px; --blur:18px; --shadow:0 10px 30px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--txt);
    font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","Segoe UI",Roboto,Arial,sans-serif;
    background:
      radial-gradient(800px 500px at 20% -10%, rgba(255,255,255,.10), transparent 60%),
      radial-gradient(800px 500px at 110% 10%, rgba(255,255,255,.08), transparent 60%),
      linear-gradient(135deg, var(--cofel), var(--cofel-2));
  }

  /* ===================== HERO ===================== */
  .hero{position:relative;z-index:1;padding:40px 20px 24px;}
  .hero-inner{max-width:1200px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;gap:16px;}
  .brand{
    display:flex;align-items:center;gap:14px;
    backdrop-filter:blur(var(--blur));
    background:linear-gradient(180deg,rgba(255,255,255,.14),rgba(255,255,255,.06));
    border:1px solid rgba(255,255,255,.18);
    padding:10px 14px;border-radius:14px;box-shadow:var(--shadow);
  }
  .brand img{height:42px;width:auto;border-radius:10px}
  .brand h1{font-size:clamp(18px,2.6vw,22px);margin:0}
  .tagline{max-width:1200px;margin:18px auto 0;padding:0 20px;color:var(--txt-dim)}

  /* ===================== LAYOUT / CARDS ===================== */
  .wrap{max-width:1200px;margin:26px auto;padding:0 20px 40px;}
  .panel{
    background:linear-gradient(180deg,rgba(255,255,255,.16),rgba(255,255,255,.06));
    border:1px solid rgba(255,255,255,.2);
    border-radius:20px;padding:18px;box-shadow:var(--shadow);backdrop-filter:blur(var(--blur));
    margin-bottom:18px;
  }
  .panel h2{margin:0 0 12px;font-size:clamp(18px,2.4vw,22px);letter-spacing:.2px}
  .card{
    background:linear-gradient(180deg,rgba(255,255,255,.14),rgba(255,255,255,.06));
    border:1px solid rgba(255,255,255,.18);
    border-radius:16px;padding:14px;box-shadow:var(--shadow);
  }
  .grid{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
  .muted{color:var(--txt-dim);font-size:12px;margin-top:6px;white-space:pre-wrap}
  footer{color:#f3ecff;font-size:12px;text-align:center;padding:24px 10px;opacity:.9;}

  /* ===================== FORM CONTROLS ===================== */
  label{font-weight:700;font-size:13px;color:var(--accent);}
  input[type="number"], select{
    width:100%; padding:10px 12px; margin-top:6px;
    border-radius:12px; outline:none; color:var(--txt);
    border:1px solid rgba(255,255,255,.22);
    background:
      linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.06)),
      linear-gradient(135deg, var(--violet-soft), var(--violet-2));
    box-shadow:var(--shadow);
    transition:border-color .18s, box-shadow .18s;
  }
  input:focus, select:focus{
    border-color:rgba(255,255,255,.34);
    box-shadow:0 0 0 3px rgba(201,183,255,.25), var(--shadow);
  }

  fieldset{
    border:1px solid rgba(255,255,255,.25);
    border-radius:16px;
    background:var(--violet-ui);
    box-shadow:var(--shadow);
    padding:10px; margin-top:10px;
  }
  fieldset legend{padding:0 6px;color:var(--txt);font-weight:700;}

  /* ===================== CHECKBOX / RADIO ===================== */
  .option-item{
    display:flex;align-items:center;gap:10px;cursor:pointer;
    border-radius:12px;padding:10px 12px;
    border:1px solid rgba(255,255,255,.25);
    background:var(--violet-ui);
    box-shadow:var(--shadow);
    margin-bottom:8px;
    color:var(--txt);
  }
  .option-item input{
    appearance:none;-webkit-appearance:none;
    width:20px;height:20px;border-radius:6px;
    border:1px solid rgba(255,255,255,.7);
    background:rgba(255,255,255,.15);
    position:relative;
  }
  .option-item input:checked{
    background:var(--violet-2);
    border-color:#fff;
  }
  .option-item input:checked::after{
    content:"";position:absolute;inset:3px 5px 5px 3px;
    border-right:3px solid #fff;border-bottom:3px solid #fff;transform:rotate(45deg);
  }

  /* ===================== RESULT + BUTTONS ===================== */
  .result{
    text-align:center;padding:16px;
    background:var(--violet-ui);
    border:1px solid rgba(255,255,255,.22); border-radius:16px;
    box-shadow:0 8px 22px rgba(0,0,0,.28);
    font-size:18px;
  }
  .result b{font-size:20px}
  .btn{
    appearance:none;border:none;cursor:pointer;font-weight:700;
    color:#0b0b0b;background:#fff;border-radius:12px;padding:10px 14px;
    box-shadow:0 10px 24px rgba(0,0,0,.25);
    transition:transform .16s, box-shadow .16s;
  }
  .btn:active{transform:translateY(1px);box-shadow:0 6px 16px rgba(0,0,0,.28);}
  .btn-ghost{background:transparent;color:var(--txt);border:1px solid rgba(255,255,255,.24);}
</style>
</head>
<body>

<!-- ===================== HERO ===================== -->
<div class="hero">
  <div class="hero-inner">
    <div class="brand">
      <img src="../assets/logo cofel.jpg" alt="Cofel" />
      <h1>Configurateur ‚Äî Lettres Alu 20/10 & Dibond 3 mm</h1>
    </div>
    <a class="brand" href="../index.html" style="text-decoration:none;color:inherit">‚¨Ö Retour aux configurateurs</a>
  </div>
  <div class="tagline">Saisissez la hauteur, choisissez la finition et les options. Le prix se met √† jour automatiquement.</div>
</div>

<!-- ===================== CONTENU ===================== -->
<main class="wrap">
  <section class="panel" aria-label="Param√®tres">
    <h2>‚öôÔ∏è Param√®tres</h2>

    <div class="card grid">
      <div>
        <label for="categorie">Cat√©gorie</label>
        <select id="categorie">
          <option value="alu20">Lettre aluminium 20/10</option>
          <option value="dibond3">Lettre alu/PVC 3 mm (type Dibond)</option>
        </select>
      </div>
      <div>
        <label for="quantite">Quantit√©</label>
        <input type="number" id="quantite" min="1" value="1" />
      </div>
    </div>

    <div class="card grid">
      <div>
        <label for="hauteur">Hauteur (mm)</label>
        <input type="number" id="hauteur" placeholder="Ex : 275" min="1" />
        <div id="helpRanges" class="muted"></div>
      </div>

      <div>
        <fieldset>
          <legend>Finition</legend>
          <label class="option-item">
            <input type="radio" name="finition" id="finitionBrut" value="brut" checked />
            <span>Brut</span>
          </label>
          <label class="option-item">
            <input type="radio" name="finition" id="finitionLaque" value="laque" />
            <span>Laqu√©</span>
          </label>
        </fieldset>

        <fieldset>
          <legend>Suppl√©ment</legend>
          <label class="option-item">
            <input type="checkbox" id="optFixation" />
            <span>Fixations</span>
          </label>
        </fieldset>
      </div>
    </div>
  </section>

  <section class="panel" aria-label="R√©capitulatif">
    <h2>üßæ R√©capitulatif</h2>
    <div class="result">
      <p>Prix HT : <b><span id="prixHT">0,00</span> ‚Ç¨</b></p>
      <p>Prix TTC : <b><span id="prixTTC">0,00</span> ‚Ç¨</b></p>
      <div class="muted">TVA 20 % incluse dans le calcul.</div>
    </div>

    <div style="margin-top:16px;display:flex;gap:10px;flex-wrap:wrap;">
      <button id="btnAddDevis" class="btn">‚ûï Ajouter au devis</button>
      <button id="btnReset"   class="btn btn-ghost">üîÑ R√©initialiser</button>
    </div>
  </section>
</main>

<footer>
  ¬© Cofel ‚Äî ZA du Perquoi, 72560 Chang√© ‚Äî SIRET 927 659 458 00024 ‚Äî TVA FR80927659458
</footer>

<!-- ===================== JS ===================== -->
<script>
/* ===== PARAMS ===== */
const TVA = 0.20;
const UPLIFT_PUBLIC = 2.0; // interne ‚Üí affichage (non montr√© √† l‚Äôutilisateur)
const CSV_URL = "https://raw.githubusercontent.com/stevens-cofel/configurateur-cofel/refs/heads/main/lettres/Lettre%20alu%2020_10%20%C3%A8me%20ou%20Type%20Dibond%203%20mm.csv";

/* ===== STATE / DOM ===== */
let HEADS=[], ROWS=[], MAP=null;
const $ = id => document.getElementById(id);
const elH = $("hauteur");
const elQ = $("quantite");
const elFix = $("optFixation");
const elFBrut = $("finitionBrut");
const elFLaque = $("finitionLaque");
const elPrixHT = $("prixHT");
const elPrixTTC = $("prixTTC");
const elHelp = $("helpRanges");

/* ===== Utils ===== */
function normKey(k){
  return String(k||'').toLowerCase()
    .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
    .replace(/[^a-z0-9]+/g,'').trim();
}
function numFR(v){
  if(v==null) return NaN;
  let s = String(v).trim()
    .replace(/‚Ç¨/g,'').replace(/[\u00A0\u202F]/g,'').replace(/\s+/g,'');
  if(s.includes(',') && s.includes('.')) s = s.replace(/\./g,'');
  s = s.replace(',', '.');
  const m = s.match(/-?\d+(\.\d+)?/);
  return m ? parseFloat(m[0]) : NaN;
}
function euro(n){ return (isFinite(n)?n:0).toFixed(2).replace('.', ','); }

/* ===== CSV ===== */
function parseCSVAuto(text){
  const lines = text.replace(/^\uFEFF/,'').split(/\r?\n/).filter(l=>l.trim()!=='');
  if(!lines.length) return {rawHeads:[],rows:[]};
  const first = lines[0];
  const sep = ((first.match(/;/g)||[]).length > (first.match(/,/g)||[]).length) ? ';' : ',';
  const parseLine = (line)=>{
    const out=[]; let cur=''; let inQ=false;
    for(let i=0;i<line.length;i++){
      const ch=line[i], nx=line[i+1];
      if(ch === '"'){
        if(inQ && nx === '"'){ cur+='"'; i++; } else inQ = !inQ;
      } else if(ch === sep && !inQ){
        out.push(cur); cur='';
      } else cur += ch;
    }
    out.push(cur); return out;
  };
  const rawHeads = parseLine(lines[0]).map(s=>s.replace(/^"+|"+$/g,'').trim());
  const rows = lines.slice(1).map(line=>{
    const cells = parseLine(line).map(s=>s.replace(/^"+|"+$/g,'').trim());
    const o={}; rawHeads.forEach((h,i)=> o[h]=cells[i]??''); return o;
  });
  return {rawHeads, rows};
}
function buildMapping(rawHeads){
  const nk = rawHeads.map(normKey);
  const find=(k)=>{const i=nk.indexOf(k); return i>=0?rawHeads[i]:null;};
  const loose=(...res)=>{ for(let i=0;i<nk.length;i++){ const k=nk[i]; if(res.every(r=>r.test(k))) return rawHeads[i]; } return null; };

  const hKey   = find('hauteurmm')      || loose(/hauteur/,/mm/);
  const brutKey= find('prixbruteur')    || loose(/brut/);
  const laqKey = find('prixlaqueeur')   || loose(/laque/);
  const fixKey = find('supfixationeur') || loose(/fix/);

  return {hKey, brutKey, laqKey, fixKey};
}

/* ===== Data helpers ===== */
function pickRowForHeight(H){
  const k=MAP.hKey;
  const pool = ROWS
    .map(r=>({row:r, h:numFR(r[k])}))
    .filter(x=>isFinite(x.h))
    .sort((a,b)=>a.h-b.h);
  if(!pool.length) return null;
  let chosen=pool[0];
  for(const x of pool){
    if(H <= x.h){ chosen=x; break; }
    chosen=x;
  }
  return chosen.row;
}
function showRanges(){
  const k=MAP?.hKey; if(!k){ elHelp.textContent=''; return; }
  const vals=[...new Set(ROWS.map(r=>numFR(r[k])).filter(v=>isFinite(v)))].sort((a,b)=>a-b);
  elHelp.textContent = vals.length ? `Hauteurs disponibles : ${vals.slice(0,10).join(' ‚Ä¢ ')}${vals.length>10?' ‚Ä¶':''}` : '';
}

/* ===== Calcul (affichage PUBLIC) ===== */
function compute(){
  const H = Number(elH.value||0);
  const Q = Math.max(1, Number(elQ.value||1));
  if(!(H>0) || !ROWS.length || !MAP?.hKey){
    elPrixHT.textContent='0,00'; elPrixTTC.textContent='0,00'; return;
  }
  const row = pickRowForHeight(H);
  if(!row){ elPrixHT.textContent='0,00'; elPrixTTC.textContent='0,00'; return; }

  const brut = MAP.brutKey ? numFR(row[MAP.brutKey]) : NaN;
  const laqe = MAP.laqKey  ? numFR(row[MAP.laqKey])  : NaN;

  // prix interne unitaire selon finition
  let unit_interne = 0;
  if(elFLaque.checked && isFinite(laqe)) unit_interne = laqe;
  else if(isFinite(brut)) unit_interne = brut;
  else if(isFinite(laqe)) { unit_interne = laqe; elFLaque.checked=true; elFBrut.checked=false; }

  // suppl√©ment fixation
  if(elFix.checked && MAP.fixKey){
    const fx = numFR(row[MAP.fixKey]);
    if(isFinite(fx)) unit_interne += fx;
  }

  // conversion ‚Üí public
  const unit_public = unit_interne * UPLIFT_PUBLIC;

  const totalHT = unit_public * Q;
  const totalTTC = totalHT * (1+TVA);

  elPrixHT.textContent  = euro(totalHT);
  elPrixTTC.textContent = euro(totalTTC);
}

/* ===== Load CSV ===== */
async function loadCSV(){
  try{
    const r = await fetch(CSV_URL,{cache:'no-store'});
    const txt = await r.text();
    const {rawHeads, rows} = parseCSVAuto(txt);
    HEADS=rawHeads; ROWS=rows; MAP=buildMapping(HEADS);
    showRanges(); compute();
  }catch(e){
    console.error(e);
    alert("Erreur lors du chargement des donn√©es. R√©essayez plus tard.");
  }
}

/* ===== INIT / EVENTS ===== */
["input","change"].forEach(evt=>{
  [elH, elQ, elFix, elFBrut, elFLaque].forEach(el=>{
    el.addEventListener(evt, compute);
  });
});
$("btnReset").addEventListener("click", ()=>{
  elH.value=''; elQ.value=1; elFix.checked=false; elFBrut.checked=true; elFLaque.checked=false;
  compute();
});
loadCSV();
</script>

<!-- ===================== MOTEUR DE DEVIS ===================== -->
<script src="../js/devis-core.js"></script>
<script>
$("btnAddDevis").addEventListener("click", ()=>{
  try{
    if(!window.Devis) throw new Error("Moteur de devis introuvable.");
    const qte = Math.max(1, Number($("quantite").value || 1));
    const hauteur = Number($("hauteur").value || 0);
    const fin = $("finitionLaque").checked ? 'laqu√©' : 'brut';
    const fix = $("optFixation").checked ? ' + fixations' : '';
    const catVal = $("categorie").value;
    const catTxt = (catVal==='alu20') ? 'Lettre aluminium 20/10' : 'Lettre alu/PVC 3 mm (type Dibond)';

    const total_ht = parseFloat($("prixHT").innerText.replace(',','.')) || 0;
    const pu_public_ht = qte>0 ? (total_ht / qte) : 0;

    const designation = `${catTxt} ‚Äî H ${hauteur || 'n.c.'} mm ‚Äî ${fin}${fix}`;

    Devis.addLine({
      type: 'Lettres',
      designation,
      quantite: qte,
      pu_public_ht: Number(pu_public_ht.toFixed(2))
    });

    alert(`‚úÖ Ligne ajout√©e au devis !
${designation}
Qt√© : ${qte}
PU HT : ${pu_public_ht.toFixed(2)} ‚Ç¨`);
  }catch(err){
    console.error(err);
    alert('Erreur lors de l‚Äôajout au devis : ' + err.message);
  }
});
</script>

</body>
</html>
