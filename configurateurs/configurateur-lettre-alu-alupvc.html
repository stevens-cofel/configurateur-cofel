<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Configurateur Lettres Aluminium 20/10 & Dibond 3 mm – Cofel</title>

<!-- Styles communs (si présents, mêmes que l’accueil) -->
<link rel="stylesheet" href="../styles/cofel.css" />
<link rel="stylesheet" href="../styles/cofel-config.css" />

<style>
  /* ===== Habillage Cofel (violet) ===== */
  body{margin:0;background:#f6f3fa;color:#2b2140;font-family:Arial, Helvetica, sans-serif}
  h1{margin:0 0 16px;text-align:center}
  .wrap{max-width:860px;margin:20px auto;background:#fff;border-radius:14px;box-shadow:0 10px 28px rgba(90,45,130,.12);padding:20px}
  label{display:block;margin-top:14px;font-weight:700}
  input,select{width:100%;padding:10px;margin-top:6px;border:1px solid #d8cbe8;border-radius:10px;min-height:44px;background:#fff}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  @media (max-width:800px){.grid{grid-template-columns:1fr}}

  fieldset{border:1px solid #e6daf4;border-radius:12px;padding:10px;margin-top:8px;background:#fcfaff}
  fieldset legend{padding:0 8px;font-weight:700;color:#4a2a6c}
  .option-item{
    display:flex;align-items:center;gap:10px;padding:10px 12px;border:1px solid #e6daf4;border-radius:10px;background:#fff;min-height:44px;cursor:pointer
  }
  .option-item input{transform:scale(1.1)}

  .result{
    margin-top:18px;padding:16px;background:#fcfaff;border:1px solid #dec5f2;border-radius:12px;text-align:center;font-size:18px;
    box-shadow:0 8px 18px rgba(90,45,130,.08)
  }
  .muted{color:#7d6f8e;font-size:12px;margin-top:8px;white-space:pre-wrap}

  /* Bandeau / footer (fallback si cofel.css absent) */
  .cofel-header{background:#5a2d82;color:#fff}
  .cofel-header .row{max-width:1100px;margin:0 auto;display:flex;align-items:center;gap:16px;padding:10px 14px}
  .cofel-back{color:#fff;text-decoration:none;border:1px solid rgba(255,255,255,.35);padding:8px 12px;border-radius:10px}
  .cofel-brand{display:flex;align-items:center;gap:10px}
  .cofel-brand img{height:36px;border-radius:6px;object-fit:cover}
  .cofel-title{font-size:18px;margin:0}
  .cofel-container{max-width:1100px;margin:0 auto;padding:14px}
  .cofel-footer{
    margin:24px 0 0;padding:14px;text-align:center;color:#6f5b86;font-size:13px;
    border-top:1px solid #e6daf4;background:#fbf9fe
  }

  /* Bouton devis */
  #btnAddDevis{
    position:fixed;right:20px;bottom:20px;padding:10px 16px;
    background:#ffffff;border:1px solid #ccc;border-radius:10px;
    box-shadow:0 2px 6px rgba(0,0,0,0.15);cursor:pointer;z-index:999;font-weight:600
  }
</style>
</head>
<body>

<!-- Bandeau violet / retour -->
<header class="cofel-header">
  <div class="row">
    <a class="cofel-back" href="../index.html">⬅ Retour aux configurateurs</a>
    <div class="cofel-brand">
      <img src="../assets/logo cofel.jpg" alt="Cofel" />
      <h1 class="cofel-title">Configurateur — Lettres Alu 20/10 & Dibond 3 mm</h1>
    </div>
  </div>
</header>

<div class="cofel-container">
  <h1>Configurateur Lettres Aluminium 20/10 & Dibond 3 mm</h1>

  <div class="wrap">
    <!-- ===== UI ===== -->
    <div class="grid">
      <div>
        <label for="categorie">Catégorie</label>
        <select id="categorie">
          <option value="alu20">Lettre aluminium 20/10ème</option>
          <option value="dibond3">Lettre alu/pvc 3 mm (type Dibond)</option>
        </select>
      </div>
      <div>
        <label for="quantite">Quantité</label>
        <input type="number" id="quantite" min="1" value="1" />
      </div>
    </div>

    <div class="grid">
      <div>
        <label for="hauteur">Hauteur (mm)</label>
        <input type="number" id="hauteur" placeholder="Ex : 275" min="1" />
        <div id="helpRanges" class="muted"></div>
      </div>
      <div>
        <fieldset>
          <legend>Finition</legend>
          <label class="option-item">
            <input type="radio" name="finition" id="finitionBrut" value="brut" checked />
            <span>Brut (PrixBrut_EUR)</span>
          </label>
          <label class="option-item">
            <input type="radio" name="finition" id="finitionLaque" value="laque" />
            <span>Laqué (PrixLaque_EUR)</span>
          </label>
        </fieldset>

        <fieldset>
          <legend>Supplément</legend>
          <label class="option-item">
            <input type="checkbox" id="optFixation" />
            <span>Fixations (+ SupFixation_EUR)</span>
          </label>
        </fieldset>
      </div>
    </div>

    <!-- Résultat (affiche PRIX PUBLIC) -->
    <div class="result">
      <p>Prix HT : <span id="prixHT">0,00</span> €</p>
      <p>Prix TTC : <span id="prixTTC">0,00</span> €</p>
    </div>

    <div id="msg" class="muted"></div>
  </div>
</div>

<!-- Pied de page -->
<footer class="cofel-footer">
  © Cofel — ZA du Perquoi, 72560 Changé — SIRET 927 659 458 00024 — TVA FR80927659458
</footer>

<!-- ===== JS ===== -->
<script>
/* ===== CONFIG ===== */
const TVA = 0.20;
const UPLIFT_PUBLIC = 2.0; // interne -> public (x2)
const CSV_URL = "https://raw.githubusercontent.com/stevens-cofel/configurateur-cofel/refs/heads/main/lettres/Lettre%20alu%2020_10%20%C3%A8me%20ou%20Type%20Dibond%203%20mm.csv";

/* ===== STATE / DOM ===== */
let HEADS=[], ROWS=[], MAP=null;
const elH = document.getElementById("hauteur");
const elQ = document.getElementById("quantite");
const elFix = document.getElementById("optFixation");
const elFBrut = document.getElementById("finitionBrut");
const elFLaque = document.getElementById("finitionLaque");
const elPrixHT = document.getElementById("prixHT");
const elPrixTTC = document.getElementById("prixTTC");
const elMsg = document.getElementById("msg");
const elHelp = document.getElementById("helpRanges");

/* ===== Utils (robustes) ===== */
function normKey(k){
  return String(k||'').toLowerCase()
    .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
    .replace(/[^a-z0-9]+/g,'').trim();
}
function numFR(v){
  if(v===null||v===undefined) return NaN;
  let s = String(v).trim()
    .replace(/€/g,'')
    .replace(/[\u00A0\u202F]/g,'')
    .replace(/\s+/g,'');
  if(s.includes(',') && s.includes('.')) s = s.replace(/\./g,'');
  s = s.replace(',', '.');
  const m = s.match(/-?\d+(\.\d+)?/);
  return m ? parseFloat(m[0]) : NaN;
}
function euro(n){ return (isFinite(n)?n:0).toFixed(2).replace('.', ','); }

/* ===== CSV parser béton ===== */
function parseCSVLine(line, sep=','){
  const out=[]; let cur=''; let inQ=false;
  for(let i=0;i<line.length;i++){
    const ch=line[i], nx=line[i+1];
    if(ch==='"'){
      if(inQ && nx==='"'){ cur+='"'; i++; } else inQ=!inQ;
    }else if(ch===sep && !inQ){
      out.push(cur); cur='';
    }else{
      cur+=ch;
    }
  }
  out.push(cur);
  return out;
}
function normalizeWeirdCSV(t){
  t=t.replace(/^\uFEFF/,'').replace(/\r/g,'');
  const manyQuotes=(t.match(/"/g)||[]).length>50;
  const fewNL=(t.match(/\n/g)||[]).length<3;
  if(manyQuotes && fewNL){
    t=t.replace(/""/g,'"');
    const blocks=[]; const re=/"([^"]*)"/g; let m;
    while((m=re.exec(t))!==null) blocks.push(m[1]);
    if(!blocks.length) return t;
    const cols=parseCSVLine(blocks[0], ',').length;
    const lines=[];
    for(let i=0;i<blocks.length;i+=cols){
      lines.push(blocks.slice(i,i+cols).map(s=>`"${s}"`).join(','));
    }
    return lines.join('\n');
  }
  return t.split('\n').map(l=>{
    const s=l.trim();
    if(s.startsWith('"') && s.endsWith('"')) return s.slice(1,-1);
    return s;
  }).join('\n');
}
function parseCSVAuto(text){
  const norm=normalizeWeirdCSV(text);
  const lines=norm.split('\n').filter(l=>l.trim()!=='');
  if(!lines.length) return {rawHeads:[], rows:[]};
  const first=lines[0];
  const sep=((first.match(/;/g)||[]).length>(first.match(/,/g)||[]).length)?';':',';
  const rawHeads=parseCSVLine(lines[0], sep).map(s=>s.replace(/^"+|"+$/g,'').trim());
  const rows=lines.slice(1).map(line=>{
    const cells=parseCSVLine(line, sep).map(s=>s.replace(/^"+|"+$/g,'').trim());
    const o={}; rawHeads.forEach((h,i)=>o[h]=cells[i]??'' ); return o;
  });
  return {rawHeads, rows};
}

/* ===== Mapping auto ===== */
function buildMapping(rawHeads){
  const nk=rawHeads.map(normKey);
  const find=(key)=>{ const i=nk.findIndex(k=>k===key); return i>=0?rawHeads[i]:null; };
  const loose=(...res)=>{ for(let i=0;i<nk.length;i++){ const k=nk[i]; if(res.every(r=>r.test(k))) return rawHeads[i]; } return null; };

  const hKey   = find('hauteurmm')      || loose(/hauteur/,/mm/);
  const brutKey= find('prixbruteur')    || loose(/prix.*brut|brut/i);
  const laqKey = find('prixlaqueeur')   || loose(/prix.*laque|laque/i);
  const fixKey = find('supfixationeur') || loose(/fixation/);

  return {hKey, brutKey, laqKey, fixKey};
}

/* ===== Data helpers ===== */
function pickRowForHeight(H){
  const k=MAP.hKey;
  const pool = ROWS
    .map(r=>({row:r, h:numFR(r[k])}))
    .filter(x=>isFinite(x.h))
    .sort((a,b)=>a.h-b.h);
  if(!pool.length) return null;
  let chosen=pool[0];
  for(const x of pool){
    if(H <= x.h){ chosen=x; break; }
    chosen=x;
  }
  return chosen.row;
}

/* ===== UI ===== */
function showRanges(){
  const k=MAP?.hKey; if(!k){ elHelp.textContent=''; return; }
  const vals=[...new Set(ROWS.map(r=>numFR(r[k])).filter(v=>isFinite(v)))].sort((a,b)=>a-b);
  elHelp.textContent = vals.length ? `Hauteurs disponibles (exemples) : ${vals.slice(0,12).join(' • ')}${vals.length>12?' …':''}` : '';
}

/* ===== Calcul (affiche PUBLIC) ===== */
function compute(){
  const H = Number(elH.value||0);
  const Q = Math.max(1, Number(elQ.value||1));
  if(!(H>0) || !ROWS.length || !MAP?.hKey){
    elPrixHT.textContent='0,00'; elPrixTTC.textContent='0,00'; return;
  }

  const row = pickRowForHeight(H);
  if(!row){ elPrixHT.textContent='0,00'; elPrixTTC.textContent='0,00'; return; }

  const brut = MAP.brutKey ? numFR(row[MAP.brutKey]) : NaN;
  const laqe = MAP.laqKey  ? numFR(row[MAP.laqKey])  : NaN;

  // Prix interne unitaire (selon choix de finition + fixation)
  let unit_interne = 0;
  if(elFLaque.checked && isFinite(laqe)) unit_interne = laqe;
  else if(isFinite(brut)) unit_interne = brut;
  else if(isFinite(laqe)) { unit_interne = laqe; elFLaque.checked=true; elFBrut.checked=false; }

  if(elFix.checked && MAP.fixKey){
    const fx=numFR(row[MAP.fixKey]);
    if(isFinite(fx)) unit_interne += fx;
  }

  // Conversion → prix public (x2)
  const unit_public = unit_interne * UPLIFT_PUBLIC;

  const totalHT_public = unit_public * Q;
  const totalTTC_public = totalHT_public * (1+TVA);
  elPrixHT.textContent  = euro(totalHT_public);
  elPrixTTC.textContent = euro(totalTTC_public);
}

/* ===== LOAD ===== */
async function fetchText(u){
  const r = await fetch(u, {cache:'no-store'});
  if(!r.ok) throw new Error('HTTP '+r.status);
  return await r.text();
}
async function loadCSV(){
  const txt = await fetchText(CSV_URL);
  const {rawHeads, rows} = parseCSVAuto(txt);
  HEADS = rawHeads;
  ROWS  = rows;
  MAP   = buildMapping(HEADS);

  elMsg.textContent = `CSV OK (${ROWS.length} lignes)`;

  showRanges();
  compute();
}

/* ===== INIT ===== */
["input","change"].forEach(evt=>{
  [hauteur, quantite, optFixation, finitionBrut, finitionLaque].forEach(el=>{
    el.addEventListener(evt, compute);
  });
});
loadCSV().catch(e=>{ msg.textContent='Erreur: '+e.message; });
</script>

<!-- ========= Intégration au devis ========= -->
<script src="../js/devis-core.js"></script>

<button id="btnAddDevis">➕ Ajouter au devis</button>

<script>
/* Ajout au devis : on lit le TOTAL HT affiché (public) et on en déduit le PU public */
(function(){
  const btn = document.getElementById('btnAddDevis');
  if(!btn) return;

  function parsePrixHTPublic(){
    const txt = document.getElementById('prixHT').innerText.trim(); // ex "725,00"
    return Number(String(txt).replace(/\s/g,'').replace(',', '.')) || 0;
  }

  btn.addEventListener('click', () => {
    try{
      if(!window.Devis) throw new Error("Moteur de devis introuvable.");

      const catVal = document.getElementById('categorie').value;
      const catTxt = (()=>{
        if(catVal === 'alu20') return 'Lettre aluminium 20/10';
        if(catVal === 'dibond3') return 'Lettre alu/PVC 3 mm (type Dibond)';
        return 'Lettres';
      })();

      const qte = Math.max(1, Number(document.getElementById('quantite').value || 1));
      const hauteur = Number(document.getElementById('hauteur').value || 0);
      const fin = document.getElementById('finitionLaque').checked ? 'laqué' : 'brut';
      const fix = document.getElementById('optFixation').checked ? ' + fixations' : '';

      const total_ht_public = parsePrixHTPublic();
      const pu_public_ht = qte > 0 ? (total_ht_public / qte) : 0;

      const designation = `${catTxt} — H ${hauteur || 'n.c.'} mm — ${fin}${fix}`;

      Devis.addLine({
        type: 'Lettres',
        designation,
        quantite: qte,
        pu_public_ht: Number(pu_public_ht.toFixed(2))
      });

      alert(`✅ Ligne ajoutée au devis !\n${designation}\nQté : ${qte}\nPU HT : ${pu_public_ht.toFixed(2)} €`);
    }catch(err){
      console.error(err);
      alert('Erreur lors de l’ajout au devis : ' + err.message);
    }
  });
})();
</script>
</body>
</html>
