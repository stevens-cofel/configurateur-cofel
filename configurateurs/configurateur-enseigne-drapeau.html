<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Configurateur Enseignes Drapeaux – Cofel</title>

<!-- Styles communs Cofel -->
<link rel="stylesheet" href="../styles/cofel.css" />
<link rel="stylesheet" href="../styles/cofel-config.css" />

<!-- Retouches locales -->
<style>
  .radio-row{display:flex;gap:8px;flex-wrap:wrap}
  .radio-row label,
  .option-item{
    font-weight:600;border:1px solid #ddd;border-radius:10px;
    padding:6px 10px;display:flex;align-items:center;gap:8px;background:#fff;
    cursor:pointer;
  }
  .result{
    background:#fcfaff;border:1px solid #dec5f2;border-radius:12px;
    padding:14px;margin:16px 0;text-align:center;font-size:18px;
    box-shadow:0 8px 18px rgba(90,45,130,.08);
  }
  .muted{color:#7d6f8e;font-size:12px;margin-top:6px;white-space:pre-wrap}
  fieldset legend{color:#5a2d82;font-weight:800}
</style>
</head>
<body>

<!-- Bandeau haut violet -->
<header class="cofel-header">
  <div class="row">
    <a class="cofel-back" href="../index.html">⬅ Retour aux configurateurs</a>
    <div class="cofel-brand">
      <img src="../assets/logo cofel.jpg" alt="Cofel" />
      <h1 class="cofel-title">Configurateur — Enseignes Drapeaux</h1>
    </div>
  </div>
</header>

<!-- Conteneur -->
<div class="cofel-container">
<h1 style="margin:8px 0 14px">Enseignes Drapeaux</h1>

<div class="wrap">

  <div class="grid">
    <div>
      <label for="forme">Forme</label>
      <select id="forme"><option value="">(choisir)</option></select>
    </div>
    <div>
      <label for="quantite">Quantité</label>
      <input type="number" id="quantite" min="1" value="1" />
    </div>
  </div>

  <div class="grid">
    <div>
      <fieldset>
        <legend>Options</legend>

        <label class="option-item">
          <input type="checkbox" id="optLaquage" />
          <span>Laquage (sur drapeau carré – base prélaqué)</span>
        </label>

        <label class="option-item">
          <input type="checkbox" id="optAjourLumi" />
          <span>Ajourage + lumineux + laquage</span>
        </label>

      </fieldset>
      <div class="muted" id="noteForme"></div>
    </div>

    <div>
      <label for="dimension">Dimension</label>
      <select id="dimension"><option value="">(choisir la dimension)</option></select>
      <div id="helpDim" class="muted"></div>
    </div>
  </div>

  <!-- Résultat (affiche le PRIX PUBLIC) -->
  <div class="result">
    <p>Prix HT : <span id="prixHT">0,00</span> €</p>
    <p>Prix TTC : <span id="prixTTC">0,00</span> €</p>
  </div>

  <div id="msg" class="muted"></div>

</div>
</div>

<!-- Pied de page -->
<footer class="cofel-footer">
  © Cofel — ZA du Perquoi, 72560 Changé — SIRET 927 659 458 00024 — TVA FR80927659458
</footer>

<script>
/* ===== PARAMS ===== */
const TVA = 0.20;
// IMPORTANT : tous les prix affichés/enregistrés sont en PUBLIC
const UPLIFT_PUBLIC = 1.5;
const CSV_URL = "https://raw.githubusercontent.com/stevens-cofel/configurateur-cofel/refs/heads/main/Enseigne%20drapeaux.csv";

/* ===== STATE / DOM ===== */
let HEADS=[], ROWS=[], MAP=null;
const $ = id=>document.getElementById(id);
const elForme=$("forme"), elQ=$("quantite"), elDim=$("dimension");
const elLaq=$("optLaquage"), elAJL=$("optAjourLumi");
const elHT=$("prixHT"), elTTC=$("prixTTC");
const elMsg=$("msg"), elHelpDim=$("helpDim"), elNote=$("noteForme");

/* ===== Utils ===== */
function normKey(k){
  return String(k||'').toLowerCase()
    .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
    .replace(/[^a-z0-9+]+/g,'').trim();
}
function numFR(v){
  if(v===null||v===undefined) return NaN;
  let s=String(v).trim().replace(/€/g,'').replace(/[\u00A0\u202F]/g,'').replace(/\s+/g,'');
  if(s.includes(',') && s.includes('.')) s=s.replace(/\./g,'');
  s=s.replace(',', '.');
  const m=s.match(/-?\d+(\.\d+)?/);
  return m?parseFloat(m[0]):NaN;
}
function euro(n){ return (isFinite(n)?n:0).toFixed(2).replace('.', ','); }

/* Robust CSV parser */
function parseCSVAuto(text){
  const raw = String(text || "").replace(/^\uFEFF/, "");
  const lines = raw.split(/\r\n|\n|\r/).filter(l => l.trim() !== "");
  if (!lines.length) return { rawHeads: [], rows: [] };
  const first = lines[0];
  const sep = ((first.match(/;/g) || []).length > (first.match(/,/g) || []).length) ? ';' : ',';
  function parseCSVLine(line){
    const out=[]; let cur=''; let inQ=false;
    for(let i=0;i<line.length;i++){
      const ch=line[i], nx=line[i+1];
      if(ch === '"'){
        if(inQ && nx === '"'){ cur+='"'; i++; } else { inQ = !inQ; }
      } else if(ch === sep && !inQ){
        out.push(cur); cur='';
      } else cur += ch;
    }
    out.push(cur);
    return out;
  }
  const rawHeads = parseCSVLine(first).map(s => s.replace(/^"+|"+$/g,'').trim());
  const rows = lines.slice(1).map(line => {
    const cells = parseCSVLine(line).map(s => s.replace(/^"+|"+$/g,'').trim());
    const o = {}; rawHeads.forEach((h,i)=> o[h] = cells[i] ?? '');
    return o;
  });
  return { rawHeads, rows };
}

function buildMapping(rawHeads){
  const nk=rawHeads.map(normKey);
  const find=(k)=>{ const i=nk.indexOf(k); return i>=0?rawHeads[i]:null; };
  const like=(...res)=>{ for(let i=0;i<nk.length;i++){ const k=nk[i]; if(res.every(re=>re.test(k))) return rawHeads[i]; } return null; };
  const TITRE=find('titre')||like(/titre/);
  const FORME=find('forme')||like(/forme/);
  const DIM=find('dimensionmm')||like(/dimension|dim/);
  const FIN=find('finition')||like(/fini/);
  const PRIX=find('prixeurl')||like(/prix|eur/);
  const COM=find('commentaire')||like(/comment/);
  const OPTAJL=find('opt_ajourage+lumineux')||like(/ajour|lum/);
  return {TITRE,FORME,DIM,FIN,PRIX,COM,OPTAJL};
}

/* Data helpers */
function distinct(v){return [...new Set(v)]}

function populateFormes(){
  const formes = distinct(ROWS.map(r=>String(r[MAP.FORME]||'').toLowerCase()).filter(Boolean))
                .sort((a,b)=>a.localeCompare(b));
  elForme.innerHTML='<option value="">(choisir)</option>';
  formes.forEach(v=> elForme.innerHTML+=`<option value="${v}">${v}</option>`);
}

function filteredPool(){
  let pool=[...ROWS];
  if(elForme.value) pool=pool.filter(r=>String(r[MAP.FORME]).toLowerCase()===elForme.value);
  const fin=r=>String(r[MAP.FIN]).trim().toLowerCase();
  const opt=r=>String(r[MAP.OPTAJL]).trim().toLowerCase();

  if(elForme.value==='carré'){
    if(elAJL.checked){ pool=pool.filter(r=>opt(r)==='vrai'&&fin(r)==='laqué'); }
    else{
      if(elLaq.checked) pool=pool.filter(r=>fin(r)==='laqué'&&opt(r)!=='vrai');
      else pool=pool.filter(r=>fin(r)==='prélaqué'&&opt(r)!=='vrai');
    }
  }else if(elForme.value==='rond'){
    pool=pool.filter(r=>fin(r)==='laqué');
    if(elAJL.checked) pool=pool.filter(r=>opt(r)==='vrai');
    else pool=pool.filter(r=>opt(r)!=='vrai');
  }
  return pool;
}

function populateDimensions(){
  const pool=filteredPool();
  const dims = distinct(pool.map(r=>String(r[MAP.DIM]||'').trim()).filter(Boolean))
                .sort((a,b)=>a.localeCompare(b,'fr',{numeric:true}));
  elDim.innerHTML='<option value="">(choisir la dimension)</option>';
  dims.forEach(v=> elDim.innerHTML+=`<option>${v}</option>`);
  elHelpDim.textContent=dims.length?`Dimensions dispo: ${dims.slice(0,10).join(' • ')}${dims.length>10?' …':''}`:'';
}

function findRow(){
  const pool=filteredPool();
  if(!pool.length) return null;
  if(elDim.value) return pool.find(r=>String(r[MAP.DIM]).trim()===elDim.value) || null;
  return pool[0];
}

/* Compute : calcule en PRIX PUBLIC (×1,5) */
function compute(){
  // contraintes d’UI
  if(elForme.value==='rond'){ elLaq.checked=true; elLaq.disabled=true; }
  if(elForme.value==='carré'){ elLaq.disabled=elAJL.checked; }

  const row=findRow();
  const Q=Math.max(1,Number(elQ.value||1));
  if(!row){ elHT.textContent='0,00'; elTTC.textContent='0,00'; return; }

  // Prix "interne" lu depuis le CSV (supposé HT unitaire)
  let unit_interne = numFR(row[MAP.PRIX]);
  if(!isFinite(unit_interne)) unit_interne = 0;

  // Conversion en PRIX PUBLIC
  const unit_public = unit_interne * UPLIFT_PUBLIC;

  // Totaux en PUBLIC
  const totalHT_public = unit_public * Q;
  const totalTTC_public = totalHT_public * (1+TVA);

  // Affichage
  elHT.textContent  = euro(totalHT_public);
  elTTC.textContent = euro(totalTTC_public);
}

/* Load CSV */
async function loadCSV(){
  try{
    const r=await fetch(CSV_URL,{cache:'no-store'});
    const txt=await r.text();
    const {rawHeads,rows}=parseCSVAuto(txt);
    HEADS=rawHeads; ROWS=rows; MAP=buildMapping(HEADS);
    populateFormes(); populateDimensions(); compute();
    elMsg.textContent=`CSV OK (${rows.length} lignes)`;
  }catch(e){ elMsg.textContent="Erreur CSV:"+e.message; }
}

/* Events */
["input","change"].forEach(evt=>{
  [forme,quantite,optLaquage,optAjourLumi,dimension].forEach(el=>{
    el.addEventListener(evt,e=>{
      if(e.target===forme||e.target===optLaquage||e.target===optAjourLumi) populateDimensions();
      compute();
    });
  });
});
loadCSV();
</script>

<!-- Charger le moteur de devis -->
<script src="../js/devis-core.js"></script>

<!-- Bouton Ajouter au devis -->
<button id="btnAddDevis"
  style="position:fixed;right:20px;bottom:20px;padding:10px 16px;
         background:#ffffff;border:1px solid #ccc;border-radius:10px;
         box-shadow:0 2px 6px rgba(0,0,0,0.15);cursor:pointer;z-index:999;font-weight:600;">
  ➕ Ajouter au devis
</button>

<script>
// === AJOUT AU DEVIS ===
// On lit le prix affiché (déjà PUBLIC), on en déduit le PU PUBLIC et on envoie pu_public_ht.
document.getElementById("btnAddDevis").addEventListener("click", () => {
  const quantite = Math.max(1, Number(document.getElementById("quantite").value || 1));

  // "prixHT" affiche le TOTAL HT PUBLIC
  const prixTotalText = document.getElementById("prixHT").innerText.trim(); // ex "725,00"
  const total_ht_public = parseFloat(prixTotalText.replace(",", ".")) || 0;

  // PU PUBLIC à stocker
  const pu_public_ht = total_ht_public / quantite;

  const designation = "Enseigne Drapeau";

  Devis.addLine({
    type: "Enseigne Drapeau",
    designation,
    quantite,
    pu_public_ht
  });

  alert(`✅ Ajouté au devis !
${designation}
Qté : ${quantite}
PU HT : ${pu_public_ht.toFixed(2)} €`);
});
</script>

</body>
</html>
