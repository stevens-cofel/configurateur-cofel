<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Configurateur ‚Äî Enseignes Drapeaux | Cofel</title>

<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

<style>
  /* ===================== THEME (Cofel ‚Äì verre + d√©grad√©s) ===================== */
  :root{
    --cofel:#5a2d82; --cofel-2:#7838a7;
    --txt:#f5f7ff; --txt-dim:#e6e6ff; --accent:#c9b7ff;
    --radius:18px; --blur:18px; --shadow:0 10px 30px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--txt);
    font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","Segoe UI",Roboto,Arial,sans-serif;
    background:
      radial-gradient(800px 500px at 20% -10%, rgba(255,255,255,.10), transparent 60%),
      radial-gradient(800px 500px at 110% 10%, rgba(255,255,255,.08), transparent 60%),
      linear-gradient(135deg, var(--cofel), var(--cofel-2));
  }

  /* ===================== HERO ===================== */
  .hero{position:relative; z-index:1; padding:40px 20px 24px;}
  .hero-inner{
    max-width:1200px; margin:0 auto;
    display:flex; align-items:center; justify-content:space-between; gap:16px;
  }
  .brand{
    display:flex; align-items:center; gap:14px;
    backdrop-filter: blur(var(--blur));
    background: linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.06));
    border:1px solid rgba(255,255,255,.18);
    padding:10px 14px; border-radius:14px;
    box-shadow: var(--shadow);
  }
  .brand img{height:42px; width:auto; object-fit:contain; border-radius:10px}
  .brand h1{font-size: clamp(18px, 2.6vw, 22px); margin:0; letter-spacing:.2px; font-weight:700;}
  .tagline{max-width:1200px;margin:18px auto 0;padding:0 20px;color:var(--txt-dim)}

  /* ===================== LAYOUT ===================== */
  .wrap{max-width:1200px; margin:26px auto; padding:0 20px 40px; position:relative; z-index:1;}
  .panel{
    background: linear-gradient(180deg, rgba(255,255,255,.16), rgba(255,255,255,.06));
    border:1px solid rgba(255,255,255,.2);
    border-radius:20px; padding:18px; box-shadow:var(--shadow);
    backdrop-filter: blur(var(--blur));
    margin-bottom:18px;
  }
  .panel h2{margin:0 0 12px; font-size: clamp(18px,2.4vw,22px); letter-spacing:.2px}

  .card{
    background: linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.06));
    border:1px solid rgba(255,255,255,.18);
    border-radius:16px; padding:14px; box-shadow:var(--shadow); backdrop-filter: blur(var(--blur));
  }

  .grid{display:grid; gap:12px; grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}

  label{font-weight:700; font-size:12px; color:var(--accent);}
  input[type="text"], input[type="number"], select, textarea{
    width:100%; margin-top:6px; padding:10px 12px;
    background: rgba(255,255,255,.08); color:var(--txt);
    border:1px solid rgba(255,255,255,.18); border-radius:12px; outline:none;
    transition: border-color .18s ease, background .18s ease;
  }
  input::placeholder, textarea::placeholder{ color:#f0edff; opacity:.75; }
  input:focus, select:focus, textarea:focus{ border-color: rgba(255,255,255,.34); background: rgba(255,255,255,.12); }

  /* Options (cases √† cocher styl√©es) */
  .option-item{
    display:flex; align-items:center; gap:10px; cursor:pointer;
    background: rgba(255,255,255,.08);
    border:1px solid rgba(255,255,255,.18);
    border-radius:12px; padding:10px 12px; user-select:none;
  }
  .option-item input{accent-color:#ffffff}

  .muted{color:var(--txt-dim); font-size:12px; margin-top:6px; white-space:pre-wrap}

  /* R√©sultat */
  .result{
    text-align:center; padding:16px;
    background: linear-gradient(180deg, rgba(255,255,255,.18), rgba(255,255,255,.08));
    border:1px solid rgba(255,255,255,.22); border-radius:16px;
    box-shadow:0 8px 22px rgba(0,0,0,.28);
    font-size:18px;
  }
  .result b{font-size:20px}

  /* Buttons */
  .btn{
    appearance:none; border:none; cursor:pointer; font-weight:700;
    color:#0b0b0b; background:#fff; border-radius:12px; padding:10px 14px;
    box-shadow: 0 10px 24px rgba(0,0,0,.25);
    transition: transform .16s ease, box-shadow .16s ease, opacity .16s ease;
  }
  .btn:active{ transform: translateY(1px); box-shadow: 0 6px 16px rgba(0,0,0,.28); }
  .btn-ghost{ background: transparent; color: var(--txt); border:1px solid rgba(255,255,255,.24); }
  .btn-danger{ background: transparent; color:#ffe3e3; border:1px solid rgba(255,107,107,.45); }

  footer{
    color:#f3ecff; font-size:12px; text-align:center; padding:24px 10px; opacity:.9;
  }
  @media (max-width:720px){ .brand h1{display:none;} }
</style>
</head>
<body>

  <!-- ===================== HERO ===================== -->
  <div class="hero">
    <div class="hero-inner">
      <div class="brand">
        <img src="../assets/logo cofel.jpg" alt="Cofel" />
        <h1>Configurateur ‚Äî Enseignes Drapeaux</h1>
      </div>
      <a class="brand" href="../index.html" style="text-decoration:none;color:inherit">
        ‚¨Ö Retour aux configurateurs
      </a>
    </div>
    <div class="tagline">Choisissez la forme, la dimension et les options. Les prix affich√©s sont **PUBLIC (√ó2)**, TVA 20 %.</div>
  </div>

  <!-- ===================== CONTENU ===================== -->
  <main class="wrap">

    <!-- Param√®tres principaux -->
    <section class="panel" aria-label="Param√®tres">
      <h2>‚öôÔ∏è Param√®tres</h2>
      <div class="card grid">
        <div>
          <label for="forme">Forme</label>
          <select id="forme"><option value="">(choisir)</option></select>
          <div id="noteForme" class="muted"></div>
        </div>
        <div>
          <label for="dimension">Dimension</label>
          <select id="dimension"><option value="">(choisir la dimension)</option></select>
          <div id="helpDim" class="muted"></div>
        </div>
        <div>
          <label for="quantite">Quantit√©</label>
          <input type="number" id="quantite" min="1" value="1" />
        </div>
      </div>
    </section>

    <!-- Options -->
    <section class="panel" aria-label="Options">
      <h2>üéõÔ∏è Options</h2>
      <div class="grid">
        <label class="option-item">
          <input type="checkbox" id="optLaquage" />
          <span>Laquage (drapeau carr√© ‚Äì base pr√©laqu√©)</span>
        </label>

        <label class="option-item">
          <input type="checkbox" id="optAjourLumi" />
          <span>Ajourage + lumineux + laquage</span>
        </label>
      </div>
      <div id="msg" class="muted" style="margin-top:10px"></div>
    </section>

    <!-- R√©cap prix -->
    <section class="panel" aria-label="R√©capitulatif">
      <h2>üßæ R√©capitulatif</h2>
      <div class="result">
        <p>Prix HT : <b><span id="prixHT">0,00</span> ‚Ç¨</b></p>
        <p>Prix TTC : <b><span id="prixTTC">0,00</span> ‚Ç¨</b></p>
        <div class="muted">Prix affich√©s en **PUBLIC (√ó2)** ‚Äî TVA 20 %</div>
      </div>

      <div style="margin-top:16px; display:flex; gap:10px; flex-wrap:wrap;">
        <button id="btnAddDevis" class="btn">‚ûï Ajouter au devis</button>
        <button id="btnReset" class="btn btn-ghost">üîÑ R√©initialiser</button>
      </div>
    </section>

  </main>

  <footer>
    ¬© Cofel ‚Äî ZA du Perquoi, 72560 Chang√© ‚Äî SIRET 927 659 458 00024 ‚Äî TVA FR80927659458
  </footer>

  <!-- ===================== LOGIQUE ===================== -->
  <script>
  /* ===== PARAMS ===== */
  const TVA = 0.20;
  // IMPORTANT : tous les prix affich√©s/enregistr√©s sont en PUBLIC (√ó2)
  const UPLIFT_PUBLIC = 2.0;
  const CSV_URL = "https://raw.githubusercontent.com/stevens-cofel/configurateur-cofel/refs/heads/main/Enseigne%20drapeaux.csv";

  /* ===== STATE / DOM ===== */
  let HEADS=[], ROWS=[], MAP=null;
  const $ = id=>document.getElementById(id);
  const elForme=$("forme"), elQ=$("quantite"), elDim=$("dimension");
  const elLaq=$("optLaquage"), elAJL=$("optAjourLumi");
  const elHT=$("prixHT"), elTTC=$("prixTTC");
  const elMsg=$("msg"), elHelpDim=$("helpDim"), elNote=$("noteForme");

  /* ===== Utils ===== */
  function normKey(k){
    return String(k||'').toLowerCase()
      .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
      .replace(/[^a-z0-9+]+/g,'').trim();
  }
  function numFR(v){
    if(v===null||v===undefined) return NaN;
    let s=String(v).trim().replace(/‚Ç¨/g,'').replace(/[\u00A0\u202F]/g,'').replace(/\s+/g,'');
    if(s.includes(',') && s.includes('.')) s=s.replace(/\./g,'');
    s=s.replace(',', '.');
    const m=s.match(/-?\\d+(\\.\\d+)?/);
    return m?parseFloat(m[0]):NaN;
  }
  function euro(n){ return (isFinite(n)?n:0).toFixed(2).replace('.', ','); }

  /* Robust CSV parser */
  function parseCSVAuto(text){
    const raw = String(text || "").replace(/^\\uFEFF/, "");
    const lines = raw.split(/\\r\\n|\\n|\\r/).filter(l => l.trim() !== "");
    if (!lines.length) return { rawHeads: [], rows: [] };
    const first = lines[0];
    const sep = ((first.match(/;/g) || []).length > (first.match(/,/g) || []).length) ? ';' : ',';
    function parseCSVLine(line){
      const out=[]; let cur=''; let inQ=false;
      for(let i=0;i<line.length;i++){
        const ch=line[i], nx=line[i+1];
        if(ch === '"'){
          if(inQ && nx === '"'){ cur+='"'; i++; } else { inQ = !inQ; }
        } else if(ch === sep && !inQ){
          out.push(cur); cur='';
        } else cur += ch;
      }
      out.push(cur);
      return out;
    }
    const rawHeads = parseCSVLine(first).map(s => s.replace(/^"+|"+$/g,'').trim());
    const rows = lines.slice(1).map(line => {
      const cells = parseCSVLine(line).map(s => s.replace(/^"+|"+$/g,'').trim());
      const o = {}; rawHeads.forEach((h,i)=> o[h] = cells[i] ?? '');
      return o;
    });
    return { rawHeads, rows };
  }

  function buildMapping(rawHeads){
    const nk=rawHeads.map(normKey);
    const find=(k)=>{ const i=nk.indexOf(k); return i>=0?rawHeads[i]:null; };
    const like=(...res)=>{ for(let i=0;i<nk.length;i++){ const k=nk[i]; if(res.every(re=>re.test(k))) return rawHeads[i]; } return null; };
    const TITRE=find('titre')||like(/titre/);
    const FORME=find('forme')||like(/forme/);
    const DIM=find('dimensionmm')||like(/dimension|dim/);
    const FIN=find('finition')||like(/fini/);
    const PRIX=find('prixeurl')||like(/prix|eur/);
    const COM=find('commentaire')||like(/comment/);
    const OPTAJL=find('opt_ajourage+lumineux')||like(/ajour|lum/);
    return {TITRE,FORME,DIM,FIN,PRIX,COM,OPTAJL};
  }

  function distinct(v){return [...new Set(v)]}

  function populateFormes(){
    const formes = distinct(ROWS.map(r=>String(r[MAP.FORME]||'').toLowerCase()).filter(Boolean))
                  .sort((a,b)=>a.localeCompare(b));
    elForme.innerHTML='<option value="">(choisir)</option>';
    formes.forEach(v=> elForme.innerHTML+=`<option value="${v}">${v}</option>`);
    elNote.textContent = formes.length ? "" : "Aucune forme disponible dans le CSV.";
  }

  function filteredPool(){
    let pool=[...ROWS];
    if(elForme.value) pool=pool.filter(r=>String(r[MAP.FORME]).toLowerCase()===elForme.value);
    const fin=r=>String(r[MAP.FIN]).trim().toLowerCase();
    const opt=r=>String(r[MAP.OPTAJL]).trim().toLowerCase();

    if(elForme.value==='carr√©'){
      if(elAJL.checked){ pool=pool.filter(r=>opt(r)==='vrai'&&fin(r)==='laqu√©'); }
      else{
        if(elLaq.checked) pool=pool.filter(r=>fin(r)==='laqu√©'&&opt(r)!=='vrai');
        else pool=pool.filter(r=>fin(r)==='pr√©laqu√©'&&opt(r)!=='vrai');
      }
    }else if(elForme.value==='rond'){
      pool=pool.filter(r=>fin(r)==='laqu√©');
      if(elAJL.checked) pool=pool.filter(r=>opt(r)==='vrai');
      else pool=pool.filter(r=>opt(r)!=='vrai');
    }
    return pool;
  }

  function populateDimensions(){
    const pool=filteredPool();
    const dims = distinct(pool.map(r=>String(r[MAP.DIM]||'').trim()).filter(Boolean))
                  .sort((a,b)=>a.localeCompare(b,'fr',{numeric:true}));
    elDim.innerHTML='<option value="">(choisir la dimension)</option>';
    dims.forEach(v=> elDim.innerHTML+=`<option>${v}</option>`);
    elHelpDim.textContent=dims.length?`Dimensions dispo : ${dims.slice(0,10).join(' ‚Ä¢ ')}${dims.length>10?' ‚Ä¶':''}`:'';
  }

  function findRow(){
    const pool=filteredPool();
    if(!pool.length) return null;
    if(elDim.value) return pool.find(r=>String(r[MAP.DIM]).trim()===elDim.value) || null;
    return pool[0];
  }

  /* Compute : calcule en PRIX PUBLIC (√ó2) */
  function compute(){
    // contraintes d‚ÄôUI
    if(elForme.value==='rond'){ elLaq.checked=true; elLaq.disabled=true; }
    else if(elForme.value==='carr√©'){ elLaq.disabled=elAJL.checked; }
    else { elLaq.disabled=false; }

    const row=findRow();
    const Q=Math.max(1,Number(elQ.value||1));
    if(!row){ elHT.textContent='0,00'; elTTC.textContent='0,00'; return; }

    // Prix "interne" lu depuis le CSV (suppos√© HT unitaire)
    let unit_interne = numFR(row[MAP.PRIX]);
    if(!isFinite(unit_interne)) unit_interne = 0;

    // Conversion en PRIX PUBLIC (√ó2)
    const unit_public = unit_interne * UPLIFT_PUBLIC;

    // Totaux en PUBLIC
    const totalHT_public = unit_public * Q;
    const totalTTC_public = totalHT_public * (1+TVA);

    // Affichage
    elHT.textContent  = euro(totalHT_public);
    elTTC.textContent = euro(totalTTC_public);
  }

  /* Load CSV */
  async function loadCSV(){
    try{
      const r=await fetch(CSV_URL,{cache:'no-store'});
      const txt=await r.text();
      const {rawHeads,rows}=parseCSVAuto(txt);
      HEADS=rawHeads; ROWS=rows; MAP=buildMapping(HEADS);
      populateFormes(); populateDimensions(); compute();
      elMsg.textContent=`CSV OK (${rows.length} lignes)`;
    }catch(e){ elMsg.textContent="Erreur CSV : "+e.message; }
  }

  /* Events */
  ["input","change"].forEach(evt=>{
    [forme,quantite,optLaquage,optAjourLumi,dimension].forEach(el=>{
      el.addEventListener(evt,e=>{
        if(e.target===forme||e.target===optLaquage||e.target===optAjourLumi) populateDimensions();
        compute();
      });
    });
  });

  function resetAll(){
    elForme.value=""; elDim.value=""; elQ.value=1;
    elLaq.checked=false; elAJL.checked=false;
    elLaq.disabled=false;
    populateFormes(); populateDimensions(); compute();
  }

  document.getElementById("btnReset").addEventListener("click", resetAll);

  loadCSV();
  </script>

  <!-- Charger le moteur de devis -->
  <script src="../js/devis-core.js"></script>

  <!-- Ajouter au devis (PUBLIC √ó2 ‚Üí on envoie pu_public_ht) -->
  <script>
  document.getElementById("btnAddDevis").addEventListener("click", () => {
    const quantite = Math.max(1, Number(document.getElementById("quantite").value || 1));

    // "prixHT" affiche le TOTAL HT PUBLIC
    const prixTotalText = document.getElementById("prixHT").innerText.trim(); // ex "725,00"
    const total_ht_public = parseFloat(prixTotalText.replace(",", ".")) || 0;

    // PU PUBLIC √† stocker
    const pu_public_ht = total_ht_public / quantite;

    const designationParts = [];
    const formeVal = document.getElementById("forme").value || "";
    const dimVal = document.getElementById("dimension").value || "";
    if(formeVal) designationParts.push(formeVal);
    if(dimVal) designationParts.push(dimVal);
    if(document.getElementById("optAjourLumi").checked) designationParts.push("ajourage lumineux laqu√©");
    else if(document.getElementById("optLaquage").checked) designationParts.push("laqu√©");

    const designation = "Enseigne Drapeau" + (designationParts.length ? " ‚Äî " + designationParts.join(" / ") : "");

    Devis.addLine({
      type: "Enseigne Drapeau",
      designation,
      quantite,
      pu_public_ht
    });

    alert(`‚úÖ Ajout√© au devis !
${designation}
Qt√© : ${quantite}
PU HT (PUBLIC √ó2) : ${pu_public_ht.toFixed(2)} ‚Ç¨`);
  });
  </script>

</body>
</html>
