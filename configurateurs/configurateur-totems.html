<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Configurateur Totems – Cofel</title>

<link rel="stylesheet" href="../styles/cofel.css" />
<link rel="stylesheet" href="../styles/cofel-config.css" />

<style>
  /* ======== DA "Verre Violet Cofel" ======== */
  :root{
    --violet:#5a2d82;
    --violet2:#7838a7;
    --glass-bg:rgba(255,255,255,.10);
    --glass-border:rgba(255,255,255,.25);
    --blur:18px;
    --txt:#fff;
    --txt-dim:#e6dfff;
  }

  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
    color:var(--txt);
    background:
      radial-gradient(700px 500px at 20% -10%,rgba(255,255,255,.10),transparent 70%),
      radial-gradient(800px 500px at 110% 10%,rgba(255,255,255,.08),transparent 60%),
      linear-gradient(135deg,var(--violet),var(--violet2));
  }

  /* Header */
  .cofel-header{
    position:sticky;top:0;z-index:100;
    background:linear-gradient(180deg,rgba(255,255,255,.12),rgba(255,255,255,.04));
    backdrop-filter:blur(var(--blur));
    border-bottom:1px solid rgba(255,255,255,.18);
  }
  .cofel-header .row{max-width:1100px;margin:0 auto;display:flex;align-items:center;gap:16px;padding:10px 14px}
  .cofel-back{color:#fff;text-decoration:none;border:1px solid rgba(255,255,255,.4);padding:8px 12px;border-radius:10px}
  .cofel-brand{display:flex;align-items:center;gap:10px}
  .cofel-brand img{height:36px;border-radius:6px}
  .cofel-title{margin:0;font-size:18px;font-weight:700}

  .cofel-container{max-width:1000px;margin:0 auto;padding:20px}
  h1{text-align:center;margin:10px 0 20px}

  /* Bloc principal verre */
  .wrap{
    background:linear-gradient(180deg,rgba(255,255,255,.16),rgba(255,255,255,.06));
    border:1px solid var(--glass-border);
    border-radius:20px;
    box-shadow:0 10px 28px rgba(0,0,0,.25);
    backdrop-filter:blur(var(--blur));
    padding:24px;
    color:var(--txt);
  }

  label{font-weight:700;color:#c9b7ff;display:block;margin-top:14px}

  select,input[type="number"]{
    width:100%;
    background:rgba(255,255,255,.10);
    border:1px solid var(--glass-border);
    border-radius:12px;
    color:var(--txt);
    padding:10px;
    min-height:44px;
    margin-top:6px;
    font-size:15px;
  }
  select option{background:#3c1f61;color:#fff}
  input::placeholder{color:var(--txt-dim);opacity:.8}

  .grid{display:grid;gap:16px}
  @media(min-width:820px){.grid{grid-template-columns:1fr 1fr}}

  .opt-row{
    display:flex;align-items:center;gap:8px;margin:6px 0;
    border:1px solid rgba(255,255,255,.18);
    border-radius:10px;padding:10px 12px;
    background:rgba(255,255,255,.08);
  }
  .opt-row input[type="checkbox"]{accent-color:#cbb3ff}

  .note{font-size:12px;color:var(--txt-dim)}

  .result{
    margin-top:22px;padding:16px;
    background:linear-gradient(180deg,rgba(255,255,255,.16),rgba(255,255,255,.06));
    border:1px solid var(--glass-border);
    border-radius:16px;text-align:center;
    font-size:18px;font-weight:700;
    box-shadow:0 6px 16px rgba(0,0,0,.25);
  }

  .cofel-footer{
    text-align:center;color:var(--txt-dim);
    font-size:13px;padding:24px 10px;opacity:.85;
  }

  #btnAddDevis{
    position:fixed;right:20px;bottom:20px;
    background:#fff;color:#000;
    border:none;border-radius:12px;
    padding:12px 18px;font-weight:800;
    box-shadow:0 10px 24px rgba(0,0,0,.3);
    cursor:pointer;z-index:999;
    transition:all .15s ease;
  }
  #btnAddDevis:hover{transform:translateY(-2px);box-shadow:0 12px 26px rgba(0,0,0,.35);}
</style>
</head>
<body>

<header class="cofel-header">
  <div class="row">
    <a class="cofel-back" href="../index.html">⬅ Retour aux configurateurs</a>
    <div class="cofel-brand">
      <img src="../assets/logo cofel.jpg" alt="Cofel"/>
      <h1 class="cofel-title">Configurateur — Totems</h1>
    </div>
  </div>
</header>

<div class="cofel-container">
  <h1>Configurateur Totems Cofel</h1>
  <div class="wrap">
    <label for="type">Type de face</label>
    <select id="type"><option value="">— sélectionnez —</option></select>

    <div class="grid">
      <div>
        <label for="hauteur">Hauteur (mm)</label>
        <select id="hauteur"><option value="">— sélectionnez —</option></select>
      </div>
      <div>
        <label for="largeur">Largeur (mm)</label>
        <select id="largeur"><option value="">— sélectionnez —</option></select>
      </div>
    </div>

    <label>Options (multi-choix)</label>
    <div id="optionsBox" class="opt-wrap">
      <div class="opt-row"><em>Aucune option disponible tant que la hauteur n’est pas choisie.</em></div>
    </div>

    <label for="quantite">Quantité</label>
    <input type="number" id="quantite" value="1" min="1"/>

    <div class="result">
      <p>Prix HT : <span id="prixHT">0,00</span> €</p>
      <p>Prix TTC : <span id="prixTTC">0,00</span> €</p>
    </div>
  </div>
</div>

<footer class="cofel-footer">
  © Cofel — ZA du Perquoi, 72560 Changé — SIRET 927 659 458 00024 — TVA FR80927659458
</footer>

<!-- ===== JS logique inchangée ===== -->
<script>
const URL_TARIFS  = "https://raw.githubusercontent.com/stevens-cofel/configurateur-cofel/refs/heads/main/Tarifs_Totems_.csv";
const URL_OPTIONS = "https://raw.githubusercontent.com/stevens-cofel/configurateur-cofel/refs/heads/main/option%20platine%20et%20panier%20de%20crosses%20(1).csv";
const TVA = 0.20;
const UPLIFT_PUBLIC = 2.0;

let RAW_TARIFFS=[], RAW_OPTIONS=[], HEADS_T=[], HEADS_O=[], TARIFFS=[], OPTIONS=[];
const MAP_T={type:null,h:null,l:null,price:null}, MAP_O={type:null,hmin:null,hmax:null,price:null,actif:null};

const elType=document.getElementById('type');
const elH=document.getElementById('hauteur');
const elL=document.getElementById('largeur');
const elOptsBox=document.getElementById('optionsBox');
const elQte=document.getElementById('quantite');
const elHT=document.getElementById('prixHT');
const elTTC=document.getElementById('prixTTC');

function num(v){const s=String(v??'').replace(/\s/g,'').replace(',','.');const m=s.match(/-?\d+(\.\d+)?/);return m?parseFloat(m[0]):NaN;}
function normalizeKey(k){return String(k||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9]+/g,'');}
function parseCSVAuto(text){
  text=text.replace(/^\uFEFF/,'').trim();
  const first=text.split(/\r?\n/,1)[0]||'';
  const sep=(first.match(/;/g)||[]).length>(first.match(/,/g)||[]).length?';':',';
  const lines=text.split(/\r?\n/).filter(l=>l.trim());
  const headsRaw=lines[0].split(sep).map(h=>h.trim());
  const heads=headsRaw.map(normalizeKey);
  const rows=lines.slice(1).map(l=>{
    const cells=l.split(sep).map(c=>c.replace(/^"+|"+$/g,'').trim());
    const o={};heads.forEach((h,i)=>o[h]=cells[i]||'');return o;
  });
  return{rows,heads};
}
function unique(arr){return[...new Set(arr)].filter(Boolean).sort((a,b)=>a-b);}

function applyData(){
  const typeKey=HEADS_T.find(h=>/type/.test(h));
  const hKey=HEADS_T.find(h=>/hauteur|height/.test(h));
  const lKey=HEADS_T.find(h=>/largeur|width/.test(h));
  const priceKey=HEADS_T.find(h=>/prix|eur|ht|base/.test(h));
  TARIFFS=RAW_TARIFFS.map(r=>({type:r[typeKey],h:r[hKey],l:r[lKey],price:num(r[priceKey])}));

  const types=[...new Set(TARIFFS.map(r=>r.type))].sort();
  elType.innerHTML='<option value="">— sélectionnez —</option>'+types.map(t=>`<option>${t}</option>`).join('');
}

function populateHL(){
  const t=elType.value;
  const filt=TARIFFS.filter(r=>r.type===t);
  const H=unique(filt.map(r=>r.h));
  const L=unique(filt.map(r=>r.l));
  elH.innerHTML='<option value="">— sélectionnez —</option>'+H.map(v=>`<option>${v}</option>`).join('');
  elL.innerHTML='<option value="">— sélectionnez —</option>'+L.map(v=>`<option>${v}</option>`).join('');
}

function renderOptions(){
  const typeKey=HEADS_O.find(h=>/type/.test(h));
  const hminKey=HEADS_O.find(h=>/min/.test(h));
  const hmaxKey=HEADS_O.find(h=>/max/.test(h));
  const priceKey=HEADS_O.find(h=>/prix|price/.test(h));
  const actKey=HEADS_O.find(h=>/actif|active|true/.test(h));

  OPTIONS=RAW_OPTIONS.map(r=>({
    type:r[typeKey],hmin:num(r[hminKey]),hmax:num(r[hmaxKey]),
    price:num(r[priceKey]),actif:/oui|true|1|vrai/.test((r[actKey]||'').toLowerCase())
  }));

  const fams=[...new Set(OPTIONS.map(o=>o.type))];
  const h=num(elH.value);
  elOptsBox.innerHTML=fams.map(f=>{
    const ok=OPTIONS.some(o=>o.type===f&&h>=o.hmin&&h<=o.hmax&&o.actif);
    return `<label class="opt-row"><input type="checkbox" value="${f}" ${ok?'':'disabled'}><span>${f}</span></label>`;
  }).join('');
  elOptsBox.querySelectorAll('input').forEach(cb=>cb.addEventListener('change',compute));
}

function priceBase(){
  const t=elType.value,h=elH.value,l=elL.value;
  const r=TARIFFS.find(r=>r.type===t&&r.h===h&&r.l===l);
  return r?r.price:0;
}
function priceOpt(){
  const h=num(elH.value);
  return [...elOptsBox.querySelectorAll('input:checked')].reduce((s,cb)=>{
    const rows=OPTIONS.filter(o=>o.type===cb.value&&h>=o.hmin&&h<=o.hmax&&o.actif);
    if(!rows.length)return s;return s+Math.max(...rows.map(o=>o.price));
  },0);
}

function compute(){
  const base=priceBase(),opts=priceOpt(),q=Math.max(1,parseInt(elQte.value||'1'));
  const unit=(base+opts)*UPLIFT_PUBLIC;
  const total=unit*q,ttc=total*(1+TVA);
  elHT.textContent=total.toFixed(2).replace('.',',');
  elTTC.textContent=ttc.toFixed(2).replace('.',',');
}

async function loadAll(){
  const [rt,ro]=await Promise.all([fetch(URL_TARIFS),fetch(URL_OPTIONS)]);
  const txtT=await rt.text(),txtO=await ro.text();
  const pT=parseCSVAuto(txtT),pO=parseCSVAuto(txtO);
  RAW_TARIFFS=pT.rows;HEADS_T=pT.heads;RAW_OPTIONS=pO.rows;HEADS_O=pO.heads;
  applyData();
}

elType.onchange=()=>{populateHL();renderOptions();compute();}
elH.onchange=()=>{renderOptions();compute();}
elL.onchange=compute;
elQte.oninput=compute;

loadAll();
</script>

<script src="../js/devis-core.js"></script>
<button id="btnAddDevis">➕ Ajouter au devis</button>

<script>
(function(){
  const btn=document.getElementById('btnAddDevis');
  if(!btn)return;

  function parseHT(){
    const t=document.getElementById('prixHT').innerText.trim();
    return Number(t.replace(/\s/g,'').replace(',','.'))||0;
  }

  btn.addEventListener('click',()=>{
    try{
      if(!window.Devis)throw new Error('Moteur de devis introuvable.');
      const type=document.getElementById('type').value||'';
      const H=document.getElementById('hauteur').value||'';
      const L=document.getElementById('largeur').value||'';
      const q=Math.max(1,parseInt(document.getElementById('quantite').value||'1',10));
      if(!type||!H||!L){alert('Merci de renseigner le type, la hauteur et la largeur.');return;}
      const total=parseHT();if(total<=0){alert('Le total est à 0.');return;}
      const pu=Number((total/q).toFixed(2));
      const opts=[...document.querySelectorAll('#optionsBox input:checked')].map(c=>c.value);
      const designation=['Totem',type,`H ${H} mm × L ${L} mm`,opts.length?`Options: ${opts.join(', ')}`:null].filter(Boolean).join(' — ');
      Devis.addLine({type:'Totem',designation,quantite:q,pu_public_ht:pu});
      alert(`✅ Ligne ajoutée au devis !\n${designation}\nQté : ${q}\nPU HT : ${pu.toFixed(2)} €`);
    }catch(e){alert('Erreur : '+e.message);}
  });
})();
</script>

</body>
</html>
