<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Configurateur Totems Cofel</title>
<style>
  :root{
    --violet:#5a2d82;
    --violet2:#7c5ab8;
    --panel-bg:rgba(255,255,255,0.08);
    --panel-bd:rgba(255,255,255,0.25);
  }

  body{
    font-family:Arial, sans-serif;
    background:linear-gradient(135deg,var(--violet),var(--violet2));
    margin:0;
    padding:24px;
    color:#fff;
  }
  h1{text-align:center;margin:0 0 16px;font-weight:800}

  .wrap{
    max-width:880px;
    margin:0 auto;
    background:var(--panel-bg);
    border:1px solid var(--panel-bd);
    border-radius:16px;
    box-shadow:0 10px 28px rgba(0,0,0,.25);
    padding:24px;
    backdrop-filter:blur(12px);
  }

  label{display:block;margin-top:14px;font-weight:700}
  select,input{
    width:100%;
    padding:10px;
    margin-top:6px;
    border:1px solid rgba(255,255,255,.4);
    border-radius:10px;
    background:#fff;
    color:#2b2140;
    font-weight:600;
  }
  select option{background-color:#fff;color:#2b2140}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  @media(max-width:820px){.grid{grid-template-columns:1fr}}

  .result{
    margin-top:22px;
    padding:16px;
    background:rgba(255,255,255,0.1);
    border:1px solid var(--panel-bd);
    border-radius:12px;
    font-size:18px;
    text-align:center;
  }

  .muted{color:#d9d0ec;font-size:12px;margin-top:8px;white-space:pre-wrap}
  .mapping{
    margin:16px 0;
    padding:12px;
    border:1px solid var(--panel-bd);
    background:rgba(255,255,255,0.06);
    border-radius:12px;
    backdrop-filter:blur(10px);
  }
  .mapping h3{margin:0 0 8px}
  .btn{
    display:inline-block;
    margin-top:8px;
    padding:10px 14px;
    border:none;
    background:#fff;
    color:var(--violet);
    border-radius:12px;
    cursor:pointer;
    font-weight:700;
  }
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .two{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  .hr{height:1px;background:rgba(255,255,255,.3);margin:16px 0}

  .options-wrap{
    margin-top:8px;
    border:1px solid var(--panel-bd);
    border-radius:12px;
    padding:10px;
    background:rgba(255,255,255,0.08);
  }
  .opt-row{
    display:flex;align-items:center;gap:8px;margin:6px 0;
    background:rgba(255,255,255,0.08);
    border:1px solid var(--panel-bd);
    border-radius:10px;
    padding:8px 10px;
  }
  .opt-row input[type="checkbox"]{transform:scale(1.2);accent-color:#fff}
  .opt-row span.note{font-size:12px;color:#d9d0ec}
</style>
</head>
<body>
<h1>Configurateur Totems Cofel</h1>

<div class="wrap">
  <div id="mapTarifsBox" class="mapping" style="display:none">
    <h3>ðŸ“„ Mappage des colonnes TARIFS</h3>
    <div class="two">
      <div><label>Type de face</label><select id="mapT_Type"></select></div>
      <div><label>Prix base HT</label><select id="mapT_Price"></select></div>
      <div><label>Hauteur (mm)</label><select id="mapT_H"></select></div>
      <div><label>Largeur (mm)</label><select id="mapT_L"></select></div>
    </div>
    <button id="applyMapTarifs" class="btn">Appliquer</button>
  </div>

  <div id="mapOptionsBox" class="mapping" style="display:none">
    <h3>ðŸ§© Mappage des colonnes OPTIONS</h3>
    <div class="two">
      <div><label>Type dâ€™option</label><select id="mapO_Type"></select></div>
      <div><label>Prix unitaire HT</label><select id="mapO_Price"></select></div>
      <div><label>Hauteur min (mm)</label><select id="mapO_HMin"></select></div>
      <div><label>Hauteur max (mm)</label><select id="mapO_HMax"></select></div>
      <div><label>Actif</label><select id="mapO_Actif"></select></div>
    </div>
    <button id="applyMapOptions" class="btn">Appliquer</button>
  </div>

  <div class="hr"></div>

  <label for="type">Type de face</label>
  <select id="type"><option value="">â€” sÃ©lectionnez â€”</option></select>

  <div class="grid">
    <div>
      <label for="hauteur">Hauteur (mm)</label>
      <select id="hauteur"><option value="">â€” sÃ©lectionnez â€”</option></select>
    </div>
    <div>
      <label for="largeur">Largeur (mm)</label>
      <select id="largeur"><option value="">â€” sÃ©lectionnez â€”</option></select>
    </div>
  </div>

  <label>Options (multi-choix)</label>
  <div id="optionsBox" class="options-wrap">
    <div class="opt-row"><em>Aucune option disponible tant que la hauteur nâ€™est pas choisie.</em></div>
  </div>

  <label for="quantite">QuantitÃ©</label>
  <input type="number" id="quantite" value="1" min="1"/>

  <div class="result">
    <p>Prix HT : <span id="prixHT">0,00</span> â‚¬</p>
    <p>Prix TTC : <span id="prixTTC">0,00</span> â‚¬</p>
  </div>

  <div id="msg" class="muted"></div>
</div>

<script>
/* ------- CONFIG ------- */
const URL_TARIFS  = "https://raw.githubusercontent.com/stevens-cofel/configurateur-cofel/refs/heads/main/Tarifs_Totems_.csv";
const URL_OPTIONS = "https://raw.githubusercontent.com/stevens-cofel/configurateur-cofel/refs/heads/main/option%20platine%20et%20panier%20de%20crosses%20(1).csv";
const TVA = 0.20;
const UPLIFT_PUBLIC = 2.0; // tarif public x2

/* ------- reste du JS original inchangÃ© sauf ligne compute() ------- */
let RAW_TARIFFS=[],RAW_OPTIONS=[],RAW_HEADERS_T=[],RAW_HEADERS_O=[],HEADS_T=[],HEADS_O=[],TARIFFS=[],OPTIONS=[];
const MAP_T=JSON.parse(localStorage.getItem('MAP_T')||'null')||{type:null,h:null,l:null,price:null};
const MAP_O=JSON.parse(localStorage.getItem('MAP_O')||'null')||{type:null,hmin:null,hmax:null,price:null,actif:null};
const $=id=>document.getElementById(id);
const elType=$('type'),elH=$('hauteur'),elL=$('largeur'),elOptsBox=$('optionsBox'),elQte=$('quantite'),elHT=$('prixHT'),elTTC=$('prixTTC'),elMsg=$('msg');
function num(v){const s=String(v??'').replace(/\u202F/g,'').replace(/\s/g,'').replace(',','.');const m=s.match(/-?\d+(\.\d+)?/);return m?parseFloat(m[0]):NaN;}
function normalizeKey(k){return String(k||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9]+/g,'').trim();}
function parseCSVAuto(text){text=text.replace(/^\uFEFF/,'').trim();const first=text.split(/\r?\n/,1)[0]||'';const sep=(first.match(/;/g)||[]).length>(first.match(/,/g)||[]).length?';':',';const lines=text.split(/\r?\n/).filter(l=>l.trim().length>0);const rawHeads=lines[0].split(sep).map(h=>h.replace(/^"+|"+$/g,'').trim());const heads=rawHeads.map(h=>normalizeKey(h));const rows=lines.slice(1).map(line=>{const cells=line.split(sep).map(c=>c.replace(/^"+|"+$/g,'').trim());const o={};heads.forEach((h,i)=>o[h]=cells[i]??'');return o;});return{rows,rawHeads,heads};}
function uniqueSortedNumeric(arr){return[...new Set(arr)].map(num).filter(n=>!isNaN(n)).sort((a,b)=>a-b).map(String);}
function fillSelect(sel,heads,rawHeads){sel.innerHTML='<option value="">â€” choisir â€”</option>'+heads.map((k,i)=>`<option value="${k}">${rawHeads[i]}</option>`).join('');}
function isActive(v){const s=String(v||'').trim().toLowerCase();return['true','1','oui','vrai','yes','y','x'].includes(s);}
function suggestMapTarifs(){const f=re=>HEADS_T.find(k=>re.test(k));MAP_T.type=MAP_T.type||f(/type/);MAP_T.h=MAP_T.h||f(/hauteur|height/);MAP_T.l=MAP_T.l||f(/largeur|width/);MAP_T.price=MAP_T.price||f(/prix|base|eur|ht/);}
function suggestMapOptions(){const f=re=>HEADS_O.find(k=>re.test(k));MAP_O.type=MAP_O.type||f(/type/);MAP_O.hmin=MAP_O.hmin||f(/min/);MAP_O.hmax=MAP_O.hmax||f(/max/);MAP_O.price=MAP_O.price||f(/prix|ht|unitaire|price/);MAP_O.actif=MAP_O.actif||f(/actif|active|true|oui|1/);}
function applyTarifs(){if(!MAP_T.type||!MAP_T.h||!MAP_T.l||!MAP_T.price)return false;TARIFFS=RAW_TARIFFS.map(r=>({type:String(r[MAP_T.type]||'').trim(),h:String(r[MAP_T.h]||'').trim(),l:String(r[MAP_T.l]||'').trim(),priceBase:num(r[MAP_T.price])||0})).filter(r=>r.type&&r.h&&r.l);const types=[...new Set(TARIFFS.map(r=>r.type))].sort();elType.innerHTML='<option value="">â€” sÃ©lectionnez â€”</option>'+types.map(t=>`<option value="${t}">${t}</option>`).join('');localStorage.setItem('MAP_T',JSON.stringify(MAP_T));return true;}
function applyOptions(){if(!MAP_O.type||!MAP_O.hmin||!MAP_O.hmax||!MAP_O.price||!MAP_O.actif)return false;OPTIONS=RAW_OPTIONS.map(r=>({typeOption:String(r[MAP_O.type]||'').trim(),hmin:num(r[MAP_O.hmin]),hmax:num(r[MAP_O.hmax]),priceUnit:num(r[MAP_O.price])||0,actif:isActive(r[MAP_O.actif])}));localStorage.setItem('MAP_O',JSON.stringify(MAP_O));return true;}
function populateHL(){const t=elType.value;const f=TARIFFS.filter(r=>r.type===t);const H=uniqueSortedNumeric(f.map(r=>r.h));const L=uniqueSortedNumeric(f.map(r=>r.l));elH.innerHTML='<option value="">â€” sÃ©lectionnez â€”</option>'+H.map(v=>`<option value="${v}">${v}</option>`).join('');elL.innerHTML='<option value="">â€” sÃ©lectionnez â€”</option>'+L.map(v=>`<option value="${v}">${v}</option>`).join('');}
function renderOptionsCheckboxes(){const fams=[...new Set(OPTIONS.map(o=>o.typeOption))].filter(Boolean).sort();if(!fams.length){elOptsBox.innerHTML='<div class="opt-row"><em>Aucune option disponible.</em></div>';return;}const h=num(elH.value);const isValid=fam=>{if(!h)return false;const rows=OPTIONS.filter(o=>o.typeOption===fam&&h>=o.hmin&&h<=o.hmax&&o.actif);return rows.length>0;};elOptsBox.innerHTML=fams.map(f=>{const ok=isValid(f);const note=ok?'':` <span class="note">(non dispo pour H=${elH.value||'â€”'})</span>`;return`<label class="opt-row"><input type="checkbox" name="opt" value="${f}" ${ok?'':'disabled'}><span>${f}</span>${note}</label>`;}).join('');[...elOptsBox.querySelectorAll('input[name="opt"]')].forEach(cb=>cb.addEventListener('change',compute));}
function priceBase(){const t=elType.value;const h=num(elH.value);const l=num(elL.value);if(!t||!h||!l)return 0;const row=TARIFFS.find(r=>r.type===t&&Math.abs(num(r.h)-h)<.001&&Math.abs(num(r.l)-l)<.001);return row?row.priceBase:0;}
function priceOptionsSum(){const checked=[...elOptsBox.querySelectorAll('input[name="opt"]:checked')].map(c=>c.value);if(!checked.length)return 0;const h=num(elH.value);return checked.reduce((sum,fam)=>{const rows=OPTIONS.filter(o=>o.typeOption===fam&&h>=o.hmin&&h<=o.hmax&&o.actif);if(!rows.length)return sum;const unit=Math.max(...rows.map(o=>o.priceUnit).filter(v=>!isNaN(v)));return sum+(isFinite(unit)?unit:0);},0);}
function compute(){const base=priceBase();const opt=priceOptionsSum();const qte=Math.max(1,parseInt(elQte.value||'1',10));const totalHT=(base+opt)*qte*UPLIFT_PUBLIC;const totalTTC=totalHT*(1+TVA);elHT.textContent=totalHT.toFixed(2).replace('.',',');elTTC.textContent=totalTTC.toFixed(2).replace('.',',');}
async function loadAll(){try{const[rt,ro]=await Promise.all([fetch(URL_TARIFS),fetch(URL_OPTIONS)]);if(!rt.ok||!ro.ok)throw new Error('Chargement rÃ©seau impossible.');const[txtT,txtO]=await Promise.all([rt.text(),ro.text()]);const pT=parseCSVAuto(txtT),pO=parseCSVAuto(txtO);RAW_TARIFFS=pT.rows;RAW_HEADERS_T=pT.rawHeads;HEADS_T=pT.heads;RAW_OPTIONS=pO.rows;RAW_HEADERS_O=pO.rawHeads;HEADS_O=pO.heads;suggestMapTarifs();suggestMapOptions();if(applyTarifs())populateHL();if(applyOptions())renderOptionsCheckboxes();elType.addEventListener('change',()=>{populateHL();renderOptionsCheckboxes();compute();});elH.addEventListener('change',()=>{renderOptionsCheckboxes();compute();});elL.addEventListener('change',compute);elQte.addEventListener('input',compute);compute();}catch(e){elMsg.textContent='Erreur : '+e.message;console.error(e);}}
loadAll();
</script>
</body>
</html>
