<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Configurateur ‚Äî Totems Cofel</title>

<!-- (Optionnel) si tu as des styles communs -->
<link rel="stylesheet" href="../styles/cofel.css" />
<link rel="stylesheet" href="../styles/cofel-config.css" />

<style>
  /* ====== DA Cofel : verre violet (m√™me esprit que T√¥le Tablette) ====== */
  :root{
    --violet:#5a2d82;
    --violet-2:#7838a7;
    --glass: rgba(255,255,255,.08);
    --glass-hr: rgba(255,255,255,.14);
    --txt:#f5f7ff;
    --txt-dim:#e6e6ff;
    --accent:#c9b7ff;
    --radius:18px;
    --blur:18px;
    --shadow: 0 10px 30px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--txt);
    font-family:-apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, Arial, sans-serif;
    background:
      radial-gradient(800px 500px at 20% -10%, rgba(255,255,255,.10), transparent 60%),
      radial-gradient(800px 500px at 110% 10%, rgba(255,255,255,.08), transparent 60%),
      linear-gradient(135deg, var(--violet), var(--violet-2));
  }

  /* ===== Header (coh√©rent accueil) ===== */
  .cofel-header{
    position:sticky; top:0; z-index:1000; color:#fff;
    background: linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.06));
    border-bottom:1px solid rgba(255,255,255,.18);
    backdrop-filter: blur(var(--blur));
  }
  .cofel-header .row{
    max-width:1200px; margin:0 auto; display:flex; align-items:center; gap:16px; padding:10px 14px;
  }
  .cofel-back{
    color:#fff; text-decoration:none; border:1px solid rgba(255,255,255,.35);
    padding:8px 12px; border-radius:12px; backdrop-filter: blur(10px);
  }
  .cofel-brand{display:flex; align-items:center; gap:10px}
  .cofel-brand img{height:36px; border-radius:8px; object-fit:cover}
  .cofel-title{font-size:18px; margin:0}
  .cofel-container{max-width:1100px; margin:0 auto; padding:18px}

  h1{margin:8px 0 14px; text-align:center; letter-spacing:.2px}

  /* ===== Cartes / fieldsets ‚Äúverre‚Äù ===== */
  fieldset{
    border:1px solid rgba(255,255,255,.2);
    border-radius:20px; padding:16px; margin:16px 0;
    background: linear-gradient(180deg, rgba(255,255,255,.16), rgba(255,255,255,.06));
    box-shadow: var(--shadow); backdrop-filter: blur(var(--blur));
    overflow:visible;
  }
  legend{
    padding:0 10px; font-weight:800; color:#fff; letter-spacing:.2px;
  }
  label{font-weight:700; font-size:13px; color:var(--accent); display:block; margin-top:10px}

  input[type="number"],
  input[type="text"],
  select{
    width:100%; margin-top:6px; padding:12px 12px; min-height:42px;
    background: rgba(255,255,255,.10); color:var(--txt);
    border:1px solid rgba(255,255,255,.24); border-radius:14px; outline:none;
    transition: border-color .18s ease, background .18s ease, box-shadow .18s ease;
    position:relative; z-index:1;
  }
  input::placeholder{color:#f0edff; opacity:.75}
  input:focus, select:focus{
    border-color: rgba(255,255,255,.38);
    background: rgba(255,255,255,.16);
    box-shadow: 0 0 0 4px rgba(255,255,255,.08) inset;
  }

  /* Menu d√©roulant harmonis√© (fond violet pour la liste) */
  select{ appearance:auto; }
  select option{ background:#3c1f61; color:#fff; }
  fieldset, .options-wrap{ position:relative; z-index:1; }
  select:focus{ z-index:1001; }

  .grid{display:grid; gap:16px}
  @media(min-width:820px){ .grid{grid-template-columns:1fr 1fr} }

  /* Mapping (rest√© discret) */
  .mapping{
    margin:16px 0; padding:12px;
    background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.05));
    border:1px solid rgba(255,255,255,.18); border-radius:16px;
  }
  .mapping h3{margin:0 0 8px; color:#fff}
  .two{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  @media(max-width:720px){ .two{grid-template-columns:1fr} }

  /* Options */
  .options-wrap{
    margin-top:8px;border:1px solid rgba(255,255,255,.22);border-radius:14px;padding:10px;
    background: linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.06));
  }
  .opt-row{
    display:flex;align-items:center;gap:10px;margin:6px 0;
    border:1px solid rgba(255,255,255,.18);border-radius:12px;padding:10px 12px;
    background: linear-gradient(180deg, rgba(255,255,255,.16), rgba(255,255,255,.08));
  }
  .opt-row input[type="checkbox"]{transform:scale(1.1); accent-color:#cbb3ff}
  .opt-row .note{color:var(--txt-dim);font-size:12px}

  /* R√©sultats */
  .result{
    margin-top:18px;padding:16px;text-align:center;font-size:18px;
    background: linear-gradient(180deg, rgba(255,255,255,.16), rgba(255,255,255,.06));
    border:1px solid rgba(255,255,255,.24); border-radius:20px;
    box-shadow: var(--shadow); backdrop-filter: blur(var(--blur));
  }
  .result span{ font-weight:800; }

  /* Bouton Ajouter au devis */
  #btnAddDevis{
    position:fixed; right:20px; bottom:20px; padding:12px 18px;
    background:#fff; color:#0b0b0b; border:none; border-radius:14px;
    box-shadow:0 10px 24px rgba(0,0,0,.25); cursor:pointer; font-weight:800; z-index:2000;
    transition: transform .16s ease, box-shadow .16s ease, opacity .16s ease;
  }
  #btnAddDevis:active{ transform: translateY(1px); box-shadow: 0 6px 16px rgba(0,0,0,.28); }

  /* Footer */
  .cofel-footer{
    color:#f3ecff; font-size:12px; text-align:center; padding:24px 10px; opacity:.9;
  }
  .muted{color:var(--txt-dim);font-size:12px;margin-top:8px;white-space:pre-wrap}
</style>
</head>
<body>

<!-- Bandeau violet / retour -->
<header class="cofel-header">
  <div class="row">
    <a class="cofel-back" href="../index.html">‚¨Ö Retour aux configurateurs</a>
    <div class="cofel-brand">
      <img src="../assets/logo cofel.jpg" alt="Cofel" />
      <h1 class="cofel-title">Configurateur ‚Äî Totems</h1>
    </div>
  </div>
</header>

<div class="cofel-container">
  <h1>Totems Cofel</h1>

  <div class="wrap">

    <!-- ===== MAPPAGE TARIFS ===== -->
    <div id="mapTarifsBox" class="mapping" style="display:none">
      <h3>üìÑ Mappage des colonnes TARIFS</h3>
      <div class="two">
        <div>
          <label>Colonne ‚ÄúType de face‚Äù</label>
          <select id="mapT_Type"></select>
        </div>
        <div>
          <label>Colonne ‚ÄúPrix base HT‚Äù</label>
          <select id="mapT_Price"></select>
        </div>
        <div>
          <label>Colonne ‚ÄúHauteur (mm)‚Äù</label>
          <select id="mapT_H"></select>
        </div>
        <div>
          <label>Colonne ‚ÄúLargeur (mm)‚Äù</label>
          <select id="mapT_L"></select>
        </div>
      </div>
      <button id="applyMapTarifs" class="pill">Appliquer le mappage TARIFS</button>
    </div>

    <!-- ===== MAPPAGE OPTIONS ===== -->
    <div id="mapOptionsBox" class="mapping" style="display:none">
      <h3>üß© Mappage des colonnes OPTIONS</h3>
      <div class="two">
        <div>
          <label>Colonne ‚ÄúType d‚Äôoption‚Äù (Platine / Panier de crosses)</label>
          <select id="mapO_Type"></select>
        </div>
        <div>
          <label>Colonne ‚ÄúPrix unitaire HT‚Äù</label>
          <select id="mapO_Price"></select>
        </div>
        <div>
          <label>Colonne ‚ÄúHauteur min (mm)‚Äù</label>
          <select id="mapO_HMin"></select>
        </div>
        <div>
          <label>Colonne ‚ÄúHauteur max (mm)‚Äù</label>
          <select id="mapO_HMax"></select>
        </div>
        <div>
          <label>Colonne ‚ÄúActif‚Äù (Oui/True/1)</label>
          <select id="mapO_Actif"></select>
        </div>
      </div>
      <button id="applyMapOptions" class="pill">Appliquer le mappage OPTIONS</button>
    </div>

    <!-- ===== UI CONFIG ===== -->
    <fieldset>
      <legend>Configuration</legend>
      <label for="type">Type de face</label>
      <select id="type"><option value="">‚Äî s√©lectionnez ‚Äî</option></select>

      <div class="grid">
        <div>
          <label for="hauteur">Hauteur (mm)</label>
          <select id="hauteur"><option value="">‚Äî s√©lectionnez ‚Äî</option></select>
        </div>
        <div>
          <label for="largeur">Largeur (mm)</label>
          <select id="largeur"><option value="">‚Äî s√©lectionnez ‚Äî</option></select>
        </div>
      </div>

      <label>Options (multi-choix)</label>
      <div id="optionsBox" class="options-wrap">
        <div class="opt-row"><em>Aucune option disponible tant que la hauteur n‚Äôest pas choisie.</em></div>
      </div>

      <label for="quantite">Quantit√©</label>
      <input type="number" id="quantite" value="1" min="1"/>
    </fieldset>

    <!-- ===== R√©sultats ===== -->
    <div class="result">
      <p>Prix HT : <span id="prixHT">0,00</span> ‚Ç¨</p>
      <p>Prix TTC : <span id="prixTTC">0,00</span> ‚Ç¨</p>
    </div>

    <div id="msg" class="muted"></div>
  </div>
</div>

<!-- Pied de page -->
<footer class="cofel-footer">
  ¬© Cofel ‚Äî ZA du Perquoi, 72560 Chang√© ‚Äî SIRET 927 659 458 00024 ‚Äî TVA FR80927659458
</footer>

<!-- ===== JS (fonctionnel, avec tarif PUBLIC x2) ===== -->
<script>
/* ------- CONFIG ------- */
const URL_TARIFS  = "https://raw.githubusercontent.com/stevens-cofel/configurateur-cofel/refs/heads/main/Tarifs_Totems_.csv";
const URL_OPTIONS = "https://raw.githubusercontent.com/stevens-cofel/configurateur-cofel/refs/heads/main/option%20platine%20et%20panier%20de%20crosses%20(1).csv";
const TVA = 0.20;
// IMPORTANT : affichage PUBLIC = x2
const UPLIFT_PUBLIC = 2.0;

/* ------- STATE ------- */
let RAW_TARIFFS = [];
let RAW_OPTIONS = [];
let RAW_HEADERS_T = [];
let RAW_HEADERS_O = [];
let HEADS_T = [];
let HEADS_O = [];
let TARIFFS = [];
let OPTIONS = [];

const MAP_T = JSON.parse(localStorage.getItem('MAP_T') || 'null') || {type:null,h:null,l:null,price:null};
const MAP_O = JSON.parse(localStorage.getItem('MAP_O') || 'null') || {type:null,hmin:null,hmax:null,price:null,actif:null};

/* ------- ELEMENTS ------- */
const elType = document.getElementById('type');
const elH    = document.getElementById('hauteur');
const elL    = document.getElementById('largeur');
const elOptsBox = document.getElementById('optionsBox');
const elQte  = document.getElementById('quantite');
const elHT   = document.getElementById('prixHT');
const elTTC  = document.getElementById('prixTTC');
const elMsg  = document.getElementById('msg');

/* ------- HELPERS ------- */
function num(v){
  const s = String(v ?? '').replace(/\u202F/g,'').replace(/\s/g,'').replace(',', '.');
  const m = s.match(/-?\d+(\.\d+)?/);
  return m ? parseFloat(m[0]) : NaN;
}
function normalizeKey(k){
  return String(k||'').toLowerCase()
    .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
    .replace(/[^a-z0-9]+/g,'').trim();
}
function parseCSVAuto(text){
  text = text.replace(/^\uFEFF/, '').trim();
  const first = text.split(/\r?\n/,1)[0] || '';
  const sep = (first.match(/;/g)||[]).length > (first.match(/,/g)||[]).length ? ';' : ',';
  const lines = text.split(/\r?\n/).filter(l=>l.trim().length>0);
  const rawHeads = lines[0].split(sep).map(h=>h.replace(/^"+|"+$/g,'').trim());
  const heads = rawHeads.map(h=>normalizeKey(h));
  const rows = lines.slice(1).map(line=>{
    const cells = line.split(sep).map(c=>c.replace(/^"+|"+$/g,'').trim());
    const o={}; heads.forEach((h,i)=>o[h]=cells[i]??''); return o;
  });
  return { rows, rawHeads, heads };
}
function uniqueSortedNumeric(arr){
  return [...new Set(arr)].map(num).filter(n=>!isNaN(n)).sort((a,b)=>a-b).map(String);
}
function fillSelect(sel, heads, rawHeads){
  sel.innerHTML = '<option value="">‚Äî choisir ‚Äî</option>' +
    heads.map((k,i)=>`<option value="${k}">${rawHeads[i]}</option>`).join('');
}
function isActive(v){
  const s = String(v||'').trim().toLowerCase();
  return ['true','1','oui','vrai','yes','y','x'].includes(s);
}

/* ------- MAPPAGE ------- */
function suggestMapTarifs(){
  const f = (re)=> HEADS_T.find(k=>re.test(k));
  MAP_T.type  = MAP_T.type  || f(/type/);
  MAP_T.h     = MAP_T.h     || f(/hauteur|height/);
  MAP_T.l     = MAP_T.l     || f(/largeur|width/);
  MAP_T.price = MAP_T.price || f(/prix|base|eur|ht/);
}
function suggestMapOptions(){
  const f = (re)=> HEADS_O.find(k=>re.test(k));
  MAP_O.type  = MAP_O.type  || f(/type/);
  MAP_O.hmin  = MAP_O.hmin  || f(/min/);
  MAP_O.hmax  = MAP_O.hmax  || f(/max/);
  MAP_O.price = MAP_O.price || f(/prix|ht|unitaire|price/);
  MAP_O.actif = MAP_O.actif || f(/actif|active|isactive|true|oui|1|vrai|yes/);
}
function applyTarifs(){
  if(!MAP_T.type || !MAP_T.h || !MAP_T.l || !MAP_T.price) return false;
  TARIFFS = RAW_TARIFFS.map(r=>({
    type: String(r[MAP_T.type] || '').trim(),
    h:    String(r[MAP_T.h]    || '').trim(),
    l:    String(r[MAP_T.l]    || '').trim(),
    priceBase: num(r[MAP_T.price]) || 0
  })).filter(r=>r.type && r.h && r.l);

  const types = [...new Set(TARIFFS.map(r=>r.type))].sort();
  elType.innerHTML = '<option value="">‚Äî s√©lectionnez ‚Äî</option>' +
    types.map(t=>`<option value="${t}">${t}</option>`).join('');
  localStorage.setItem('MAP_T', JSON.stringify(MAP_T));
  return true;
}
function applyOptions(){
  if(!MAP_O.type || !MAP_O.hmin || !MAP_O.hmax || !MAP_O.price || !MAP_O.actif) return false;
  OPTIONS = RAW_OPTIONS.map(r=>({
    typeOption: String(r[MAP_O.type] || '').trim(),
    hmin: num(r[MAP_O.hmin]),
    hmax: num(r[MAP_O.hmax]),
    priceUnit: num(r[MAP_O.price]) || 0,
    actif: isActive(r[MAP_O.actif])
  }));
  localStorage.setItem('MAP_O', JSON.stringify(MAP_O));
  return true;
}

/* ------- UI ------- */
function populateHL(){
  const t = elType.value;
  const filtered = TARIFFS.filter(r => r.type === t);
  const H = uniqueSortedNumeric(filtered.map(r=>r.h));
  const L = uniqueSortedNumeric(filtered.map(r=>r.l));
  elH.innerHTML = '<option value="">‚Äî s√©lectionnez ‚Äî</option>' + H.map(v=>`<option value="${v}">${v}</option>`).join('');
  elL.innerHTML = '<option value="">‚Äî s√©lectionnez ‚Äî</option>' + L.map(v=>`<option value="${v}">${v}</option>`).join('');
}

function renderOptionsCheckboxes(){
  const families = [...new Set(OPTIONS.map(o=>o.typeOption))].filter(Boolean).sort();
  if(!families.length){
    elOptsBox.innerHTML = '<div class="opt-row"><em>Aucune option disponible.</em></div>';
    return;
  }
  const h = num(elH.value);
  const isValid = (fam)=>{
    if(!h) return false;
    const rows = OPTIONS.filter(o =>
      o.typeOption===fam &&
      !isNaN(o.hmin) && !isNaN(o.hmax) &&
      h>=o.hmin && h<=o.hmax &&
      o.actif
    );
    return rows.length>0;
  };

  elOptsBox.innerHTML = families.map(f=>{
    const ok = isValid(f);
    const note = ok ? '' : ` <span class="note">(non dispo pour H=${elH.value||'‚Äî'})</span>`;
    return `
      <label class="opt-row">
        <input type="checkbox" name="opt" value="${f}" ${ok?'':'disabled'}>
        <span>${f}</span>${note}
      </label>
    `;
  }).join('');

  [...elOptsBox.querySelectorAll('input[name="opt"]')].forEach(cb=>{
    cb.addEventListener('change', compute);
  });

  if(!h){
    elMsg.textContent = "Choisis d‚Äôabord la hauteur pour activer les options.";
  }else{
    const valides = families.filter(f=>!elOptsBox.querySelector(`input[value="${f}"]`)?.disabled);
    elMsg.textContent = `Hauteur s√©lectionn√©e: ${elH.value} | Options valides: ${valides.join(', ') || 'aucune'}`;
  }
}

/* ------- CALCUL (affichage PUBLIC x2) ------- */
function priceBase(){
  const t = elType.value;
  const h = num(elH.value);
  const l = num(elL.value);
  if(!t||!h||!l) return 0;

  const row = TARIFFS.find(r =>
    r.type===t &&
    Math.abs(num(r.h)-h)<0.001 &&
    Math.abs(num(r.l)-l)<0.001
  );
  return row ? row.priceBase : 0; // interne
}
function priceOptionsSum(){
  const checked = [...elOptsBox.querySelectorAll('input[name="opt"]:checked')].map(c=>c.value);
  if(!checked.length) return 0;
  const h = num(elH.value);
  return checked.reduce((sum, fam)=>{
    const rows = OPTIONS.filter(o => o.typeOption===fam && h>=o.hmin && h<=o.hmax && o.actif);
    if(!rows.length) return sum;
    const unit = Math.max(...rows.map(o=>o.priceUnit).filter(v=>!isNaN(v)));
    return sum + (isFinite(unit)?unit:0);
  }, 0); // interne
}
function compute(){
  const base_interne = priceBase();
  const opt_interne  = priceOptionsSum();
  const qte  = Math.max(1, parseInt(elQte.value||'1',10));

  // ‚Üí PUBLIC x2
  const unit_public  = (base_interne + opt_interne) * UPLIFT_PUBLIC;
  const totalHT_pub  = unit_public * qte;
  const totalTTC_pub = totalHT_pub * (1+TVA);

  elHT.textContent  = totalHT_pub.toFixed(2).replace('.', ',');
  elTTC.textContent = totalTTC_pub.toFixed(2).replace('.', ',');
}

/* ------- CHARGEMENT ------- */
async function loadAll(){
  try{
    const [rt, ro] = await Promise.all([fetch(URL_TARIFS), fetch(URL_OPTIONS)]);
    if(!rt.ok || !ro.ok) throw new Error('Chargement r√©seau impossible (CSV).');
    const [txtT, txtO] = await Promise.all([rt.text(), ro.text()]);
    const pT = parseCSVAuto(txtT);
    const pO = parseCSVAuto(txtO);

    RAW_TARIFFS = pT.rows; RAW_HEADERS_T = pT.rawHeads; HEADS_T = pT.heads;
    RAW_OPTIONS = pO.rows; RAW_HEADERS_O = pO.rawHeads; HEADS_O = pO.heads;

    suggestMapTarifs(); suggestMapOptions();

    const mapTarifsBox  = document.getElementById('mapTarifsBox');
    const mapOptionsBox = document.getElementById('mapOptionsBox');

    const setSel = (id, heads, raws, val)=>{
      const el = document.getElementById(id);
      fillSelect(el, heads, raws);
      if(val) el.value = val;
      return el;
    };
    const sTtype  = setSel('mapT_Type',  HEADS_T, RAW_HEADERS_T, MAP_T.type);
    const sTh     = setSel('mapT_H',     HEADS_T, RAW_HEADERS_T, MAP_T.h);
    const sTl     = setSel('mapT_L',     HEADS_T, RAW_HEADERS_T, MAP_T.l);
    const sTprice = setSel('mapT_Price', HEADS_T, RAW_HEADERS_T, MAP_T.price);

    const sOtype  = setSel('mapO_Type',  HEADS_O, RAW_HEADERS_O, MAP_O.type);
    const sOhmin  = setSel('mapO_HMin',  HEADS_O, RAW_HEADERS_O, MAP_O.hmin);
    const sOhmax  = setSel('mapO_HMax',  HEADS_O, RAW_HEADERS_O, MAP_O.hmax);
    const sOprice = setSel('mapO_Price', HEADS_O, RAW_HEADERS_O, MAP_O.price);
    const sOactif = setSel('mapO_Actif', HEADS_O, RAW_HEADERS_O, MAP_O.actif);

    mapTarifsBox.style.display  = (MAP_T.type && MAP_T.h && MAP_T.l && MAP_T.price) ? 'none' : 'block';
    mapOptionsBox.style.display = (MAP_O.type && MAP_O.hmin && MAP_O.hmax && MAP_O.price && MAP_O.actif) ? 'none' : 'block';

    let okT=false, okO=false;
    if(mapTarifsBox.style.display==='none') okT=applyTarifs();
    if(mapOptionsBox.style.display==='none') okO=applyOptions();

    document.getElementById('applyMapTarifs').onclick=()=>{
      MAP_T.type=sTtype.value||null; MAP_T.h=sTh.value||null; MAP_T.l=sTl.value||null; MAP_T.price=sTprice.value||null;
      if(applyTarifs()){ mapTarifsBox.style.display='none'; populateHL(); compute(); }
      else alert('Merci de s√©lectionner les 4 colonnes TARIFS.');
    };
    document.getElementById('applyMapOptions').onclick=()=>{
      MAP_O.type=sOtype.value||null; MAP_O.hmin=sOhmin.value||null; MAP_O.hmax=sOhmax.value||null; MAP_O.price=sOprice.value||null; MAP_O.actif=sOactif.value||null;
      if(applyOptions()){ mapOptionsBox.style.display='none'; renderOptionsCheckboxes(); compute(); }
      else alert('Merci de s√©lectionner les 5 colonnes OPTIONS.');
    };

    // √âcouteurs
    elType.addEventListener('change', ()=>{ populateHL(); renderOptionsCheckboxes(); compute(); });
    elH.addEventListener('change',   ()=>{ renderOptionsCheckboxes(); compute(); });
    elL.addEventListener('change', compute);
    elQte.addEventListener('input', compute);

    elMsg.textContent =
      `Donn√©es charg√©es.\n` +
      `En-t√™tes TARIFS : ${RAW_HEADERS_T.join(' | ')}\n` +
      `En-t√™tes OPTIONS : ${RAW_HEADERS_O.join(' | ')}`;

    if(okT && okO){ populateHL(); renderOptionsCheckboxes(); compute(); }
  }catch(e){
    elMsg.textContent = "Erreur de chargement : " + e.message;
    console.error(e);
  }
}
loadAll();
</script>

<!-- ===== Int√©gration Devis (PU PUBLIC) ===== -->
<script src="../js/devis-core.js"></script>
<button id="btnAddDevis">‚ûï Ajouter au devis</button>

<script>
(function(){
  const btn = document.getElementById('btnAddDevis');
  if(!btn) return;

  function parseHTPublic(){
    const t = (document.getElementById('prixHT').innerText || '0').trim();
    return Number(t.replace(/\s/g,'').replace(',', '.')) || 0; // total HT PUBLIC affich√©
  }
  function selectedOptionsList(){
    const cbs = [...document.querySelectorAll('#optionsBox input[name="opt"]:checked')];
    return cbs.map(cb=>cb.value);
  }

  btn.addEventListener('click', ()=>{
    try{
      if(!window.Devis) throw new Error('Moteur de devis introuvable.');

      const typeFace = document.getElementById('type').value || '';
      const H = document.getElementById('hauteur').value || '';
      const L = document.getElementById('largeur').value || '';
      const qte = Math.max(1, parseInt(document.getElementById('quantite').value||'1',10));

      if(!typeFace || !H || !L){
        alert('Merci de s√©lectionner le type de face, la hauteur et la largeur.');
        return;
      }

      const total_ht_public = parseHTPublic();
      if(total_ht_public <= 0){
        alert('Le total est √† 0, v√©rifie la configuration.');
        return;
      }

      const pu_public_ht = Number((total_ht_public / qte).toFixed(2));
      const opts = selectedOptionsList();
      const designation = [
        'Totem',
        typeFace,
        `H ${H} mm √ó L ${L} mm`,
        opts.length ? `Options: ${opts.join(', ')}` : null
      ].filter(Boolean).join(' ‚Äî ');

      Devis.addLine({
        type: 'Totem',
        designation,
        quantite: qte,
        pu_public_ht
      });

      alert(`‚úÖ Ligne ajout√©e au devis !\n${designation}\nQt√© : ${qte}\nPU HT : ${pu_public_ht.toFixed(2)} ‚Ç¨`);
    }catch(err){
      console.error(err);
      alert('Erreur lors de l‚Äôajout au devis : ' + err.message);
    }
  });
})();
</script>

</body>
</html>
