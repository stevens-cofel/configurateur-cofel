<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Configurateur Totems ‚Äì Cofel</title>

<!-- Styles communs Cofel -->
<link rel="stylesheet" href="../styles/cofel.css" />
<link rel="stylesheet" href="../styles/cofel-config.css" />

<!-- Retouches locales (visuel uniquement) -->
<style>
  /* Harmonisation ‚Äúpills‚Äù + cartes r√©sultat */
  .radio-row{display:flex;gap:8px;flex-wrap:wrap}
  .radio-row label,
  .opt-row{
    font-weight:600;border:1px solid #ddd;border-radius:10px;
    padding:6px 10px;display:flex;align-items:center;gap:8px;background:#fff;
  }
  .opt-row input[type="checkbox"]{transform:scale(1.1)}
  .wrap{max-width:860px;margin:0 auto;background:#fff;border-radius:12px;box-shadow:0 10px 28px rgba(0,0,0,.08);padding:20px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .result{
    background:#fcfaff;border:1px solid #dec5f2;border-radius:12px;
    padding:16px;margin:16px 0;text-align:center;font-size:18px;
    box-shadow:0 8px 18px rgba(90,45,130,.08);
  }
  .muted{color:#7d6f8e;font-size:12px;white-space:pre-wrap}
  .mapping{
    margin:16px 0;padding:12px;border:1px solid #ffd38a;background:#fff7e6;border-radius:12px
  }
  .mapping h3{margin:0 0 8px}
  .btn{
    display:inline-block;margin-top:8px;padding:10px 14px;border:1px solid #5a2d82;
    background:#5a2d82;color:#fff;border-radius:12px;cursor:pointer;font-weight:700;
    box-shadow:0 8px 18px rgba(90,45,130,.18)
  }
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .two{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  .hr{height:1px;background:#eee;margin:16px 0}
  label{display:block;margin-top:10px;font-weight:700}
  select,input{width:100%;padding:10px;margin-top:6px;border:1px solid #ddd;border-radius:10px}
</style>
</head>
<body>

<!-- Bandeau violet -->
<header class="cofel-header">
  <div class="row">
    <a class="cofel-back" href="../index.html">‚¨Ö Retour aux configurateurs</a>
    <div class="cofel-brand">
      <img src="../assets/logo cofel.jpg" alt="Cofel" />
      <h1 class="cofel-title">Configurateur ‚Äî Totems</h1>
    </div>
  </div>
</header>

<!-- Conteneur commun -->
<div class="cofel-container">
  <h1 style="margin:8px 0 14px">Totems</h1>

  <div class="wrap">
    <!-- MAPPAGE TARIFS -->
    <div id="mapTarifsBox" class="mapping" style="display:none">
      <h3>üìÑ Mappage des colonnes TARIFS</h3>
      <div class="two">
        <div>
          <label>Colonne ‚ÄúType de face‚Äù</label>
          <select id="mapT_Type"></select>
        </div>
        <div>
          <label>Colonne ‚ÄúPrix base HT‚Äù</label>
          <select id="mapT_Price"></select>
        </div>
        <div>
          <label>Colonne ‚ÄúHauteur (mm)‚Äù</label>
          <select id="mapT_H"></select>
        </div>
        <div>
          <label>Colonne ‚ÄúLargeur (mm)‚Äù</label>
          <select id="mapT_L"></select>
        </div>
      </div>
      <button id="applyMapTarifs" class="btn">Appliquer le mappage TARIFS</button>
    </div>

    <!-- MAPPAGE OPTIONS -->
    <div id="mapOptionsBox" class="mapping" style="display:none">
      <h3>üß© Mappage des colonnes OPTIONS</h3>
      <div class="two">
        <div>
          <label>Colonne ‚ÄúType d‚Äôoption‚Äù (Platine / Panier de crosses)</label>
          <select id="mapO_Type"></select>
        </div>
        <div>
          <label>Colonne ‚ÄúPrix unitaire HT‚Äù</label>
          <select id="mapO_Price"></select>
        </div>
        <div>
          <label>Colonne ‚ÄúHauteur min (mm)‚Äù</label>
          <select id="mapO_HMin"></select>
        </div>
        <div>
          <label>Colonne ‚ÄúHauteur max (mm)‚Äù</label>
          <select id="mapO_HMax"></select>
        </div>
        <div>
          <label>Colonne ‚ÄúActif‚Äù (Oui/True/1)</label>
          <select id="mapO_Actif"></select>
        </div>
      </div>
      <button id="applyMapOptions" class="btn">Appliquer le mappage OPTIONS</button>
    </div>

    <div class="hr"></div>

    <!-- UI CONFIG -->
    <label for="type">Type de face</label>
    <select id="type"><option value="">‚Äî s√©lectionnez ‚Äî</option></select>

    <div class="grid">
      <div>
        <label for="hauteur">Hauteur (mm)</label>
        <select id="hauteur"><option value="">‚Äî s√©lectionnez ‚Äî</option></select>
      </div>
      <div>
        <label for="largeur">Largeur (mm)</label>
        <select id="largeur"><option value="">‚Äî s√©lectionnez ‚Äî</option></select>
      </div>
    </div>

    <label>Options (multi-choix)</label>
    <div id="optionsBox" class="options-wrap">
      <!-- cases √† cocher g√©n√©r√©es dynamiquement -->
      <div class="opt-row"><em>Aucune option disponible tant que la hauteur n‚Äôest pas choisie.</em></div>
    </div>

    <label for="quantite">Quantit√©</label>
    <input type="number" id="quantite" value="1" min="1"/>

    <div class="result">
      <p>Prix HT : <span id="prixHT">0,00</span> ‚Ç¨</p>
      <p>Prix TTC : <span id="prixTTC">0,00</span> ‚Ç¨</p>
    </div>

    <div id="msg" class="muted"></div>
  </div>
</div>

<!-- Pied de page -->
<footer class="cofel-footer">
  ¬© Cofel ‚Äî ZA du Perquoi, 72560 Chang√© ‚Äî SIRET 927 659 458 00024 ‚Äî TVA FR80927659458
</footer>

<script>
/* ------- CONFIG ------- */
const URL_TARIFS  = "https://raw.githubusercontent.com/stevens-cofel/configurateur-cofel/refs/heads/main/Tarifs_Totems_.csv";
const URL_OPTIONS = "https://raw.githubusercontent.com/stevens-cofel/configurateur-cofel/refs/heads/main/option%20platine%20et%20panier%20de%20crosses%20(1).csv";
const TVA = 0.20;

/* ------- STATE ------- */
let RAW_TARIFFS = [];
let RAW_OPTIONS = [];
let RAW_HEADERS_T = [];
let RAW_HEADERS_O = [];
let HEADS_T = [];
let HEADS_O = [];
let TARIFFS = [];
let OPTIONS = [];

const MAP_T = JSON.parse(localStorage.getItem('MAP_T') || 'null') || {type:null,h:null,l:null,price:null};
const MAP_O = JSON.parse(localStorage.getItem('MAP_O') || 'null') || {type:null,hmin:null,hmax:null,price:null,actif:null};

/* ------- ELEMENTS ------- */
const elType = document.getElementById('type');
const elH    = document.getElementById('hauteur');
const elL    = document.getElementById('largeur');
const elOptsBox = document.getElementById('optionsBox');
const elQte  = document.getElementById('quantite');
const elHT   = document.getElementById('prixHT');
const elTTC  = document.getElementById('prixTTC');
const elMsg  = document.getElementById('msg');

/* ------- HELPERS ------- */
function num(v){
  const s = String(v ?? '').replace(/\u202F/g,'').replace(/\s/g,'').replace(',', '.');
  const m = s.match(/-?\d+(\.\d+)?/);
  return m ? parseFloat(m[0]) : NaN;
}
function normalizeKey(k){
  return String(k||'').toLowerCase()
    .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
    .replace(/[^a-z0-9]+/g,'').trim();
}
function parseCSVAuto(text){
  text = text.replace(/^\uFEFF/, '').trim();
  const first = text.split(/\r?\n/,1)[0] || '';
  const sep = (first.match(/;/g)||[]).length > (first.match(/,/g)||[]).length ? ';' : ',';
  const lines = text.split(/\r?\n/).filter(l=>l.trim().length>0);
  const rawHeads = lines[0].split(sep).map(h=>h.replace(/^"+|"+$/g,'').trim());
  const heads = rawHeads.map(h=>normalizeKey(h));
  const rows = lines.slice(1).map(line=>{
    const cells = line.split(sep).map(c=>c.replace(/^"+|"+$/g,'').trim());
    const o={}; heads.forEach((h,i)=>o[h]=cells[i]??''); return o;
  });
  return { rows, rawHeads, heads };
}
function uniqueSortedNumeric(arr){
  return [...new Set(arr)].map(num).filter(n=>!isNaN(n)).sort((a,b)=>a-b).map(String);
}
function fillSelect(sel, heads, rawHeads){
  sel.innerHTML = '<option value="">‚Äî choisir ‚Äî</option>' +
    heads.map((k,i)=>`<option value="${k}">${rawHeads[i]}</option>`).join('');
}
function isActive(v){
  const s = String(v||'').trim().toLowerCase();
  return ['true','1','oui','vrai','yes','y','x'].includes(s);
}

/* ------- MAPPAGE ------- */
function suggestMapTarifs(){
  const f = (re)=> HEADS_T.find(k=>re.test(k));
  MAP_T.type  = MAP_T.type  || f(/type/);
  MAP_T.h     = MAP_T.h     || f(/hauteur|height/);
  MAP_T.l     = MAP_T.l     || f(/largeur|width/);
  MAP_T.price = MAP_T.price || f(/prix|base|eur|ht/);
}
function suggestMapOptions(){
  const f = (re)=> HEADS_O.find(k=>re.test(k));
  MAP_O.type  = MAP_O.type  || f(/type/);
  MAP_O.hmin  = MAP_O.hmin  || f(/min/);
  MAP_O.hmax  = MAP_O.hmax  || f(/max/);
  MAP_O.price = MAP_O.price || f(/prix|ht|unitaire|price/);
  MAP_O.actif = MAP_O.actif || f(/actif|active|isactive|true|oui|1|vrai|yes/);
}
function applyTarifs(){
  if(!MAP_T.type || !MAP_T.h || !MAP_T.l || !MAP_T.price) return false;
  TARIFFS = RAW_TARIFFS.map(r=>({
    type: String(r[MAP_T.type] || '').trim(),
    h:    String(r[MAP_T.h]    || '').trim(),
    l:    String(r[MAP_T.l]    || '').trim(),
    priceBase: num(r[MAP_T.price]) || 0
  })).filter(r=>r.type && r.h && r.l);

  const types = [...new Set(TARIFFS.map(r=>r.type))].sort();
  elType.innerHTML = '<option value="">‚Äî s√©lectionnez ‚Äî</option>' +
    types.map(t=>`<option value="${t}">${t}</option>`).join('');
  localStorage.setItem('MAP_T', JSON.stringify(MAP_T));
  return true;
}
function applyOptions(){
  if(!MAP_O.type || !MAP_O.hmin || !MAP_O.hmax || !MAP_O.price || !MAP_O.actif) return false;
  OPTIONS = RAW_OPTIONS.map(r=>({
    typeOption: String(r[MAP_O.type] || '').trim(),
    hmin: num(r[MAP_O.hmin]),
    hmax: num(r[MAP_O.hmax]),
    priceUnit: num(r[MAP_O.price]) || 0,
    actif: isActive(r[MAP_O.actif])
  }));
  localStorage.setItem('MAP_O', JSON.stringify(MAP_O));
  return true;
}

/* ------- UI ------- */
function populateHL(){
  const t = elType.value;
  const filtered = TARIFFS.filter(r => r.type === t);
  const H = uniqueSortedNumeric(filtered.map(r=>r.h));
  const L = uniqueSortedNumeric(filtered.map(r=>r.l));
  elH.innerHTML = '<option value="">‚Äî s√©lectionnez ‚Äî</option>' + H.map(v=>`<option value="${v}">${v}</option>`).join('');
  elL.innerHTML = '<option value="">‚Äî s√©lectionnez ‚Äî</option>' + L.map(v=>`<option value="${v}">${v}</option>`).join('');
}

function renderOptionsCheckboxes(){
  const families = [...new Set(OPTIONS.map(o=>o.typeOption))].filter(Boolean).sort();
  if(!families.length){
    elOptsBox.innerHTML = '<div class="opt-row"><em>Aucune option disponible.</em></div>';
    return;
  }
  const h = num(elH.value);
  const isValid = (fam)=>{
    if(!h) return false;
    const rows = OPTIONS.filter(o =>
      o.typeOption===fam &&
      !isNaN(o.hmin) && !isNaN(o.hmax) &&
      h>=o.hmin && h<=o.hmax &&
      o.actif
    );
    return rows.length>0;
  };

  elOptsBox.innerHTML = families.map(f=>{
    const ok = isValid(f);
    const note = ok ? '' : ` <span class="muted">(non dispo pour H=${elH.value||'‚Äî'})</span>`;
    return `
      <label class="opt-row">
        <input type="checkbox" name="opt" value="${f}" ${ok?'':'disabled'}>
        <span>${f}</span>${note}
      </label>
    `;
  }).join('');

  [...elOptsBox.querySelectorAll('input[name="opt"]')].forEach(cb=>{
    cb.addEventListener('change', compute);
  });

  if(!h){
    elMsg.textContent = "Choisis d‚Äôabord la hauteur pour activer les options.";
  }else{
    const valides = families.filter(f=>!elOptsBox.querySelector(\`input[value="\${f}"]\`)?.disabled);
    elMsg.textContent = \`Hauteur s√©lectionn√©e: \${elH.value} | Options valides: \${valides.join(', ') || 'aucune'}\`;
  }
}

/* ------- CALCUL ------- */
function priceBase(){
  const t = elType.value;
  const h = num(elH.value);
  const l = num(elL.value);
  if(!t||!h||!l) return 0;

  const row = TARIFFS.find(r =>
    r.type===t &&
    Math.abs(num(r.h)-h)<0.001 &&
    Math.abs(num(r.l)-l)<0.001
  );
  return row ? row.priceBase : 0;
}
function priceOptionsSum(){
  const checked = [...elOptsBox.querySelectorAll('input[name="opt"]:checked')].map(c=>c.value);
  if(!checked.length) return 0;
  const h = num(elH.value);
  return checked.reduce((sum, fam)=>{
    const rows = OPTIONS.filter(o => o.typeOption===fam && h>=o.hmin && h<=o.hmax && o.actif);
    if(!rows.length) return sum;
    const unit = Math.max(...rows.map(o=>o.priceUnit).filter(v=>!isNaN(v)));
    return sum + (isFinite(unit)?unit:0);
  }, 0);
}
function compute(){
  const base = priceBase();
  const opt  = priceOptionsSum();
  const qte  = Math.max(1, parseInt(elQte.value||'1',10));
  const totalHT  = (base + opt) * qte;
  const totalTTC = totalHT * (1+TVA);
  elHT.textContent  = totalHT.toFixed(2).replace('.', ',');
  elTTC.textContent = totalTTC.toFixed(2).replace('.', ',');
}

/* ------- CHARGEMENT ------- */
async function loadAll(){
  try{
    const [rt, ro] = await Promise.all([fetch(URL_TARIFS), fetch(URL_OPTIONS)]);
    if(!rt.ok || !ro.ok) throw new Error('Chargement r√©seau impossible (CSV).');
    const [txtT, txtO] = await Promise.all([rt.text(), ro.text()]);
    const pT = parseCSVAuto(txtT);
    const pO = parseCSVAuto(txtO);

    RAW_TARIFFS = pT.rows; RAW_HEADERS_T = pT.rawHeads; HEADS_T = pT.heads;
    RAW_OPTIONS = pO.rows; RAW_HEADERS_O = pO.rawHeads; HEADS_O = pO.heads;

    suggestMapTarifs(); suggestMapOptions();

    const mapTarifsBox  = document.getElementById('mapTarifsBox');
    const mapOptionsBox = document.getElementById('mapOptionsBox');

    const setSel = (id, heads, raws, val)=>{
      const el = document.getElementById(id);
      el.innerHTML = '<option value="">‚Äî choisir ‚Äî</option>' +
        heads.map((k,i)=>`<option value="${k}">${raws[i]}</option>`).join('');
      if(val) el.value = val;
      return el;
    };
    const sTtype  = setSel('mapT_Type',  HEADS_T, RAW_HEADERS_T, MAP_T.type);
    const sTh     = setSel('mapT_H',     HEADS_T, RAW_HEADERS_T, MAP_T.h);
    const sTl     = setSel('mapT_L',     HEADS_T, RAW_HEADERS_T, MAP_T.l);
    const sTprice = setSel('mapT_Price', HEADS_T, RAW_HEADERS_T, MAP_T.price);

    const sOtype  = setSel('mapO_Type',  HEADS_O, RAW_HEADERS_O, MAP_O.type);
    const sOhmin  = setSel('mapO_HMin',  HEADS_O, RAW_HEADERS_O, MAP_O.hmin);
    const sOhmax  = setSel('mapO_HMax',  HEADS_O, RAW_HEADERS_O, MAP_O.hmax);
    const sOprice = setSel('mapO_Price', HEADS_O, RAW_HEADERS_O, MAP_O.price);
    const sOactif = setSel('mapO_Actif', HEADS_O, RAW_HEADERS_O, MAP_O.actif);

    mapTarifsBox.style.display  = (MAP_T.type && MAP_T.h && MAP_T.l && MAP_T.price) ? 'none' : 'block';
    mapOptionsBox.style.display = (MAP_O.type && MAP_O.hmin && MAP_O.hmax && MAP_O.price && MAP_O.actif) ? 'none' : 'block';

    let okT=false, okO=false;
    if(mapTarifsBox.style.display==='none') okT=applyTarifs();
    if(mapOptionsBox.style.display==='none') okO=applyOptions();

    document.getElementById('applyMapTarifs').onclick=()=>{
      MAP_T.type=sTtype.value||null; MAP_T.h=sTh.value||null; MAP_T.l=sTl.value||null; MAP_T.price=sTprice.value||null;
      if(applyTarifs()){ mapTarifsBox.style.display='none'; populateHL(); compute(); }
      else alert('Merci de s√©lectionner les 4 colonnes TARIFS.');
    };
    document.getElementById('applyMapOptions').onclick=()=>{
      MAP_O.type=sOtype.value||null; MAP_O.hmin=sOhmin.value||null; MAP_O.hmax=sOhmax.value||null; MAP_O.price=sOprice.value||null; MAP_O.actif=sOactif.value||null;
      if(applyOptions()){ mapOptionsBox.style.display='none'; renderOptionsCheckboxes(); compute(); }
      else alert('Merci de s√©lectionner les 5 colonnes OPTIONS.');
    };

    // √âcouteurs
    elType.addEventListener('change', ()=>{ populateHL(); renderOptionsCheckboxes(); compute(); });
    elH.addEventListener('change',   ()=>{ renderOptionsCheckboxes(); compute(); });
    elL.addEventListener('change', compute);
    elQte.addEventListener('input', compute);

    elMsg.textContent =
      `Donn√©es charg√©es.\n` +
      `En-t√™tes TARIFS : ${RAW_HEADERS_T.join(' | ')}\n` +
      `En-t√™tes OPTIONS : ${RAW_HEADERS_O.join(' | ')}`;

    if(okT && okO){ populateHL(); renderOptionsCheckboxes(); compute(); }
  }catch(e){
    elMsg.textContent = "Erreur de chargement : " + e.message;
    console.error(e);
  }
}

loadAll();
</script>
</body>
</html>
