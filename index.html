<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Configurateurs Cofel</title>

  <!-- ðŸ”’ Protection -->
  <script src="./auth/lock.js" type="module"></script>

  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <style>
    :root{
      --cofel:#5a2d82; --cofel-2:#7838a7; --glass: rgba(255,255,255,.08); --glass-hr: rgba(255,255,255,.14);
      --txt:#f5f7ff; --txt-dim:#e6e6ff; --accent:#c9b7ff; --radius:18px; --blur:18px; --shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{
      margin:0; color:var(--txt);
      font-family:-apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, Arial, sans-serif;
      background:
        radial-gradient(800px 500px at 20% -10%, rgba(255,255,255,.10), transparent 60%),
        radial-gradient(800px 500px at 110% 10%, rgba(255,255,255,.08), transparent 60%),
        linear-gradient(135deg, var(--cofel), var(--cofel-2));
      position:relative; overflow-x:hidden;
    }

    .hero{ position:relative; z-index:1; padding:40px 20px 24px; }
    .hero-inner{ max-width:1200px; margin:0 auto; display:flex; align-items:center; justify-content:space-between; gap:16px; }
    .brand{
      display:flex; align-items:center; gap:14px;
      backdrop-filter: blur(var(--blur));
      background: linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.06));
      border:1px solid rgba(255,255,255,.18);
      padding:10px 14px; border-radius:14px; box-shadow: var(--shadow);
    }
    .brand img{height:42px; width:auto; object-fit:contain; border-radius:10px}
    .brand h1{ font-size: clamp(18px, 2.6vw, 22px); margin:0; letter-spacing:.2px; font-weight:700; }
    .hero-tagline{ max-width:1200px; margin:18px auto 0; padding:0 20px; color:var(--txt-dim); }
    .hero-actions{ display:flex; align-items:center; gap:10px; }

    .wrap{max-width:1200px; margin:26px auto; padding:0 20px 40px; position:relative; z-index:1;}
    .apps{ display:grid; gap:16px; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); }
    .app{
      position:relative; text-decoration:none; color:var(--txt);
      background: linear-gradient(180deg, rgba(255,255,255,.18), rgba(255,255,255,.08));
      border:1px solid rgba(255,255,255,.2); border-radius:20px; padding:18px 16px;
      box-shadow: var(--shadow); backdrop-filter: blur(var(--blur));
      transform: translateY(0); transition: transform .18s ease, box-shadow .18s ease, background .18s ease, border-color .18s ease;
    }
    .app:hover{ transform: translateY(-4px); box-shadow: 0 18px 40px rgba(0,0,0,.45); }
    .app .title{ font-weight:800; margin:0 0 6px; letter-spacing:.2px; }
    .app .hint{ color:var(--txt-dim); margin:0; font-size:13px; }
    .app::after{ content:""; position:absolute; right:10px; top:10px; width:46px; height:46px; border-radius:12px;
      background: radial-gradient(closest-side, rgba(255,255,255,.26), transparent 70%); filter: blur(6px); opacity:.65; }

    .panel{
      margin-top:28px;
      background: linear-gradient(180deg, rgba(255,255,255,.16), rgba(255,255,255,.06));
      border:1px solid rgba(255,255,255,.2);
      border-radius:20px; padding:18px; box-shadow: var(--shadow); backdrop-filter: blur(var(--blur));
    }
    .panel h2{ margin:0 0 12px; font-size: clamp(18px, 2.4vw, 22px); letter-spacing:.2px; }

    .client-card{
      margin:12px 0 16px; background: linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.06));
      border:1px solid rgba(255,255,255,.18); border-radius:16px; padding:14px;
      display:grid; gap:12px; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    }
    label{font-weight:700; font-size:12px; color:var(--accent);}
    input[type="text"], input[type="number"]{
      width:100%; margin-top:6px; padding:10px 12px; background: rgba(255,255,255,.08);
      color:var(--txt); border:1px solid rgba(255,255,255,.18); border-radius:12px; outline:none;
      transition: border-color .18s ease, background .18s ease;
    }
    input[type="text"]::placeholder, input[type="number"]::placeholder{ color:#f0edff; opacity:.75; }
    input[type="text"]:focus, input[type="number"]:focus{ border-color: rgba(255,255,255,.34); background: rgba(255,255,255,.12); }

    .table-wrap{overflow:auto; border-radius:14px; border:1px solid rgba(255,255,255,.16);}
    table{width:100%; border-collapse:collapse; min-width:720px;}
    thead tr{ background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.04)); }
    th, td{ padding:10px 12px; text-align:left; }
    th{ font-size:12px; color:var(--accent); letter-spacing:.3px; }
    tbody tr + tr td{ border-top:1px solid rgba(255,255,255,.12); }
    td.right{ text-align:right; } td.center{ text-align:center; }

    .totaux{ margin-top:16px; display:flex; justify-content:space-between; gap:16px; align-items:flex-start; flex-wrap:wrap; }
    .totaux-box{
      min-width:320px; border-radius:16px; padding:12px 14px;
      background: linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.06));
      border:1px solid rgba(255,255,255,.18);
    }
    .row{ display:flex; justify-content:space-between; padding:6px 0; border-bottom:1px dashed rgba(255,255,255,.16); }
    .row:last-child{ border-bottom:none; padding-bottom:0; }
    .grand{ font-weight:800; font-size:18px; }
    .subnote{ color:var(--txt-dim); font-size:12px; margin-top:6px; }

    .btn{ appearance:none; border:none; cursor:pointer; font-weight:700;
      color:#0b0b0b; background:#fff; border-radius:12px; padding:10px 14px; box-shadow: 0 10px 24px rgba(0,0,0,.25);
      transition: transform .16s ease, box-shadow .16s ease, opacity .16s ease; }
    .btn:active{ transform: translateY(1px); box-shadow: 0 6px 16px rgba(0,0,0,.28); }
    .btn-ghost{ background: transparent; color:var(--txt); border:1px solid rgba(255,255,255,.24); }
    .btn-danger{ background: transparent; color:#ffe3e3; border:1px solid rgba(255, 107, 107, .45); }
    .btn[disabled]{ opacity:.45; cursor:not-allowed; box-shadow:none; pointer-events:none; }

    /* Mini-carte Â« app Â» Ã  lâ€™intÃ©rieur du panneau */
    .app-inline{
      display:flex; align-items:center; gap:10px; padding:12px 14px; border-radius:14px; text-decoration:none; color:var(--txt);
      background: linear-gradient(180deg, rgba(255,255,255,.18), rgba(255,255,255,.08));
@@ -113,8 +112,10 @@
    .app-inline:hover{ transform: translateY(-2px); box-shadow: 0 14px 30px rgba(0,0,0,.42); }
    .app-inline .title{ margin:0; font-weight:800; }
    .app-inline .hint{ margin:0; color:var(--txt-dim); font-size:12px; }

    footer{ color:#f3ecff; font-size:12px; text-align:center; padding:24px 10px; opacity:.9; }
    @media (max-width:720px){ .brand h1{display:none;} }

    .logout-btn{ appearance:none; border:none; cursor:pointer; font-weight:700; color:var(--txt);
      background: linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.06));
      border:1px solid rgba(255,255,255,.18); border-radius:12px; padding:8px 12px; box-shadow: var(--shadow); backdrop-filter: blur(var(--blur)); }
@@ -213,6 +214,9 @@
  (function(){
    if(!window.Devis){ console.error("Devis-core non chargÃ©. VÃ©rifiez ./js/devis-core.js"); return; }

    // === MAIL WEBHOOK (Google Apps Script) ===
    const MAIL_WEBHOOK = "https://script.google.com/macros/s/AKfycbwfOBZhRoL0WX9R1moMC4DIIiG2jUpNL0RwV7PRx4hME8j1_dyyEWbAdC8_l-srMzg/exec";

    // Helpers
    const fmt = n => (Number(n)||0).toFixed(2).replace('.', ',') + " â‚¬";
    const STORAGE_KEY = "devisCourant_v1";
@@ -277,7 +281,6 @@

    // ==== INTEGRATION TRANSPORT ====
    function addTransportLine(payload){
      // payload: {id, designation, quantite, pu_net_ht, type, ts}
      const st = readStore();
      if(!st.lignes) st.lignes = [];
      const exists = st.lignes.some(l => l.id === payload.id);
@@ -308,11 +311,10 @@
      localStorage.removeItem('cofel_transport_add');
    }

    // Au chargement + quand transport.html Ã©crit (Ã©vÃ¨nement storage si autre onglet)
    checkTransportInbox();
    window.addEventListener('storage', (ev)=>{ if(ev.key === 'cofel_transport_add' && ev.newValue){ checkTransportInbox(); } });

    // === EXPORT PDF (inchangÃ©) ===
    // === EXPORT PDF + ENVOI EMAIL ===
    function loadImageDataURL(src){
      return new Promise((resolve,reject)=>{
        const img = new Image(); img.crossOrigin="anonymous";
@@ -322,6 +324,53 @@
      });
    }

    async function sendEmailWithPayload({client, devis, pdfDataUrl}){
      try{
        // Construction dâ€™un sujet lisible
        const dateStr = new Date().toLocaleDateString("fr-FR");
        const subject = `Devis Cofel â€” ${client?.societe||"Sans sociÃ©tÃ©"} â€” ${client?.chantier||"Sans chantier"} â€” ${fmt(devis.total_ttc)} â€” ${dateStr}`;

        // On Ã©vite dâ€™envoyer un PDF trop lourd Ã  Apps Script
        let attachBase64 = null;
        if (pdfDataUrl){
          const base64 = pdfDataUrl.split(",")[1] || "";
          // ~7 MB max raisonnable pour GAS ; on limite Ã  ~4 MB pour marge
          if (base64.length < 4_000_000 * 1.37) { // base64 ~ 1.37x
            attachBase64 = base64;
          }
        }

        const body = {
          subject,
          client,
          devis: {
            remise_pct: devis.remise_pct,
            total_ht: devis.total_ht,
            tva: devis.tva,
            total_ttc: devis.total_ttc,
            lignes: (devis.lignes||[]).map(l=>({
              designation: l.designation, quantite: l.quantite, pu_net_ht: l.pu_net_ht, total_ligne_ht: l.total_ligne_ht, type: l.type||""
            }))
          },
          meta: {
            page: location.href,
            userAgent: navigator.userAgent,
            date: new Date().toISOString()
          },
          pdf: attachBase64 ? { filename: "Devis-Cofel.pdf", base64: attachBase64 } : null
        };

        await fetch(MAIL_WEBHOOK, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });
        // Pas d'alert bloquante : on envoie en arriÃ¨re-plan
      }catch(err){
        console.warn("Envoi email Ã©chouÃ© (non bloquant)", err);
      }
    }

    document.getElementById("btnPdf").addEventListener("click", async () => {
      try{
        const { jsPDF } = window.jspdf;
@@ -366,8 +415,28 @@
          theme:"grid", margin:{ left: margin, right: margin }, didDrawPage: ()=> drawHeader() });
        const afterTableY = doc.lastAutoTable ? doc.lastAutoTable.finalY + 16 : (margin + 200); drawTotalsBox(afterTableY);
        const pageCount=doc.internal.getNumberOfPages(); for(let i=1;i<=pageCount;i++){ doc.setPage(i); drawFooter(i,pageCount); }

        // ---- Envoi email (non bloquant) ----
        try{
          // datauristring -> base64 (peut Ãªtre volumineux)
          const dataUrl = doc.output("datauristring"); // "data:application/pdf;base64,...."
          await sendEmailWithPayload({
            client,
            devis: d,
            pdfDataUrl: dataUrl
          });
        }catch(e){
          console.warn("PrÃ©paration email Ã©chouÃ©e", e);
          // On tente quand mÃªme un envoi sans PDF
          sendEmailWithPayload({ client, devis: d, pdfDataUrl: null });
        }

        // TÃ©lÃ©chargement PDF utilisateur
        doc.save("Devis-Cofel.pdf");
      }catch(err){ alert("Erreur pendant la gÃ©nÃ©ration du PDF : " + err.message); console.error(err); }
      }catch(err){
        alert("Erreur pendant la gÃ©nÃ©ration du PDF : " + err.message);
        console.error(err);
      }
    });

    // Initial render
