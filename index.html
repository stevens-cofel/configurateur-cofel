<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Configurateurs Cofel</title>

  <!-- üîí Protection -->
  <script src="./auth/lock.js" type="module"></script>

  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <style>
    :root{
      --cofel:#5a2d82; --cofel-2:#7838a7; --glass: rgba(255,255,255,.08); --glass-hr: rgba(255,255,255,.14);
      --txt:#f5f7ff; --txt-dim:#e6e6ff; --accent:#c9b7ff; --radius:18px; --blur:18px; --shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{
      margin:0; color:var(--txt);
      font-family:-apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, Arial, sans-serif;
      background:
        radial-gradient(800px 500px at 20% -10%, rgba(255,255,255,.10), transparent 60%),
        radial-gradient(800px 500px at 110% 10%, rgba(255,255,255,.08), transparent 60%),
        linear-gradient(135deg, var(--cofel), var(--cofel-2));
      position:relative; overflow-x:hidden;
    }

    .hero{ position:relative; z-index:1; padding:40px 20px 24px; }
    .hero-inner{ max-width:1200px; margin:0 auto; display:flex; align-items:center; justify-content:space-between; gap:16px; }
    .brand{
      display:flex; align-items:center; gap:14px;
      backdrop-filter: blur(var(--blur));
      background: linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.06));
      border:1px solid rgba(255,255,255,.18);
      padding:10px 14px; border-radius:14px; box-shadow: var(--shadow);
    }
    .brand img{height:42px; width:auto; object-fit:contain; border-radius:10px}
    .brand h1{ font-size: clamp(18px, 2.6vw, 22px); margin:0; letter-spacing:.2px; font-weight:700; }
    .hero-tagline{ max-width:1200px; margin:18px auto 0; padding:0 20px; color:var(--txt-dim); }
    .hero-actions{ display:flex; align-items:center; gap:10px; }

    .wrap{max-width:1200px; margin:26px auto; padding:0 20px 40px; position:relative; z-index:1;}
    .apps{ display:grid; gap:16px; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); }
    .app{
      position:relative; text-decoration:none; color:var(--txt);
      background: linear-gradient(180deg, rgba(255,255,255,.18), rgba(255,255,255,.08));
      border:1px solid rgba(255,255,255,.2); border-radius:20px; padding:18px 16px;
      box-shadow: var(--shadow); backdrop-filter: blur(var(--blur));
      transform: translateY(0); transition: transform .18s ease, box-shadow .18s ease, background .18s ease, border-color .18s ease;
    }
    .app:hover{ transform: translateY(-4px); box-shadow: 0 18px 40px rgba(0,0,0,.45); }
    .app .title{ font-weight:800; margin:0 0 6px; letter-spacing:.2px; }
    .app .hint{ color:var(--txt-dim); margin:0; font-size:13px; }
    .app::after{ content:""; position:absolute; right:10px; top:10px; width:46px; height:46px; border-radius:12px;
      background: radial-gradient(closest-side, rgba(255,255,255,.26), transparent 70%); filter: blur(6px); opacity:.65; }

    .panel{
      margin-top:28px;
      background: linear-gradient(180deg, rgba(255,255,255,.16), rgba(255,255,255,.06));
      border:1px solid rgba(255,255,255,.2);
      border-radius:20px; padding:18px; box-shadow: var(--shadow); backdrop-filter: blur(var(--blur));
    }
    .panel h2{ margin:0 0 12px; font-size: clamp(18px, 2.4vw, 22px); letter-spacing:.2px; }

    .client-card{
      margin:12px 0 16px; background: linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.06));
      border:1px solid rgba(255,255,255,.18); border-radius:16px; padding:14px;
      display:grid; gap:12px; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    }
    label{font-weight:700; font-size:12px; color:var(--accent);}
    input[type="text"], input[type="number"]{
      width:100%; margin-top:6px; padding:10px 12px; background: rgba(255,255,255,.08);
      color:var(--txt); border:1px solid rgba(255,255,255,.18); border-radius:12px; outline:none;
      transition: border-color .18s ease, background .18s ease;
    }
    input[type="text"]::placeholder, input[type="number"]::placeholder{ color:#f0edff; opacity:.75; }
    input[type="text"]:focus, input[type="number"]*:focus{ border-color: rgba(255,255,255,.34); background: rgba(255,255,255,.12); }

    .table-wrap{overflow:auto; border-radius:14px; border:1px solid rgba(255,255,255,.16);}
    table{width:100%; border-collapse:collapse; min-width:720px;}
    thead tr{ background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.04)); }
    th, td{ padding:10px 12px; text-align:left; }
    th{ font-size:12px; color:var(--accent); letter-spacing:.3px; }
    tbody tr + tr td{ border-top:1px solid rgba(255,255,255,.12); }
    td.right{ text-align:right; } td.center{ text-align:center; }

    .totaux{ margin-top:16px; display:flex; justify-content:space-between; gap:16px; align-items:flex-start; flex-wrap:wrap; }
    .totaux-box{
      min-width:320px; border-radius:16px; padding:12px 14px;
      background: linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.06));
      border:1px solid rgba(255,255,255,.18);
    }
    .row{ display:flex; justify-content:space-between; padding:6px 0; border-bottom:1px dashed rgba(255,255,255,.16); }
    .row:last-child{ border-bottom:none; padding-bottom:0; }
    .grand{ font-weight:800; font-size:18px; }
    .subnote{ color:var(--txt-dim); font-size:12px; margin-top:6px; }

    .btn{ appearance:none; border:none; cursor:pointer; font-weight:700;
      color:#0b0b0b; background:#fff; border-radius:12px; padding:10px 14px; box-shadow: 0 10px 24px rgba(0,0,0,.25);
      transition: transform .16s ease, box-shadow .16s ease, opacity .16s ease; }
    .btn:active{ transform: translateY(1px); box-shadow: 0 6px 16px rgba(0,0,0,.28); }
    .btn-ghost{ background: transparent; color:var(--txt); border:1px solid rgba(255,255,255,.24); }
    .btn-danger{ background: transparent; color:#ffe3e3; border:1px solid rgba(255, 107, 107, .45); }
    .btn[disabled]{ opacity:.45; cursor:not-allowed; box-shadow:none; pointer-events:none; }

    .app-inline{
      display:flex; align-items:center; gap:10px; padding:12px 14px; border-radius:14px; text-decoration:none; color:var(--txt);
      background: linear-gradient(180deg, rgba(255,255,255,.18), rgba(255,255,255,.08));
      border:1px solid rgba(255,255,255,.2); box-shadow: var(--shadow); backdrop-filter: blur(var(--blur));
      transition: transform .18s ease, box-shadow .18s ease;
    }
    .app-inline:hover{ transform: translateY(-2px); box-shadow: 0 14px 30px rgba(0,0,0,.42); }
    .app-inline .title{ margin:0; font-weight:800; }
    .app-inline .hint{ margin:0; color:var(--txt-dim); font-size:12px; }

    footer{ color:#f3ecff; font-size:12px; text-align:center; padding:24px 10px; opacity:.9; }
    @media (max-width:720px){ .brand h1{display:none;} }

    .logout-btn{ appearance:none; border:none; cursor:pointer; font-weight:700; color:var(--txt);
      background: linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.06));
      border:1px solid rgba(255,255,255,.18); border-radius:12px; padding:8px 12px; box-shadow: var(--shadow); backdrop-filter: blur(var(--blur)); }
    .logout-btn:hover{ transform: translateY(-1px); box-shadow: 0 14px 34px rgba(0,0,0,.42); }

    .toast{ position:fixed; right:16px; bottom:16px; background:#fff; color:#222; padding:10px 12px; border-radius:10px; box-shadow:0 10px 24px rgba(0,0,0,.35); display:none; z-index:99; }
    .toast.show{ display:block; }
  </style>
</head>
<body>

  <!-- ===================== HERO ===================== -->
  <div class="hero">
    <div class="hero-inner">
      <div class="brand">
        <img src="./assets/logo cofel.jpg" alt="Cofel" />
        <h1>Configurateurs Cofel</h1>
      </div>
      <div class="hero-actions">
        <div class="brand" style="gap:10px;">
          <div style="font-size:12px;color:var(--txt-dim)">Rapide ‚Ä¢ Clair ‚Ä¢ PDF pr√™t √† envoyer</div>
        </div>
        <button id="logoutBtn" class="logout-btn" title="Se d√©connecter">üö™ Se d√©connecter</button>
      </div>
    </div>
    <div class="hero-tagline">Choisissez un configurateur puis composez votre devis‚Ä¶</div>
  </div>

  <!-- ===================== APPS GRID ===================== -->
  <main class="wrap">
    <section class="apps" aria-label="Liste des configurateurs">
      <a class="app" href="./configurateurs/configurateur-tole-tablette.html"><p class="title">T√¥le Tablette</p><p class="hint">Ajourage, PMMA, ch√¢ssis‚Ä¶</p></a>
      <a class="app" href="./configurateurs/configurateur-rampe-lumineuse.html"><p class="title">Rampe Lumineuse (PLL)</p><p class="hint">LED + laquage inclus</p></a>
      <a class="app" href="./configurateurs/configurateur-enseigne-drapeau.html"><p class="title">Enseigne Drapeau</p><p class="hint">Rond / Carr√©, potence</p></a>
      <a class="app" href="./configurateurs/configurateur-totems.html"><p class="title">Totems</p><p class="hint">Hauteurs, options d‚Äôinstallation</p></a>
      <a class="app" href="./configurateurs/configurateur-lettres PVC.html"><p class="title">Lettres PVC</p><p class="hint">Hauteur, chant, finitions</p></a>
      <a class="app" href="./configurateurs/configurateur-lettre-alu-alupvc.html"><p class="title">Lettres Alu / Alu-PVC</p><p class="hint">Finitions et options</p></a>
      <a class="app" href="./configurateurs/configurateur-lettre-boitier.html"><p class="title">Lettres Bo√Ætiers</p><p class="hint">Face PMMA ou Dibond</p></a>
      <a class="app" href="./configurateurs/configurateur-tolerie-dibond.html"><p class="title">T√¥lerie Alu / Dibond</p><p class="hint">Au m¬≤, laqu√© / pr√©laqu√©</p></a>
    </section>

    <!-- ===================== R√âCAP + CLIENT ===================== -->
    <section class="panel" aria-label="R√©capitulatif du devis">
      <h2>üßæ R√©capitulatif du devis</h2>

      <!-- Client -->
      <div class="client-card">
        <div><label for="societe">Entreprise</label><input type="text" id="societe" placeholder="Nom de l‚Äôentreprise"></div>
        <div><label for="contact">Nom & pr√©nom</label><input type="text" id="contact" placeholder="Nom Pr√©nom"></div>
        <div><label for="chantier">Nom du chantier</label><input type="text" id="chantier" placeholder="Nom du chantier"></div>
        <div><label for="remiseInput">Remise client (%)</label><input type="number" id="remiseInput" value="0" min="0" max="90" placeholder="0 √† 90"></div>
      </div>

      <!-- Tableau -->
      <div class="table-wrap">
        <table>
          <thead><tr><th>D√©signation</th><th>Qt√©</th><th class="right">PU HT (net)</th><th class="right">Total HT</th><th class="center">Actions</th></tr></thead>
        <tbody id="bodyDevis"><tr><td colspan="5" style="padding:12px;color:var(--txt-dim)">Aucune ligne dans le devis.</td></tr></tbody>
        </table>
      </div>

      <!-- Totaux + bouton Transport -->
      <div class="totaux">
        <div class="totaux-box">
          <div class="row"><div>Total HT</div><div id="totHT">0,00 ‚Ç¨</div></div>
          <div class="row"><div>TVA 20 %</div><div id="totTVA">0,00 ‚Ç¨</div></div>
          <div class="row grand"><div>Total TTC</div><div id="totTTC">0,00 ‚Ç¨</div></div>
          <div class="subnote">Remise commerciale incluse dans les montants affich√©s.</div>
        </div>

        <!-- Tuile transport dans le panneau -->
        <a class="app-inline" href="./transport.html" title="Calculer le co√ªt de transport">
          <div style="font-size:22px">üöö</div>
          <div>
            <p class="title">Co√ªt de transport</p>
            <p class="hint">Messagerie / Affr√®tement ‚Ä¢ Ajouter au devis</p>
          </div>
        </a>
      </div>

      <div style="margin-top:16px; display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
        <button id="btnPdf" class="btn" disabled title="Renseignez Entreprise, Nom & pr√©nom et Nom du chantier pour activer l‚Äôexport PDF">üìÑ Exporter le devis en PDF</button>
        <button id="btnClear" class="btn btn-danger">üóë Vider le devis</button>
        <div id="noteInfo" class="note-info">üí° Veuillez renseigner l‚Äôentreprise, le nom du contact et le chantier pour activer l‚Äôexport PDF.</div>
      </div>
    </section>
  </main>

  <footer>¬© Cofel ‚Äî ZA du Perquoi, 72560 Chang√© ‚Äî SIRET 927 659 458 00024 ‚Äî TVA FR80927659458</footer>

  <!-- Core devis -->
  <script src="./js/devis-core.js"></script>

  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.3/jspdf.plugin.autotable.min.js"></script>

  <div id="toast" class="toast"></div>

  <script>
  (function(){
    if(!window.Devis){ console.error("Devis-core non charg√©. V√©rifiez ./js/devis-core.js"); return; }

    // === WEBHOOK (Google Apps Script) ===
    const MAIL_WEBHOOK = "https://script.google.com/macros/s/AKfycbwfOBZhRoL0WX9R1moMC4DIIiG2jUpNL0RwV7PRx4hME8j1_dyyEWbAdC8_l-srMzg/exec
";
    const SEND_PDF_ATTACHMENT = false; // ‚úÖ on d√©sactive l‚Äôenvoi de la PJ pour fiabilit√©

    // Helpers
    const fmt = n => (Number(n)||0).toFixed(2).replace('.', ',') + " ‚Ç¨";
    const STORAGE_KEY = "devisCourant_v1";
    const toast = document.getElementById('toast');
    function showToast(msg, ok=true){
      toast.textContent = msg;
      toast.style.background = ok ? "#d7ffd7" : "#ffe3e3";
      toast.style.color = "#222";
      toast.classList.add('show');
      setTimeout(()=> toast.classList.remove('show'), 3000);
    }

    function readStore(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}"); }catch{ return {}; } }
    function writeStore(obj){ localStorage.setItem(STORAGE_KEY, JSON.stringify(obj)); }
    function updateClientField(key, value){ const st=readStore(); if(!st.client) st.client={}; st.client[key]=value; writeStore(st); }
    function getClient(){ const st = readStore(); return st.client || {}; }

    // DOM
    const elRemise=document.getElementById('remiseInput'), body=document.getElementById('bodyDevis');
    const elHT=document.getElementById('totHT'), elTVA=document.getElementById('totTVA'), elTTC=document.getElementById('totTTC');
    const elSociete=document.getElementById('societe'), elContact=document.getElementById('contact'), elChantier=document.getElementById('chantier');
    const btnPdf=document.getElementById('btnPdf'), btnClear=document.getElementById('btnClear'), noteInfo=document.getElementById('noteInfo');

    function validateExportEnabled(){
      const filled = v => (v || '').trim().length > 0;
      const ok = filled(elSociete.value) && filled(elContact.value) && filled(elChantier.value);
      btnPdf.disabled = !ok; btnPdf.title = ok ? "" : "Renseignez Entreprise, Nom & pr√©nom et Nom du chantier pour activer l‚Äôexport PDF";
      if(noteInfo){ noteInfo.classList.toggle('hidden', ok); }
    }

    (function hydrateClient(){
      const c=getClient(); if(c.societe) elSociete.value=c.societe; if(c.contact) elContact.value=c.contact; if(c.chantier) elChantier.value=c.chantier; validateExportEnabled();
    })();

    [ ['societe', elSociete], ['contact', elContact], ['chantier', elChantier] ]
      .forEach(([k,el]) => el.addEventListener('input', () => { updateClientField(k, el.value); validateExportEnabled(); }));

    function render(){
      const d = Devis.computeTotals();
      const storedRemise = Number(d.remise_pct||0);
      if(Number(elRemise.value||0) !== storedRemise) elRemise.value = storedRemise;

      if(!d.lignes.length){
        body.innerHTML = '<tr><td colspan="5" style="padding:12px;color:#f0edff">Aucune ligne dans le devis.</td></tr>';
      } else {
        body.innerHTML = d.lignes.map(l => `
          <tr data-id="${l.id}">
            <td>${l.designation || "-"}</td>
            <td class="center">${l.quantite}</td>
            <td class="right">${fmt(l.pu_net_ht)}</td>
            <td class="right">${fmt(l.total_ligne_ht)}</td>
            <td class="center">
              <button class="btn btn-ghost btn-qty" style="margin-right:6px;">üìù Qt√©</button>
              <button class="btn btn-danger btn-del">Suppr.</button>
            </td>
          </tr>`).join("");
      }
      elHT.textContent=fmt(d.total_ht); elTVA.textContent=fmt(d.tva); elTTC.textContent=fmt(d.total_ttc);
    }

    elRemise.addEventListener('input', ()=>{ const v=Math.max(0, Math.min(90, Number(elRemise.value||0))); Devis.setRemise(v); elRemise.value=v; render(); });

    body.addEventListener('click',(e)=>{
      const tr = e.target.closest('tr[data-id]'); if(!tr) return; const id = tr.getAttribute('data-id');
      if(e.target.classList.contains('btn-del')){ if(confirm("Supprimer cette ligne du devis ?")){ Devis.removeLine(id); render(); } }
      if(e.target.classList.contains('btn-qty')){ const currentQty = Number(tr.children[1].textContent||1); const q = prompt("Nouvelle quantit√© :", currentQty); if(q !== null){ Devis.updateQty(id, q); render(); } }
    });

    btnClear.addEventListener('click', ()=>{ if(confirm("Vider enti√®rement le devis ?")){ Devis.clearAll(true); render(); validateExportEnabled(); } });

    // ==== INTEGRATION TRANSPORT ====
    function addTransportLine(payload){
      const st = readStore();
      if(!st.lignes) st.lignes = [];
      const exists = st.lignes.some(l => l.id === payload.id);
      if(!exists){
        const q = Number(payload.quantite||1);
        const pu = Number(payload.pu_net_ht||0);
        st.lignes.push({
          id: payload.id,
          designation: payload.designation || "Transport",
          quantite: q,
          pu_net_ht: pu,
          total_ligne_ht: +(q*pu).toFixed(2),
          type: payload.type || "transport"
        });
        writeStore(st);
        try{ Devis.reload && Devis.reload(); }catch{}
        render();
      }
    }

    function checkTransportInbox(){
      const raw = localStorage.getItem('cofel_transport_add');
      if(!raw) return;
      try{
        const payload = JSON.parse(raw);
        if(payload && payload.id){ addTransportLine(payload); }
      }catch(e){ console.warn("Transport payload invalide", e); }
      localStorage.removeItem('cofel_transport_add');
    }

    checkTransportInbox();
    window.addEventListener('storage', (ev)=>{ if(ev.key === 'cofel_transport_add' && ev.newValue){ checkTransportInbox(); } });

    // === EXPORT PDF + ENVOI EMAIL (sans PJ) ===
    function loadImageDataURL(src){
      return new Promise((resolve,reject)=>{
        const img = new Image(); img.crossOrigin="anonymous";
        img.onload = ()=>{ const canvas=document.createElement('canvas'); const targetW=180; const ratio=img.height/img.width; canvas.width=targetW; canvas.height=Math.round(targetW*ratio);
          const ctx=canvas.getContext('2d'); ctx.drawImage(img,0,0,canvas.width,canvas.height); resolve(canvas.toDataURL('image/jpeg',0.95)); };
        img.onerror = reject; img.src = src;
      });
    }

    async function sendEmail({client, devis, maybePdfDataUrl}){
      try{
        const dateStr = new Date().toLocaleDateString("fr-FR");
        const subject = `Devis Cofel ‚Äî ${client?.societe||"Sans soci√©t√©"} ‚Äî ${client?.chantier||"Sans chantier"} ‚Äî ${((Number(devis.total_ttc)||0).toFixed(2)).replace('.',',')} ‚Ç¨ ‚Äî ${dateStr}`;

        const body = {
          subject,
          client,
          devis: {
            remise_pct: devis.remise_pct,
            total_ht: devis.total_ht,
            tva: devis.tva,
            total_ttc: devis.total_ttc,
            lignes: (devis.lignes||[]).map(l=>({
              designation: l.designation, quantite: l.quantite, pu_net_ht: l.pu_net_ht, total_ligne_ht: l.total_ligne_ht, type: l.type||""
            }))
          },
          meta: { page: location.href, userAgent: navigator.userAgent, date: new Date().toISOString() },
          pdf: null
        };

        // Si un jour tu veux remettre la PJ : passe SEND_PDF_ATTACHMENT √† true.
        if (SEND_PDF_ATTACHMENT && maybePdfDataUrl) {
          const base64 = (maybePdfDataUrl.split(",")[1] || "");
          // garde-fou ~4 MB
          if (base64.length < 4_000_000 * 1.37) {
            body.pdf = { filename: "Devis-Cofel.pdf", base64 };
          }
        }

        const resp = await fetch(MAIL_WEBHOOK, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });

        const text = await resp.text().catch(()=>"(no text)");
        console.log("[MAIL] status", resp.status, "body:", text);
        if (!resp.ok) showToast(`‚ùå Mail non envoy√© (HTTP ${resp.status})`, false);
        else showToast(/ok/i.test(text) ? "‚úÖ Email envoy√©" : "‚úÖ Email envoy√© (r√©ponse re√ßue)", true);
      }catch(err){
        console.warn("Envoi email √©chou√©:", err);
        showToast("‚ùå Erreur envoi email (voir console)", false);
      }
    }

    document.getElementById("btnPdf").addEventListener("click", async () => {
      try{
        const { jsPDF } = window.jspdf;
        const COLOR_PRIMARY=[90,45,130], COLOR_TEXT=[20,20,20], COLOR_MUTED=[110,110,110], BG_SOFT=[245,242,252];
        const d=Devis.computeTotals(); const client=getClient();
        const doc=new jsPDF({ unit:"pt", format:"a4", compress:true });
        const pageWidth=doc.internal.pageSize.getWidth(), pageHeight=doc.internal.pageSize.getHeight(), margin=40;
        let logoData=null; try{ logoData=await loadImageDataURL("./assets/logo cofel.jpg"); }catch{}
        const drawHeader=()=>{ const yTop=margin, logoW=120; if(logoData){ doc.addImage(logoData,"JPEG",margin,yTop,logoW,logoW*0.28); }
          doc.setFont("Helvetica","bold"); doc.setFontSize(18); doc.setTextColor(...COLOR_PRIMARY); doc.text("DEVIS", pageWidth-margin, yTop+6,{align:"right"});
          doc.setFont("Helvetica","normal"); doc.setFontSize(10); doc.setTextColor(...COLOR_TEXT);
          ["COFEL72 ‚Äî ZA du Perquoi, 72560 Chang√©","SIRET 927 659 458 00024 ‚Äî TVA FR80927659458","Date : "+new Date().toLocaleDateString("fr-FR")]
            .forEach((t,i)=> doc.text(t, pageWidth - margin, yTop + 26 + i*14, {align:"right"}));
          doc.setDrawColor(...COLOR_PRIMARY); doc.setLineWidth(1); doc.line(margin, yTop+54, pageWidth-margin, yTop+54); };
        const drawFooter=(pageNum,pageCount)=>{ const y=pageHeight - margin + 8; doc.setFont("Helvetica","normal"); doc.setFontSize(9); doc.setTextColor(...COLOR_MUTED);
          doc.text("Conditions : Offre valable 30 jours. D√©lais et transport √† confirmer. Paiement selon conditions Cofel.", margin, y);
          doc.text(`Page ${pageNum} / ${pageCount}`, pageWidth - margin, y, { align:"right" }); };
        const formatEuros=n=>(Number(n)||0).toFixed(2).replace(".", ",")+" ‚Ç¨";
        const drawClientCard=(yStart)=>{ const cardW=pageWidth - margin*2, cardH=90; doc.setFillColor(...BG_SOFT); doc.setDrawColor(230,230,240); doc.roundedRect(margin,yStart,cardW,cardH,8,8,"FD");
          let y=yStart+24; doc.setFont("Helvetica","bold"); doc.setFontSize(12); doc.setTextColor(...COLOR_PRIMARY); doc.text("Client", margin+14, y);
          doc.setFont("Helvetica","normal"); doc.setFontSize(11); doc.setTextColor(...COLOR_TEXT); y+=18;
          const lines=[]; if(client.societe) lines.push(["Entreprise :", client.societe]); if(client.contact) lines.push(["Contact :", client.contact]); if(client.chantier) lines.push(["Chantier :", client.chantier]);
          if(d.remise_pct>0) lines.push(["Remise :", `${d.remise_pct} %`]);
          const colGap=260, leftX=margin+14, rightX=leftX+colGap;
          lines.forEach((row,idx)=>{ const isRight=(idx>=3); const x=isRight?rightX:leftX; const yy=y+(isRight?(idx-3)*16:idx*16);
            doc.setTextColor(...COLOR_MUTED); doc.text(row[0], x, yy); doc.setTextColor(...COLOR_TEXT); doc.text(String(row[1]), x+80, yy); });
          return yStart+cardH+18; };

        const drawTotalsBox=(yStart)=>{ const boxW=220, boxH=102, x=pageWidth - margin - boxW, y=yStart;
          doc.setFillColor(255,255,255); doc.setDrawColor(...COLOR_PRIMARY); doc.roundedRect(x,y,boxW,boxH,8,8,"S");
          doc.setFont("Helvetica","bold"); doc.setFontSize(12); doc.setTextColor(...COLOR_PRIMARY); doc.text("R√©capitulatif", x+12, y+18);
          const row=(label,value,yy,bold=false)=>{ doc.setFont("Helvetica", bold?"bold":"normal"); doc.setFontSize(11); doc.setTextColor(...COLOR_TEXT);
            doc.text(label, x+12, yy); doc.text(value, x+boxW-12, yy, {align:"right"}); };
          row("Total HT", formatEuros(d.total_ht), y+40); row("TVA 20 %", formatEuros(d.tva), y+58); row("Total TTC", formatEuros(d.total_ttc), y+82, true);
          return y+boxH; };

        const rows = (d.lignes||[]).map(l => ([ String(l.designation||"-"), String(l.quantite||0), (Number(l.pu_net_ht)||0).toFixed(2), (Number(l.total_ligne_ht)||0).toFixed(2) ]));
        drawHeader(); let currentY = drawClientCard(margin + 66);
        doc.autoTable({ startY: currentY, head:[["D√©signation","Qt√©","PU HT","Total HT"]], body: rows,
          styles:{ font:"helvetica", fontSize:10, halign:"left", cellPadding:6 }, headStyles:{ fillColor:COLOR_PRIMARY, textColor:[255,255,255], fontStyle:"bold" },
          columnStyles:{ 1:{halign:"center", cellWidth:40}, 2:{halign:"right", cellWidth:70}, 3:{halign:"right", cellWidth:80} },
          theme:"grid", margin:{ left: margin, right: margin }, didDrawPage: ()=> drawHeader() });
        const afterTableY = doc.lastAutoTable ? doc.lastAutoTable.finalY + 16 : (margin + 200); drawTotalsBox(afterTableY);
        const pageCount=doc.internal.getNumberOfPages(); for(let i=1;i<=pageCount;i++){ doc.setPage(i); drawFooter(i,pageCount); }

        // ---- Envoi email (m√©tadonn√©es uniquement) ----
        try{
          const dataUrl = doc.output("datauristring"); // dispo si un jour on r√©active la PJ
          await sendEmail({ client, devis: d, maybePdfDataUrl: SEND_PDF_ATTACHMENT ? dataUrl : null });
        }catch(e){
          console.warn("Pr√©paration email √©chou√©e", e);
          await sendEmail({ client, devis: d, maybePdfDataUrl: null });
        }

        // T√©l√©chargement PDF utilisateur
        doc.save("Devis-Cofel.pdf");
      }catch(err){
        alert("Erreur pendant la g√©n√©ration du PDF : " + err.message);
        console.error(err);
      }
    });

    // Initial render
    render();

    // D√©connexion
    (async () => {
      let siteId="cofel-configs";
      try{ const mod=await import("./auth/config.js"); if(mod?.AUTH_SETTINGS?.siteId) siteId=mod.AUTH_SETTINGS.siteId; }catch{}
      const TOKEN_KEY=`auth_token_${siteId}`;
      const btn=document.getElementById("logoutBtn");
      if(btn){ btn.addEventListener("click", ()=>{ try{ localStorage.removeItem(TOKEN_KEY);}catch{} location.href="./auth/login.html"; }); }
    })();
  })();
  </script>
</body>
</html>
