<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Configurateurs Cofel</title>
  <style>
    :root{
      --cofel:#5a2d82;
      --cofel-2:#7838a7;
      --bg:#f7f5fa;
      --card:#ffffff;
      --text:#1d1327;
      --muted:#7d6f8e;
      --shadow:0 10px 24px rgba(0,0,0,.08);
      --radius:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:"Segoe UI", Roboto, Arial, sans-serif;
      background:var(--bg);
      color:var(--text);
      display:flex;
      flex-direction:column;
    }

    header{
      background:linear-gradient(135deg,var(--cofel),var(--cofel-2));
      color:#fff;
      text-align:center;
      padding:36px 16px 28px;
      box-shadow:0 6px 20px rgba(0,0,0,.15);
      position:relative;
      overflow:hidden;
    }
    header::after{
      content:"";
      position:absolute;
      inset:-40% -20% auto -20%;
      height:200%;
      background:radial-gradient(ellipse at 50% 30%, rgba(255,255,255,.12), transparent 60%);
    }
    .brand{display:flex; flex-direction:column; align-items:center; gap:14px;}
    .brand img{height:70px; filter:drop-shadow(0 2px 6px rgba(0,0,0,.25));}
    h1{margin:0; font-size:clamp(22px, 2.6vw, 34px);}
    .subtitle{margin-top:6px; color:#e8dff1; font-size:14px}

    .wrap{width:100%; max-width:1120px; margin:28px auto; padding:0 18px 36px;}
    .grid{display:grid; gap:18px; grid-template-columns:repeat(auto-fit, minmax(220px, 1fr));}

    a.card{
      display:flex; justify-content:center; align-items:center; text-align:center;
      background:var(--card); border-radius:var(--radius);
      padding:22px 18px; border:1px solid rgba(0,0,0,.06); box-shadow:var(--shadow);
      text-decoration:none; color:var(--text); min-height:84px;
      transition:0.18s;
    }
    a.card:hover{transform:translateY(-4px); background:#fcfaff; border-color:var(--cofel-2);}

    footer{margin-top:auto; text-align:center; padding:18px 10px; color:#7d6f8e; font-size:13px;}
    button{cursor:pointer;}
  </style>
</head>
<body>

<header>
  <div class="brand">
    <img src="./assets/logo cofel.jpg" alt="Logo Cofel" />
    <h1>Configurateurs Cofel</h1>
    <div class="subtitle">Choisissez un configurateur pour commencer votre chiffrage</div>
  </div>
</header>

<main class="wrap">

  <!-- === LISTE DES CONFIGURATEURS === -->
  <section class="grid">
    <a class="card" href="./configurateurs/configurateur-tole-tablette.html"><div><p class="title">T√¥le Tablette</p><p class="hint">Ajourage, PMMA, ch√¢ssis‚Ä¶</p></div></a>
    <a class="card" href="./configurateurs/configurateur-rampe-lumineuse.html"><div><p class="title">Rampe Lumineuse (PLL)</p><p class="hint">LED + Laquage inclus</p></div></a>
    <a class="card" href="./configurateurs/configurateur-enseigne-drapeau.html"><div><p class="title">Enseigne Drapeau</p><p class="hint">Rond / Carr√©, potence</p></div></a>
    <a class="card" href="./configurateurs/configurateur-totems.html"><div><p class="title">Totems</p><p class="hint">Hauteurs, laquage</p></div></a>
    <a class="card" href="./configurateurs/configurateur-lettres PVC.html"><div><p class="title">Lettres PVC</p></div></a>
    <a class="card" href="./configurateurs/configurateur-lettre-alu-alupvc.html"><div><p class="title">Lettres Alu / Alu-PVC</p></div></a>
    <a class="card" href="./configurateurs/configurateur-lettre-boitier.html"><div><p class="title">Lettres Bo√Ætiers</p></div></a>
    <a class="card" href="./configurateurs/configurateur-tolerie-dibond.html"><div><p class="title">T√¥lerie Alu / Dibond</p></div></a>
  </section>

  <!-- === R√âCAP DEVIS === -->
  <section style="background:#fff; padding:16px; border:1px solid #eee; border-radius:12px; margin-top:30px;">
    <h2>üßæ R√©capitulatif du devis</h2>

    <div style="margin:12px 0; display:flex; gap:12px; align-items:center;">
      <label>Remise client (%)</label>
      <input type="number" id="remiseInput" value="0" min="0" max="90" style="width:80px;">
      <span style="color:#777;font-size:12px;">(appliqu√©e au tarif public = +50%)</span>
    </div>

    <table style="width:100%;border-collapse:collapse;">
      <thead>
        <tr style="background:#faf7ff;">
          <th>D√©signation</th>
          <th>Qt√©</th>
          <th style="text-align:right;">PU HT (net)</th>
          <th style="text-align:right;">Total HT</th>
          <th style="text-align:center;">Actions</th>
        </tr>
      </thead>
      <tbody id="bodyDevis">
        <tr><td colspan="5" style="padding:10px;">Aucune ligne dans le devis.</td></tr>
      </tbody>
    </table>

    <div style="text-align:right;margin-top:16px;">
      <div>Total HT : <span id="totHT">0,00 ‚Ç¨</span></div>
      <div>TVA 20% : <span id="totTVA">0,00 ‚Ç¨</span></div>
      <div style="font-weight:bold;font-size:18px;margin-top:6px;">Total TTC : <span id="totTTC">0,00 ‚Ç¨</span></div>
    </div>

    <button id="btnPdf"
      style="margin-top:18px;padding:10px 18px;border-radius:8px;background:#5a2d82;color:#fff;border:none;font-weight:600;box-shadow:0 2px 6px rgba(0,0,0,0.12);">
      üìÑ Exporter le devis en PDF
    </button>
  </section>

</main>

<footer>
  ¬© Cofel ‚Äî ZA du Perquoi, 72560 Chang√© ‚Äî SIRET 927 659 458 00024 ‚Äî TVA FR80927659458
</footer>

<!-- Core devis -->
<script src="./js/devis-core.js"></script>

<!-- jsPDF pour export PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

<script>
(function(){
  if(!window.Devis) return;

  const fmt = n => (Number(n)||0).toFixed(2).replace('.', ',') + " ‚Ç¨";
  const elRemise = document.getElementById('remiseInput');
  const body = document.getElementById('bodyDevis');
  const elHT = document.getElementById('totHT');
  const elTVA = document.getElementById('totTVA');
  const elTTC = document.getElementById('totTTC');

  function render(){
    const d = Devis.computeTotals();
    const storedRemise = Number(d.remise_pct||0);
    if(Number(elRemise.value||0) !== storedRemise) elRemise.value = storedRemise;

    if(!d.lignes.length){
      body.innerHTML = '<tr><td colspan="5" style="padding:10px;color:#777;">Aucune ligne dans le devis.</td></tr>';
    } else {
      body.innerHTML = d.lignes.map(l => `
        <tr data-id="${l.id}">
          <td>${l.designation || "-"}</td>
          <td style="text-align:center;">${l.quantite}</td>
          <td style="text-align:right;">${fmt(l.pu_net_ht)}</td>
          <td style="text-align:right;">${fmt(l.total_ligne_ht)}</td>
          <td style="text-align:center;">
            <button class="btn-qty" style="margin-right:6px;padding:4px 8px;border:1px solid #ddd;border-radius:8px;background:#fff;">üìù Qt√©</button>
            <button class="btn-del" style="padding:4px 8px;border:1px solid #e6b3b3;border-radius:8px;background:#fff;color:#b00020;">üóë Suppr.</button>
          </td>
        </tr>
      `).join("");
    }

    elHT.textContent  = fmt(d.total_ht);
    elTVA.textContent = fmt(d.tva);
    elTTC.textContent = fmt(d.total_ttc);
  }

  // Remise
  elRemise.addEventListener('input', ()=>{
    const v = Math.max(0, Math.min(90, Number(elRemise.value||0)));
    Devis.setRemise(v);
    elRemise.value = v;
    render();
  });

  // Actions lignes (d√©l√©gation)
  body.addEventListener('click',(e)=>{
    const tr = e.target.closest('tr[data-id]');
    if(!tr) return;
    const id = tr.getAttribute('data-id');

    if(e.target.classList.contains('btn-del')){
      if(confirm("Supprimer cette ligne du devis ?")){
        Devis.removeLine(id);
        render();
      }
    }

    if(e.target.classList.contains('btn-qty')){
      const currentQty = Number(tr.children[1].textContent||1);
      const q = prompt("Nouvelle quantit√© :", currentQty);
      if(q !== null){
        Devis.updateQty(id, q);
        render();
      }
    }
  });

  // Export PDF
  document.getElementById("btnPdf").addEventListener("click", () => {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit: "pt", format: "a4" });

    const d = Devis.computeTotals();

    // En-t√™te
    doc.setFont("Helvetica", "bold");
    doc.setFontSize(18);
    doc.text("COFEL72 ‚Äî Devis", 40, 50);

    doc.setFont("Helvetica", "normal");
    doc.setFontSize(11);
    doc.text("ZA du Perquoi, 72560 Chang√©", 40, 70);
    doc.text("SIRET 927 659 458 00024 ‚Äî TVA FR80927659458", 40, 85);
    doc.text("Date : " + new Date().toLocaleDateString("fr-FR"), 40, 105);
    if (d.remise_pct > 0) {
      doc.text("Remise appliqu√©e : " + d.remise_pct + " %", 40, 120);
    }

    // Tableau
    const rows = d.lignes.map(l => [
      String(l.designation||"-"),
      String(l.quantite),
      (Number(l.pu_net_ht)||0).toFixed(2) + " ‚Ç¨",
      (Number(l.total_ligne_ht)||0).toFixed(2) + " ‚Ç¨"
    ]);

    doc.autoTable({
      startY: 140,
      head: [["D√©signation", "Qt√©", "PU HT", "Total HT"]],
      body: rows,
      styles: { font: "helvetica", fontSize: 10 }
    });

    // Totaux
    let y = doc.lastAutoTable ? doc.lastAutoTable.finalY + 25 : 170;
    doc.setFont("Helvetica", "bold");
    doc.text("Total HT : " + (Number(d.total_ht)||0).toFixed(2) + " ‚Ç¨", 40, y);
    doc.text("TVA 20% : " + (Number(d.tva)||0).toFixed(2) + " ‚Ç¨", 40, y + 18);
    doc.text("Total TTC : " + (Number(d.total_ttc)||0).toFixed(2) + " ‚Ç¨", 40, y + 36);

    // Pied de page
    doc.setFont("Helvetica", "normal");
    doc.setFontSize(9);
    doc.text("Conditions : Offre valable 30 jours. D√©lais et transport √† confirmer. Paiement selon conditions Cofel.", 40, y + 64);

    doc.save("Devis-Cofel.pdf");
  });

  // Premi√®re peinture
  render();
})();
</script>

</body>
</html>
