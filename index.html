<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Configurateurs Cofel</title>

  <!-- üîí Protection par mot de passe -->
  <script src="./auth/lock.js" type="module"></script>

  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <style>
    :root{
      --cofel:#5a2d82; --cofel-2:#7838a7;
      --glass: rgba(255,255,255,.08); --glass-hr: rgba(255,255,255,.14);
      --txt:#f5f7ff; --txt-dim:#e6e6ff; --accent:#c9b7ff;
      --radius:18px; --blur:18px; --shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--txt);
      font-family:-apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, Arial, sans-serif;
      background:
        radial-gradient(800px 500px at 20% -10%, rgba(255,255,255,.10), transparent 60%),
        radial-gradient(800px 500px at 110% 10%, rgba(255,255,255,.08), transparent 60%),
        linear-gradient(135deg, var(--cofel), var(--cofel-2));
      position:relative; overflow-x:hidden;
    }

    /* ===================== HEADER / HERO (nouvelle version) ===================== */
    .hero{
      position:relative; z-index:1;
      padding:24px 20px 16px;
    }
    .hero-inner{
      max-width:1200px; margin:0 auto;
      display:flex; align-items:center; justify-content:space-between; gap:16px;
    }
    .brand-lite{
      display:flex; align-items:center; gap:12px;
    }
    .brand-lite img{
      height:42px; width:auto; object-fit:contain; border-radius:8px;
    }
    .brand-lite h1{
      font-size: clamp(18px, 2.4vw, 22px); margin:0; letter-spacing:.2px; font-weight:700;
    }
    .hero-tagline{
      max-width:1200px; margin:10px auto 0; padding:0 20px; color:var(--txt-dim);
    }
    .hero::after{
      content:""; display:block; height:1px; margin-top:14px;
      background: linear-gradient(90deg, rgba(255,255,255,.15), rgba(255,255,255,.04));
    }

    .logout-btn{
      appearance:none; border:none; cursor:pointer; font-weight:700; color:var(--txt);
      background: linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.06));
      border:1px solid rgba(255,255,255,.18); border-radius:12px; padding:8px 12px;
      box-shadow: var(--shadow); backdrop-filter: blur(var(--blur));
      opacity:.95; transition: opacity .15s, transform .15s, box-shadow .15s;
    }
    .logout-btn:hover{ opacity:1; transform: translateY(-1px); box-shadow: 0 14px 34px rgba(0,0,0,.42); }

    /* ===================== APPS GRID ===================== */
    .wrap{max-width:1200px; margin:26px auto; padding:0 20px 40px; position:relative; z-index:1;}
    .apps{ display:grid; gap:16px; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); }
    .app{
      position:relative; text-decoration:none; color:var(--txt);
      background: linear-gradient(180deg, rgba(255,255,255,.18), rgba(255,255,255,.08));
      border:1px solid rgba(255,255,255,.2); border-radius:20px; padding:18px 16px;
      box-shadow: var(--shadow); backdrop-filter: blur(var(--blur));
      transform: translateY(0); transition: transform .18s, box-shadow .18s, background .18s, border-color .18s;
    }
    .app:hover{ transform: translateY(-4px); box-shadow: 0 18px 40px rgba(0,0,0,.45); }
    .app .title{ font-weight:800; margin:0 0 6px; letter-spacing:.2px; }
    .app .hint{ color:var(--txt-dim); margin:0; font-size:13px; }

    /* ===================== PANEL (devis + client) ===================== */
    .panel{
      margin-top:28px;
      background: linear-gradient(180deg, rgba(255,255,255,.16), rgba(255,255,255,.06));
      border:1px solid rgba(255,255,255,.2);
      border-radius:20px; padding:18px;
      box-shadow: var(--shadow); backdrop-filter: blur(var(--blur));
    }
    .panel h2{ margin:0 0 12px; font-size: clamp(18px, 2.4vw, 22px); letter-spacing:.2px; }

    .client-card{
      margin:12px 0 16px;
      background: linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.06));
      border:1px solid rgba(255,255,255,.18);
      border-radius:16px;
      padding:14px;
      display:grid; gap:12px;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    }
    label{font-weight:700; font-size:12px; color:var(--accent);}
    input[type="text"], input[type="number"]{
      width:100%; margin-top:6px; padding:10px 12px;
      background: rgba(255,255,255,.08); color:var(--txt);
      border:1px solid rgba(255,255,255,.18); border-radius:12px; outline:none;
      transition: border-color .18s ease, background .18s ease;
    }
    input[type="text"]::placeholder, input[type="number"]::placeholder{ color: #f0edff; opacity:.75; }
    input[type="text"]:focus, input[type="number"]:focus{ border-color: rgba(255,255,255,.34); background: rgba(255,255,255,.12); }

    .table-wrap{overflow:auto; border-radius:14px; border:1px solid rgba(255,255,255,.16);}
    table{width:100%; border-collapse:collapse; min-width:720px;}
    thead tr{ background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.04)); }
    th, td{ padding:10px 12px; text-align:left; }
    th{ font-size:12px; color:var(--accent); letter-spacing:.3px; }
    tbody tr + tr td{ border-top:1px solid rgba(255,255,255,.12); }
    td.right{ text-align:right; } td.center{ text-align:center; }

    .totaux{ margin-top:16px; display:flex; justify-content:space-between; gap:16px; align-items:flex-start; flex-wrap:wrap; }
    .totaux-box{
      min-width:320px; border-radius:16px; padding:12px 14px;
      background: linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.06));
      border:1px solid rgba(255,255,255,.18);
    }
    .row{ display:flex; justify-content:space-between; padding:6px 0; border-bottom:1px dashed rgba(255,255,255,.16); }
    .row:last-child{ border-bottom:none; padding-bottom:0; }
    .grand{ font-weight:800; font-size:18px; }
    .subnote{ color:var(--txt-dim); font-size:12px; margin-top:6px; }

    .btn{
      appearance:none; border:none; cursor:pointer; font-weight:700;
      color:#0b0b0b; background:#fff; border-radius:12px; padding:10px 14px;
      box-shadow: 0 10px 24px rgba(0,0,0,.25);
      transition: transform .16s ease, box-shadow .16s ease, opacity .16s ease;
    }
    .btn:active{ transform: translateY(1px); box-shadow: 0 6px 16px rgba(0,0,0,.28); }
    .btn-ghost{ background: transparent; color:var(--txt); border:1px solid rgba(255,255,255,.24); }
    .btn-danger{ background: transparent; color:#ffe3e3; border:1px solid rgba(255, 107, 107, .45); }
    .btn[disabled]{ opacity:.45; cursor:not-allowed; box-shadow:none; pointer-events:none; }

    .app-inline{
      display:flex; align-items:center; gap:10px; padding:12px 14px; border-radius:14px; text-decoration:none; color:var(--txt);
      background: linear-gradient(180deg, rgba(255,255,255,.18), rgba(255,255,255,.08));
      border:1px solid rgba(255,255,255,.2); box-shadow: var(--shadow); backdrop-filter: blur(var(--blur));
      transition: transform .18s ease, box-shadow .18s ease;
    }
    .app-inline:hover{ transform: translateY(-2px); box-shadow: 0 14px 30px rgba(0,0,0,.42); }
    .app-inline .title{ margin:0; font-weight:800; }
    .app-inline .hint{ margin:0; color:var(--txt-dim); font-size:12px; }

    footer{ color:#f3ecff; font-size:12px; text-align:center; padding:24px 10px; opacity:.9; }
    @media (max-width:720px){ .brand h1{display:none;} }

    .toast{ position:fixed; right:16px; bottom:16px; background:#fff; color:#222; padding:10px 12px; border-radius:10px; box-shadow:0 10px 24px rgba(0,0,0,.35); display:none; z-index:99; }
    .toast.show{ display:block; }
  </style>
</head>
<body>

  <!-- ===================== HEADER / HERO ===================== -->
  <header class="hero">
    <div class="hero-inner">
      <div class="brand-lite">
        <img src="./assets/logo cofel.jpg" alt="Cofel" />
        <h1>Configurateurs Cofel</h1>
      </div>
      <button id="logoutBtn" class="logout-btn" title="Se d√©connecter">üö™ Se d√©connecter</button>
    </div>
    <p class="hero-tagline">
      Choisissez un configurateur puis composez votre devis en quelques clics.
      L‚Äôaper√ßu et l‚Äôexport PDF sont mis √† jour automatiquement.
    </p>
  </header>

  <!-- ===================== APPS GRID ===================== -->
  <main class="wrap">
    <section class="apps" aria-label="Liste des configurateurs">
      <a class="app" href="./configurateurs/configurateur-tole-tablette.html">
        <p class="title">T√¥le Tablette</p><p class="hint">Ajourage, PMMA, ch√¢ssis‚Ä¶</p>
      </a>
      <a class="app" href="./configurateurs/configurateur-rampe-lumineuse.html">
        <p class="title">Rampe Lumineuse (PLL)</p><p class="hint">LED + laquage inclus</p>
      </a>
      <a class="app" href="./configurateurs/configurateur-enseigne-drapeau.html">
        <p class="title">Enseigne Drapeau</p><p class="hint">Rond / Carr√©, potence</p>
      </a>
      <a class="app" href="./configurateurs/configurateur-totems.html">
        <p class="title">Totems</p><p class="hint">Hauteurs, options d‚Äôinstallation</p>
      </a>
      <a class="app" href="./configurateurs/configurateur-lettres PVC.html">
        <p class="title">Lettres PVC</p><p class="hint">Hauteur, chant, finitions</p>
      </a>
      <a class="app" href="./configurateurs/configurateur-lettre-alu-alupvc.html">
        <p class="title">Lettres Alu / Alu-PVC</p><p class="hint">Finitions et options</p>
      </a>
      <a class="app" href="./configurateurs/configurateur-lettre-boitier.html">
        <p class="title">Lettres Bo√Ætiers</p><p class="hint">Face PMMA ou Dibond</p>
      </a>
      <a class="app" href="./configurateurs/configurateur-tolerie-dibond.html">
        <p class="title">T√¥lerie Alu / Dibond</p><p class="hint">Au m¬≤, laqu√© / pr√©laqu√©</p>
      </a>
    </section>

    <!-- ===================== R√âCAP + CLIENT ===================== -->
    <section class="panel" aria-label="R√©capitulatif du devis">
      <h2>üßæ R√©capitulatif du devis</h2>

      <div class="client-card">
        <div>
          <label for="societe">Entreprise</label>
          <input type="text" id="societe" placeholder="Nom de l‚Äôentreprise">
        </div>
        <div>
          <label for="contact">Nom & pr√©nom</label>
          <input type="text" id="contact" placeholder="Nom Pr√©nom">
        </div>
        <div>
          <label for="chantier">Nom du chantier</label>
          <input type="text" id="chantier" placeholder="Nom du chantier">
        </div>
        <div style="display:none;"><label for="remise-client">Remise client (%)</label><input type="number" id="remise-client" value="0"></div>
      </div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>D√©signation</th>
              <th>Qt√©</th>
              <th class="right">PU HT (net)</th>
              <th class="right">Total HT</th>
              <th class="center">Actions</th>
            </tr>
          </thead>
          <tbody id="bodyDevis">
            <tr><td colspan="5" style="padding:12px;color:var(--txt-dim)">Aucune ligne dans le devis.</td></tr>
          </tbody>
        </table>
      </div>

      <div class="totaux">
        <div class="totaux-box">
          <div class="row"><div>Total HT</div><div id="totHT">0,00 ‚Ç¨</div></div>
          <div class="row"><div>TVA 20 %</div><div id="totTVA">0,00 ‚Ç¨</div></div>
          <div class="row grand"><div>Total TTC</div><div id="totTTC">0,00 ‚Ç¨</div></div>
          <div class="subnote">La remise ne s‚Äôapplique pas au transport.</div>
        </div>

        <!-- Tuile transport (page d√©di√©e) -->
        <a class="app-inline" href="./transport.html" title="Calculer le co√ªt de transport">
          <div style="font-size:22px">üöö</div>
          <div>
            <p class="title">Co√ªt de transport</p>
            <p class="hint">Messagerie / Affr√®tement ‚Ä¢ Ajouter au devis</p>
          </div>
        </a>
      </div>

      <div style="margin-top:16px; display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
        <button id="btnPdf" class="btn" disabled
          title="Renseignez Entreprise, Nom & pr√©nom et Nom du chantier pour activer l‚Äôexport PDF">üìÑ Exporter le devis en PDF</button>
        <button id="btnClear" class="btn btn-danger">üóë Vider le devis</button>
        <div id="noteInfo" class="note-info">üí° Veuillez renseigner l‚Äôentreprise, le nom du contact et le chantier pour activer l‚Äôexport PDF.</div>
      </div>
    </section>
  </main>

  <footer>
    ¬© Cofel ‚Äî ZA du Perquoi, 72560 Chang√© ‚Äî SIRET 927 659 458 00024 ‚Äî TVA FR80927659458
  </footer>

  <!-- zone toast -->
  <div id="toast" class="toast"></div>

  <!-- Core devis -->
  <script src="./js/devis-core.js"></script>

  <!-- jsPDF + AutoTable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.3/jspdf.plugin.autotable.min.js"></script>

  <!-- Script principal -->
  <script>
  (function(){
    if(!window.Devis){
      console.error("Devis-core non charg√©. V√©rifiez ./js/devis-core.js");
      return;
    }

    // === Webhook e-mail (GAS) ‚Äî SANS pi√®ce jointe (robuste) ===
    const MAIL_WEBHOOK = "https://script.google.com/macros/s/AKfycbwKL-QFzzfTY-Root-3g56rDwb9uwmkwNCv25d5YE6CQBfoJnJ1x8Fz7HTBdNtANRsmpg/exec";

    const toast = document.getElementById('toast');
    function showToast(msg, ok=true){
      if(!toast) return alert(msg);
      toast.textContent = msg;
      toast.style.background = ok ? "#d7ffd7" : "#ffe3e3";
      toast.style.color = "#222";
      toast.classList.add('show');
      setTimeout(()=> toast.classList.remove('show'), 3000);
    }

    // Helpers
    const fmt = n => (Number(n)||0).toFixed(2).replace('.', ',') + " ‚Ç¨";
    const STORAGE_KEY = "devisCourant_v1";
    const TVA_RATE = 0.20;

    function readStore(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}"); }catch{ return {}; } }
    function writeStore(obj){ localStorage.setItem(STORAGE_KEY, JSON.stringify(obj)); }
    function updateClientField(key, value){
      const state = readStore(); if(!state.client) state.client = {};
      state.client[key] = value; writeStore(state);
    }
    function getClient(){ const st = readStore(); return st.client || {}; }

    // üëâ Totaux avec remise EXCLUANT les lignes de type "transport"
    function totalsExcludingTransportDiscount(d){
      const lignes = d?.lignes || [];
      const remise = 0;
      let sumTransport = 0, sumNon = 0;
      for (const l of lignes){
        const q  = Number(l.quantite)||0;
        const pu = Number(l.pu_net_ht)||0;
        const total = q * pu;
        if ((l.type || "").toLowerCase() === "transport") sumTransport += total;
        else sumNon += total;
      }
      const nonAfterRemise = sumNon * (1 - remise/100);
      const total_ht  = +(nonAfterRemise + sumTransport).toFixed(2);
      const tva       = +(total_ht * TVA_RATE).toFixed(2);
      const total_ttc = +(total_ht + tva).toFixed(2);
      return { total_ht, tva, total_ttc };
    }

    // DOM refs
    const elRemise   = document.getElementById('remise-client');
    const body       = document.getElementById('bodyDevis');
    const elHT       = document.getElementById('totHT');
    const elTVA      = document.getElementById('totTVA');
    const elTTC      = document.getElementById('totTTC');
    const elSociete  = document.getElementById('societe');
    const elContact  = document.getElementById('contact');
    const elChantier = document.getElementById('chantier');
    const btnPdf     = document.getElementById('btnPdf');
    const btnClear   = document.getElementById('btnClear');
    const noteInfo   = document.getElementById('noteInfo');

    // Validation activation export PDF
    function validateExportEnabled(){
      const filled = v => (v || '').trim().length > 0;
      const ok = filled(elSociete.value) && filled(elContact.value) && filled(elChantier.value);
      btnPdf.disabled = !ok;
      btnPdf.title = ok ? "" : "Renseignez Entreprise, Nom & pr√©nom et Nom du chantier pour activer l‚Äôexport PDF";
      if(noteInfo){ noteInfo.classList.toggle('hidden', ok); }
    }

    // ‚úÖ Prefill depuis le profil client + sauvegarde devis
    (function hydrateClient(){
      // 1) Profil client venant de client-login.html
      try{
        const rawProfile = localStorage.getItem('cofel_client_profile');
        if (rawProfile) {
          const profile = JSON.parse(rawProfile);

          // Entreprise
          if (profile.company && !elSociete.value) {
            elSociete.value = profile.company;
          }
          // Nom & pr√©nom
          if (profile.contactName && !elContact.value) {
            elContact.value = profile.contactName;
          }

          // Remise : discountRate est un taux (0.5 = 50 %)
          if (typeof profile.discountRate === 'number' && !isNaN(profile.discountRate)) {
            const pct = Math.max(0, Math.min(90, Math.round(profile.discountRate * 100)));
            if (elRemise) {
              elRemise.value = pct;
            }
            Devis.setRemise(0);
          }
        }
      } catch(e){
        console.error('Erreur lecture profil client :', e);
      }

      // 2) √âventuelle sauvegarde d'un devis pr√©c√©dent
      const c = getClient();
      if(c.societe)  elSociete.value  = c.societe;
      if(c.contact)  elContact.value  = c.contact;
      if(c.chantier) elChantier.value = c.chantier;

      validateExportEnabled();
    })();

    // Save-as-you-type + revalidate
    [ ['societe', elSociete], ['contact', elContact], ['chantier', elChantier] ]
      .forEach(([k,el]) => el?.addEventListener('input', () => { updateClientField(k, el.value); validateExportEnabled(); } ));

    // Rendu du tableau + totaux
    function render(){
      const d = Devis.computeTotals();
      const storedRemise = Number(d.remise_pct||0);
      if(Number(elRemise?.value||0) !== storedRemise && elRemise) elRemise.value = storedRemise;

      if(!d.lignes.length){
        body.innerHTML = '<tr><td colspan="5" style="padding:12px;color:#f0edff">Aucune ligne dans le devis.</td></tr>';
      } else {
        body.innerHTML = d.lignes.map(l => `
          <tr data-id="${l.id}">
            <td>${l.designation || "-"}</td>
            <td class="center">${l.quantite}</td>
            <td class="right">${fmt(l.pu_net_ht)}</td>
            <td class="right">${fmt(l.total_ligne_ht)}</td>
            <td class="center">
              <button class="btn btn-ghost btn-qty" style="margin-right:6px;">üìù Qt√©</button>
              <button class="btn btn-danger btn-del">Suppr.</button>
            </td>
          </tr>
        `).join("");
      }

      // üëâ Totaux corrig√©s (remise hors transport)
      const t = totalsExcludingTransportDiscount(d);
      elHT.textContent  = fmt(t.total_ht);
      elTVA.textContent = fmt(t.tva);
      elTTC.textContent = fmt(t.total_ttc);
    }

    // Remise (si l'utilisateur la modifie √† la main)
    

    // Actions lignes
    body.addEventListener('click',(e)=>{
      const tr = e.target.closest('tr[data-id]');
      if(!tr) return;
      const id = tr.getAttribute('data-id');

      if(e.target.classList.contains('btn-del')){
        if(confirm("Supprimer cette ligne du devis ?")){
          Devis.removeLine(id); render();
        }
      }
      if(e.target.classList.contains('btn-qty')){
        const currentQty = Number(tr.children[1].textContent||1);
        const q = prompt("Nouvelle quantit√© :", currentQty);
        if(q !== null){ Devis.updateQty(id, q); render(); }
      }
    });

    // Vider le devis
    btnClear.addEventListener('click', ()=>{
      if(confirm("Vider enti√®rement le devis ?")){
        Devis.clearAll(true);
        render();
        validateExportEnabled();
      }
    });

    // ===== Int√©gration TRANSPORT : r√©ception depuis transport.html =====
    function addTransportLine(payload){
      const st = readStore();
      if(!st.lignes) st.lignes = [];
      const exists = st.lignes.some(l => l.id === payload.id);
      if(!exists){
        const q = Number(payload.quantite||1);
        const pu = Number(payload.pu_net_ht||0);
        st.lignes.push({
          id: payload.id,
          designation: payload.designation || "Transport",
          quantite: q,
          pu_net_ht: pu,
          total_ligne_ht: +(q*pu).toFixed(2),
          type: payload.type || "transport"
        });
        writeStore(st);
        try{ Devis.reload && Devis.reload(); }catch{}
        render();
      }
    }
    function checkTransportInbox(){
      const raw = localStorage.getItem('cofel_transport_add');
      if(!raw) return;
      try{
        const payload = JSON.parse(raw);
        if(payload && payload.id){ addTransportLine(payload); }
      }catch(e){ console.warn("Transport payload invalide", e); }
      localStorage.removeItem('cofel_transport_add');
    }
    checkTransportInbox();
    window.addEventListener('storage', (ev)=>{ if(ev.key === 'cofel_transport_add' && ev.newValue){ checkTransportInbox(); } });

    // ====== CHARGEMENT LOGO SANS R√âDUCTION (PLEINE R√âSOLUTION) ======
    async function loadImageDataURL(src){
      // Lit l'image telle quelle et la convertit en DataURL sans r√©√©chantillonnage
      const resp = await fetch(src, { cache: "no-cache" });
      if(!resp.ok) throw new Error("Logo introuvable: " + src);
      const blob = await resp.blob();
      return await new Promise((resolve, reject) => {
        const fr = new FileReader();
        fr.onload = () => resolve(fr.result);
        fr.onerror = reject;
        fr.readAsDataURL(blob);
      });
    }

    // === Envoi e-mail (silencieux c√¥t√© client) =========================
    async function sendEmail({client, devis}){
      try{
        const t = totalsExcludingTransportDiscount(devis);
        const subject = `Devis Cofel ‚Äî ${client?.societe||"Sans soci√©t√©"} ‚Äî ${client?.chantier||"Sans chantier"} ‚Äî ${((Number(t.total_ttc)||0).toFixed(2)).replace('.',',')} ‚Ç¨ ‚Äî ${new Date().toLocaleDateString("fr-FR")}`;
        const body = {
          subject,
          client,
          devis: {
            remise_pct: devis.remise_pct,
            total_ht: t.total_ht,
            tva: t.tva,
            total_ttc: t.total_ttc,
            lignes: (devis.lignes||[]).map(l=>({
              designation: l.designation, quantite: l.quantite, pu_net_ht: l.pu_net_ht, total_ligne_ht: l.total_ligne_ht, type: l.type||""
            }))
          },
          meta: { page: location.href, userAgent: navigator.userAgent, date: new Date().toISOString() },
          pdf: null
        };

        const resp = await fetch(MAIL_WEBHOOK, {
          method: "POST",
          headers: { "Content-Type": "text/plain;charset=utf-8" }, // √©vite le pr√©flight CORS
          body: JSON.stringify(body)
        });
        const text = await resp.text().catch(()=>"(no text)");
        console.log("[MAIL] status", resp.status, "body:", text);
      }catch(err){
        console.warn("Envoi email √©chou√©:", err);
      }
    }

    // ===================== EXPORT PDF =====================
    document.getElementById("btnPdf").addEventListener("click", async () => {
  try {
    const { jsPDF } = window.jspdf;

    // Palette couleurs Cofel
    const COLOR_PRIMARY = [90, 45, 130];   // Violet Cofel
    const COLOR_TEXT    = [20, 20, 20];
    const COLOR_MUTED   = [110, 110, 110];
    const BG_SOFT       = [245, 242, 252];

    // Donn√©es devis
    const d = Devis.computeTotals();
    const t = totalsExcludingTransportDiscount(d);
    const client = {
      societe: (elSociete?.value || "").trim(),
      contact: (elContact?.value || "").trim(),
      chantier: (elChantier?.value || "").trim(),
    };

    // jsPDF
    const doc = new jsPDF({ unit: "pt", format: "a4", compress: true });
    const pageWidth = doc.internal.pageSize.getWidth();
    const pageHeight = doc.internal.pageSize.getHeight();
    const margin = 40;

    // ----- Chargement Logo haute r√©solution -----
    async function loadImageDataURL(src) {
      const resp = await fetch(src, { cache: "no-cache" });
      const blob = await resp.blob();
      return await new Promise((resolve) => {
        const fr = new FileReader();
        fr.onload = () => resolve(fr.result);
        fr.readAsDataURL(blob);
      });
    }

    let logoData = null;
    try {
      logoData = await loadImageDataURL("./assets/logo cofel.jpg");
    } catch (e) {
      console.warn("Logo non charg√© :", e);
    }

    // ----- HEADER -----
    const drawHeader = () => {
      const yTop = margin;

      if (logoData) {
        const W = 180;
        const H = Math.round(W * 0.28);
        doc.addImage(logoData, "JPEG", margin, yTop, W, H);
      }

      doc.setFont("Helvetica", "bold");
      doc.setFontSize(18);
      doc.setTextColor(...COLOR_PRIMARY);
      doc.text("DEVIS", pageWidth - margin, yTop + 6, { align: "right" });

      doc.setFont("Helvetica", "normal");
      doc.setFontSize(10);
      doc.setTextColor(...COLOR_TEXT);

      const lines = [
        "COFEL72 ‚Äî ZA du Perquoi, 72560 Chang√©",
        "SIRET 927 659 458 00024 ‚Äî TVA FR80927659458",
        "Date : " + new Date().toLocaleDateString("fr-FR"),
      ];

      lines.forEach((t, i) => {
        doc.text(t, pageWidth - margin, yTop + 26 + i * 14, { align: "right" });
      });

      // ligne violette
      doc.setDrawColor(...COLOR_PRIMARY);
      doc.setLineWidth(1);
      doc.line(margin, yTop + 54, pageWidth - margin, yTop + 54);
    };

    // ----- FOOTER -----
    const drawFooter = (pageNum, pageCount) => {
      const y = pageHeight - margin + 12;
      doc.setFont("Helvetica", "normal");
      doc.setFontSize(9);
      doc.setTextColor(...COLOR_MUTED);

      doc.text(
        "Offre valable 30 jours ‚Äî Sous r√©serve de faisabilit√© et validation technique",
        margin,
        y
      );
      doc.text(`Page ${pageNum} / ${pageCount}`, pageWidth - margin, y, {
        align: "right",
      });
    };

    // ----- CARTOUCHE "Sous r√©serve" -----
    function drawTechNotice(yStart) {
      const boxW = pageWidth - margin * 2;
      const boxH = 56;
      const y = Math.min(
        pageHeight - margin - boxH - 10,
        yStart
      );

      doc.setFillColor(255, 247, 220);
      doc.setDrawColor(220, 160, 0);
      doc.roundedRect(margin, y, boxW, boxH, 8, 8, "FD");

      doc.setTextColor(120, 70, 0);
      doc.setFont("Helvetica", "bold");
      doc.setFontSize(12.5);
      doc.text(
        "DEVIS SOUS R√âSERVE D'APPROBATION DE NOTRE √âQUIPE TECHNIQUE",
        margin + boxW / 2,
        y + boxH / 2 + 4,
        { align: "center", baseline: "middle" }
      );

      return y + boxH;
    }

    // ----- CARTE CLIENT -----
    const drawClientCard = (yStart) => {
      const CARD_H = 90;
      const cardW = pageWidth - margin * 2;

      doc.setFillColor(...BG_SOFT);
      doc.setDrawColor(230, 230, 240);
      doc.roundedRect(margin, yStart, cardW, CARD_H, 8, 8, "FD");

      let y = yStart + 24;
      doc.setFont("Helvetica", "bold");
      doc.setFontSize(12);
      doc.setTextColor(...COLOR_PRIMARY);
      doc.text("Client", margin + 14, y);

      doc.setFont("Helvetica", "normal");
      doc.setFontSize(11);

      const rows = [
        ["Entreprise :", client.societe],
        ["Contact :", client.contact],
        ["Chantier :", client.chantier],
      ];

      rows.forEach((r, i) => {
        doc.setTextColor(...COLOR_MUTED);
        doc.text(r[0], margin + 14, y + 20 + i * 16);
        doc.setTextColor(...COLOR_TEXT);
        doc.text(r[1] || "-", margin + 95, y + 20 + i * 16);
      });

      return yStart + CARD_H + 18;
    };

    // ----- TOTaUX -----
    const drawTotalsBox = (yStart) => {
      const boxW = 220;
      const boxH = 100;
      const x = pageWidth - margin - boxW;

      doc.setFillColor(255, 255, 255);
      doc.setDrawColor(...COLOR_PRIMARY);
      doc.roundedRect(x, yStart, boxW, boxH, 8, 8);

      const row = (label, value, yy, bold = false) => {
        doc.setFont("Helvetica", bold ? "bold" : "normal");
        doc.setFontSize(11);
        doc.setTextColor(...COLOR_TEXT);
        doc.text(label, x + 12, yy);
        doc.text(value, x + boxW - 12, yy, { align: "right" });
      };

      row("Total HT", t.total_ht.toFixed(2) + " ‚Ç¨", yStart + 28);
      row("TVA 20 %", t.tva.toFixed(2) + " ‚Ç¨", yStart + 46);
      row("Total TTC", t.total_ttc.toFixed(2) + " ‚Ç¨", yStart + 68, true);

      return yStart + boxH;
    };

    // ----- TABLEAU -----
    const rows = (d.lignes || []).map((l) => [
      l.designation || "-",
      String(l.quantite),
      (Number(l.pu_net_ht) || 0).toFixed(2),
      (Number(l.total_ligne_ht) || 0).toFixed(2),
    ]);

    drawHeader();
    let cursorY = drawClientCard(margin + 90);

    doc.autoTable({
      startY: cursorY,
      head: [["D√©signation", "Qt√©", "PU HT", "Total HT"]],
      body: rows,
      styles: { font: "helvetica", fontSize: 10, cellPadding: 6 },
      headStyles: { fillColor: COLOR_PRIMARY, textColor: [255, 255, 255] },
      alternateRowStyles: { fillColor: [250, 248, 255] },
      margin: { left: margin, right: margin },
      theme: "grid",
      didDrawPage: () => drawHeader(),
    });

    const afterTableY = doc.lastAutoTable.finalY + 16;
    const afterTotalsY = drawTotalsBox(afterTableY);

    doc.setPage(doc.internal.getNumberOfPages());
    drawTechNotice(afterTotalsY + 20);

    // FOOTER all pages
    const pageCount = doc.internal.getNumberOfPages();
    for (let i = 1; i <= pageCount; i++) {
      doc.setPage(i);
      drawFooter(i, pageCount);
    }

    // ----- EMAIL SILENCIEUX -----
    await sendEmail({ client, devis: d });

    // ----- ENREGISTREMENT BD -----
    let profileEmail = "";
    try {
      profileEmail = JSON.parse(
        localStorage.getItem("cofel_client_profile") || "{}"
      ).email;
    } catch {}

    const logResp = await fetch(
      "https://cofel-auth.sonveven.workers.dev/log-quote",
      {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          clientEmail: profileEmail,
          clientCompany: client.societe,
          clientName: client.contact,
          productType: "devis-index",
          totalHT: t.total_ht,
          totalTTC: t.total_ttc,
          extra: {
            chantier: client.chantier,
            date: new Date().toISOString(),
            lignes: d.lignes || [],
          },
        }),
      }
    );

    const logData = await logResp.json();
    window.lastCreatedQuoteId = logData.quoteId;

    // ----- PDF ‚Üí base64 -----
    const pdfBlob = doc.output("blob");
    const pdfBase64 = await new Promise((resolve) => {
      const fr = new FileReader();
      fr.onloadend = () => resolve(fr.result.split(",")[1]);
      fr.readAsDataURL(pdfBlob);
    });

    // ----- UPLOAD GITHUB -----
    await fetch("https://cofel-auth.sonveven.workers.dev/upload-pdf", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        quoteId: window.lastCreatedQuoteId,
        pdfBase64,
        clientCompany: client.societe,
        productType: "devis-index",
        createdAt: new Date().toISOString(),
      }),
    });

    // ----- DOWNLOAD LOCAL -----
    doc.save("Devis-Cofel.pdf");
  } catch (err) {
    alert("Erreur PDF : " + err.message);
    console.error(err);
  }
});

    // Initial render
    render();

    // üö™ D√©connexion (client + admin)
    (function setupLogout(){
      const btn = document.getElementById("logoutBtn");
      if (!btn) return;

      btn.addEventListener("click", () => {
        try {
          // Profil client
          localStorage.removeItem('cofel_client_profile');
          // Tokens admin √©ventuels
          Object.keys(localStorage).forEach(key => {
            if (key.startsWith('auth_token_')) {
              localStorage.removeItem(key);
            }
          });
        } catch (e) {
          console.error("Erreur nettoyage stockage lors de la d√©connexion", e);
        }

        const parts = location.pathname.split("/").filter(Boolean);
        const project = parts.length ? parts[0] : "";
        const loginUrl = `/${project}/auth/client-login.html`;
        location.href = loginUrl;
      });
    })();

  })();
  </script>
</body>
</html>
