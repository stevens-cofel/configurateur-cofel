<!-- /auth/admin-clients.html -->
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Administration clients ‚Äî Cofel</title>

  <!-- üîí Protection par le m√™me mot de passe que le portail interne -->
  <!-- üîí Protection interne -->
  <script src="./lock.js" type="module"></script>

  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <style>
    :root{
      --cofel:#5a2d82; --cofel-2:#7838a7;
@@ -30,813 +29,369 @@
      padding:20px;
    }

    .shell{
      max-width:1200px;
      margin:0 auto;
    }
    .shell{max-width:1200px;margin:0 auto;}

    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      margin-bottom:18px;
      flex-wrap:wrap;
    }
    .brand{
      display:flex; align-items:center; gap:12px;
    }
    .brand img{
      height:40px; width:auto; border-radius:10px; object-fit:contain;
    }
    h1{
      margin:0;
      font-size:clamp(18px,2.4vw,22px);
    }
    .tagline{
      margin:4px 0 0;
      font-size:13px;
      color:var(--txt-dim);
      margin-bottom:18px;
    }

    .header-actions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .brand{display:flex;align-items:center;gap:12px;}
    .brand img{height:40px;border-radius:10px;}

    h1{margin:0;font-size:22px;}
    .tagline{font-size:13px;color:var(--txt-dim);margin-top:4px;}

    .header-actions{display:flex;gap:8px;flex-wrap:wrap;}

    .btn{
      appearance:none; border:none; cursor:pointer; font-weight:700;
      color:#0b0b0b; background:#fff; border-radius:999px; padding:8px 14px;
      appearance:none;border:none;cursor:pointer;
      font-weight:700;font-size:13px;
      background:#fff;color:#0b0b0b;
      border-radius:999px;padding:8px 14px;
      box-shadow:0 10px 24px rgba(0,0,0,.25);
      font-size:13px;
      white-space:nowrap;
    }

    .btn-row{
      appearance:none;
      padding:4px 8px;
      font-size:11px;
      box-shadow:none;
      border-radius:999px;
      white-space:nowrap;
      border:1px solid rgba(0,0,0,.2);
      cursor:pointer;
      background:#fff;
      color:#111;
    }
    .btn-row-secondary{
      background:transparent;
      color:var(--txt);
      border:1px solid rgba(255,255,255,.4);
    }
    .btn-row-reset{
      background:transparent;
      color:#ffe9b5;
      border:1px solid rgba(255, 202, 116, .7);
    }

    /* TABLE */
    .card{
      background: linear-gradient(180deg, var(--glass), var(--glass-soft));
      border-radius:var(--radius);
      border:1px solid rgba(255,255,255,.22);
      box-shadow:var(--shadow);
      backdrop-filter: blur(var(--blur));
      padding:16px 16px 10px;
      padding:16px;
      backdrop-filter:blur(var(--blur));
    }

    .toolbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      flex-wrap:wrap;
      gap:10px;
      margin-bottom:10px;
    }
    .toolbar-left{
      display:flex;
      flex-direction:column;
      gap:4px;
      font-size:13px;
      color:var(--txt-dim);
    }
    .filter-row{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }
    .filter-row input{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.25);
      background:rgba(0,0,0,.15);
      color:var(--txt);
      font-size:13px;
      min-width:180px;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:3px 8px;
      border-radius:999px;
      font-size:11px;
      border:1px solid rgba(255,255,255,.22);
      background:rgba(0,0,0,.2);
    table{width:100%;border-collapse:collapse;font-size:13px;}
    th, td{padding:8px 10px;text-align:left;}
    thead th{
      background:rgba(0,0,0,.25);
      position:sticky;top:0;z-index:1;
      color:var(--accent);text-transform:uppercase;
      letter-spacing:.05em;font-size:11px;
    }
    tbody tr:nth-child(even){background:rgba(255,255,255,.06);}
    tbody tr:hover{background:rgba(255,255,255,.1);}
    .empty{text-align:center;padding:20px;color:var(--txt-dim);}

    .status-pill{
      display:inline-flex;
      padding:3px 8px;
      border-radius:999px;
      font-size:11px;
      font-weight:600;
    .btn-row{
      padding:4px 8px;font-size:11px;border-radius:999px;
      cursor:pointer;border:1px solid rgba(0,0,0,.2);
      background:#fff;color:#111;margin-right:4px;
    }
    .status-active{
      background:rgba(46, 213, 115, .18);
      color:#b9ffd4;
      border:1px solid rgba(46, 213, 115, .4);
    .btn-row-secondary{
      background:transparent;color:var(--txt);
      border-color:rgba(255,255,255,.4);
    }
    .status-inactive{
      background:rgba(255, 118, 117, .18);
      color:#ffd6d5;
      border:1px solid rgba(255, 118, 117, .4);
    .btn-row-reset{
      background:transparent;color:#ffe9b5;
      border:1px solid rgba(255,202,116,.7);
    }

    .table-wrap{
      margin-top:6px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.18);
      overflow:auto;
      max-width:100%;
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
      table-layout:auto;
    }
    thead{
      background:rgba(0,0,0,.25);
    }
    th, td{
      padding:8px 10px;
      text-align:left;
    }
    th{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.04em;
      color:var(--accent);
      border-bottom:1px solid rgba(255,255,255,.22);
      position:sticky;
      top:0;
      backdrop-filter: blur(10px);
      background:rgba(10,5,30,.95);
      z-index:1;
      white-space:nowrap;
    #modalNew, #modalEdit{
      position:fixed;inset:0;background:rgba(0,0,0,.55);
      display:none;align-items:center;justify-content:center;
      backdrop-filter:blur(4px);z-index:2000;
    }
    tbody tr:nth-child(even){
      background:rgba(0,0,0,.12);
    }
    tbody tr:hover{
      background:rgba(255,255,255,.05);
    .modal-box{
      background:#1c1530;border-radius:16px;
      width:320px;padding:20px;
      border:1px solid rgba(255,255,255,.25);
    }
    td{
      border-bottom:1px solid rgba(255,255,255,.08);
      vertical-align:middle;
    .modal-box input, .modal-box select{
      width:100%;padding:8px;margin-bottom:10px;
      border-radius:8px;border:none;
    }
    #modalMsg{color:#ffe3e3;font-size:13px;margin-top:8px;}
  </style>
</head>

    .col-discount{text-align:right;}
    .col-date{white-space:nowrap;}
    .col-actions{text-align:right;}

    @media (max-width: 900px){
      .col-email,
      .col-company,
      .col-contact{
        max-width:180px;
        word-wrap:break-word;
        white-space:normal;
      }
      .col-actions{
        white-space:normal;
      }
    }
<body>
<div class="shell">

    .empty{
      text-align:center;
      padding:18px 10px;
      color:var(--txt-dim);
      font-size:13px;
    }
  <!-- HEADER -->
  <header>
    <div class="brand">
      <img src="../assets/logo cofel.jpg">
      <div>
        <h1>Administration des comptes clients</h1>
        <p class="tagline">Cr√©ation, modification, remises, statuts, reset MDP.</p>
      </div>
    </div>
    <div class="header-actions">
      <button id="btnNewClient" class="btn">‚ûï Nouveau client</button>
      <button id="btnExport" class="btn">‚¨á Export Excel</button>
      <button id="btnBack" class="btn">‚¨Ö Retour</button>
    </div>
  </header>

  <!-- TABLE -->
  <section class="card">
    <div>
      <input id="searchInput" type="text" placeholder="Recherche‚Ä¶" 
             style="padding:8px;border-radius:12px;width:240px;border:none;">
      <span id="infoCount" style="margin-left:10px;color:var(--txt-dim);font-size:13px;">Chargement‚Ä¶</span>
    </div>

    .pill-discount{
      display:inline-flex;
      align-items:center;
      justify-content:flex-end;
      gap:4px;
      min-width:60px;
    }
    <div style="margin-top:10px;overflow:auto;max-height:70vh;">
      <table>
        <thead>
          <tr>
            <th>Email</th>
            <th>Soci√©t√©</th>
            <th>Contact</th>
            <th>Remise</th>
            <th>Statut</th>
            <th>Cr√©√© le</th>
            <th>Derni√®re connexion</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="tbodyClients">
          <tr><td colspan="8" class="empty">Chargement‚Ä¶</td></tr>
        </tbody>
      </table>
    </div>

    .muted{
      color:var(--txt-dim);
      font-size:11px;
    }
    .err{
      color:#ffe3e3;
      font-size:13px;
      margin-top:8px;
      min-height:18px;
    }
    .loader{
      font-size:13px;
      color:var(--txt-dim);
      display:flex;
      align-items:center;
      gap:6px;
    }
    .dot{
      width:6px; height:6px; border-radius:50%; background:var(--accent);
      animation:bounce 1s infinite alternate;
    }
    .dot:nth-child(2){animation-delay:.15s;}
    .dot:nth-child(3){animation-delay:.3s;}
    @keyframes bounce{
      from{ transform:translateY(0); opacity:.6;}
      to  { transform:translateY(-4px); opacity:1;}
    }
  </style>
</head>
  <!-- === MODAL CR√âATION CLIENT === -->
<div id="modalNew" style="
  display:none; position:fixed; inset:0; background:rgba(0,0,0,.55);
  backdrop-filter:blur(3px); z-index:1000; align-items:center; justify-content:center;
">
  <div style="
    background:#1c1530; padding:20px; border-radius:14px; width:320px;
    border:1px solid rgba(255,255,255,.25);
  ">
    <h3 style="margin-top:0;">Cr√©er un nouveau client</h3>

    <label>Email</label>
    <input id="newEmail" type="email" style="width:100%; margin-bottom:8px;">

    <label>Soci√©t√©</label>
    <input id="newCompany" type="text" style="width:100%; margin-bottom:8px;">

    <label>Contact</label>
    <input id="newContact" type="text" style="width:100%; margin-bottom:8px;">

    <label>Remise (%)</label>
    <input id="newDiscount" type="number" min="0" max="90" value="0" style="width:100%; margin-bottom:8px;">

    <label>Statut</label>
    <select id="newStatus" style="width:100%; margin-bottom:12px;">
    <div id="err" style="margin-top:8px;font-size:13px;color:#ffe3e3;"></div>
  </section>

</div>

<!-- MODALE NOUVEAU CLIENT -->
<div id="modalNew">
  <div class="modal-box">
    <h3>Cr√©er un client</h3>

    <input id="newEmail" placeholder="Email">
    <input id="newCompany" placeholder="Soci√©t√©">
    <input id="newContact" placeholder="Contact">
    <input id="newDiscount" type="number" placeholder="Remise (%)" min="0" max="90">
    <select id="newStatus">
      <option value="active">Actif</option>
      <option value="inactive">Inactif</option>
    </select>

    <div style="display:flex; justify-content:space-between;">
    <div style="display:flex;justify-content:space-between;">
      <button id="btnCreateClient" class="btn-row">Cr√©er</button>
      <button id="btnCloseModal" class="btn-row btn-row-secondary">Annuler</button>
    </div>

    <div id="modalMsg" style="margin-top:10px; font-size:13px;"></div>
    <div id="modalMsg"></div>
  </div>
</div>

<body>
  <div class="shell">
    <header>
      <div>
        <div class="brand">
          <img src="../assets/logo cofel.jpg" alt="Cofel">
          <div>
            <h1>Administration des comptes clients</h1>
            <p class="tagline">Visualisez les comptes, remises, statuts et r√©initialisez les mots de passe.</p>
          </div>
        </div>
      </div>
      <div class="header-actions">
        <button id="btnNewClient" class="btn">‚ûï Nouveau client</button>
        <button id="btnExport" class="btn">‚¨á Export Excel (.xls)</button>
        <button id="btnBack" class="btn">‚¨Ö Retour aux configurateurs</button>
      </div>
    </header>

    <section class="card">
      <div class="toolbar">
        <div class="toolbar-left">
          <div class="filter-row">
            <span>Recherche :</span>
            <input id="searchInput" type="text" placeholder="Filtrer par email, soci√©t√© ou contact‚Ä¶">
          </div>
          <div>
            <span id="infoCount" class="badge">Chargement‚Ä¶</span>
          </div>
        </div>
        <div class="loader" id="loader">
          <span class="dot"></span><span class="dot"></span><span class="dot"></span>
          <span>R√©cup√©ration des clients‚Ä¶</span>
        </div>
      </div>
<!-- MODALE EDIT -->
<div id="modalEdit">
  <div class="modal-box">
    <h3>Modifier client</h3>

    <input id="editEmail" placeholder="Email (actuel)">
    <input id="editNewEmail" placeholder="Nouvel email">
    <input id="editCompany" placeholder="Soci√©t√©">
    <input id="editContact" placeholder="Contact">
    <input id="editDiscount" type="number" placeholder="Remise (%)" min="0" max="90">
    <select id="editStatus">
      <option value="active">Actif</option>
      <option value="inactive">Inactif</option>
    </select>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th class="col-email">Email</th>
              <th class="col-company">Soci√©t√©</th>
              <th class="col-contact">Contact</th>
              <th class="col-discount">Remise</th>
              <th class="col-status">Statut</th>
              <th class="col-date">Cr√©√© le</th>
              <th class="col-date">Derni√®re connexion</th>
              <th class="col-actions">Actions</th>
            </tr>
          </thead>
          <tbody id="tbodyClients">
            <tr><td colspan="8" class="empty">En attente des donn√©es‚Ä¶</td></tr>
          </tbody>
        </table>
      </div>
    <div style="display:flex;justify-content:space-between;">
      <button id="editSave" class="btn-row">Enregistrer</button>
      <button id="editCancel" class="btn-row btn-row-secondary">Annuler</button>
    </div>

      <div id="err" class="err"></div>
    </section>
    <div id="editMsg" style="color:#ffe3e3;font-size:13px;margin-top:8px;"></div>
  </div>
</div>

  <script>
    const WORKER_BASE = 'https://cofel-auth.sonveven.workers.dev';

    const tbody = document.getElementById('tbodyClients');
    const loader = document.getElementById('loader');
    const errBox = document.getElementById('err');
    const infoCount = document.getElementById('infoCount');
    const searchInput = document.getElementById('searchInput');
    const btnBack = document.getElementById('btnBack');
    const btnExport = document.getElementById('btnExport');

    let allClients = [];

    function formatDate(iso){
      if(!iso) return '‚Äî';
      const d = new Date(iso);
      if (isNaN(d.getTime())) return '‚Äî';
      return d.toLocaleDateString('fr-FR') + ' ' + d.toLocaleTimeString('fr-FR', {hour:'2-digit', minute:'2-digit'});
    }
<script>
const WORKER_BASE = "https://cofel-auth.sonveven.workers.dev";

    function formatDiscount(rate){
      const r = Number(rate || 0);
      const pct = Math.round(r * 1000) / 10;
      return pct.toLocaleString('fr-FR', {maximumFractionDigits:1}) + ' %';
    }
const tbody = document.getElementById("tbodyClients");
const errBox = document.getElementById("err");
const searchInput = document.getElementById("searchInput");
const infoCount = document.getElementById("infoCount");

    function renderTable(filterText = ''){
      const q = (filterText || '').toLowerCase().trim();
      let rows = allClients;

      if (q){
        rows = rows.filter(c => {
          return (
            (c.email || '').toLowerCase().includes(q) ||
            (c.company || '').toLowerCase().includes(q) ||
            (c.contact_name || '').toLowerCase().includes(q)
          );
        });
      }

      infoCount.textContent = rows.length
        ? `${rows.length} client(s) affich√©(s)`
        : `Aucun client ne correspond au filtre`;

      if (!rows.length){
        tbody.innerHTML = '<tr><td colspan="8" class="empty">Aucun client √† afficher.</td></tr>';
        return;
      }

      tbody.innerHTML = rows.map(c => {
        const status = (c.status || '').toLowerCase();
        const statusClass = status === 'active' ? 'status-active' : 'status-inactive';
        const statusLabel = status === 'active' ? 'Actif' : 'Inactif';
        const actionLabel = status === 'active' ? 'üîí Bloquer' : 'üîì R√©activer';

        return `
          <tr data-email="${c.email || ''}">
            <td class="col-email">
              <div>${c.email || '‚Äî'}</div>
            </td>
            <td class="col-company">
              ${c.company || '‚Äî'}
            </td>
            <td class="col-contact">
              ${c.contact_name || '‚Äî'}
            </td>
            <td class="col-discount">
              <span class="pill-discount">
                <span>${formatDiscount(c.discount_rate)}</span>
              </span>
            </td>
            <td class="col-status">
              <span class="status-pill ${statusClass}">${statusLabel}</span>
            </td>
            <td class="col-date">
              <div>${formatDate(c.created_at)}</div>
            </td>
            <td class="col-date">
              <div>${formatDate(c.last_login_at)}</div>
            </td>
            <td class="col-actions">
              <button class="btn-row btn-row-edit" data-email="${c.email || ''}">
  ‚úè Modifier
</button>
              <button class="btn-row btn-row-secondary btn-row-toggle" data-email="${c.email || ''}">
                ${actionLabel}
              </button>
              <button class="btn-row btn-row-reset" data-email="${c.email || ''}">
                üîÅ Reset MDP
              </button>
            </td>
          </tr>
        `;
      }).join('');
    }
let allClients = [];

    async function loadClients(){
      loader.style.display = 'flex';
      errBox.textContent = '';
      errBox.style.color = '#ffe3e3';
      try{
        const res = await fetch(`${WORKER_BASE}/clients`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json'
          }
        });
        if (!res.ok){
          throw new Error('HTTP ' + res.status);
        }
        const data = await res.json();
        if (!data.ok){
          throw new Error('R√©ponse invalide du Worker');
        }

        allClients = data.clients || [];
        loader.style.display = 'none';
        renderTable('');
      }catch(e){
        console.error('Erreur chargement clients :', e);
        loader.style.display = 'none';
        errBox.style.color = '#ffe3e3';
        errBox.textContent = "Impossible de r√©cup√©rer la liste des clients. V√©rifiez le Worker ou r√©essayez plus tard.";
      }
    }
/* ---------- HELPERS ---------- */
function formatDate(i){
  if(!i) return "‚Äî";
  const d = new Date(i);
  return d.toLocaleDateString("fr-FR")+" "+d.toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"});
}
function formatDiscount(r){
  return Math.round((r||0)*1000)/10+" %";
}

    async function updateClient(email, payload){
      const res = await fetch(`${WORKER_BASE}/client-update`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          email,
          ...payload
        })
      });
      if (!res.ok){
        throw new Error('HTTP ' + res.status);
      }
      const data = await res.json();
      if (!data.ok){
        throw new Error('R√©ponse Worker non ok');
      }
      return data;
    }
/* ---------- RENDER TABLE ---------- */
function renderTable(filter=""){
  const f = filter.toLowerCase();
  const rows = allClients.filter(c =>
    c.email?.toLowerCase().includes(f) ||
    c.company?.toLowerCase().includes(f) ||
    c.contact_name?.toLowerCase().includes(f)
  );

  infoCount.textContent = rows.length+" client(s)";

  tbody.innerHTML = rows.length
    ? rows.map(c => `
      <tr data-email="${c.email}">
        <td>${c.email}</td>
        <td>${c.company || "‚Äî"}</td>
        <td>${c.contact_name || "‚Äî"}</td>
        <td>${formatDiscount(c.discount_rate)}</td>
        <td>${c.status}</td>
        <td>${formatDate(c.created_at)}</td>
        <td>${formatDate(c.last_login_at)}</td>
        <td>
          <button class="btn-row btn-edit" data-email="${c.email}">‚úè Modifier</button>
          <button class="btn-row btn-row-secondary btn-toggle" data-email="${c.email}">
            ${c.status==="active"?"üîí Bloquer":"üîì R√©activer"}
          </button>
          <button class="btn-row btn-row-reset btn-reset" data-email="${c.email}">
            üîÅ Reset MDP
          </button>
        </td>
      </tr>
    `).join("")
    : `<tr><td colspan="8" class="empty">Aucun client</td></tr>`;
}

    async function resetClientPassword(email){
      const res = await fetch(`${WORKER_BASE}/client-reset-password`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ email })
      });
      if (!res.ok){
        throw new Error('HTTP ' + res.status);
      }
      const data = await res.json();
      if (!data.ok){
        throw new Error('R√©ponse Worker non ok');
      }
      return data;
    }
/* ---------- LOAD CLIENTS ---------- */
async function loadClients(){
  const res = await fetch(`${WORKER_BASE}/clients`);
  const data = await res.json();
  allClients = data.clients || [];
  renderTable("");
}
loadClients();

    searchInput.addEventListener('input', () => {
      renderTable(searchInput.value);
    });
/* ---------- SEARCH ---------- */
searchInput.addEventListener("input", e => renderTable(e.target.value));

    btnBack.addEventListener('click', () => {
      const parts = location.pathname.split('/').filter(Boolean);
      const project = parts.length ? parts[0] : '';
      location.href = `/${project}/index.html`;
    });
/* ---------- EXPORT XLS ---------- */
document.getElementById("btnExport").onclick = () => {
  window.open(`${WORKER_BASE}/clients-export-xls`);
};

    // ‚¨á Export Excel : on ouvre directement la route du Worker
    btnExport.addEventListener('click', () => {
      window.open(`${WORKER_BASE}/clients-export-xls`, '_blank');
    });
/* ---------- BACK ---------- */
document.getElementById("btnBack").onclick = () => history.back();

    tbody.addEventListener('click', async (e) => {
      const editBtn = e.target.closest('.btn-row-edit');
      if (editBtn) {
  const email = editBtn.getAttribute('data-email');
  const c = allClients.find(cl => cl.email === email);
  if (!c) return;

  // Pr√©-remplissage de la modale
  document.getElementById('editEmail').value = c.email;
  document.getElementById('editNewEmail').value = c.email;
  document.getElementById('editCompany').value = c.company || "";
  document.getElementById('editContact').value = c.contact_name || "";
  document.getElementById('editDiscount').value =
    Math.round((c.discount_rate || 0) * 100);
  document.getElementById('editStatus').value = c.status || "active";

  // Affiche la modale
  document.getElementById('modalEdit').style.display = 'flex';
  return;
}
/* ---------- NEW CLIENT MODAL ---------- */
const modalNew = document.getElementById("modalNew");
document.getElementById("btnNewClient").onclick = ()=> modalNew.style.display="flex";
document.getElementById("btnCloseModal").onclick = ()=> modalNew.style.display="none";

      const toggleBtn = e.target.closest('.btn-row-toggle');
      const resetBtn = e.target.closest('.btn-row-reset');

      // ‚úè Modifier la remise
      if (editBtn) {
        const email = editBtn.getAttribute('data-email');
        if (!email) return;
document.getElementById("btnCreateClient").onclick = async ()=> {
  const email = newEmail.value.trim();
  const company = newCompany.value.trim();
  const contact = newContact.value.trim();
  const discount = Number(newDiscount.value||0);
  const status = newStatus.value;

        const client = allClients.find(c => c.email === email);
        if (!client) return;
  if(!email){ modalMsg.textContent="Email obligatoire"; return; }

        const currentPct = Math.round(Number(client.discount_rate || 0) * 1000) / 10;
  const res = await fetch(`${WORKER_BASE}/client-create`,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({email,company,contact,discount,status})
  });
  const data = await res.json();

        const input = prompt(
          `Nouvelle remise pour ${client.company || client.email} (en %) :`,
          currentPct.toString().replace('.', ',')
        );
        if (input === null) return;

        const parsed = parseFloat(String(input).replace(',', '.'));
        if (isNaN(parsed) || parsed < 0 || parsed > 90){
          alert("Merci d'entrer une remise entre 0 et 90 %.");
          return;
        }

        const newRate = parsed / 100;

        try{
          errBox.textContent = '';
          errBox.style.color = '#ffe3e3';
          const result = await updateClient(email, { discountRate: newRate });

          client.discount_rate = result.discountRate;
          client.status = result.status || client.status;
          renderTable(searchInput.value);

          errBox.style.color = '#b7ffcf';
          errBox.textContent = "Remise mise √† jour avec succ√®s.";
        }catch(err){
          console.error('Erreur update remise :', err);
          errBox.style.color = '#ffe3e3';
          errBox.textContent = "Erreur lors de la mise √† jour de la remise.";
        }

        return;
      }

      // üîí Bloquer / üîì R√©activer
      if (toggleBtn) {
        const email = toggleBtn.getAttribute('data-email');
        if (!email) return;

        const client = allClients.find(c => c.email === email);
        if (!client) return;

        const currentStatus = (client.status || 'active').toLowerCase();
        const nextStatus = currentStatus === 'active' ? 'inactive' : 'active';

        const message = nextStatus === 'inactive'
          ? `Voulez-vous vraiment bloquer l'acc√®s pour ${client.company || client.email} ?`
          : `Voulez-vous r√©activer l'acc√®s pour ${client.company || client.email} ?`;

        if (!confirm(message)) return;

        try{
          errBox.textContent = '';
          errBox.style.color = '#ffe3e3';

          const result = await updateClient(email, { status: nextStatus });

          client.status = result.status || nextStatus;
          if (typeof result.discountRate === 'number') {
            client.discount_rate = result.discountRate;
          }

          renderTable(searchInput.value);

          errBox.style.color = '#b7ffcf';
          errBox.textContent = nextStatus === 'inactive'
            ? "Client bloqu√© avec succ√®s."
            : "Client r√©activ√© avec succ√®s.";
        }catch(err){
          console.error('Erreur update statut :', err);
          errBox.style.color = '#ffe3e3';
          errBox.textContent = "Erreur lors de la mise √† jour du statut.";
        }

        return;
      }

      // üîÅ Reset MDP
      if (resetBtn) {
        const email = resetBtn.getAttribute('data-email');
        if (!email) return;

        const client = allClients.find(c => c.email === email);
        if (!client) return;

        const ok = confirm(
          `R√©initialiser le mot de passe pour ${client.company || client.email} ?\n\n` +
          `Un nouveau mot de passe sera g√©n√©r√© et remplacera l'ancien.`
        );
        if (!ok) return;

        try {
          errBox.textContent = '';
          errBox.style.color = '#ffe3e3';

          const { password } = await resetClientPassword(email);

          errBox.style.color = '#b7ffcf';
          errBox.textContent =
            `Nouveau mot de passe pour ${email} : ${password} (copiez-le tout de suite, il ne sera plus affich√©).`;

          alert(
            `Nouveau mot de passe pour ${email} :\n\n` +
            `${password}\n\n` +
            `Copiez-le maintenant, il ne sera plus visible ensuite.`
          );
        } catch (err) {
          console.error('Erreur reset MDP :', err);
          errBox.style.color = '#ffe3e3';
          errBox.textContent = "Erreur lors de la r√©initialisation du mot de passe.";
        }
      }
    });
  if(!data.ok){ modalMsg.textContent="Erreur"; return; }

    // Chargement initial
    // ========== MODAL NOUVEAU CLIENT ==========
  alert("Mot de passe pour "+email+" :\n"+data.password);

const modal = document.getElementById('modalNew');
const modalMsg = document.getElementById('modalMsg');
  modalNew.style.display="none";
  loadClients();
};

document.getElementById('btnNewClient').addEventListener('click', () => {
  modal.style.display = 'flex';
  modalMsg.textContent = '';
});
/* ---------- EDIT CLIENT MODAL ---------- */
const modalEdit = document.getElementById("modalEdit");
document.getElementById("editCancel").onclick = ()=> modalEdit.style.display="none";

document.getElementById('btnCloseModal').addEventListener('click', () => {
  modal.style.display = 'none';
});
tbody.onclick = async (e)=>{
  const email = e.target.getAttribute("data-email");
  if(!email) return;

// Cr√©er client
document.getElementById('btnCreateClient').addEventListener('click', async () => {
  const email = document.getElementById('newEmail').value.trim();
  const company = document.getElementById('newCompany').value.trim();
  const contact = document.getElementById('newContact').value.trim();
  const discount = Number(document.getElementById('newDiscount').value);
  const status = document.getElementById('newStatus').value;
  const client = allClients.find(c=>c.email===email);

  modalMsg.style.color = "#ffe3e3";
  modalMsg.textContent = "";
  /* EDIT */
  if(e.target.classList.contains("btn-edit")){
    editEmail.value = client.email;
    editNewEmail.value = client.email;
    editCompany.value = client.company || "";
    editContact.value = client.contact_name || "";
    editDiscount.value = Math.round((client.discount_rate||0)*100);
    editStatus.value = client.status;

  if (!email) {
    modalMsg.textContent = "Email obligatoire.";
    modalEdit.style.display="flex";
    return;
  }

  try {
    const res = await fetch(`${WORKER_BASE}/client-create`, {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ email, company, contact, discount, status })
    });

    const data = await res.json();

    if (!res.ok || !data.ok) {
      modalMsg.textContent = "Erreur : " + (data || "inconnue");
      return;
    }

    modalMsg.style.color = "#b7ffcf";
    modalMsg.textContent = "Client cr√©√©. Mot de passe : " + data.password;
  /* TOGGLE */
  if(e.target.classList.contains("btn-toggle")){
    const next = client.status==="active"?"inactive":"active";

    alert("Mot de passe pour " + email + " :\n\n" + data.password);
    if(!confirm(`Confirmer : passer ${client.email} en ${next} ?`)) return;

    // recharge la table
    await loadClients();

  } catch (err) {
    modalMsg.style.color = "#ffe3e3";
    modalMsg.textContent = "Erreur de r√©seau.";
  }
});
// Bouton Annuler de la modale
document.getElementById('editCancel').addEventListener('click', () => {
  document.getElementById('modalEdit').style.display = 'none';
});
// Bouton Enregistrer de la modale
document.getElementById('editSave').addEventListener('click', async () => {
  const email = document.getElementById('editEmail').value.trim().toLowerCase();
  const newEmail = document.getElementById('editNewEmail').value.trim().toLowerCase();
  const company = document.getElementById('editCompany').value.trim();
  const contact = document.getElementById('editContact').value.trim();
  const discount = Number(document.getElementById('editDiscount').value);
  const status = document.getElementById('editStatus').value;
try {
    const res = await fetch(`${WORKER_BASE}/client-edit`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        email,
        newEmail,
        company,
        contact,
        discount,
        status
      })
    await fetch(`${WORKER_BASE}/client-update`,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({ email, status:next })
    });

    if (!res.ok) throw new Error(await res.text());

    // Fermer la modale
    document.getElementById('modalEdit').style.display = 'none';

    alert("Client mis √† jour avec succ√®s !");
    
    // Recharge le tableau pour voir les modifications
    loadClients();

  } catch (err) {
    alert("Erreur mise √† jour client : " + err.message);
    return;
  }
});

    loadClients();
    
  </script>
  <!-- MODALE EDIT CLIENT -->
<div id="modalEdit" style="
  position:fixed; inset:0; background:rgba(0,0,0,.55);
  display:none; align-items:center; justify-content:center; z-index:9999;
">
  <div style="
    background:#fff; color:#111; padding:20px; border-radius:14px;
    width:90%; max-width:420px; box-shadow:0 10px 30px rgba(0,0,0,.4);
  ">
    <h2 style="margin-top:0; font-size:20px;">Modifier le client</h2>

    <label>Email</label>
    <input id="editEmail" type="text" style="width:100%; padding:8px; margin-bottom:10px;">

    <label>Nouvel email</label>
    <input id="editNewEmail" type="text" style="width:100%; padding:8px; margin-bottom:10px;">

    <label>Soci√©t√©</label>
    <input id="editCompany" type="text" style="width:100%; padding:8px; margin-bottom:10px;">

    <label>Nom du contact</label>
    <input id="editContact" type="text" style="width:100%; padding:8px; margin-bottom:10px;">

    <label>Remise (%)</label>
    <input id="editDiscount" type="number" min="0" max="90" style="width:100%; padding:8px; margin-bottom:10px;">

    <label>Statut</label>
    <select id="editStatus" style="width:100%; padding:8px; margin-bottom:15px;">
      <option value="active">Actif</option>
      <option value="inactive">Inactif</option>
    </select>
  /* RESET PASSWORD */
  if(e.target.classList.contains("btn-reset")){
    if(!confirm(`Reset mot de passe pour ${email} ?`)) return;

    <div style="display:flex; gap:10px; justify-content:flex-end;">
      <button id="editCancel" style="padding:8px 14px;">Annuler</button>
      <button id="editSave" style="padding:8px 14px; background:#5a2d82; color:#fff; border-radius:8px;">
        Enregistrer
      </button>
    </div>
  </div>
</div>
    const res = await fetch(`${WORKER_BASE}/client-reset-password`,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({ email })
    });
    const data = await res.json();
    alert("Nouveau MDP : "+data.password);
    return;
  }
};

/* SAVE EDIT */
document.getElementById("editSave").onclick = async ()=>{
  const payload = {
    email: editEmail.value.trim(),
    newEmail: editNewEmail.value.trim(),
    company: editCompany.value.trim(),
    contact: editContact.value.trim(),
    discount: Number(editDiscount.value),
    status: editStatus.value
  };

  const res = await fetch(`${WORKER_BASE}/client-edit`,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify(payload)
  });

  if(res.ok){
    alert("Client mis √† jour !");
    modalEdit.style.display="none";
    loadClients();
  } else {
    alert("Erreur lors de la mise √† jour.");
  }
};
</script>
</body>
</html>
