<!-- /auth/admin-clients.html -->
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Administration clients ‚Äî Cofel</title>

  <!-- üîí Protection identique au portail interne -->
  <script src="./lock.js" type="module"></script>

  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <style>
    :root{
      --cofel:#5a2d82; --cofel-2:#7838a7;
      --glass: rgba(255,255,255,.12);
      --glass-soft: rgba(255,255,255,.06);
      --txt:#f5f7ff; --txt-dim:#dcd6ff; --accent:#c9b7ff;
      --radius:18px; --blur:18px; --shadow:0 10px 30px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box;}
    html,body{height:100%;}
    body{
      margin:0; color:var(--txt);
      font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","Segoe UI",Roboto,Arial,sans-serif;
      background:
        radial-gradient(800px 500px at 20% -10%, rgba(255,255,255,.10), transparent 60%),
        radial-gradient(800px 500px at 110% 10%, rgba(255,255,255,.08), transparent 60%),
        linear-gradient(135deg, var(--cofel), var(--cofel-2));
      padding:20px;
    }

    .shell{ max-width:1200px; margin:0 auto; }
    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:18px;
      flex-wrap:wrap;
    }
    .brand{display:flex; align-items:center; gap:12px;}
    .brand img{height:40px; border-radius:10px;}
    h1{margin:0; font-size:22px;}
    .btn{
      appearance:none; border:none; cursor:pointer;
      background:#fff; color:#1a102b;
      padding:8px 14px; border-radius:999px;
      font-weight:700; font-size:13px;
      box-shadow:0 10px 24px rgba(0,0,0,.25);
    }

    .tabs{ display:flex; gap:10px; margin-bottom:18px; }
    .tab-btn{
      padding:8px 16px; cursor:pointer;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.35);
      background:rgba(0,0,0,.25); color:#fff;
      font-size:13px; font-weight:600;
    }
    .tab-btn.active{ background:#fff; color:#1a102b; }
    .tab-panel{ display:none; }
    .tab-panel.active{ display:block; }

    .card{
      background:rgba(6,4,18,.85);
      border-radius:var(--radius);
      border:1px solid rgba(255,255,255,.22);
      box-shadow:var(--shadow);
      padding:16px;
      backdrop-filter:blur(var(--blur));
    }

    table{ width:100%; border-collapse:collapse; }
    th, td{ padding:8px 10px; font-size:13px; }
    thead{ background:rgba(0,0,0,.25); }
    th{
      text-transform:uppercase; font-size:11px;
      color:var(--accent);
      border-bottom:1px solid rgba(255,255,255,.22);
    }
    .btn-row{
      padding:4px 8px; cursor:pointer; border-radius:8px;
      font-size:11px; margin:2px;
      border:none;
    }
    .btn-approve{ background:#4caf50; color:#fff; font-weight:700; }
    .btn-row-secondary{ background:#555; color:#fff; }
    .btn-row-reset{ background:#ffca28; color:#000; font-weight:600; }
    .btn-row-delete{ background:#c62828; color:white; }

    .empty{ text-align:center; padding:12px; color:var(--txt-dim); }

    /* MODALE APPROBATION */
    #modalApprove{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.6);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:20;
    }
    .modal-card{
      width:100%; max-width:420px;
      background:rgba(25,15,45,.95);
      border-radius:16px; padding:18px;
      border:1px solid rgba(255,255,255,.22);
      box-shadow:0 12px 40px rgba(0,0,0,.45);
    }
    .modal-card h3{ margin-top:0; font-size:17px; }
    .modal-field{ margin-bottom:12px; }
    .modal-field label{ font-size:12px; color:var(--txt-dim); }
    .modal-field input,
    .modal-field select{
      width:100%; padding:8px; font-size:14px;
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.25);
      border-radius:8px; color:#fff;
    }

    .modal-actions{ text-align:right; margin-top:16px; }
    .btn-modal{
      padding:8px 14px; border:none; cursor:pointer;
      border-radius:999px; font-size:13px; font-weight:700;
    }
    .btn-cancel{ background:rgba(255,255,255,.08); color:#fff; }
    .btn-ok{ background:#fff; color:#1a102b; }
  </style>
</head>

<body>
<div class="shell">

  <header>
    <div class="brand">
      <img src="../assets/logo cofel.jpg">
      <h1>Administration des comptes clients</h1>
    </div>

    <div class="actions">
      <button id="btnBack" class="btn">‚¨Ö Retour</button>
    </div>
  </header>

  <!-- TABS -->
  <div class="tabs">
    <button class="tab-btn active" data-tab="clients">Clients</button>
    <button class="tab-btn" data-tab="requests">Demandes d‚Äôacc√®s</button>
  </div>

  <!-- PANNEAU : CLIENTS -->
  <div id="clients" class="tab-panel active">
    <div class="card">
      <table>
        <thead>
          <tr>
            <th>Email</th>
            <th>Soci√©t√©</th>
            <th>Contact</th>
            <th>Remise</th>
            <th>Configs</th>
            <th>Statut</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="tbodyClients">
          <tr><td colspan="7" class="empty">Chargement‚Ä¶</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- PANNEAU : DEMANDES -->
  <div id="requests" class="tab-panel">
    <div class="card">
      <table>
        <thead>
          <tr>
            <th>Soci√©t√©</th>
            <th>Nom</th>
            <th>Email</th>
            <th>T√©l√©phone</th>
            <th>Message</th>
            <th>Cr√©√©</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="reqTbody">
          <tr><td colspan="7" class="empty">Chargement‚Ä¶</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- MODALE APPROBATION -->
  <div id="modalApprove">
    <div class="modal-card">
      <h3>Approuver l‚Äôacc√®s</h3>

      <div class="modal-field">
        <label>Remise (%)</label>
        <input id="approveDiscount" type="number" min="0" max="90" value="0">
      </div>

      <div class="modal-field" style="display:none;">
  <label>Configurateurs autoris√©s</label>
  <select id="approveConfigs" multiple size="8">
    <option value="enseigne-drapeau">Enseigne drapeau</option>
    <option value="lettre-alu-alupvc">Lettre alu / alu-PVC</option>
    <option value="lettre-boitier">Lettre bo√Ætier</option>
    <option value="lettres-pvc">Lettres PVC</option>
    <option value="rampe-lumineuse">Rampe lumineuse (PLL)</option>
    <option value="tole-tablette">T√¥le tablette</option>
    <option value="tolerie-dibond">T√¥lerie / Dibond</option>
    <option value="totems">Totems</option>
  </select>
</div>
      <div class="modal-actions">
        <button class="btn-modal btn-cancel" id="approveCancel">Annuler</button>
        <button class="btn-modal btn-ok" id="approveSave">Approuver</button>
      </div>

      <div id="approveMsg"></div>
    </div>
  </div>
<script>
const WORKER_BASE = "https://cofel-auth.sonveven.workers.dev";

/* =====================  NAVIGATION TABS ===================== */
const tabButtons = document.querySelectorAll(".tab-btn");
const tabPanels  = document.querySelectorAll(".tab-panel");

tabButtons.forEach(btn => {
  btn.addEventListener("click", () => {
    tabButtons.forEach(b => b.classList.remove("active"));
    btn.classList.add("active");

    const target = btn.getAttribute("data-tab");

    tabPanels.forEach(p => {
      p.classList.remove("active");
      if (p.id === target) p.classList.add("active");
    });
  });
});

/* =====================  TABLEAU CLIENTS ===================== */
const tbodyClients = document.getElementById("tbodyClients");

function formatRate(rate){
  return ((rate || 0) * 100).toFixed(1) + " %";
}

function formatDate(iso){
  if(!iso) return "‚Äî";
  const d = new Date(iso);
  if(isNaN(d)) return "‚Äî";
  return d.toLocaleDateString("fr-FR") + " " + d.toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"});
}

async function loadClients(){
  tbodyClients.innerHTML = `<tr><td colspan="7" class="empty">Chargement‚Ä¶</td></tr>`;
  try{
    const r = await fetch(`${WORKER_BASE}/clients`);
    const data = await r.json();

    if(!data.clients || !data.clients.length){
      tbodyClients.innerHTML = `<tr><td colspan="7" class="empty">Aucun client.</td></tr>`;
      return;
    }

    tbodyClients.innerHTML = data.clients.map(c => {
      const status = c.status === "active" ? "üü¢ Actif" : "üî¥ Inactif";
      const configs = JSON.parse(c.allowed_configurators || "[]");

      return `
        <tr>
          <td>${c.email}</td>
          <td>${c.company || "‚Äî"}</td>
          <td>${c.contact_name || "‚Äî"}</td>
          <td>${formatRate(c.discount_rate)}</td>
          <td>${configs.join(", ") || "‚Äî"}</td>
          <td>${status}</td>
          <td>
            <button class="btn-row btn-row-secondary btn-edit" data-email="${c.email}">‚úè Modifier</button>
            <button class="btn-row btn-row-reset btn-reset" data-email="${c.email}">üîÅ Reset MDP</button>
            <button class="btn-row btn-row-delete btn-delete" data-email="${c.email}">üóë Supprimer</button>
          </td>
        </tr>
      `;
    }).join("");

  } catch(err){
    tbodyClients.innerHTML = `<tr><td colspan="7" class="empty">Erreur de chargement.</td></tr>`;
  }
}

/* =====================  ACTIONS CLIENTS ===================== */

tbodyClients.addEventListener("click", async e => {
  const email = e.target.dataset.email;
  if (!email) return;

  /* --- Reset mot de passe --- */
  if (e.target.classList.contains("btn-reset")){
    if (!confirm("R√©initialiser le mot de passe ?")) return;

    const r = await fetch(`${WORKER_BASE}/client-reset-password`, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ email })
    });

    const out = await r.json();
    alert("Nouveau mot de passe : " + out.password);
    return;
  }

  /* --- Supprimer client --- */
  if (e.target.classList.contains("btn-delete")){
    if (!confirm("Supprimer ce client ?")) return;

    await fetch(`${WORKER_BASE}/client-delete`, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ email })
    });

    alert("Client supprim√©.");
    loadClients();
    return;
  }

  /* --- Modifier (ouvre popup s√©par√©e) --- */
  if (e.target.classList.contains("btn-edit")){
    window.open(
      `./edit-client.html?email=${encodeURIComponent(email)}`,
      "_blank",
      "width=520,height=720,top=100,left=100"
    );
    return;
  }
});

/* =====================  TABLEAU DES DEMANDES ===================== */
const reqTbody = document.getElementById("reqTbody");
let approvalTargetId = null;

async function loadRequests(){
  reqTbody.innerHTML = `<tr><td colspan="7" class="empty">Chargement‚Ä¶</td></tr>`;
  
  try{
    const r = await fetch(`${WORKER_BASE}/pending-requests`);
    const data = await r.json();

    if(!data.requests || !data.requests.length){
      reqTbody.innerHTML = `<tr><td colspan="7" class="empty">Aucune demande en attente.</td></tr>`;
      return;
    }

    reqTbody.innerHTML = data.requests.map(r => `
      <tr>
        <td>${r.company}</td>
        <td>${r.name}</td>
        <td>${r.email}</td>
        <td>${r.phone || "‚Äî"}</td>
        <td>${r.message || "‚Äî"}</td>
        <td>${formatDate(r.created_at)}</td>
        <td>
          <button class="btn-row btn-approve" data-id="${r.id}">‚úî Approuver</button>
          <button class="btn-row btn-row-secondary btn-reject" data-id="${r.id}">‚ùå Refuser</button>
        </td>
      </tr>
    `).join("");

  }catch(err){
    reqTbody.innerHTML = `<tr><td colspan="7" class="empty">Erreur de chargement.</td></tr>`;
  }
}

/* =====================  ACTIONS DEMANDES ===================== */

reqTbody.addEventListener("click", async e => {

  const id = e.target.dataset.id;
  if (!id) return;

  /* --- Refuser --- */
  if (e.target.classList.contains("btn-reject")){
    if (!confirm("Refuser cette demande ?")) return;

    await fetch(`${WORKER_BASE}/access-request-reject`, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ id })
    });

    alert("Demande refus√©e.");
    loadRequests();
    return;
  }

  /* --- Approuver (ouvre modale) --- */
  if (e.target.classList.contains("btn-approve")){
    approvalTargetId = id;
    document.getElementById("modalApprove").style.display = "flex";
  }
});

/* =====================  BOUTON RETOUR ===================== */
document.getElementById("btnBack").onclick = () => {
  location.href = "../index.html";
};

/* =====================  CHARGEMENT INITIAL ===================== */
loadClients();
loadRequests();
/* =====================  APPROBATION ‚Äî MODALE (simplifi√©e) ===================== */

const modalApprove = document.getElementById("modalApprove");
const approveDiscount = document.getElementById("approveDiscount");
const approveMsg = document.getElementById("approveMsg");

// Acc√®s toujours global : tous les configurateurs
const ALL_CONFIGS = [
  "enseigne-drapeau",
  "lettre-alu-alupvc",
  "lettre-boitier",
  "lettres-pvc",
  "rampe-lumineuse",
  "tole-tablette",
  "tolerie-dibond",
  "totems"
];

document.getElementById("approveCancel").onclick = () => {
  modalApprove.style.display = "none";
  approveMsg.textContent = "";
};

/* --- VALIDATION --- */
document.getElementById("approveSave").onclick = async () => {

  if (!approvalTargetId){
    alert("Erreur : aucun ID de demande.");
    return;
  }

  approveMsg.textContent = "";
  approveMsg.style.color = "#ffb3b3";

  // 1) Remise
  const discount = Number(approveDiscount.value || 0);
  if (isNaN(discount) || discount < 0 || discount > 90){
    approveMsg.textContent = "Remise invalide (0 √† 90 %).";
    return;
  }

  // 2) Appel Worker pour approuver
  let out;
  try{
    const res = await fetch(`${WORKER_BASE}/admin-approve`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        requestId: approvalTargetId,
        discount: discount,
        configs: ALL_CONFIGS      // acc√®s global
      })
    });

    // Si le Worker r√©pond erreur texte, on essaie de lire proprement
    const text = await res.text();
    try {
      out = JSON.parse(text);
    } catch {
      throw new Error("R√©ponse non valide du Worker : " + text);
    }

    if (!out.ok){
      throw new Error("Le Worker a renvoy√© ok=false.");
    }

  } catch(err){
    console.error("Erreur Worker /admin-approve :", err);
    approveMsg.textContent = "Erreur avec le serveur (approbation).";
    return;
  }

  // 3) Envoi du mot de passe via Apps Script (on n‚Äôarr√™te pas si √ßa plante)
  try{
    await fetch(
      "https://script.google.com/macros/s/AKfycbyWE3JduQ5Cz0EEIZwJi7ob_WW9YySFSrgsLDVdKAzV3Olo6Ljo0ByRyl1xs6Ez5CkB8w/exec",
      {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          type: "password_notification",
          email: out.email,
          password: out.password
        })
      }
    );
  } catch(errMail){
    console.error("Erreur lors de l'envoi de l'email (Apps Script) :", errMail);
    // On NE bloque PAS l'approbation pour autant
  }

  // 4) Succ√®s c√¥t√© interface
  approveMsg.style.color = "#b7ffcf";
  approveMsg.textContent = "Acc√®s approuv√©.";
  alert("Acc√®s approuv√©. Le mot de passe a √©t√© envoy√© (ou sera envoy√©).");

  modalApprove.style.display = "none";
  loadRequests();
  loadClients();
};


</script>
</body>
</html>

