<!-- /auth/admin-clients.html -->
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Administration clients ‚Äî Cofel</title>

  <!-- üîí Protection interne -->
  <script src="./lock.js" type="module"></script>

  <style>
    :root{
      --cofel:#5a2d82; --cofel-2:#7838a7;
      --glass: rgba(255,255,255,.12);
      --glass-soft: rgba(255,255,255,.06);
      --txt:#f5f7ff; --txt-dim:#dcd6ff; --accent:#c9b7ff;
      --radius:18px; --blur:18px; --shadow:0 10px 30px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box;}
    html,body{height:100%;}
    body{
      margin:0; color:var(--txt);
      font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","Segoe UI",Roboto,Arial,sans-serif;
      background:
        radial-gradient(800px 500px at 20% -10%, rgba(255,255,255,.10), transparent 60%),
        radial-gradient(800px 500px at 110% 10%, rgba(255,255,255,.08), transparent 60%),
        linear-gradient(135deg, var(--cofel), var(--cofel-2));
      padding:20px;
    }

    .shell{max-width:1200px;margin:0 auto;}

    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      flex-wrap:wrap;
      margin-bottom:18px;
    }

    .brand{display:flex;align-items:center;gap:12px;}
    .brand img{height:40px;border-radius:10px;}

    h1{margin:0;font-size:22px;}
    .tagline{font-size:13px;color:var(--txt-dim);margin-top:4px;}

    .header-actions{display:flex;gap:8px;flex-wrap:wrap;}

    .btn{
      appearance:none;border:none;cursor:pointer;
      font-weight:700;font-size:13px;
      background:#fff;color:#0b0b0b;
      border-radius:999px;padding:8px 14px;
      box-shadow:0 10px 24px rgba(0,0,0,.25);
      white-space:nowrap;
    }

    /* TABLE */
    .card{
      background: linear-gradient(180deg, var(--glass), var(--glass-soft));
      border-radius:var(--radius);
      border:1px solid rgba(255,255,255,.22);
      box-shadow:var(--shadow);
      padding:16px;
      backdrop-filter:blur(var(--blur));
    }

    table{width:100%;border-collapse:collapse;font-size:13px;}
    th, td{padding:8px 10px;text-align:left;}
    thead th{
      background:rgba(0,0,0,.25);
      position:sticky;top:0;z-index:1;
      color:var(--accent);text-transform:uppercase;
      letter-spacing:.05em;font-size:11px;
    }
    tbody tr:nth-child(even){background:rgba(255,255,255,.06);}
    tbody tr:hover{background:rgba(255,255,255,.1);}
    .empty{text-align:center;padding:20px;color:var(--txt-dim);}

    .btn-row{
      padding:4px 8px;font-size:11px;border-radius:999px;
      cursor:pointer;border:1px solid rgba(0,0,0,.2);
      background:#fff;color:#111;margin-right:4px;
    }
    .btn-row-secondary{
      background:transparent;color:var(--txt);
      border-color:rgba(255,255,255,.4);
    }
    .btn-row-reset{
      background:transparent;color:#ffe9b5;
      border:1px solid rgba(255,202,116,.7);
    }

    #modalNew, #modalEdit{
  position:fixed;inset:0;background:rgba(0,0,0,.55);
  display:none;align-items:center;justify-content:center;
  backdrop-filter:blur(4px);z-index:2000;
}
.modal-box{
  background:#1c1530;border-radius:16px;
  width:420px;max-width:90vw;
  padding:22px;
  border:1px solid rgba(255,255,255,.25);
  color:var(--txt);
}
.modal-box h3{
  margin:0 0 12px;
  font-size:18px;
}
.modal-box label{
  display:block;
  margin:6px 0 2px;
  font-size:12px;
  color:var(--accent);
}
.modal-box input,
.modal-box select{
  width:100%;
  padding:8px;
  margin-bottom:10px;
  border-radius:8px;
  border:none;
}
#modalMsg{color:#ffe3e3;font-size:13px;margin-top:8px;}

  </style>
</head>

<body>
<div class="shell">

  <!-- HEADER -->
  <header>
    <div class="brand">
      <img src="../assets/logo cofel.jpg">
      <div>
        <h1>Administration des comptes clients</h1>
        <p class="tagline">Cr√©ation, modification, remises, statuts, reset MDP.</p>
      </div>
    </div>
    <div class="header-actions">
      <button id="btnNewClient" class="btn">‚ûï Nouveau client</button>
      <button id="btnExport" class="btn">‚¨á Export Excel</button>
      <button id="btnBack" class="btn">‚¨Ö Retour</button>
    </div>
  </header>

  <!-- TABLE -->
  <section class="card">
    <div>
      <input id="searchInput" type="text" placeholder="Recherche‚Ä¶" 
             style="padding:8px;border-radius:12px;width:240px;border:none;">
      <span id="infoCount" style="margin-left:10px;color:var(--txt-dim);font-size:13px;">Chargement‚Ä¶</span>
    </div>

    <div style="margin-top:10px;overflow:auto;max-height:70vh;">
      <table>
        <thead>
          <tr>
            <th>Email</th>
            <th>Soci√©t√©</th>
            <th>Contact</th>
            <th>Remise</th>
            <th>Statut</th>
            <th>Cr√©√© le</th>
            <th>Derni√®re connexion</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="tbodyClients">
          <tr><td colspan="8" class="empty">Chargement‚Ä¶</td></tr>
        </tbody>
      </table>
    </div>

    <div id="err" style="margin-top:8px;font-size:13px;color:#ffe3e3;"></div>
  </section>

</div>

<!-- MODALE NOUVEAU CLIENT -->
<div id="modalNew">
  <div class="modal-box">
    <h3>Cr√©er un client</h3>

    <input id="newEmail" placeholder="Email">
    <input id="newCompany" placeholder="Soci√©t√©">
    <input id="newContact" placeholder="Contact">
    <input id="newDiscount" type="number" placeholder="Remise (%)" min="0" max="90">
    <select id="newStatus">
      <option value="active">Actif</option>
      <option value="inactive">Inactif</option>
    </select>

    <div style="display:flex;justify-content:space-between;">
      <button id="btnCreateClient" class="btn-row">Cr√©er</button>
      <button id="btnCloseModal" class="btn-row btn-row-secondary">Annuler</button>
    </div>
    <div id="modalMsg"></div>
  </div>
</div>

<!-- MODALE EDIT -->
<div id="modalEdit">
  <div class="modal-box">
    <h3>Modifier le client</h3>

    <label for="editEmail">Email actuel (r√©f√©rence ‚Äì non modifiable)</label>
    <input id="editEmail" type="email" readonly>

    <label for="editNewEmail">Nouvel email (optionnel)</label>
    <input id="editNewEmail" type="email" placeholder="Laisser identique si pas de changement">

    <label for="editCompany">Soci√©t√©</label>
    <input id="editCompany" type="text">

    <label for="editContact">Nom du contact</label>
    <input id="editContact" type="text">

    <label for="editDiscount">Remise (%)</label>
    <input id="editDiscount" type="number" min="0" max="90">

    <label for="editStatus">Statut du compte</label>
    <select id="editStatus">
      <option value="active">Actif</option>
      <option value="inactive">Inactif</option>
    </select>

    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:6px;">
      <button id="editCancel" class="btn-row btn-row-secondary">Annuler</button>
      <button id="editSave" class="btn-row">Enregistrer</button>
    </div>

    <div id="editMsg" style="color:#ffe3e3;font-size:13px;margin-top:8px;"></div>
  </div>
</div>



<script>
const WORKER_BASE = "https://cofel-auth.sonveven.workers.dev";

const tbody = document.getElementById("tbodyClients");
const errBox = document.getElementById("err");
const searchInput = document.getElementById("searchInput");
const infoCount = document.getElementById("infoCount");

let allClients = [];

/* ---------- HELPERS ---------- */
function formatDate(i){
  if(!i) return "‚Äî";
  const d = new Date(i);
  return d.toLocaleDateString("fr-FR")+" "+d.toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"});
}
function formatDiscount(r){
  return Math.round((r||0)*1000)/10+" %";
}

/* ---------- RENDER TABLE ---------- */
function renderTable(filter=""){
  const f = filter.toLowerCase();
  const rows = allClients.filter(c =>
    c.email?.toLowerCase().includes(f) ||
    c.company?.toLowerCase().includes(f) ||
    c.contact_name?.toLowerCase().includes(f)
  );

  infoCount.textContent = rows.length+" client(s)";

  tbody.innerHTML = rows.length
    ? rows.map(c => `
      <tr data-email="${c.email}">
        <td>${c.email}</td>
        <td>${c.company || "‚Äî"}</td>
        <td>${c.contact_name || "‚Äî"}</td>
        <td>${formatDiscount(c.discount_rate)}</td>
        <td>${c.status}</td>
        <td>${formatDate(c.created_at)}</td>
        <td>${formatDate(c.last_login_at)}</td>
        <td>
          <button class="btn-row btn-edit" data-email="${c.email}">‚úè Modifier</button>
          <button class="btn-row btn-row-secondary btn-toggle" data-email="${c.email}">
            ${c.status==="active"?"üîí Bloquer":"üîì R√©activer"}
          </button>
          <button class="btn-row btn-row-reset btn-reset" data-email="${c.email}">
            üîÅ Reset MDP
          </button>
        </td>
      </tr>
    `).join("")
    : `<tr><td colspan="8" class="empty">Aucun client</td></tr>`;
}

/* ---------- LOAD CLIENTS ---------- */
async function loadClients(){
  const res = await fetch(`${WORKER_BASE}/clients`);
  const data = await res.json();
  allClients = data.clients || [];
  renderTable("");
}
loadClients();

/* ---------- SEARCH ---------- */
searchInput.addEventListener("input", e => renderTable(e.target.value));

/* ---------- EXPORT XLS ---------- */
document.getElementById("btnExport").onclick = () => {
  window.open(`${WORKER_BASE}/clients-export-xls`);
};

/* ---------- BACK ---------- */
document.getElementById("btnBack").onclick = () => history.back();

/* ---------- NEW CLIENT MODAL ---------- */
const modalNew = document.getElementById("modalNew");
document.getElementById("btnNewClient").onclick = ()=> modalNew.style.display="flex";
document.getElementById("btnCloseModal").onclick = ()=> modalNew.style.display="none";

document.getElementById("btnCreateClient").onclick = async ()=> {
  const email = newEmail.value.trim();
  const company = newCompany.value.trim();
  const contact = newContact.value.trim();
  const discount = Number(newDiscount.value||0);
  const status = newStatus.value;

  if(!email){ modalMsg.textContent="Email obligatoire"; return; }

  const res = await fetch(`${WORKER_BASE}/client-create`,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({email,company,contact,discount,status})
  });
  const data = await res.json();

  if(!data.ok){ modalMsg.textContent="Erreur"; return; }

  alert("Mot de passe pour "+email+" :\n"+data.password);

  modalNew.style.display="none";
  loadClients();
};

/* ---------- EDIT CLIENT MODAL ---------- */
const modalEdit = document.getElementById("modalEdit");
document.getElementById("editCancel").onclick = ()=> modalEdit.style.display="none";

tbody.onclick = async (e)=>{
  const email = e.target.getAttribute("data-email");
  if(!email) return;

  const client = allClients.find(c=>c.email===email);

  /* EDIT */
  if(e.target.classList.contains("btn-edit")){
    editEmail.value = client.email;
    editNewEmail.value = client.email;
    editCompany.value = client.company || "";
    editContact.value = client.contact_name || "";
    editDiscount.value = Math.round((client.discount_rate||0)*100);
    editStatus.value = client.status;

    modalEdit.style.display="flex";
    return;
  }

  /* TOGGLE */
  if(e.target.classList.contains("btn-toggle")){
    const next = client.status==="active"?"inactive":"active";

    if(!confirm(`Confirmer : passer ${client.email} en ${next} ?`)) return;

    await fetch(`${WORKER_BASE}/client-update`,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({ email, status:next })
    });
    loadClients();
    return;
  }

  /* RESET PASSWORD */
  if(e.target.classList.contains("btn-reset")){
    if(!confirm(`Reset mot de passe pour ${email} ?`)) return;

    const res = await fetch(`${WORKER_BASE}/client-reset-password`,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({ email })
    });
    const data = await res.json();
    alert("Nouveau MDP : "+data.password);
    return;
  }
};

/* SAVE EDIT */
document.getElementById("editSave").onclick = async ()=>{
  const payload = {
    email: editEmail.value.trim(),
    newEmail: editNewEmail.value.trim(),
    company: editCompany.value.trim(),
    contact: editContact.value.trim(),
    discount: Number(editDiscount.value),
    status: editStatus.value
  };

  const res = await fetch(`${WORKER_BASE}/client-edit`,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify(payload)
  });

  if(res.ok){
    alert("Client mis √† jour !");
    modalEdit.style.display="none";
    loadClients();
  } else {
    alert("Erreur lors de la mise √† jour.");
  }
};
</script>
</body>
</html>
