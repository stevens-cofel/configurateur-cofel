<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Administration ‚Äî Clients Cofel</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>

  <style>
    body{
      margin:0;
      background:#120d1f;
      color:#f5f5ff;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
    }
    header{
      padding:16px;
      background:#1e1533;
      border-bottom:1px solid rgba(255,255,255,.15);
    }
    header h1{
      margin:0;
      font-size:22px;
      font-weight:700;
      letter-spacing:.3px;
    }
    .wrap{
      max-width:1200px;
      margin:20px auto;
      padding:0 16px 60px;
    }
    .card{
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.18);
      border-radius:16px;
      padding:18px;
      margin-bottom:26px;
      backdrop-filter:blur(14px);
      box-shadow:0 10px 30px rgba(0,0,0,.35);
    }
    h2{
      margin:0 0 14px;
      font-size:20px;
      font-weight:700;
    }
    table{
      width:100%;
      border-collapse:collapse;
      margin-top:12px;
    }
    th, td{
      padding:10px 12px;
      border-bottom:1px solid rgba(255,255,255,.12);
      font-size:14px;
    }
    th{
      text-align:left;
      color:#c9b7ff;
      font-size:13px;
      letter-spacing:.3px;
    }
    tr:hover td{
      background:rgba(255,255,255,.06);
    }
    button{
      cursor:pointer;
      border:none;
      padding:8px 14px;
      border-radius:10px;
      font-weight:600;
    }
    .btn-valider{
      background:#8cf59b;
      color:#0e2913;
    }
    .btn-refuser{
      background:#f58989;
      color:#2a0b0b;
    }
    .btn-edit{
      background:#ffffff;
      color:#1a1a1a;
    }
  </style>
</head>

<body>
<header>
  <h1>Portail Administrateur ‚Äî Cofel</h1>
</header>

<main class="wrap">

  <!-- ============================================
       DEMANDES D‚ÄôACC√àS EN ATTENTE
       ============================================ -->
  <section class="card" id="pendingRequestsCard" style="display:none;">
    <h2>üîî Demandes d‚Äôacc√®s en attente</h2>
    <p style="color:#ccc; font-size:14px; margin-top:-8px;">
      Validez ou refusez directement depuis cet √©cran.
    </p>

    <table>
      <thead>
        <tr>
          <th>Soci√©t√©</th>
          <th>Nom</th>
          <th>Email</th>
          <th>T√©l√©phone</th>
          <th>Message</th>
          <th>Re√ßue le</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="pendingRequestsBody">
        <tr>
          <td colspan="7" style="padding:12px; text-align:center; color:#bbb;">
            Aucune demande en attente.
          </td>
        </tr>
      </tbody>
    </table>
  </section>

  <!-- ============================================
       LISTE DES CLIENTS
       ============================================ -->
  <section class="card" id="clientList">
    <h2>üë• Clients enregistr√©s</h2>

    <table>
      <thead>
        <tr>
          <th>Email</th>
          <th>Soci√©t√©</th>
          <th>Contact</th>
          <th>Statut</th>
          <th>Remise (%)</th>
          <th>Cr√©√©</th>
          <th>Derni√®re connexion</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="clientListBody">
        <tr>
          <td colspan="8" style="padding:12px; text-align:center; color:#bbb;">
            Chargement‚Ä¶
          </td>
        </tr>
      </tbody>
    </table>
  </section>
  <!-- ============================================
       MODALE ‚Äî VALIDER DEMANDE
       ============================================ -->
  <div id="modalApprove" class="modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.6); backdrop-filter:blur(4px); align-items:center; justify-content:center;">
    <div style="background:#201833; padding:20px; border-radius:14px; width:360px;">
      <h3>Valider l'acc√®s</h3>
      <input type="hidden" id="approveRequestId">

      <label style="display:block; margin-top:10px;">Remise (%)</label>
      <input type="number" id="approveDiscount" min="0" max="90" value="0"
             style="width:100%; padding:8px; border-radius:8px; border:none;">

      <label style="display:block; margin-top:12px;">Configurateurs autoris√©s</label>
      <div id="approveConfigs" style="display:grid; gap:6px; margin-top:6px; font-size:14px;">
        <label><input type="checkbox" value="enseigne-drapeau"> Enseigne drapeau</label>
        <label><input type="checkbox" value="lettre-alu-alupvc"> Lettres Alu / Alu-PVC</label>
        <label><input type="checkbox" value="lettre-boitier"> Lettres bo√Ætiers</label>
        <label><input type="checkbox" value="lettres-pvc"> Lettres PVC</label>
        <label><input type="checkbox" value="pll"> Rampe lumineuse (PLL)</label>
        <label><input type="checkbox" value="tole-tablette" checked> T√¥le Tablette</label>
        <label><input type="checkbox" value="tolerie-dibond"> T√¥lerie Dibond</label>
        <label><input type="checkbox" value="totems"> Totems</label>
      </div>

      <div style="display:flex; gap:8px; margin-top:20px;">
        <button id="btnApproveConfirm" class="btn-valider" style="flex:1;">Valider</button>
        <button onclick="closeModal('modalApprove')" class="btn-refuser" style="flex:1;">Annuler</button>
      </div>
    </div>
  </div>

  <!-- ============================================
       MODALE ‚Äî REFUSER DEMANDE
       ============================================ -->
  <div id="modalReject" class="modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.6); backdrop-filter:blur(4px); align-items:center; justify-content:center;">
    <div style="background:#201833; padding:20px; border-radius:14px; width:330px;">
      <h3>Refuser la demande</h3>
      <input type="hidden" id="rejectRequestId">

      <p style="font-size:14px; color:#ccc;">√ätes-vous s√ªr de vouloir refuser cette demande d'acc√®s ?</p>

      <div style="display:flex; gap:8px; margin-top:20px;">
        <button id="btnRejectConfirm" class="btn-refuser" style="flex:1;">Refuser</button>
        <button onclick="closeModal('modalReject')" class="btn-edit" style="flex:1;">Annuler</button>
      </div>
    </div>
  </div>

</main>

<!-- ============================
     JAVASCRIPT PRINCIPAL
     ============================ -->
<script>
const API = "https://cofel-auth.stevens.workers.dev";  // Ton worker

/* ---------- Utils modales ----------- */
function openModal(id){ document.getElementById(id).style.display="flex"; }
function closeModal(id){ document.getElementById(id).style.display="none"; }

/* ---------- Chargement tableaux ----------- */
async function loadPendingRequests(){
  try{
    const r = await fetch(API + "/pending-requests");
    const data = await r.json();

    const card = document.getElementById("pendingRequestsCard");
    const body = document.getElementById("pendingRequestsBody");

    if(!data.requests || data.requests.length === 0){
      card.style.display = "none";
      body.innerHTML = `
        <tr><td colspan="7" style="text-align:center; padding:12px; color:#888;">Aucune demande en attente.</td></tr>
      `;
      return;
    }

    card.style.display = "block";
    body.innerHTML = data.requests.map(req => `
      <tr>
        <td>${req.company}</td>
        <td>${req.name}</td>
        <td>${req.email}</td>
        <td>${req.phone || "-"}</td>
        <td>${req.message || "-"}</td>
        <td>${new Date(req.created_at).toLocaleDateString("fr-FR")}</td>
        <td>
          <button class="btn-valider" onclick="openApprove('${req.id}')">Valider</button>
          <button class="btn-refuser" onclick="openReject('${req.id}')">Refuser</button>
        </td>
      </tr>
    `).join("");
  }catch(e){
    console.error("Erreur pending:", e);
  }
}

async function loadClients(){
  try{
    const r = await fetch(API + "/clients");
    const data = await r.json();

    const body = document.getElementById("clientListBody");

    body.innerHTML = (data.clients || []).map(c => `
      <tr>
        <td>${c.email}</td>
        <td>${c.company}</td>
        <td>${c.contact_name}</td>
        <td>${c.status}</td>
        <td>${((c.discount_rate||0)*100).toFixed(0)}%</td>
        <td>${c.created_at ? new Date(c.created_at).toLocaleDateString("fr-FR") : "-"}</td>
        <td>${c.last_login_at ? new Date(c.last_login_at).toLocaleDateString("fr-FR") : "-"}</td>
        <td><button class="btn-edit" onclick="alert('Edition client √† venir')">Modifier</button></td>
      </tr>
    `).join("");
  }catch(e){
    console.error("Erreur clients:", e);
  }
}

/* ---------- Actions demandes ----------- */
function openApprove(id){
  document.getElementById("approveRequestId").value = id;
  openModal("modalApprove");
}

function openReject(id){
  document.getElementById("rejectRequestId").value = id;
  openModal("modalReject");
}

document.getElementById("btnApproveConfirm").addEventListener("click", async ()=>{
  const id = document.getElementById("approveRequestId").value;
  const discount = Number(document.getElementById("approveDiscount").value);
  const cfg = [...document.querySelectorAll("#approveConfigs input:checked")].map(i => i.value);

  const r = await fetch(API + "/admin-approve", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({ requestId:id, discount, configs:cfg })
  });

  closeModal("modalApprove");
  await loadPendingRequests();
  await loadClients();
});

document.getElementById("btnRejectConfirm").addEventListener("click", async ()=>{
  const id = document.getElementById("rejectRequestId").value;

  const r = await fetch(API + "/admin-reject", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({ requestId:id })
  });

  closeModal("modalReject");
  await loadPendingRequests();
});

/* ---------- Initial load ----------- */
loadPendingRequests();
loadClients();
</script>

</body>
</html>


