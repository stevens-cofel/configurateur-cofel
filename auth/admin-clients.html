<!-- /auth/admin-clients.html -->
<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Administration clients ‚Äî Cofel</title>

<style>
  body{
    margin:0;
    font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, Arial, sans-serif;
    background:#f4f4fa;
  }

  header{
    background:#5a2d82;
    color:white;
    padding:16px;
    font-size:22px;
    font-weight:700;
  }

  .tabs{
    display:flex;
    background:white;
    border-bottom:1px solid #ddd;
  }
  .tab{
    padding:14px 20px;
    cursor:pointer;
    font-weight:600;
    color:#444;
  }
  .tab.active{
    border-bottom:3px solid #5a2d82;
    color:#5a2d82;
  }

  .page{
    display:none;
    padding:20px;
  }
  .page.active{
    display:block;
  }

  table{
    width:100%;
    border-collapse:collapse;
    background:white;
    border-radius:10px;
    overflow:hidden;
    box-shadow:0 2px 6px rgba(0,0,0,.1);
  }
  th,td{
    padding:12px;
    border-bottom:1px solid #eee;
    font-size:14px;
  }
  th{
    background:#faf7ff;
    font-weight:700;
    color:#5a2d82;
  }

  button{
    cursor:pointer;
  }

  .btn-approve{
    background:#5a2d82;
    color:white;
    border:none;
    padding:6px 12px;
    border-radius:8px;
    font-weight:600;
  }
  .btn-reject{
    background:#999;
    color:white;
    border:none;
    padding:6px 12px;
    border-radius:8px;
    font-weight:600;
  }
  .btn-edit{
    background:#5a2d82;
    color:white;
    border:none;
    padding:4px 10px;
    border-radius:8px;
    font-size:13px;
  }
  .btn-delete{
    background:#b30000;
    color:white;
    border:none;
    padding:4px 10px;
    border-radius:8px;
    font-size:13px;
  }

  /* ---------------- MODALE ------------------- */

  #modalApprove{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,.55);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:20;
  }
  .modal-card{
    width: 380px;
    background:white;
    border-radius:12px;
    padding:20px;
    box-shadow:0 4px 16px rgba(0,0,0,.25);
  }
  .modal-title{
    font-size:18px;
    font-weight:700;
    margin-bottom:12px;
    color:#5a2d82;
  }
  .modal-field{
    margin-bottom:14px;
  }
  .modal-field label{
    font-size:13px;
    font-weight:700;
    color:#444;
  }
  .modal-field input{
    width:100%;
    padding:10px;
    margin-top:6px;
    border:1px solid #ddd;
    border-radius:8px;
  }

  #approveMsg{
    font-size:13px;
    margin-top:6px;
    min-height:20px;
  }

  .modal-buttons{
    display:flex;
    justify-content:flex-end;
    gap:10px;
    margin-top:12px;
  }
  .btn-cancel{
    background:#aaa;
    color:white;
    padding:8px 16px;
    border-radius:8px;
    border:none;
    font-weight:700;
  }
  .btn-save{
    background:#5a2d82;
    color:white;
    padding:8px 16px;
    border-radius:8px;
    border:none;
    font-weight:700;
  }
</style>
</head>

<body>

<header>Administration ‚Äî Cofel</header>

<div class="tabs">
  <div class="tab active" data-tab="requests">Demandes d‚Äôacc√®s</div>
  <div class="tab" data-tab="clients">Clients</div>
</div>

<div id="pageRequests" class="page active">
  <h2>Demandes d‚Äôacc√®s</h2>
  <table>
    <thead>
      <tr>
        <th>Soci√©t√©</th>
        <th>Nom</th>
        <th>Email</th>
        <th>T√©l√©phone</th>
        <th>Message</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="requestsBody"></tbody>
  </table>
</div>

<div id="pageClients" class="page">
  <h2>Clients Cofel</h2>
  <table>
    <thead>
      <tr>
        <th>Email</th>
        <th>Soci√©t√©</th>
        <th>Nom</th>
        <th>Statut</th>
        <th>Remise</th>
        <th>Derni√®re connexion</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="clientsBody"></tbody>
  </table>
</div>

<!-- ======================== MODALE APPROBATION ===================== -->
<div id="modalApprove">
  <div class="modal-card">
    <div class="modal-title">Approuver la demande</div>

    <div class="modal-field">
      <label>Remise (%)</label>
      <input id="approveDiscount" type="number" min="0" max="90" value="0">
    </div>

    <div id="approveMsg"></div>

    <div class="modal-buttons">
      <button class="btn-cancel" id="approveCancel">Annuler</button>
      <button class="btn-save" id="approveSave">Valider</button>
    </div>
  </div>
</div>

<script>
const WORKER_BASE = "https://cofel-auth.sonveven.workers.dev";

/* ----------------- TABS ------------------ */
document.querySelectorAll(".tab").forEach(tab=>{
  tab.onclick = ()=>{
    document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
    document.querySelectorAll(".page").forEach(p=>p.classList.remove("active"));
    tab.classList.add("active");
    document.getElementById("page"+tab.dataset.tab.charAt(0).toUpperCase()+tab.dataset.tab.slice(1)).classList.add("active");
  }
});

/* ================================================================
   CHARGEMENT DES DEMANDES D‚ÄôACC√àS
================================================================ */
async function loadRequests(){
  const body = document.getElementById("requestsBody");
  body.innerHTML = "<tr><td colspan='6'>Chargement...</td></tr>";

  try{
    const r = await fetch(`${WORKER_BASE}/pending-requests`);
    const data = await r.json();

    if (!data.ok){
      body.innerHTML = "<tr><td colspan='6'>Erreur</td></tr>";
      return;
    }

    if (data.requests.length === 0){
      body.innerHTML = "<tr><td colspan='6'>Aucune demande</td></tr>";
      return;
    }

    body.innerHTML = "";
    data.requests.forEach(req=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${req.company}</td>
        <td>${req.name}</td>
        <td>${req.email}</td>
        <td>${req.phone || "-"}</td>
        <td>${req.message || "-"}</td>
        <td>
          <button class="btn-approve" onclick="openApprove('${req.id}')">‚úî Approuver</button>
          <button class="btn-reject" onclick="rejectRequest('${req.id}')">‚úñ Rejeter</button>
        </td>
      `;
      body.appendChild(tr);
    });

  }catch(err){
    body.innerHTML = "<tr><td colspan='6'>Erreur r√©seau</td></tr>";
  }
}

/* ============================================
   REJETER DEMANDE
============================================ */
async function rejectRequest(id){
  if (!confirm("Rejeter cette demande ?")) return;

  await fetch(`${WORKER_BASE}/access-request-reject`, {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ id })
  });

  loadRequests();
}
/* ================================================================
   CHARGEMENT DES CLIENTS COFEL
================================================================ */
async function loadClients(){
  const body = document.getElementById("clientsBody");
  body.innerHTML = "<tr><td colspan='7'>Chargement...</td></tr>";

  try{
    const r = await fetch(`${WORKER_BASE}/clients`);
    const data = await r.json();

    if (!data.ok){
      body.innerHTML = "<tr><td colspan='7'>Erreur</td></tr>";
      return;
    }

    if (data.clients.length === 0){
      body.innerHTML = "<tr><td colspan='7'>Aucun client</td></tr>";
      return;
    }

    body.innerHTML = "";
    data.clients.forEach(c=>{

      const tr = document.createElement("tr");

      const discount = (Number(c.discount_rate || 0) * 100).toFixed(0) + "%";

      tr.innerHTML = `
        <td>${c.email}</td>
        <td>${c.company || "-"}</td>
        <td>${c.contact_name || "-"}</td>
        <td>${c.status}</td>
        <td>${discount}</td>
        <td>${c.last_login_at ? c.last_login_at.replace("T"," ").slice(0,16) : "-"}</td>
        <td>
          <button class="btn-edit" onclick="editClient('${c.email}')">‚úè Modifier</button>
          <button class="btn-delete" onclick="deleteClient('${c.email}')">üóë Supprimer</button>
        </td>
      `;

      body.appendChild(tr);
    });

  }catch(err){
    body.innerHTML = "<tr><td colspan='7'>Erreur r√©seau</td></tr>";
  }
}

/* ================================================================
   MODIFIER CLIENT (redirige vers page d√©di√©e)
================================================================ */
function editClient(email){
  window.location.href = "./edit-client.html?email=" + encodeURIComponent(email);
}

/* ================================================================
   SUPPRIMER CLIENT
================================================================ */
async function deleteClient(email){
  if (!confirm("Supprimer ce client ?")) return;

  await fetch(`${WORKER_BASE}/client-delete`, {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ email })
  });

  loadClients();
}

/* ===================== PREMIER CHARGEMENT ====================== */
loadRequests();
loadClients();


// ================================================================
//   OUVERTURE DE LA MODALE D‚ÄôAPPROBATION
// ================================================================
let approvalTargetId = null;

function openApprove(id){
  approvalTargetId = id;
  approveDiscount.value = 0;
  approveMsg.textContent = "";
  document.getElementById("modalApprove").style.display = "flex";
}
/* ================================================================
   PARTIE C : APPROBATION ‚Äî APPEL DIRECT AU WORKER (Version Finale)
================================================================ */

const ALL_CONFIGS = [
  "enseigne-drapeau",
  "lettre-alu-alupvc",
  "lettre-boitier",
  "lettres-pvc",
  "rampe-lumineuse",
  "tole-tablette",
  "tolerie-dibond",
  "totems"
];

document.getElementById("approveCancel").onclick = () => {
  document.getElementById("modalApprove").style.display = "none";
  approveMsg.textContent = "";
};

/* ----------------------- APPROBATION --------------------------- */
document.getElementById("approveSave").onclick = async () => {

  if (!approvalTargetId){
    alert("Erreur : aucun ID de demande.");
    return;
  }

  approveMsg.textContent = "";
  approveMsg.style.color = "#ffb3b3";

  // 1) Remise
  const discount = Number(approveDiscount.value || 0);
  if (isNaN(discount) || discount < 0 || discount > 90){
    approveMsg.textContent = "Remise invalide (0 √† 90 %).";
    return;
  }

  // 2) Appel au WORKER ‚Äî envoi email automatique dans le Worker
  let out;
  try{
    const res = await fetch(`${WORKER_BASE}/admin-approve`, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({
        requestId: approvalTargetId,
        discount: discount,
        configs: ALL_CONFIGS   // acc√®s global pour tous
      })
    });

    const text = await res.text();

    try{ out = JSON.parse(text); }
    catch{
      console.error("R√©ponse invalide du Worker:", text);
      approveMsg.textContent = "R√©ponse invalide du serveur.";
      return;
    }

    if (!out.ok){
      approveMsg.textContent = "Le serveur a renvoy√© une erreur.";
      return;
    }

  }catch(err){
    console.error("Erreur r√©seau Worker:", err);
    approveMsg.textContent = "Erreur r√©seau.";
    return;
  }

  // 3) Succ√®s
  approveMsg.style.color = "#1a8f3c";
  approveMsg.textContent = "Acc√®s approuv√©.";

  alert("Acc√®s approuv√©.\nLe mot de passe a √©t√© envoy√© automatiquement au client.");

  document.getElementById("modalApprove").style.display = "none";
  loadRequests();
  loadClients();
};

</script>
</body>
</html>
