<!-- /auth/admin-clients.html -->
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Administration clients ‚Äî Cofel</title>

  <!-- üîí Protection par le m√™me mot de passe que le portail interne -->
  <script src="./lock.js" type="module"></script>

  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <style>
    :root{
      --cofel:#5a2d82; --cofel-2:#7838a7;
      --glass: rgba(255,255,255,.12);
      --glass-soft: rgba(255,255,255,.06);
      --txt:#f5f7ff; --txt-dim:#dcd6ff; --accent:#c9b7ff;
      --radius:18px; --blur:18px; --shadow:0 10px 30px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box;}
    html,body{height:100%;}
    body{
      margin:0; color:var(--txt);
      font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","Segoe UI",Roboto,Arial,sans-serif;
      background:
        radial-gradient(800px 500px at 20% -10%, rgba(255,255,255,.10), transparent 60%),
        radial-gradient(800px 500px at 110% 10%, rgba(255,255,255,.08), transparent 60%),
        linear-gradient(135deg, var(--cofel), var(--cofel-2));
      padding:20px;
    }

    .shell{
      max-width:1200px;
      margin:0 auto;
    }

    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      margin-bottom:18px;
      flex-wrap:wrap;
    }
    .brand{
      display:flex; align-items:center; gap:12px;
    }
    .brand img{
      height:40px; width:auto; border-radius:10px; object-fit:contain;
    }
    h1{
      margin:0;
      font-size:clamp(18px,2.4vw,22px);
    }
    .tagline{
      margin:4px 0 0;
      font-size:13px;
      color:var(--txt-dim);
    }

    .header-actions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .btn{
      appearance:none; border:none; cursor:pointer; font-weight:700;
      color:#0b0b0b; background:#fff; border-radius:999px; padding:8px 14px;
      box-shadow:0 10px 24px rgba(0,0,0,.25);
      font-size:13px;
      white-space:nowrap;
    }

    .table-wrap{
      margin-top:6px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.18);
      overflow:auto;
      max-width:100%;
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
      table-layout:auto;
    }
    thead{
      background:rgba(0,0,0,.25);
    }
    th, td{
      padding:8px 10px;
      text-align:left;
    }
    th{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.04em;
      color:var(--accent);
      border-bottom:1px solid rgba(255,255,255,.22);
      position:sticky;
      top:0;
      backdrop-filter: blur(10px);
      background:rgba(10,5,30,.95);
      z-index:1;
      white-space:nowrap;
    }

    /* ONGLET NAVIGATION */
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 18px;
    }
    .tab-btn {
      padding: 8px 18px;
      border-radius: 999px;
      cursor: pointer;
      border: 1px solid rgba(255,255,255,.35);
      background: rgba(0,0,0,.25);
      color: #f5f7ff;
      font-weight: 600;
      font-size: 13px;
      transition: 0.2s;
    }
    .tab-btn.active {
      background: #fff;
      color: #1a102b;
    }
    .tab-panel { display:none; }
    .tab-panel.active { display:block; }

    /* LOADER */
    .loader{
      font-size:13px;
      color:var(--txt-dim);
      display:flex;
      align-items:center;
      gap:6px;
    }
    .dot{
      width:6px; height:6px; border-radius:50%; background:var(--accent);
      animation:bounce 1s infinite alternate;
    }
    .dot:nth-child(2){animation-delay:.15s;}
    .dot:nth-child(3){animation-delay:.3s;}
    @keyframes bounce{
      from{ transform:translateY(0); opacity:.6;}
      to  { transform:translateY(-4px); opacity:1;}
    }

    .card{
      background:rgba(6,4,18,.8);
      border-radius:var(--radius);
      border:1px solid rgba(255,255,255,.22);
      padding:14px 16px 16px;
      box-shadow:var(--shadow);
      backdrop-filter:blur(var(--blur));
    }

    .toolbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      flex-wrap:wrap;
      gap:10px;
      margin-bottom:8px;
    }
    .toolbar-left{
      display:flex;
      flex-direction:column;
      gap:6px;
      font-size:13px;
    }
    .filter-row{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }
    .filter-row input{
      min-width:220px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.22);
      background:rgba(15,10,35,.8);
      color:var(--txt);
      font-size:13px;
    }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size:12px;
      padding:4px 10px;
      border-radius:999px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.18);
    }

    .pagination{
      margin-top:10px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-size:12px;
      color:var(--txt-dim);
    }
    .pagination button{
      font-size:12px;
      padding:4px 10px;
      border-radius:999px;
      border:none;
      cursor:pointer;
      background:#fff;
      color:#1a102b;
      font-weight:600;
    }
    .pagination button:disabled{
      opacity:.4;
      cursor:default;
    }

    .status-pill{
      display:inline-flex;
      align-items:center;
      padding:2px 8px;
      border-radius:999px;
      font-size:11px;
      font-weight:600;
    }
    .status-active{
      background:rgba(0,220,130,.12);
      color:#65f3b0;
      border:1px solid rgba(0,220,130,.4);
    }
    .status-inactive{
      background:rgba(255,80,80,.12);
      color:#ffb0b0;
      border:1px solid rgba(255,80,80,.4);
    }

    .btn-row{
      font-size:11px;
      border-radius:999px;
      padding:4px 8px;
      border:none;
      cursor:pointer;
      margin:1px;
      white-space:nowrap;
    }
    .btn-row-edit{
      background:#fff;
      color:#1a102b;
      font-weight:600;
    }
    .btn-row-secondary{
      background:rgba(255,255,255,.08);
      color:var(--txt);
      border:1px solid rgba(255,255,255,.25);
    }
    .btn-row-reset{
      background:#ffca28;
      color:#1a102b;
      font-weight:600;
    }

    .empty{
      text-align:center;
      padding:20px 8px;
      font-size:13px;
      color:var(--txt-dim);
    }

    .err{
      color:#ffb3b3;
      font-size:13px;
      margin-top:8px;
    }

    .pagination-buttons{
      display:flex;
      gap:6px;
    }

    /* Modales (gard√©es mais FORC√âES invisibles) */
    #modalNew, #modalEdit{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.65);
      display:none !important; /* üîí jamais affich√©es */
      align-items:center;
      justify-content:center;
      z-index:10;
    }
    .modal-card{
      width:100%;
      max-width:420px;
      background:rgba(15,10,35,.96);
      border-radius:16px;
      padding:18px 16px 16px;
      border:1px solid rgba(255,255,255,.22);
      box-shadow:0 12px 40px rgba(0,0,0,.45);
    }
    .modal-card h3{
      margin:0 0 10px;
      font-size:16px;
    }
    .modal-field{
      margin-bottom:10px;
      font-size:13px;
    }
    .modal-field label{
      display:block;
      margin-bottom:4px;
      color:var(--txt-dim);
    }
    .modal-field input,
    .modal-field select{
      width:100%;
      padding:6px 8px;
      border-radius:8px;
      border:1px solid rgba(255,255,255,.25);
      background:rgba(5,4,20,.9);
      color:var(--txt);
      font-size:13px;
    }
    .modal-actions{
      margin-top:12px;
      display:flex;
      justify-content:flex-end;
      gap:8px;
    }
    .btn-modal{
      border-radius:999px;
      padding:6px 12px;
      border:none;
      cursor:pointer;
      font-size:13px;
      font-weight:600;
    }
    .btn-modal-primary{
      background:#fff; color:#1a102b;
    }
    .btn-modal-secondary{
      background:rgba(255,255,255,.08);
      color:var(--txt);
      border:1px solid rgba(255,255,255,.25);
    }
  </style>
</head>
<body>

<div class="shell">

  <header>
    <div class="brand">
      <img src="../assets/logo cofel.jpg" alt="Cofel">
      <div>
        <h1>Administration des comptes clients</h1>
        <p class="tagline">Visualisez les comptes, remises, statuts, cr√©ez des clients et g√©rez les demandes d‚Äôacc√®s.</p>
      </div>
    </div>

    <div class="header-actions">
      <button id="btnNewClient" class="btn">‚ûï Nouveau client</button>
      <button id="btnExport" class="btn">‚¨á Export Excel (.xls)</button>
      <button id="btnBack" class="btn">‚¨Ö Retour aux configurateurs</button>
    </div>
  </header>

  <!-- ONGLET NAVIGATION -->
  <div class="tabs">
    <button class="tab-btn active" data-tab="tab-clients">Clients</button>
    <button class="tab-btn" data-tab="tab-requests">Demandes d‚Äôacc√®s</button>
  </div>

  <!-- ONGLET : CLIENTS -->
  <div id="tab-clients" class="tab-panel active">

    <section class="card">
      <div class="toolbar">
        <div class="toolbar-left">
          <div class="filter-row">
            <span>Recherche :</span>
            <input id="searchInput" type="text" placeholder="Filtrer par email, soci√©t√© ou contact‚Ä¶">
          </div>
          <div>
            <span id="infoCount" class="badge">Chargement‚Ä¶</span>
          </div>
        </div>
        <div class="loader" id="loader">
          <span class="dot"></span><span class="dot"></span><span class="dot"></span>
          <span>R√©cup√©ration des clients‚Ä¶</span>
        </div>
      </div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Email</th>
              <th>Soci√©t√©</th>
              <th>Contact</th>
              <th>Remise</th>
              <th>Statut</th>
              <th>Cr√©√© le</th>
              <th>Derni√®re connexion</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="tbodyClients">
            <tr><td colspan="8" class="empty">En attente des donn√©es‚Ä¶</td></tr>
          </tbody>
        </table>
      </div>

      <div class="pagination">
        <div id="paginationInfo">Page 1 / 1</div>
        <div class="pagination-buttons">
          <button id="btnPrevPage">‚óÄ Pr√©c√©dent</button>
          <button id="btnNextPage">Suivant ‚ñ∂</button>
        </div>
      </div>

      <div id="err" class="err"></div>
    </section>

  </div> <!-- FIN ONGLET CLIENTS -->


  <!-- ONGLET : DEMANDES D‚ÄôACC√àS -->
  <div id="tab-requests" class="tab-panel">

    <section class="card">
      <h2 style="margin-top:0; font-size:18px;">Demandes d‚Äôacc√®s en attente</h2>

      <div id="reqLoader" class="loader" style="display:flex; margin-bottom:10px;">
        <span class="dot"></span><span class="dot"></span><span class="dot"></span>
        <span>Chargement des demandes‚Ä¶</span>
      </div>

      <div id="reqError" class="err"></div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Soci√©t√©</th>
              <th>Contact</th>
              <th>Email</th>
              <th>T√©l√©phone</th>
              <th>Message</th>
              <th>Cr√©√© le</th>
              <th>Actions</th>
            </tr>
          </thead>

          <tbody id="reqTbody">
            <tr><td colspan="7" class="empty">Chargement‚Ä¶</td></tr>
          </tbody>
        </table>
      </div>
    </section>

  </div> <!-- FIN ONGLET DEMANDES -->


  <!-- MODALE : NOUVEAU CLIENT (gard√©e mais jamais affich√©e) -->
  <div id="modalNew">
    <div class="modal-card">
      <h3>Cr√©er un nouveau client</h3>

      <div class="modal-field">
        <label for="newEmail">Email (identifiant)</label>
        <input id="newEmail" type="email" placeholder="client@exemple.com">
      </div>

      <div class="modal-field">
        <label for="newCompany">Soci√©t√©</label>
        <input id="newCompany" type="text" placeholder="Nom de la soci√©t√©">
      </div>

      <div class="modal-field">
        <label for="newContact">Nom du contact</label>
        <input id="newContact" type="text" placeholder="Nom Pr√©nom">
      </div>

      <div class="modal-field">
        <label for="newDiscount">Remise (%)</label>
        <input id="newDiscount" type="number" min="0" max="90" value="0">
      </div>

      <div class="modal-field">
        <label for="newStatus">Statut</label>
        <select id="newStatus">
          <option value="active">Actif</option>
          <option value="inactive">Inactif</option>
        </select>
      </div>

      <div class="modal-actions">
        <button id="btnCloseModal" class="btn-modal btn-modal-secondary">Annuler</button>
        <button id="btnCreateClient" class="btn-modal btn-modal-primary">Cr√©er</button>
      </div>

      <div id="modalMsg"></div>
    </div>
  </div>

  <!-- MODALE : EDIT CLIENT (gard√©e mais jamais affich√©e) -->
  <div id="modalEdit">
    <div class="modal-card">
      <h3>Modifier client</h3>

      <div class="modal-field">
        <label for="editEmailCurrent">Email actuel (lecture seule)</label>
        <input id="editEmailCurrent" type="email" disabled>
      </div>

      <div class="modal-field">
        <label for="editNewEmail">Nouvel email (optionnel)</label>
        <input id="editNewEmail" type="email" placeholder="Laisser vide pour conserver l'email actuel">
      </div>

      <div class="modal-field">
        <label for="editCompany">Soci√©t√©</label>
        <input id="editCompany" type="text">
      </div>

      <div class="modal-field">
        <label for="editContact">Nom du contact</label>
        <input id="editContact" type="text">
      </div>

      <div class="modal-field">
        <label for="editDiscount">Remise (%)</label>
        <input id="editDiscount" type="number" min="0" max="90">
      </div>

      <div class="modal-field">
        <label for="editStatus">Statut</label>
        <select id="editStatus">
          <option value="active">Actif</option>
          <option value="inactive">Inactif</option>
        </select>
      </div>

      <div class="modal-actions">
        <button id="editCancel" class="btn-modal btn-modal-secondary">Annuler</button>
        <button id="editSave" class="btn-modal btn-modal-primary">Enregistrer</button>
      </div>

      <div id="editMsg"></div>
    </div>
  </div>

  <!-- ======================= SCRIPTS ========================== -->

  <script>
    const WORKER_BASE = "https://cofel-auth.sonveven.workers.dev";

    /* ONGLET NAVIGATION */
    const tabButtons = document.querySelectorAll(".tab-btn");
    const tabPanels  = document.querySelectorAll(".tab-panel");

    tabButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        tabButtons.forEach(b => b.classList.remove("active"));
        btn.classList.add("active");

        const target = btn.getAttribute("data-tab");

        tabPanels.forEach(p => {
          if (p.id === target) p.classList.add("active");
          else p.classList.remove("active");
        });
      });
    });

    /* TABLEAU CLIENTS */
    const tbody = document.getElementById("tbodyClients");
    const loader = document.getElementById("loader");
    const errBox = document.getElementById("err");
    const infoCount = document.getElementById("infoCount");
    const searchInput = document.getElementById("searchInput");
    const btnPrevPage = document.getElementById("btnPrevPage");
    const btnNextPage = document.getElementById("btnNextPage");
    const paginationInfo = document.getElementById("paginationInfo");

    const PAGE_SIZE = 25;
    let allClients = [];
    let filteredClients = [];
    let currentPage = 1;

    function formatDate(iso){
      if(!iso) return "‚Äî";
      const d = new Date(iso);
      if (isNaN(d.getTime())) return "‚Äî";
      return d.toLocaleDateString("fr-FR") + " " +
             d.toLocaleTimeString("fr-FR",{ hour:"2-digit", minute:"2-digit" });
    }

    function formatDiscount(rate){
      const pct = Math.round((rate || 0) * 1000) / 10;
      return pct.toLocaleString("fr-FR",{maximumFractionDigits:1}) + " %";
    }

    function applyFilter(text){
      const q = (text || "").toLowerCase().trim();
      if (!q){
        filteredClients = [...allClients];
      } else {
        filteredClients = allClients.filter(c =>
          (c.email || "").toLowerCase().includes(q) ||
          (c.company || "").toLowerCase().includes(q) ||
          (c.contact_name || "").toLowerCase().includes(q)
        );
      }
      currentPage = 1;
      renderTable();
    }

    function renderTable(){
      const total = filteredClients.length;
      const totalPages = Math.max(1, Math.ceil(total / PAGE_SIZE));
      currentPage = Math.min(Math.max(1, currentPage), totalPages);

      const start = (currentPage - 1) * PAGE_SIZE;
      const rows = filteredClients.slice(start, start + PAGE_SIZE);

      infoCount.textContent = total
        ? `${rows.length} client(s) affich√©(s) sur ${total} ‚Äî page ${currentPage}/${totalPages}`
        : `Aucun client ne correspond au filtre`;

      paginationInfo.textContent = `Page ${currentPage}/${totalPages}`;
      btnPrevPage.disabled = currentPage <= 1;
      btnNextPage.disabled = currentPage >= totalPages;

      if (!rows.length){
        tbody.innerHTML = `<tr><td colspan="8" class="empty">Aucun client √† afficher.</td></tr>`;
        return;
      }

      tbody.innerHTML = rows.map(c => {
        const status = (c.status || "").toLowerCase();
        const classStatus = status === "active" ? "status-active" : "status-inactive";
        const labelStatus = status === "active" ? "Actif" : "Inactif";
        const actionLabel = status === "active" ? "üîí Bloquer" : "üîì R√©activer";

        return `
          <tr data-email="${c.email}">
            <td>${c.email}</td>
            <td>${c.company || "‚Äî"}</td>
            <td>${c.contact_name || "‚Äî"}</td>
            <td>${formatDiscount(c.discount_rate)}</td>
            <td><span class="status-pill ${classStatus}">${labelStatus}</span></td>
            <td>${formatDate(c.created_at)}</td>
            <td>${formatDate(c.last_login_at)}</td>
            <td>
              <button class="btn-row btn-row-edit" data-email="${c.email}">‚úè Modifier</button>
              <button class="btn-row btn-row-secondary btn-row-toggle" data-email="${c.email}">
                ${actionLabel}
              </button>
              <button class="btn-row btn-row-reset" data-email="${c.email}">üîÅ Reset MDP</button>
              <button class="btn-row btn-row-delete" data-email="${c.email}" style="background:#c62828;color:white;">
                üóë Supprimer
              </button>
            </td>
          </tr>
        `;
      }).join("");
    }

    async function loadClients(){
      loader.style.display = "flex";
      try{
        const res = await fetch(`${WORKER_BASE}/clients`);
        const data = await res.json();
        allClients = data.clients || [];
        filteredClients = [...allClients];
        loader.style.display = "none";
        renderTable();
      } catch(err){
        loader.style.display = "none";
        errBox.textContent =
          "Impossible de r√©cup√©rer la liste des clients.";
      }
    }

    /* TABLEAU DES DEMANDES D'ACC√àS */

    const reqLoader = document.getElementById("reqLoader");
    const reqError  = document.getElementById("reqError");
    const reqTbody  = document.getElementById("reqTbody");

    async function loadRequests(){
      reqLoader.style.display = "flex";
      reqError.textContent = "";
      try{
        const res = await fetch(`${WORKER_BASE}/pending-requests`);
        const data = await res.json();

        reqLoader.style.display = "none";

        const rows = data.requests || [];
        if (!rows.length){
          reqTbody.innerHTML =
            `<tr><td colspan="7" class="empty">Aucune demande en attente.</td></tr>`;
          return;
        }

        reqTbody.innerHTML = rows.map(r => `
          <tr data-id="${r.id}">
            <td>${r.company || "‚Äî"}</td>
            <td>${r.name || "‚Äî"}</td>
            <td>${r.email}</td>
            <td>${r.phone || "‚Äî"}</td>
            <td>${r.message || "‚Äî"}</td>
            <td>${formatDate(r.created_at)}</td>
            <td>
              <button class="btn-row btn-approve" data-id="${r.id}">‚úî Approuver</button>
              <button class="btn-row btn-row-secondary btn-reject" data-id="${r.id}">‚ùå Refuser</button>
            </td>
          </tr>
        `).join("");

      }catch(err){
        reqLoader.style.display = "none";
        reqError.textContent =
          "Erreur lors du chargement des demandes.";
      }
    }

    async function approveRequest(id){
      try{
        const res = await fetch(`${WORKER_BASE}/admin-approve`, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({
            requestId:id,
            discount:0,
            configs:["t√¥le-tablette"]
          })
        });

        const data = await res.json();
        if (data.ok){
          alert("Demande approuv√©e.");
          loadRequests();
          loadClients();
        }

      }catch(err){
        alert("Erreur lors de l'approbation.");
      }
    }

    async function rejectRequest(id){
      try{
        const res = await fetch(`${WORKER_BASE}/access-request-reject`, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ id })
        });

        const data = await res.json();
        if (data.ok){
          alert("Demande refus√©e.");
          loadRequests();
        }
      }catch(err){
        alert("Erreur lors du refus.");
      }
    }

    reqTbody.addEventListener("click", e => {
      const approve = e.target.closest(".btn-approve");
      const reject  = e.target.closest(".btn-reject");

      if (approve){
        const id = approve.getAttribute("data-id");
        if (confirm("Approuver cette demande ?")){
          approveRequest(id);
        }
      }

      if (reject){
        const id = reject.getAttribute("data-id");
        if (confirm("Refuser cette demande ?")){
          rejectRequest(id);
        }
      }
    });

    /* ACTIONS CLIENTS : reset, toggle, delete, edit */

    async function resetClientPassword(email){
      const res = await fetch(`${WORKER_BASE}/client-reset-password`, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body:JSON.stringify({ email })
      });
      return res.json();
    }

    async function updateClient(payload){
      const res = await fetch(`${WORKER_BASE}/client-edit`, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body:JSON.stringify(payload)
      });
      return res.json();
    }

    const modalNew = document.getElementById("modalNew");
    const modalEdit = document.getElementById("modalEdit");

    tbody.addEventListener("click", async e => {
      const edit   = e.target.closest(".btn-row-edit");
      const toggle = e.target.closest(".btn-row-toggle");
      const reset  = e.target.closest(".btn-row-reset");
      const del    = e.target.closest(".btn-row-delete");

      /* EDIT ‚Üí FEN√äTRE POP-UP */
      if (edit){
        const email = edit.getAttribute("data-email");
        window.open(
          `./edit-client.html?email=${encodeURIComponent(email)}`,
          "_blank",
          "width=520,height=720,top=100,left=100"
        );
        return;
      }

      /* BLOQUER / D√âBLOQUER */
      if (toggle){
        const email = toggle.getAttribute("data-email");
        const c = allClients.find(x => x.email === email);
        if (!c) return;

        const next = c.status === "active" ? "inactive" : "active";
        if (!confirm(`Confirmer changement de statut (${next}) ?`)) return;

        await fetch(`${WORKER_BASE}/client-update`, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body:JSON.stringify({ email, status:next })
        });

        loadClients();
        return;
      }

      /* RESET MDP */
      if (reset){
        const email = reset.getAttribute("data-email");
        if (!confirm("R√©initialiser le mot de passe ?")) return;

        const result = await resetClientPassword(email);
        alert(`Nouveau mot de passe : ${result.password}`);
        return;
      }

      /* SUPPRIMER CLIENT */
      if (del){
        const email = del.getAttribute("data-email");
        if (!confirm(`Supprimer le client : ${email} ?`)) return;

        try {
          const res = await fetch(`${WORKER_BASE}/client-delete`, {
            method:"POST",
            headers:{ "Content-Type":"application/json" },
            body:JSON.stringify({ email })
          });

          const out = await res.json();

          if (out.ok){
            alert("Client supprim√© !");
            loadClients();
          } else {
            alert("Erreur lors de la suppression.");
          }
        } catch(err){
          alert("Erreur r√©seau : " + err);
        }
      }
    });

    /* BOUTON NOUVEAU CLIENT ‚Üí POP-UP */
    document.getElementById("btnNewClient").onclick = () => {
      window.open(
        "./new-client.html",
        "_blank",
        "width=520,height=680,top=120,left=120"
      );
    };

    /* Logique de modale conserv√©e mais jamais utilis√©e */
    document.getElementById("btnCloseModal").onclick = () =>
      modalNew.style.display = "none";

    document.getElementById("btnCreateClient").onclick = async () => {
      const email = document.getElementById("newEmail").value.trim();
      const company = document.getElementById("newCompany").value.trim();
      const contact = document.getElementById("newContact").value.trim();
      const discount = Number(document.getElementById("newDiscount").value);
      const status = document.getElementById("newStatus").value;

      const msg = document.getElementById("modalMsg");

      if (!email){
        msg.textContent = "Email obligatoire.";
        return;
      }

      try{
        const res = await fetch(`${WORKER_BASE}/client-create`, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body:JSON.stringify({ email, company, contact, discount, status })
        });

        const data = await res.json();

        msg.style.color = "#b7ffcf";
        msg.textContent = "Client cr√©√©. Mot de passe : " + data.password;
        alert("Mot de passe : " + data.password);

        loadClients();

      }catch(err){
        msg.style.color = "#ffe3e3";
        msg.textContent = "Erreur lors de la cr√©ation.";
      }
    };

    document.getElementById("editCancel").onclick = () =>
      modalEdit.style.display = "none";

    document.getElementById("editSave").onclick = async () => {
      const email = document.getElementById("editEmailCurrent").value;
      let newEmail = document.getElementById("editNewEmail").value;
      const company = document.getElementById("editCompany").value.trim();
      const contact = document.getElementById("editContact").value.trim();
      const discount = Number(document.getElementById("editDiscount").value);
      const status = document.getElementById("editStatus").value;

      if (!newEmail) newEmail = email;

      try{
        await updateClient({
          email,
          newEmail,
          company,
          contact,
          discount,
          status
        });
        alert("Modifi√© !");
        modalEdit.style.display = "none";
        loadClients();

      }catch(err){
        document.getElementById("editMsg").textContent =
          "Erreur lors de la mise √† jour.";
      }
    };

    /* NAV / EXPORT */
    document.getElementById("btnBack").onclick = () => {
      location.href = "../index.html";
    };

    document.getElementById("btnExport").onclick = () => {
      window.open(`${WORKER_BASE}/clients-export-xls`, "_blank");
    };

    searchInput.addEventListener("input", () =>
      applyFilter(searchInput.value));

    btnPrevPage.onclick = () => { currentPage--; renderTable(); };
    btnNextPage.onclick = () => { currentPage++; renderTable(); };

    /* CHARGEMENT INITIAL */
    loadClients();
    loadRequests();

  </script>

</div>
</body>
</html>
